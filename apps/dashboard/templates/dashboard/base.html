{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}SAIF · Dashboard{% endblock %}</title>
 

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: { DEFAULT: '#0E7A3A' } },
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] }
        }
      }
    };
  </script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    /* Título decorativo (opcional) */
    .cheto-title{
      font-weight:800; line-height:1.05;
      background:linear-gradient(90deg,#0ea5e9,#10b981,#0ea5e9);
      background-size:200% auto; -webkit-background-clip:text; background-clip:text;
      color:transparent; animation:shine 6s linear infinite; position:relative;
    }
    .cheto-title::after{
      content:""; position:absolute; left:0; bottom:-8px; height:4px; width:120px;
      background:linear-gradient(90deg,#10b981,transparent); border-radius:9999px;
      animation:underline 3s ease-in-out infinite;
    }
    @keyframes shine { to { background-position:200% center; } }
    @keyframes underline { 0%{width:90px;opacity:.7} 50%{width:220px;opacity:1} 100%{width:90px;opacity:.7} }

    /* Submenú de Mantenimiento */
    .saif-collapse{ overflow:hidden; max-height:0; transition:max-height .25s ease; }
    .saif-collapse.open{ max-height:500px; }
    .saif-caret{ transition:transform .2s ease; }
    .saif-caret.up{ transform:rotate(180deg); }

    .saif-active{ background:rgba(16,185,129,.15); position:relative; }
    .saif-active::before{
      content:""; position:absolute; inset:0 auto 0 0; width:4px; background:#10b981; border-radius:0 4px 4px 0;
    }
    .saif-item{ border-radius:.5rem; }
    .saif-item:hover{ background:rgba(16,185,129,.2); }
  </style>

  <!-- Bootstrap (opcional) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

  <!-- CSS propio -->
  <link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>

<body class="font-sans text-slate-800">
  <!-- TOPBAR -->
  <header class="bg-brand text-white">
    <div class="h-14 px-4 flex items-center gap-3">
      <a href="{% url 'dashboard:index' %}" class="flex items-center gap-3">
        <img src="{% static 'home/img/logo_empresa.png' %}" alt="Logo SAIF" class="h-8 w-8 rounded-full bg-white p-1">
        <span class="text-2xl font-extrabold tracking-wide">SAIF</span>
      </a>

      <div class="ml-auto flex items-center gap-4">
        {% if request.user.is_authenticated %}
          <form action="{% url 'logout' %}" method="post" class="m-0 p-0">
            {% csrf_token %}
            <button type="submit" class="flex items-center gap-2 hover:underline bg-transparent border-0 text-white">
              <i class="bi bi-box-arrow-right"></i> Logout
            </button>
          </form>
          <span class="text-white/80 text-sm hidden sm:inline">
            Hola, {% firstof request.user.first_name request.user.get_short_name request.user.get_username request.user %}
          </span>
        {% endif %}
      </div>
    </div>
  </header>

  <div class="grid grid-cols-[260px_1fr] min-h-[calc(100vh-56px)]">
    <!-- SIDEBAR -->
    <aside class="bg-emerald-900 text-emerald-50 min-h-screen p-4">
      <nav class="space-y-2 text-sm">
        <h6 class="uppercase text-xs text-emerald-200 font-semibold">Principio</h6>
        <hr>
        <a href="/dashboard/" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-emerald-800 transition">
          <i class="bi bi-house-door"></i><span>Inicio</span>
        </a>

        <h6 class="uppercase text-xs text-emerald-200 font-semibold">Inventario</h6>
        <hr>



       <!-- ==== Gestión de Inventario: BOTÓN TOGGLE + Submenú ==== -->
<div id="inventario-group" class="space-y-1">
  <!-- Botón que SOLO despliega/colapsa (no navega) -->
  <button type="button"
          id="inventario-toggle"
          class="saif-item w-full text-left flex items-center gap-2 px-3 py-2 rounded transition"
          aria-expanded="false"
          aria-controls="inventario-submenu">
    <i class="bi bi-box-seam"></i>
    <span class="flex-1">Gestión Inventario</span>
    <i id="inventario-caret" class="saif-caret bi bi-caret-down ms-auto text-emerald-200"></i>
  </button>

  <!-- Submenú -->
  <div id="inventario-submenu"
       class="saif-collapse mt-1 ms-8"
       data-index-url="/inventario/">

<a href="/inventario/" class="saif-item flex items-center gap-2 px-3 py-1.5">
    <i class="bi bi-grid"></i>
    <span>Dashboard</span>
  </a>

    <a href="/inventario/productos" class="saif-item flex items-center gap-2 px-3 py-1.5">
      <i class="bi bi-clipboard-data"></i>
      <span>Gestión de Productos</span>
    </a>
    <a href="/inventario/stock/" class="saif-item flex items-center gap-2 px-3 py-1.5">
      <i class="bi bi-boxes"></i>
      <span>Stock</span>
    </a>
  </div>
</div>
<!-- ==== /Gestión de Inventario ==== -->



        <a href="/recepcion_almacenamiento/" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-emerald-800 transition">
          <i class="bi bi-truck"></i><span>Recepción y Almacenamiento</span>
        </a>
        <a href="/salidas_devoluciones/" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-emerald-800 transition">
          <i class="bi bi-box-arrow-right"></i><span>Salidas y Devoluciones</span>
        </a>
        <a href="/alertas_vencimientos/" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-emerald-800 transition">
          <i class="bi bi-exclamation-triangle"></i><span>Alertas y Vencimientos</span>
        </a>

        <h6 class="uppercase text-xs text-emerald-200 font-semibold mt-4">Operaciones</h6>
        <hr>
        <a href="/solicitudes_bodega_central/" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-emerald-800 transition">
          <i class="bi bi-inboxes"></i><span>Solicitudes a Bodega Central</span>
        </a>
        <!-- ==== Gestión de Recetas ==== -->
<div id="recetas-group" class="space-y-1">
  <!-- Botón toggle -->
  <button type="button"
          id="recetas-toggle"
          class="saif-item w-full text-left flex items-center gap-2 px-3 py-2 rounded transition"
          aria-expanded="false"
          aria-controls="recetas-submenu">
    <i class="bi bi-bookmark"></i>
    <span class="flex-1">Gestión Recetas</span>
    <i id="recetas-caret" class="saif-caret bi bi-caret-down ms-auto text-emerald-200"></i>
  </button>

  <!-- Submenú -->
  <div id="recetas-submenu"
       class="saif-collapse mt-1 ms-8"
       data-index-url="/recetas/">

    <a href="/recetas/" class="saif-item flex items-center gap-2 px-3 py-1.5">
      <i class="bi bi-grid"></i>
      <span>Dashboard</span>
    </a>

    <a href="/recetas/registrar/" class="saif-item flex items-center gap-2 px-3 py-1.5">
      <i class="bi bi-journal-plus"></i>
      <span>Registrar Receta</span>
    </a>

    <a href="/recetas/lista/" class="saif-item flex items-center gap-2 px-3 py-1.5">
      <i class="bi bi-list-ul"></i>
      <span>Listado Recetas</span>
    </a>

    <a href="/recetas/registrar_envio/" class="saif-item flex items-center gap-2 px-3 py-1.5">
      <i class="bi bi-send-plus"></i>
      <span>Registrar Envío</span>
    </a>

    <a href="/recetas/lista_envios/" class="saif-item flex items-center gap-2 px-3 py-1.5">
      <i class="bi bi-archive"></i>
      <span>Listado Envíos</span>
    </a>
  </div>
</div>
<!-- ==== /Gestión de Recetas ==== -->

        <a href="/ajustes_inventario/" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-emerald-800 transition">
          <i class="bi bi-sliders"></i><span>Conteo Físico y Ajustes</span>
        </a>

        <h6 class="uppercase text-xs text-emerald-200 font-semibold mt-4">Administración</h6>
        <hr>

        {# ==== Mantenimiento: BOTÓN TOGGLE + Submenú (con Dashboard) ==== #}
        <div id="mantenimiento-group" class="space-y-1">
          <!-- Botón que SOLO despliega/colapsa (no navega) -->
          <button type="button"
                  id="mantenimiento-toggle"
                  class="saif-item w-full text-left flex items-center gap-2 px-3 py-2 rounded transition"
                  aria-expanded="false"
                  aria-controls="mantenimiento-submenu">
            <i class="bi bi-gear"></i>
            <span class="flex-1">Mantenimiento</span>
            <i id="mantenimiento-caret" class="saif-caret bi bi-caret-down ms-auto text-emerald-200"></i>
          </button>

         <!-- Submenú (incluye Dashboard con ícono) -->
<div id="mantenimiento-submenu"
     class="saif-collapse mt-1 ms-8"
     data-index-url="{% url 'mantenimiento:index' %}">

  <a href="{% url 'mantenimiento:index' %}" class="saif-item flex items-center gap-2 px-3 py-1.5">
    <i class="bi bi-grid"></i>
    <span>Dashboard</span>
  </a>

  <a href="{% url 'mantenimiento:mantenimiento_usuarios:lista' %}" class="saif-item flex items-center gap-2 px-3 py-1.5">
    <i class="bi bi-people"></i>
    <span>Usuarios</span>
  </a>

  <a href="{% url 'mantenimiento:mantenimiento_roles:lista' %}" class="saif-item flex items-center gap-2 px-3 py-1.5">
    <i class="bi bi-person-badge"></i>
    <span>Roles</span>
  </a>

  <a href="{% url 'mantenimiento:mantenimiento_laboratorios:lista' %}" class="saif-item flex items-center gap-2 px-3 py-1.5">
    <i class="bi bi-building"></i>
    <span>Laboratorios</span>
  </a>

  <a href="{% url 'mantenimiento:mantenimiento_presentaciones:lista' %}" class="saif-item flex items-center gap-2 px-3 py-1.5">
    <i class="bi bi-box"></i>
    <span>Presentaciones</span>
  </a>

  <a href="{% url 'mantenimiento:mantenimiento_unidadesmedida:lista' %}" class="saif-item flex items-center gap-2 px-3 py-1.5">
    <i class="bi bi-rulers"></i>
    <span>Unidades de Medida</span>
  </a>

  <a href="{% url 'mantenimiento:mantenimiento_condicionesalmacenamiento:lista' %}" class="saif-item flex items-center gap-2 px-3 py-1.5">
    <i class="bi bi-thermometer-snow"></i>
    <span>Condiciones de Almacenamiento</span>
  </a>
</div>

        </div>
        {# ==== /Mantenimiento ==== #}
      </nav>
    </aside>

    <!-- CONTENT -->
    <main class="bg-white">
      {% block content %}{% endblock %}
    </main>
  </div>

  <footer class="border-t text-xs text-slate-600 px-4 py-3">
    SAIF | © 2025 Todos los derechos reservados.
  </footer>

 
<!-- Script del sidebar (siempre cargado) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const path = location.pathname || '';

  // ===== Utilidades comunes =====
  const normalize = (s) => (s || '').replace(/\/+$/, '');
  const groups = [];

  const setupGroup = ({ toggleId, submenuId, caretId, openIfStartsWith }) => {
    const toggleBtn = document.getElementById(toggleId);
    const submenu   = document.getElementById(submenuId);
    const caret     = document.getElementById(caretId);
    if (!toggleBtn || !submenu || !caret) return;

    const open  = () => { submenu.classList.add('open');  caret.classList.add('up');  toggleBtn.setAttribute('aria-expanded','true'); };
    const close = () => { submenu.classList.remove('open');caret.classList.remove('up');toggleBtn.setAttribute('aria-expanded','false'); };
    const isOpen = () => submenu.classList.contains('open');

    // Resaltar subitem activo (incluye índice del grupo)
    const idxURL = submenu.dataset.indexUrl || '';
    submenu.querySelectorAll('a').forEach(a => {
      const href = a.getAttribute('href') || '';
      if (normalize(path) === normalize(href) || path.startsWith(href + '/')) {
        a.classList.add('saif-active');
      }
      if (idxURL && normalize(path) === normalize(idxURL) && normalize(href) === normalize(idxURL)) {
        a.classList.add('saif-active');
      }
    });

    // Registra el grupo
    const group = { toggleBtn, submenu, caret, open, close, isOpen, openIfStartsWith };
    groups.push(group);

    // Toggle con acordeón: cierra otros antes de abrir este
    toggleBtn.addEventListener('click', () => {
      if (group.isOpen()) {
        group.close();
      } else {
        groups.forEach(g => { if (g !== group) g.close(); });
        group.open();
      }
    });

    return group;
  };

  // ====== Registra tus grupos aquí ======
  const gMant = setupGroup({
    toggleId: 'mantenimiento-toggle',
    submenuId: 'mantenimiento-submenu',
    caretId:  'mantenimiento-caret',
    openIfStartsWith: '/mantenimiento/'
  });

  const gInv = setupGroup({
    toggleId: 'inventario-toggle',
    submenuId: 'inventario-submenu',
    caretId:  'inventario-caret',
    openIfStartsWith: '/inventario/'
  });

  const gRec = setupGroup({
  toggleId: 'recetas-toggle',
  submenuId: 'recetas-submenu',
  caretId:  'recetas-caret',
  openIfStartsWith: '/recetas/'
});

  // ====== Auto-apertura por ruta pero en modo acordeón (solo uno abierto) ======
  // Si varias rutas coinciden, se queda abierto el primero que haga match.
  const firstMatch = groups.find(g => g.openIfStartsWith && path.startsWith(g.openIfStartsWith));
  if (firstMatch) {
    groups.forEach(g => g.close());
    firstMatch.open();
  } else {
    // Si el HTML ya trajo alguno abierto, asegura que solo quede uno
    const alreadyOpen = groups.find(g => g.isOpen());
    if (alreadyOpen) {
      groups.forEach(g => { if (g !== alreadyOpen) g.close(); });
    }
  }
});
</script>
  {% block extra_js %}{% endblock %}
  {% block modals %}{% endblock %}
</body>
</html>
