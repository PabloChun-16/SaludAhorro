{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Ingresos por Ajuste · SAIF{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'lista/lista.css' %}">

<style>
/* ====== Estilo de tabla tipo “Productos” (solo diseño) ====== */
.table-container{ overflow-x:auto; width:100%; scroll-padding-top:90px; }

#tablaAjustes{
  table-layout:fixed; width:100%; min-width:900px;
  border-collapse:separate; border-spacing:0;
  outline:1px solid #e3e6ea; outline-offset:-1px; border-radius:.5rem; margin-bottom:0;
}

#tablaAjustes th,#tablaAjustes td{
  overflow:hidden; white-space:nowrap; text-overflow:ellipsis; vertical-align:middle;
  padding:.5rem; font-size:.875rem; background-clip:padding-box; border:1px solid #e3e6ea; /* líneas internas */
}

#tablaAjustes tbody tr{ background:#ffffff; }

#tablaAjustes thead.sticky-top{ position:sticky; top:0; z-index:10; box-shadow:0 2px 4px rgba(0,0,0,.06); }
#tablaAjustes thead.sticky-top tr:first-child th{
  position:sticky; top:0; z-index:11; background:#e8f5ec;  /* verde suave */
  border-bottom:1px solid #d7dbdf;                        /* división header/filtros */
}
#tablaAjustes thead.sticky-top tr.filter-row th{
  position:sticky; top:42px; z-index:10; background:#f4fbf6;
  border-top:1px solid #d9f3e0; border-bottom:1px solid #d7dbdf;
  box-shadow:0 2px 3px rgba(0,0,0,.04) inset;
  padding:.35rem .5rem; overflow:visible;
}

/* Inputs de filtros (solo estilo) */
thead .form-control-sm{ padding-top:.25rem; padding-bottom:.25rem; height:28px; }
.filter-control{
  width:100%; height:32px; padding:.25rem .5rem; border:1px solid #cfe9d7;
  background:#fff; border-radius:.5rem; transition:border-color .15s, box-shadow .15s;
  font-size:.85rem; box-sizing:border-box;
}
.filter-control::placeholder{ color:#94a3b8; }
.filter-control.text-center{ text-align:center; }
.filter-control:focus{ border-color:#62c07b; outline:0; box-shadow:0 0 0 .15rem rgba(34,197,94,.15); }

#tablaAjustes thead.sticky-top tr.filter-row th .filter-wrap{ display:flex; justify-content:center; }

/* Bordes y hover */
#tablaAjustes thead tr:first-child th{ border-top:0; }
#tablaAjustes tbody tr:last-child td{ border-bottom:0; }
#tablaAjustes tr>*:first-child{ border-left:0; }
#tablaAjustes tr>*:last-child{  border-right:0; }
#tablaAjustes tbody tr:hover{ background:#fafafa; }
</style>

<section class="p-3">
  <div class="saif-card mb-4 shadow-lg rounded-3 overflow-hidden">
    <!-- Header -->
    <div class="saif-card-header d-flex align-items-center justify-content-between bg-success text-white px-3 py-2">
      <h3 class="mb-0 fs-6">
        <i class="bi bi-box-arrow-in-down me-2"></i> Ingresos por Ajuste
      </h3>
      <span class="badge bg-light text-success px-2 py-1 fs-7">SAIF</span>
    </div>

    <!-- Contenedor de tabla -->
    <div class="table-container">
      <table class="table table-hover align-middle text-center" id="tablaAjustes">
        <thead class="table-success text-dark shadow-sm sticky-top">
          <tr>
            <th>Correlativo</th>
            <th>Estado</th>
            <th>Fecha</th>
            <th>Usuario</th>
          </tr>
          <tr class="filter-row">
            <th><input id="f-id" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-estado" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-fecha" class="form-control form-control-sm filter-control text-center" placeholder="dd/mm/aaaa"></th>
            <th><input id="f-usuario" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
          </tr>
        </thead>

        <tbody>
          {% for a in ajustes %}
          <tr data-id="{{ a.id }}">
            <td>{{ a.id }}</td>
            <td>
              {% if a.estado == "Completado" %}
                <span class="badge bg-success">Completado</span>
              {% elif a.estado == "Pendiente" %}
                <span class="badge bg-warning text-dark">Pendiente</span>
              {% else %}
                <span class="badge bg-secondary">{{ a.estado }}</span>
              {% endif %}
            </td>
            <td>{{ a.fecha_conteo|date:"d/m/Y" }}</td>
            <td>{{ a.id_usuario }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="py-5 text-muted" data-empty-row>
              <i class="bi bi-inbox fs-3 d-block mb-2"></i>
              No hay ingresos por ajuste registrados.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Paginador -->
    <div id="pagerAjustes" class="saif-pager"></div>

    <!-- Botones -->
    <div class="px-3 py-3 text-center border-top bg-light">
      <!-- CREAR -->
      <button id="btnCrearAjuste"
              class="btn btn-warning rounded-pill px-3 me-2 shadow-sm"
              data-bs-toggle="modal"
              data-bs-target="#modalAjusteIngreso"
              data-url="{% url 'ajustes_inventario:ingresos:ajuste_ingreso_create' %}">
        <i class="bi bi-plus-circle"></i> Crear
      </button>

      <!-- CONSULTAR -->
      <button id="btnConsultarAjuste"
              class="btn btn-primary rounded-pill px-3 shadow-sm"
              disabled>
        <i class="bi bi-search"></i> Consultar
      </button>

      <!-- ANULAR -->
      <button id="btnAnularAjuste"
              class="btn btn-danger rounded-pill px-3 shadow-sm"
              disabled>
        <i class="bi bi-x-circle"></i> Anular
      </button>
    </div>
  </div>
</section>

<!-- Modal CREAR: se carga dinámicamente -->
<div class="modal fade" id="modalAjusteIngreso" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" id="modal-ajuste-content"></div>
  </div>
</div>

<!-- Modal CONSULTAR -->
<div class="modal fade" id="modalConsultarAjuste" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content" id="modal-consultar-content"></div>
  </div>
</div>

<!-- Modales auxiliares -->
{% include "recepcion/partials/producto_modal.html" %}
{% include "recepcion/partials/lote_modal.html" %}
{% endblock %}

{% block extra_js %}

<script>
document.addEventListener("DOMContentLoaded", function () {
  const modalEl = document.getElementById("modalAjusteIngreso");
  const modalContent = document.getElementById("modal-ajuste-content");
  const btnCrear = document.getElementById("btnCrearAjuste");
  const modalInstance = new bootstrap.Modal(modalEl);
  let detalles = [];

  // === ABRIR FORMULARIO PRINCIPAL ===
  btnCrear?.addEventListener("click", (ev) => {
    const url = ev.currentTarget.getAttribute("data-url");
    modalContent.innerHTML = '<div class="p-4 text-center text-muted">Cargando...</div>';
    modalInstance.show();

    fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
      .then(r => r.text())
      .then(html => {
        modalContent.innerHTML = html;
        inicializarFormulario(); // 👈 se inicializa cuando se carga el form
      })
      .catch(() => {
        modalContent.innerHTML = '<div class="p-4 text-danger text-center">Error cargando el formulario.</div>';
      });
  });

  // === INICIALIZAR FORMULARIO DE CREACIÓN ===
  function inicializarFormulario() {
    const btnAdd = document.getElementById("btnAddDetalle");
    const tableBody = document.getElementById("detalleTable");
    const modalProducto = document.getElementById("modalBuscarProducto");
    const modalLote = document.getElementById("modalBuscarLote");

    const productoInput = document.getElementById("productoInput");
    const productoIdInput = document.getElementById("productoIdInput");
    const loteInput = document.getElementById("loteInput");
    const loteIdInput = document.getElementById("loteIdInput");
    const cantidadInput = document.getElementById("cantidadInput");

    // === AÑADIR DETALLE ===
    btnAdd?.addEventListener("click", () => {
      const productoId = productoIdInput.value.trim();
      const producto = productoInput.value.trim();
      const loteId = loteIdInput.value.trim();
      const lote = loteInput.value.trim();
      const cantidad = parseInt(cantidadInput.value) || 0;

      if (!productoId) return alert("Seleccione un producto antes de añadir.");
      if (!lote && !loteId) return alert("Seleccione o ingrese un lote.");
      if (cantidad <= 0) return alert("Ingrese una cantidad válida.");

      const item = {
        producto_id: productoId,
        producto,
        lote_id: loteId,
        numero_lote: lote,
        cantidad_ajustada: cantidad
      };
      detalles.push(item);

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${producto}</td>
        <td>${lote}</td>
        <td>${cantidad}</td>
        <td>
          <button type="button" class="btn btn-sm btn-outline-danger btnRemove">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      `;
      row.querySelector(".btnRemove").addEventListener("click", () => {
        row.remove();
        detalles = detalles.filter(d => d !== item);
        if (detalles.length === 0)
          tableBody.innerHTML = '<tr><td colspan="4" class="text-muted">Sin productos agregados</td></tr>';
      });

      if (detalles.length === 1) tableBody.innerHTML = "";
      tableBody.appendChild(row);

      productoInput.value = "";
      productoIdInput.value = "";
      loteInput.value = "";
      loteIdInput.value = "";
      cantidadInput.value = "0";
    });

    // === GUARDAR AJUSTE (POST AJAX) ===
    const form = document.getElementById("formAjusteIngreso");

    form?.addEventListener("submit", function (e) {
      e.preventDefault();
      document.activeElement?.blur();

      if (detalles.length === 0) {
        alert("Debe agregar al menos un producto antes de guardar.");
        return;
      }

      const fecha_ajuste = document.querySelector("#id_fecha_ajuste")?.value;
      const csrf = document.querySelector("[name=csrfmiddlewaretoken]").value;

      // ✅ Generar JSON de detalles
      const hiddenDetalles = document.getElementById("detallesJson");
      if (hiddenDetalles) hiddenDetalles.value = JSON.stringify(detalles);

      // Limpiar campo cantidad (evita validación)
      const cantidadInput = document.getElementById("cantidadInput");
      if (cantidadInput) cantidadInput.value = "";

      // === Enviar datos ===
      const payload = {
        form_data: { fecha_ajuste },
        detalles: detalles
      };

      fetch("{% url 'ajustes_inventario:ingresos:ajuste_ingreso_create' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrf,
          "X-Requested-With": "XMLHttpRequest"
        },
        body: JSON.stringify(payload)
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            alert("Ajuste guardado correctamente.");
            modalInstance.hide();
            window.location.reload();
          } else {
            alert("Error al guardar: " + (data.errors || "Desconocido."));
          }
        })
        .catch(() => alert("Error de red o servidor al guardar el ajuste."));
    });

    // === ABRIR MODALES DE PRODUCTO / LOTE ===
    document.getElementById("btnBuscarProducto")?.addEventListener("click", () => {
      bootstrap.Modal.getOrCreateInstance(modalProducto).show();
    });
    document.getElementById("btnBuscarLote")?.addEventListener("click", () => {
      bootstrap.Modal.getOrCreateInstance(modalLote).show();
      cargarLotes();
    });

    // === BUSCAR PRODUCTOS ===
    modalProducto?.addEventListener("shown.bs.modal", () => {
      const searchInput = document.getElementById("searchProducto");
      const tbodyResultados = document.getElementById("tablaBuscarProductos");
      if (!searchInput || !tbodyResultados) return;

      searchInput.value = "";
      tbodyResultados.innerHTML = '<tr><td colspan="9" class="text-muted">Escribe para buscar...</td></tr>';

      searchInput.oninput = function () {
        const term = this.value.trim();
        fetch("{% url 'ajustes_inventario:ingresos:search_productos' %}?term=" + encodeURIComponent(term))
          .then(r => r.json())
          .then(data => {
            tbodyResultados.innerHTML = "";
            if (data.length === 0) {
              tbodyResultados.innerHTML = '<tr><td colspan="9" class="text-muted">Sin resultados.</td></tr>';
              return;
            }
            data.forEach(p => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${p.codigo}</td>
                <td>${p.nombre}</td>
                <td>${p.descripcion || "-"}</td>
                <td>${p.presentacion || "-"}</td>
                <td>${p.unidad || "-"}</td>
                <td>${p.condicion || "-"}</td>
                <td>${p.receta ? "Sí" : "No"}</td>
                <td>${p.controlado ? "Sí" : "No"}</td>
                <td><button class="btn btn-sm btn-success"><i class="bi bi-check2"></i></button></td>
              `;
              tr.querySelector("button").addEventListener("click", () => {
                productoInput.value = `${p.codigo} - ${p.nombre}`;
                productoIdInput.value = p.id;
                bootstrap.Modal.getInstance(modalProducto).hide();
              });
              tbodyResultados.appendChild(tr);
            });
          });
      };
    });

    // === BUSCAR LOTES ===
    function cargarLotes() {
      const productoId = productoIdInput.value;
      const searchLoteInput = document.getElementById("searchLote");
      const tablaLotes = document.getElementById("tablaBuscarLotes");

      if (!productoId) {
        tablaLotes.innerHTML = '<tr><td colspan="4" class="text-danger">Seleccione un producto primero.</td></tr>';
        return;
      }

      const base = "{% url 'ajustes_inventario:ingresos:search_lotes' 0 %}".replace("0/", productoId + "/");
      const term = searchLoteInput?.value || "";
      const url = base + (term ? "?term=" + encodeURIComponent(term) : "");

      fetch(url)
        .then(r => r.json())
        .then(data => {
          tablaLotes.innerHTML = "";
          if (data.length === 0) {
            tablaLotes.innerHTML = '<tr><td colspan="4" class="text-muted">No hay lotes registrados.</td></tr>';
            return;
          }
          data.forEach(l => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${l.numero_lote}</td>
              <td>${l.fecha_caducidad || "-"}</td>
              <td>${l.cantidad || 0}</td>
              <td><button class="btn btn-sm btn-success"><i class="bi bi-check2"></i></button></td>
            `;
            tr.querySelector("button").addEventListener("click", () => {
              loteInput.value = l.numero_lote;
              loteIdInput.value = l.id;
              bootstrap.Modal.getInstance(modalLote).hide();
            });
            tablaLotes.appendChild(tr);
          });
        });
    }

    document.getElementById("searchLote")?.addEventListener("input", cargarLotes);
  } // <-- FIN de inicializarFormulario


  /* === CONSULTAR AJUSTE (se ejecuta SIEMPRE al cargar la página) === */
  const btnConsultar = document.getElementById("btnConsultarAjuste");
  const modalConsultar = new bootstrap.Modal(document.getElementById("modalConsultarAjuste"));
  const modalConsultarContent = document.getElementById("modal-consultar-content");

  function activarSeleccionFilas() {
    const filas = document.querySelectorAll("#tablaAjustes tbody tr[data-id]");
    filas.forEach(row => {
      row.addEventListener("click", () => {
        const id = row.dataset.id;
        filas.forEach(r => r.classList.remove("table-success"));
        row.classList.add("table-success");
        btnConsultar.removeAttribute("disabled");
        btnAnular.removeAttribute("disabled");
        btnConsultar.dataset.id = id;
        btnAnular.dataset.id = id; 
      });
    });
  }

  /* === ANULAR AJUSTE === */
  const btnAnular = document.getElementById("btnAnularAjuste");
  btnAnular?.addEventListener("click", () => {
    const id = btnConsultar?.dataset.id; // usamos el mismo id seleccionado
    if (!id) return alert("Seleccione un ajuste para anular.");

    if (!confirm("¿Seguro que desea anular este ajuste? Esta acción revertirá el stock.")) return;

    fetch(`/ajustes_inventario/ingresos/anular/${id}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
        "X-Requested-With": "XMLHttpRequest",
      },
    })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          alert("Ajuste anulado correctamente. El stock ha sido revertido.");
          window.location.reload();
        } else {
          alert("Error: " + (data.error || "No se pudo anular el ajuste."));
        }
      })
      .catch(() => alert("Error de red o servidor."));
  });

  // activar selección de filas desde el inicio
  activarSeleccionFilas();

  btnConsultar?.addEventListener("click", () => {
    const id = btnConsultar.dataset.id;
    if (!id) return;
    modalConsultarContent.innerHTML = '<div class="p-4 text-center text-muted">Cargando...</div>';
    modalConsultar.show();

    fetch(`/ajustes_inventario/ingresos/consultar/${id}/`, {
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
      .then(r => r.text())
      .then(html => (modalConsultarContent.innerHTML = html))
      .catch(() => {
        modalConsultarContent.innerHTML =
          '<div class="p-4 text-danger text-center">Error al cargar el detalle.</div>';
      });
  });

  /* === EXTRA NO INVASIVO: doble clic y Enter para consultar (reutiliza tu botón) === */
  (function addDblClickAndEnter(){
    const tbody = document.querySelector("#tablaAjustes tbody");
    const btn = btnConsultar;
    if(tbody && btn){
      tbody.addEventListener("dblclick",(ev)=>{
        const row = ev.target.closest("tr[data-id]");
        if(!row) return;
        row.click();                           // usa tu misma lógica de selección
        if(!btn.disabled) btn.click();         // abre consulta con tu propio botón
      });
    }
    document.addEventListener("keydown",(ev)=>{
      if(ev.key==="Enter" && btn && !btn.disabled){
        btn.click();
        ev.preventDefault();
      }
    });
  })();

});
</script>

{% endblock %}
