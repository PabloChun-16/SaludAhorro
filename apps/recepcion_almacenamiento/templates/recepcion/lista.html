{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Recepciones &middot; SAIF{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'lista/lista.css' %}">

<style>
/* ====== Contenedor con scroll ====== */
.table-container{
  overflow-x:auto;
  width:100%;
  scroll-padding-top:90px; /* evita que el sticky solape al saltar */
}

/* ====== Tabla ====== */
#tablaRecepciones{
  table-layout:fixed;
  width:100%;
  min-width:900px;
  border-collapse:separate;   /* necesario para sticky + bordes finos */
  border-spacing:0;
  outline:1px solid #e3e6ea;  /* contorno sin ocupar espacio */
  outline-offset:-1px;
  border-radius:.5rem;
}

/* ====== Celdas ====== */
#tablaRecepciones th,
#tablaRecepciones td{
  overflow:hidden;
  white-space:nowrap;
  text-overflow:ellipsis;
  vertical-align:middle;
  padding:.5rem;
  font-size:.875rem;
  background-clip:padding-box; /* evita solapes con sticky */
  border:1px solid #e3e6ea;    /* lÃ­neas internas */
}

/* Mismo color en todas las filas */
#tablaRecepciones tbody tr{ background:#ffffff; }

/* ====== Encabezado pegajoso (2 filas: tÃ­tulos + filtros) ====== */
#tablaRecepciones thead.sticky-top{
  position:sticky;
  top:0;
  z-index:10;
  box-shadow:0 2px 4px rgba(0,0,0,.06);
}

/* Fila de tÃ­tulos */
#tablaRecepciones thead.sticky-top tr:first-child th{
  position:sticky;
  top:0;
  z-index:11;
  background:#e8f5ec;               /* verde muy suave */
  border-bottom:1px solid #d7dbdf;   /* divisiÃ³n header/filtros */
}

/* Fila de filtros */
#tablaRecepciones thead.sticky-top tr.filter-row th{
  position:sticky;
  top:42px;                          /* altura aproximada de la fila de tÃ­tulos */
  z-index:10;
  background:#f4fbf6;
  border-top:1px solid #d9f3e0;
  border-bottom:1px solid #d7dbdf;
  box-shadow:0 2px 3px rgba(0,0,0,.04) inset;
  padding:.35rem .5rem;
  overflow:visible;
}

/* ====== Controles de filtro ====== */
thead .form-control-sm,
thead .form-select-sm{
  padding-top:.25rem;
  padding-bottom:.25rem;
  height:28px;
}

.filter-control{
  width:100%;
  height:32px;
  padding:.25rem .5rem;
  border:1px solid #cfe9d7;
  background:#fff;
  border-radius:.5rem;
  transition:border-color .15s, box-shadow .15s;
  font-size:.85rem;
  box-sizing:border-box;
}
.filter-control::placeholder{ color:#94a3b8; }
.filter-control.text-center{ text-align:center; }
.filter-control:focus{
  border-color:#62c07b;
  outline:0;
  box-shadow:0 0 0 .15rem rgba(34,197,94,.15);
}

select.filter-control{
  padding-right:1.75rem;
  appearance:none;
  min-width:100px;
}
#tablaRecepciones thead.sticky-top tr.filter-row th .filter-wrap{
  display:flex; justify-content:center;
}
#tablaRecepciones thead.sticky-top tr.filter-row th .filter-wrap>select{
  width:100%; max-width:100%;
}
#tablaRecepciones thead.sticky-top tr.filter-row th select.form-select.filter-control{
  -moz-text-align-last:center !important;
  text-align-last:center !important;
  text-align:center !important;
}

/* MÃ­nimos para inputs angostos */
#tablaRecepciones thead .filter-row th{ min-width:100px; }
#tablaRecepciones thead .filter-row th:nth-child(1){ min-width:110px; } /* ID */
#tablaRecepciones thead .filter-row th:nth-child(3){ min-width:140px; } /* Fecha */
#tablaRecepciones thead .filter-row th:nth-child(5){ min-width:120px; } /* Estado */

/* ====== Utilidades de ancho ====== */
.wp-12{width:12%}.wp-20{width:20%}.wp-16{width:16%}.wp-18{width:18%}.wp-14{width:14%}

/* ====== PaginaciÃ³n: ocultar filas fuera de pÃ¡gina ====== */
.hidden-by-pagination{ display:none !important; }

/* ====== FIX bordes duplicados vs contorno ====== */
#tablaRecepciones thead tr:first-child th{ border-top:0; }
#tablaRecepciones tbody tr:last-child td{ border-bottom:0; }
#tablaRecepciones tr>*:first-child{ border-left:0; }
#tablaRecepciones tr>*:last-child{  border-right:0; }
#tablaRecepciones tbody tr.last-visible td{ border-bottom:0 !important; }

/* Hover suave */
#tablaRecepciones tbody tr:hover{ background:#fafafa; }
</style>
<!-- Overrides para evitar salto y unificar comportamiento -->
<style>
.table-container{ max-height: calc(100vh - 250px); overflow-y: auto; }
</style>

<section class="p-3">
  <div class="saif-card mb-4 shadow-lg rounded-3 overflow-hidden">
    <div class="saif-card-header d-flex align-items-center justify-content-between bg-success text-white px-3 py-2">
      <h3 class="mb-0 fs-6">
        <i class="bi bi-box-arrow-in-down me-2"></i> Recepciones de Productos
      </h3>
      <span class="badge bg-light text-success px-2 py-1 fs-7">SAIF</span>
    </div>

    <div class="table-container">
      <table class="table table-hover align-middle text-center" id="tablaRecepciones">
        <colgroup>
          <col class="wp-12"><col class="wp-20"><col class="wp-16"><col class="wp-20"><col class="wp-14">
        </colgroup>

        <thead class="table-success text-dark shadow-sm sticky-top">
          <tr>
            <th>ID</th><th>Número Envío</th><th>Fecha Recepción</th><th>Usuario</th><th>Estado</th>
          </tr>
          <tr class="filter-row">
            <th><input id="f-id" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-envio" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-fecha" class="form-control form-control-sm filter-control text-center" placeholder="dd/mm/aaaa"></th>
            <th><input id="f-usuario" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th>
              <div class="filter-wrap">
                <select id="f-estado" class="form-select form-select-sm filter-control text-center">
                  <option value="">Todos</option>
                  <option value="recibido completo">Recibido Completo</option>
                  <option value="recibido parcialmente">Recibido Parcialmente</option>
                  <option value="rechazado">Rechazado</option>
                </select>
              </div>
            </th>
          </tr>
        </thead>

        <tbody>
          {% for r in recepciones %}
          <tr data-id="{{ r.id }}" style="cursor:pointer;">
            <td class="text-truncate">{{ r.id }}</td>
            <td class="text-truncate">{{ r.numero_envio_bodega }}</td>
            <td class="text-truncate">{{ r.fecha_recepcion|date:"d/m/Y" }}</td>
            <td class="text-truncate">{{ r.id_usuario }}</td>
            <td class="text-truncate">
              {% with nombre=r.estado_recepcion.nombre_estado %}
                {% if nombre == "Recibido Completo" %}
                  <span class="badge bg-success badge-pill">Recibido Completo</span>
                {% elif nombre == "Recibido Parcialmente" %}
                  <span class="badge bg-warning text-dark badge-pill">Recibido Parcialmente</span>
                {% elif nombre == "Rechazado" %}
                  <span class="badge bg-danger badge-pill">Rechazado</span>
                {% else %}
                  <span class="badge bg-secondary badge-pill">{{ nombre }}</span>
                {% endif %}
              {% endwith %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="py-5 text-muted" data-empty-row>
              <i class="bi bi-inbox fs-3 d-block mb-2"></i>
              No hay recepciones registradas.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="pagerRecepciones" class="saif-pager"></div>

    <div class="px-3 py-3 text-center border-top bg-light">
      <button id="btnCrear" class="btn btn-warning rounded-pill px-3 me-2 shadow-sm"
              data-bs-toggle="modal" data-bs-target="#modalRecepcion"
              data-url="{% url 'recepcion:recepcion_create' %}">
        <i class="bi bi-plus-circle"></i> Crear
      </button>

      <button id="btnConsultar" class="btn btn-primary rounded-pill px-3 shadow-sm" disabled>
        <i class="bi bi-search"></i> Consultar
      </button>

      <!-- NUEVO: Cambiar estado -->
      <button id="btnCambiarEstado" class="btn btn-outline-success rounded-pill px-3 ms-2 shadow-sm" disabled>
        <i class="bi bi-arrow-repeat"></i> Cambiar estado
      </button>

      <a href="{% url 'recepcion:graficas' %}" class="btn btn-success rounded-pill px-3 ms-2 shadow-sm">
        <i class="bi bi-graph-up"></i> Gráficas
      </a>
    </div>
  </div>
</section>

<!-- Modal CREAR -->
<div class="modal fade" id="modalRecepcion" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" id="modal-recepcion-content"></div>
  </div>
</div>

<!-- Modal CONSULTAR -->
<div class="modal fade" id="modalConsultar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content" id="modal-consultar-content"></div>
  </div>
</div>

<!-- NUEVO: Modal Cambiar Estado -->
<div class="modal fade" id="modalEstado" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white py-2">
        <h5 class="modal-title mb-0"><i class="bi bi-arrow-repeat"></i> Cambiar estado</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning small">
          <strong>Notas:</strong>
          <ul class="mb-0">
            <li><em>Recibido Completo</em> y <em>Recibido Parcialmente</em> no afectan inventario.</li>
            <li><em>Rechazado</em> revierte la recepción (marca REC como cancelado y resta stock). Solo si no hubo salidas posteriores.</li>
          </ul>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="estadoNuevo" id="estCompleto" value="Recibido Completo">
          <label class="form-check-label" for="estCompleto">Recibido Completo</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="estadoNuevo" id="estParcial" value="Recibido Parcialmente">
          <label class="form-check-label" for="estParcial">Recibido Parcialmente</label>
        </div>
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" name="estadoNuevo" id="estRechazado" value="Rechazado">
          <label class="form-check-label" for="estRechazado">Rechazado</label>
        </div>
        <div id="motivoWrap" class="d-none">
          <label class="form-label">Motivo (obligatorio para Rechazado)</label>
          <textarea id="motivoEstado" class="form-control" rows="2" placeholder="Explique el motivo..."></textarea>
        </div>
        <div id="estadoAlert" class="alert alert-danger d-none mt-2"></div>
      </div>
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="btnConfirmEstado">Confirmar</button>
      </div>
    </div>
  </div>
</div>

{% include "recepcion/partials/producto_modal.html" %}
{% include "recepcion/partials/lote_modal.html" %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  /* ==================== MODAL CREAR ==================== */
  const modalEl = document.getElementById("modalRecepcion");
  const modalContent = document.getElementById("modal-recepcion-content");
  const btnCrear = document.getElementById("btnCrear");
  const modalInstance = new bootstrap.Modal(modalEl);

  // Se vacía/llena cada vez que se abre el form
  let detalles = [];

  function inicializarFormulario() {
    // ----- Añadir línea al detalle -----
    const addBtn = document.getElementById("btnAddDetalle");
    if (addBtn) {
      addBtn.addEventListener("click", function () {
        const productoIdEl = document.getElementById("productoIdInput");
        const productoTextEl = document.getElementById("productoInput");
        const loteIdEl      = document.getElementById("loteIdInput");
        const loteTextEl    = document.getElementById("loteInput");
        const caducidadEl   = document.getElementById("caducidadInput");
        const cantidadEl    = document.getElementById("cantidadInput");
        const costoEl       = document.getElementById("costoInput");
        const tableBody     = document.getElementById("detalleTable");

        if (!tableBody) { console.warn("No se encontró #detalleTable"); return; }

        const productoId = (productoIdEl?.value || "").trim();
        const productoTx = (productoTextEl?.value || "").trim();
        const loteId     = (loteIdEl?.value || "").trim();
        const numeroLote = (loteTextEl?.value || "").trim();
        const caducidad  = caducidadEl?.value || "";
        const cantidad   = cantidadEl?.value;
        const costo      = costoEl?.value;

        if (!productoId) { alert("Seleccione un producto."); return; }
        if (!loteId && !numeroLote) { alert("Ingrese o seleccione el número de lote."); return; }
        if (!loteId && !caducidad) { alert("Para un lote nuevo, ingrese fecha de caducidad."); return; }
        if (!cantidad || parseInt(cantidad, 10) <= 0) { alert("Cantidad inválida."); return; }

        const item = {
          producto_id: parseInt(productoId, 10),
          producto: productoTx,
          lote_id: loteId ? parseInt(loteId, 10) : null,
          numero_lote: numeroLote || null,
          fecha_caducidad: caducidad || null,
          cantidad_recibida: parseInt(cantidad, 10),
          costo_unitario: costo ? parseFloat(costo) : 0
        };
        detalles.push(item);

        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="text-start">${item.producto}</td>
          <td>${item.numero_lote ?? ('#' + item.lote_id)}</td>
          <td>${item.fecha_caducidad ?? ''}</td>
          <td>${item.cantidad_recibida}</td>
          <td>${item.costo_unitario.toFixed(2)}</td>
          <td><button type="button" class="btn btn-sm btn-outline-danger btnRemove"><i class="bi bi-trash"></i></button></td>
        `;
        row.querySelector(".btnRemove").addEventListener("click", () => {
          row.remove();
          detalles = detalles.filter(d => d !== item);
        });
        tableBody.appendChild(row);

        // limpiar campos de la línea
        loteIdEl.value = ""; loteTextEl.value = ""; caducidadEl.value = "";
        cantidadEl.value = ""; costoEl.value = "";
      });
    }

    // ----- Envío del formulario -----
    const formRecepcion = document.getElementById("form-recepcion");
    if (formRecepcion) {
      const urlCrearRecepcion = "{% url 'recepcion:recepcion_create' %}";
      formRecepcion.addEventListener("submit", function (event) {
        event.preventDefault();

        const formData = {
          numero_envio_bodega: document.getElementById("id_numero_envio_bodega")?.value || "",
          fecha_recepcion: document.getElementById("id_fecha_recepcion")?.value || ""
        };
        const comentario = document.getElementById("comentarioInput")?.value?.trim() || "";
        const payload = { form_data: formData, detalles: detalles, comentario: comentario };

        fetch(urlCrearRecepcion, {
          method: "POST",
          body: JSON.stringify(payload),
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
            "X-Requested-With": "XMLHttpRequest",
          },
        })
        .then(response => {
          if (!response.ok) {
            return response.json().then(errorData => {
              console.error("Error del servidor:", errorData);
              alert("Error: " + (errorData.errors || "Ocurrió un error inesperado."));
            });
          }
          return response.json();
        })
        .then(data => {
          if (!data) return;
          if (data.success) {
            alert("Recepción creada exitosamente.");
            modalInstance.hide();
            window.location.reload();
          } else {
            alert(data.error || "Ocurrió un error al crear la recepción.");
          }
        })
        .catch(err => {
          console.error(err);
          alert("Ocurrió un error de red al crear la recepción.");
        });
      });
    }

    // abrir modales auxiliares
    document.getElementById("btnBuscarProducto")?.addEventListener("click", () => {
      bootstrap.Modal.getOrCreateInstance(document.getElementById("modalBuscarProducto")).show();
    });
    document.getElementById("btnBuscarLote")?.addEventListener("click", () => {
      bootstrap.Modal.getOrCreateInstance(document.getElementById("modalBuscarLote")).show();
    });
  } // fin inicializarFormulario

  // Abrir modal CREAR y cargar form vía AJAX
  btnCrear?.addEventListener("click", (ev) => {
    const url = ev.currentTarget.getAttribute("data-url");
    modalContent.innerHTML = '<div class="p-4">Cargando...</div>';
    modalInstance.show();

    fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
      .then(r => r.text())
      .then(html => { modalContent.innerHTML = html; inicializarFormulario(); })
      .catch(() => { modalContent.innerHTML = '<div class="p-4 text-danger">Error cargando el formulario.</div>'; });
  });

  /* ==================== AUXILIARES PRODUCTOS/LOTES ==================== */
  const modalBuscar     = document.getElementById("modalBuscarProducto");
  const searchInput     = document.getElementById("searchProducto");
  const tbodyResultados = document.getElementById("tablaBuscarProductos");

  const modalLote       = document.getElementById("modalBuscarLote");
  const searchLoteInput = document.getElementById("searchLote");
  const tablaLotes      = document.getElementById("tablaBuscarLotes");

  modalBuscar?.addEventListener("shown.bs.modal", () => {
    const productoInput   = document.querySelector("#modalRecepcion #productoInput");
    const productoIdInput = document.querySelector("#modalRecepcion #productoIdInput");
    if (!searchInput || !tbodyResultados) return;
    searchInput.value = ""; tbodyResultados.innerHTML = ""; searchInput.focus();

    searchInput.oninput = function () {
      const term = this.value;
      fetch("{% url 'recepcion:search_productos' %}?term=" + encodeURIComponent(term))
        .then(r => r.json())
        .then(data => {
          tbodyResultados.innerHTML = "";
          data.forEach(p => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${p.codigo}</td><td>${p.nombre}</td><td>${p.descripcion ?? ""}</td>
              <td>${p.presentacion ?? ""}</td><td>${p.unidad ?? ""}</td><td>${p.condicion ?? ""}</td>
              <td>${p.receta ? "Sí" : "No"}</td><td>${p.controlado ? "Sí" : "No"}</td>
              <td><button type="button" class="btn btn-sm btn-success" title="Seleccionar"><i class="bi bi-check-lg"></i></button></td>
            `;
            tr.querySelector("button").addEventListener("click", () => {
              if (typeof window.setProductoSeleccionado === "function") {
                window.setProductoSeleccionado({ id: p.id, texto: `${p.codigo} - ${p.nombre}` });
              } else {
                if (productoInput)   productoInput.value = `${p.codigo} - ${p.nombre}`;
                if (productoIdInput) productoIdInput.value = p.id;
              }
              bootstrap.Modal.getInstance(modalBuscar)?.hide();
              bootstrap.Modal.getOrCreateInstance(modalEl).show();
            });
            tbodyResultados.appendChild(tr);
          });
        })
        .catch(() => {
          tbodyResultados.innerHTML = `<tr><td colspan="9" class="text-danger">Error buscando productos.</td></tr>`;
        });
    };
  });

  modalBuscar?.addEventListener("hidden.bs.modal", () => {
    if (!tbodyResultados || !searchInput) return;
    tbodyResultados.innerHTML = ""; searchInput.value = "";
  });

  function lotesUrl(productoId, term) {
    const base = "{% url 'recepcion:search_lotes' 0 %}".replace("0/", productoId + "/");
    const q = term ? "?term=" + encodeURIComponent(term) : "";
    return base + q;
  }
  function renderLotes(rows) {
    if (!tablaLotes) return;
    if (!rows || rows.length === 0) {
      tablaLotes.innerHTML = `<tr><td colspan="4" class="text-muted">Sin lotes para este producto.</td></tr>`;
      return;
    }
    tablaLotes.innerHTML = "";
    rows.forEach(l => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${l.numero_lote}</td><td>${l.fecha_caducidad || ""}</td><td>${l.cantidad}</td>
        <td><button type="button" class="btn btn-sm btn-success" title="Seleccionar"><i class="bi bi-check-lg"></i></button></td>
      `;
      tr.querySelector("button").addEventListener("click", () => {
        if (typeof window.setLoteSeleccionado === "function") {
          window.setLoteSeleccionado({ id: l.id, numero: l.numero_lote, fecha: l.fecha_caducidad });
        } else {
          const loteIdInput = document.querySelector("#modalRecepcion #loteIdInput");
          const loteInput   = document.querySelector("#modalRecepcion #loteInput");
          const cadInput    = document.querySelector("#modalRecepcion #caducidadInput");
          if (loteIdInput) loteIdInput.value = l.id;
          if (loteInput)   loteInput.value   = l.numero_lote;
          if (cadInput && l.fecha_caducidad) cadInput.value = l.fecha_caducidad;
        }
        bootstrap.Modal.getInstance(modalLote)?.hide();
        bootstrap.Modal.getOrCreateInstance(modalEl).show();
      });
      tablaLotes.appendChild(tr);
    });
  }
  function loadLotes(term = "") {
    const productoId = document.getElementById("productoIdInput")?.value;
    if (!tablaLotes) return;
    if (!productoId) {
      tablaLotes.innerHTML = `<tr><td colspan="4" class="text-danger">Primero seleccione un producto.</td></tr>`;
      return;
    }
    tablaLotes.innerHTML = `<tr><td colspan="4" class="text-muted">Cargando...</td></tr>`;
    fetch(lotesUrl(productoId, term))
      .then(r => r.json())
      .then(renderLotes)
      .catch(() => {
        tablaLotes.innerHTML = `<tr><td colspan="4" class="text-danger">Error cargando lotes.</td></tr>`;
      });
  }
  modalLote?.addEventListener("shown.bs.modal", () => {
    if (!searchLoteInput) return;
    searchLoteInput.value = ""; loadLotes("");
    searchLoteInput.oninput = () => loadLotes(searchLoteInput.value);
  });

  // Crear lote rápido
  const modalCrearLote = document.getElementById("modalCrearLote");
  const btnGuardarLote = document.getElementById("btnGuardarLote");
  if (btnGuardarLote) {
    btnGuardarLote.addEventListener("click", () => {
      const productoId = document.getElementById("productoIdInput").value;
      const numero = document.getElementById("numeroLote").value;
      const caducidad = document.getElementById("fechaCaducidad").value;
      const ubicacion = document.getElementById("ubicacionAlmacen").value;
      if (!productoId) { alert("Primero debe seleccionar un producto."); return; }

      fetch("{% url 'recepcion:create_lote' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ producto_id: productoId, numero_lote: numero, fecha_caducidad: caducidad, ubicacion: ubicacion })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          bootstrap.Modal.getInstance(modalCrearLote).hide();
          bootstrap.Modal.getOrCreateInstance(modalLote).show();
          loadLotes("");
          document.getElementById("loteInput").value = data.numero_lote;
          document.getElementById("caducidadInput").value = data.fecha_caducidad || "";
          document.getElementById("loteIdInput").value = data.id;
        } else {
          alert(data.error || "Error al crear el lote.");
        }
      });
    });
  }
  document.getElementById("btnCancelarLote")?.addEventListener("click", () => {
    bootstrap.Modal.getInstance(modalCrearLote).hide();
    bootstrap.Modal.getOrCreateInstance(modalLote).show();
  });
  document.getElementById("btnCerrarProducto")?.addEventListener("click", () => {
    bootstrap.Modal.getInstance(modalBuscar)?.hide();
    bootstrap.Modal.getOrCreateInstance(modalEl).show();
  });
  document.getElementById("btnCerrarLote")?.addEventListener("click", () => {
    bootstrap.Modal.getInstance(modalLote).hide();
    bootstrap.Modal.getOrCreateInstance(document.getElementById("modalRecepcion")).show();
  });

  /* ==================== TABLA: selección, filtros y paginación ==================== */
  const table = document.getElementById("tablaRecepciones");
  const tbody = table.querySelector("tbody");
  const pagerEl = document.getElementById("pagerRecepciones");
  const btnConsultar = document.getElementById("btnConsultar");
  const btnCambiarEstado = document.getElementById("btnCambiarEstado");
  let selectedId = null;

  function refreshAutoTitles(){
    table.querySelectorAll("td, th").forEach(el=>{
      if(el.scrollWidth>el.clientWidth){el.setAttribute("title",el.textContent.trim())}
      else{el.removeAttribute("title")}
    });
  }
  function removeEmptyRows(){
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      if(tr.hasAttribute('data-empty-row')) return;
      const hasContent = Array.from(tr.cells).some(td => (td.textContent||'').trim() !== '' || td.querySelector('*'));
      if(!hasContent){ tr.remove(); }
    });
  }
  function selectRow(row){
    if(!row) return;
    tbody.querySelectorAll("tr").forEach(r=>r.classList.remove("table-active"));
    row.classList.add("table-active");
    selectedId = row.getAttribute("data-id");
    const enabled = !!selectedId;
    btnConsultar.disabled = !enabled;
    if (btnCambiarEstado) btnCambiarEstado.disabled = !enabled;
  }
  tbody.addEventListener("click",(ev)=>{
    const row = ev.target.closest("tr");
    if(!row || row.hasAttribute("data-empty-row")) return;
    selectRow(row);
  });

  // Doble click = Consultar
  tbody.addEventListener("dblclick",(ev)=>{
    const row = ev.target.closest("tr");
    if(!row || row.hasAttribute("data-empty-row")) return;
    selectRow(row);
    if(selectedId){
      const urlBase = "{% url 'recepcion:recepcion_detail' 0 %}";
      const url = urlBase.replace("0/", selectedId + "/");
      abrirModalConsultar(url);
    }
  });

  function abrirModalConsultar(url){
    const modalConsultar = new bootstrap.Modal(document.getElementById("modalConsultar"));
    const container = document.getElementById("modal-consultar-content");
    container.innerHTML = '<div class="p-4">Cargando...</div>';

    fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
      .then(r => r.text())
      .then(html => { container.innerHTML = html; modalConsultar.show(); })
      .catch(() => { container.innerHTML = '<div class="p-4 text-danger">No se pudo cargar la recepción.</div>'; modalConsultar.show(); });
  }

  // Teclado para navegar/abrir
  table.addEventListener("keydown",(ev)=>{
    const current = tbody.querySelector("tr.table-active");
    const rows = Array.from(tbody.querySelectorAll("tr"))
      .filter(r=>!r.classList.contains("hidden-by-pagination") && !r.hasAttribute("data-empty-row"));
    if(!rows.length) return;

    const idx = rows.indexOf(current);
    if(ev.key==="ArrowDown"){
      const next = rows[Math.min(rows.length-1, idx+1>=0?idx+1:0)];
      selectRow(next); next.focus({preventScroll:true}); ev.preventDefault();
    }else if(ev.key==="ArrowUp"){
      const prev = rows[Math.max(0, idx-1>=0?idx-1:0)];
      selectRow(prev); prev.focus({preventScroll:true}); ev.preventDefault();
    }else if(ev.key==="Enter" && selectedId){
      const urlBase = "{% url 'recepcion:recepcion_detail' 0 %}";
      const url = urlBase.replace("0/", selectedId + "/");
      abrirModalConsultar(url); ev.preventDefault();
    }
  });

  document.getElementById("btnConsultar").addEventListener("click", () => {
    if (!selectedId) return;
    const urlBase = "{% url 'recepcion:recepcion_detail' 0 %}";
    const url = urlBase.replace("0/", selectedId + "/");
    abrirModalConsultar(url);
  });

  /* ====== Paginación ====== */
  let currentPage=1; let pageSize=15; const rowHeight=42;

  function recomputarPageSize(){
    const rect=tbody.getBoundingClientRect(); const margenInf=160;
    const espacio=window.innerHeight-rect.top-margenInf;
    pageSize=Math.max(1,Math.floor(espacio/rowHeight));
  }
  function getDataRows(){
    return Array.from(tbody.querySelectorAll("tr"))
      .filter(tr=>!tr.hasAttribute("data-empty-row") && tr.style.display!=="none");
  }
  function renderPager(totalPages){
    if(totalPages<=1){ pagerEl.innerHTML=""; pagerEl.style.display="none"; return; }
    pagerEl.style.display="flex"; pagerEl.innerHTML="";
    const prev=document.createElement("button");
    prev.className="btn btn-outline-secondary me-2"; prev.innerHTML="&laquo; Anterior";
    prev.disabled=currentPage===1; prev.onclick=()=>{currentPage--;applyPagination();};
    const info=document.createElement("span");
    info.className="align-self-center mx-2"; info.textContent=`Página ${currentPage} de ${totalPages}`;
    const next=document.createElement("button");
    next.className="btn btn-outline-secondary ms-2"; next.innerHTML="Siguiente &raquo;";
    next.disabled=currentPage===totalPages; next.onclick=()=>{currentPage++;applyPagination();};
    pagerEl.append(prev,info,next);
  }
  function applyPagination(){
    const rows=getDataRows(); const total=rows.length;
    const totalPages=Math.max(1,Math.ceil(total/pageSize));
    if(currentPage>totalPages) currentPage=totalPages;
    const start=(currentPage-1)*pageSize; const end=start+pageSize;
    rows.forEach((tr,idx)=>{ tr.classList.toggle("hidden-by-pagination", !(idx>=start && idx<end)); });
    renderPager(totalPages);
    // Marcar última visible para quitar borde inferior
    tbody.querySelectorAll('tr').forEach(tr=>tr.classList.remove('last-visible'));
    const visibles = rows.filter(r=>!r.classList.contains('hidden-by-pagination'));
    const last = visibles[visibles.length-1];
    if(last) last.classList.add('last-visible');

    // Mantener selección visible
    if(selectedId){
      const sel=rows.find(r=>r.getAttribute("data-id")===selectedId);
      if(sel && sel.classList.contains("hidden-by-pagination")){
        const firstVisible=rows.find(r=>!r.classList.contains("hidden-by-pagination"));
        if(firstVisible) selectRow(firstVisible);
      }
    }
    refreshAutoTitles();
  }

  /* ====== Filtros ====== */
  function installFilters(){
    const fId=document.getElementById("f-id");
    const fEnvio=document.getElementById("f-envio");
    const fFecha=document.getElementById("f-fecha");
    const fUsuario=document.getElementById("f-usuario");
    const fEstado=document.getElementById("f-estado");

    const inputs=[fId,fEnvio,fFecha,fUsuario,fEstado].filter(Boolean);
    const norm=(s)=>(s||"").toString().trim().toLowerCase();
    const cleanAccents=(s)=>norm(s).normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    function applyFilters(){
      const idVal=cleanAccents(fId?.value);
      const envioVal=cleanAccents(fEnvio?.value);
      const fechaVal=cleanAccents(fFecha?.value);
      const usuarioVal=cleanAccents(fUsuario?.value);
      const estadoVal=cleanAccents(fEstado?.value);

      const rows=Array.from(tbody.querySelectorAll("tr")).filter(r=>!r.hasAttribute("data-empty-row"));

      rows.forEach(tr=>{
        const tds=tr.querySelectorAll("td");
        const txt=i=>cleanAccents(tds[i]?.textContent);
        const ok =
          (!idVal     || txt(0).includes(idVal)) &&
          (!envioVal  || txt(1).includes(envioVal)) &&
          (!fechaVal  || txt(2).includes(fechaVal)) &&
          (!usuarioVal|| txt(3).includes(usuarioVal)) &&
          (!estadoVal || txt(4).includes(estadoVal));
        tr.style.display = ok ? "" : "none";
      });

      currentPage=1; applyPagination();
    }
    inputs.forEach(inp=>{
      const ev=(inp.tagName==="SELECT")?"change":"input";
      inp.addEventListener(ev,applyFilters);
    });
  }

  /* ====== Cambiar Estado (modal) ====== */
  const modalEstadoEl = document.getElementById("modalEstado");
  const modalEstado   = modalEstadoEl ? new bootstrap.Modal(modalEstadoEl) : null;
  const alertEstado   = document.getElementById("estadoAlert");
  const motivoWrap    = document.getElementById("motivoWrap");
  const motivoInput   = document.getElementById("motivoEstado");

  function showErr(msg){ if(alertEstado){ alertEstado.textContent = msg; alertEstado.classList.remove("d-none"); } }
  function hideErr(){ if(alertEstado){ alertEstado.textContent=""; alertEstado.classList.add("d-none"); } }

  modalEstadoEl?.addEventListener("change", (e)=>{
    if(e.target.name === "estadoNuevo"){
      const v = document.querySelector('input[name="estadoNuevo"]:checked')?.value;
      motivoWrap?.classList.toggle("d-none", v !== "Rechazado");
    }
  });

  btnCambiarEstado?.addEventListener("click", ()=>{
    if(!selectedId || !modalEstado) return;
    hideErr();
    document.querySelectorAll('#modalEstado input[name="estadoNuevo"]').forEach(r => r.checked = false);
    if (motivoInput) motivoInput.value = "";
    motivoWrap?.classList.add("d-none");
    modalEstado.show();
  });

  document.getElementById("btnConfirmEstado")?.addEventListener("click", ()=>{
    hideErr();
    const estado = document.querySelector('input[name="estadoNuevo"]:checked')?.value;
    const motivo = (motivoInput?.value || "").trim();
    if(!estado){ showErr("Seleccione un estado."); return; }
    if(estado === "Rechazado" && !motivo){ showErr("Debe indicar un motivo para rechazar."); return; }

    const urlBase = "{% url 'recepcion:cambiar_estado' 0 %}";
    const url = urlBase.replace("0/", selectedId + "/");

    fetch(url, {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "X-Requested-With":"XMLHttpRequest",
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({ nuevo_estado: estado, motivo })
    })
    .then(r => r.json().then(j => ({ok:r.ok, data:j})))
    .then(({ok, data})=>{
      if(!ok || !data.success){ showErr(data.error || "No se pudo cambiar el estado."); return; }
      const row = tbody.querySelector(`tr[data-id="${selectedId}"]`);
      if(row){
        const td = row.querySelectorAll("td")[4];
        if(estado === "Recibido Completo") td.innerHTML = '<span class="badge bg-success badge-pill">Recibido Completo</span>';
        else if(estado === "Recibido Parcialmente") td.innerHTML = '<span class="badge bg-warning text-dark badge-pill">Recibido Parcialmente</span>';
        else td.innerHTML = '<span class="badge bg-danger badge-pill">Rechazado</span>';
      }
      modalEstado?.hide();
    })
    .catch(()=> showErr("Error de red al cambiar estado."));
  });

  /* ====== Inicializar tabla ====== */
  removeEmptyRows();
  recomputarPageSize();
  installFilters();
  applyPagination();
  refreshAutoTitles();
  window.addEventListener("resize",()=>{recomputarPageSize();applyPagination();});
});
</script>
{% endblock %}

