{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Recepciones · SAIF{% endblock %}

{% block content %}
<section class="p-6 md:p-8">
  <div class="saif-card mb-4">
    <div class="saif-card-header">
      <i class="bi bi-box-arrow-in-down"></i>
      <h3>Recepciones de Productos</h3>
    </div>

    <div class="table-wrap">
      <table class="table table-saif align-middle text-center" id="tablaRecepciones">
        <thead>
          <tr>
            <th>ID</th>
            <th>Número Envío</th>
            <th>Fecha Recepción</th>
            <th>Usuario</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for r in recepciones %}
          <tr data-id="{{ r.id }}" style="cursor:pointer;">
            <td>{{ r.id }}</td>
            <td>{{ r.numero_envio_bodega }}</td>
            <td>{{ r.fecha_recepcion|date:"d/m/Y" }}</td>
            <td>{{ r.id_usuario }}</td>
            <td>{{ r.estado_recepcion }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="py-4 text-muted">No hay recepciones registradas.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="px-3 py-3 text-center">
      <!-- CREAR -->
      <button id="btnCrear"
              class="btn btn-warning me-2"
              data-bs-toggle="modal"
              data-bs-target="#modalRecepcion"
              data-url="{% url 'recepcion:recepcion_create' %}">
        <i class="bi bi-plus-circle"></i> CREAR
      </button>

      <!-- CONSULTAR -->
      <button id="btnConsultar" class="btn btn-primary me-2" disabled>
        <i class="bi bi-search"></i> CONSULTAR
      </button>
    </div>
  </div>
</section>

<!-- Modal CREAR: contenedor donde se inyectará el form -->
<div class="modal fade" id="modalRecepcion" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" id="modal-recepcion-content"></div>
  </div>
</div>

<!-- Modal CONSULTAR: contenedor donde se inyectará el parcial _consultar.html -->
<div class="modal fade" id="modalConsultar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content" id="modal-consultar-content"></div>
  </div>
</div>

<!-- Modales auxiliares (se incluyen una sola vez en la página) -->
{% include "recepcion/partials/producto_modal.html" %}
{% include "recepcion/partials/lote_modal.html" %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  // ---------------- CREAR (carga del formulario en modal) ----------------
  const modalEl = document.getElementById("modalRecepcion");
  const modalContent = document.getElementById("modal-recepcion-content");
  const btnCrear = document.getElementById("btnCrear");
  const modalInstance = new bootstrap.Modal(modalEl);

  // Se vacía/llena cada vez que se abre el form
  let detalles = [];

  function inicializarFormulario() {
    // ----- Añadir línea al detalle -----
    const addBtn = document.getElementById("btnAddDetalle");
    if (addBtn) {
      addBtn.addEventListener("click", function () {
        const productoIdEl = document.getElementById("productoIdInput");
        const productoTextEl = document.getElementById("productoInput");
        const loteIdEl      = document.getElementById("loteIdInput");
        const loteTextEl    = document.getElementById("loteInput");
        const caducidadEl   = document.getElementById("caducidadInput");
        const cantidadEl    = document.getElementById("cantidadInput");
        const costoEl       = document.getElementById("costoInput");
        const tableBody     = document.getElementById("detalleTable");

        if (!tableBody) { console.warn("No se encontró #detalleTable"); return; }

        const productoId = (productoIdEl?.value || "").trim();
        const productoTx = (productoTextEl?.value || "").trim();
        const loteId     = (loteIdEl?.value || "").trim();     // si escogió un lote existente
        const numeroLote = (loteTextEl?.value || "").trim();   // si escribe/crea uno nuevo
        const caducidad  = caducidadEl?.value || "";
        const cantidad   = cantidadEl?.value;
        const costo      = costoEl?.value;

        if (!productoId) { alert("Seleccione un producto."); return; }
        if (!loteId && !numeroLote) { alert("Ingrese o seleccione el número de lote."); return; }
        if (!loteId && !caducidad) { alert("Para un lote nuevo, ingrese fecha de caducidad."); return; }
        if (!cantidad || parseInt(cantidad, 10) <= 0) { alert("Cantidad inválida."); return; }

        const item = {
          producto_id: parseInt(productoId, 10),
          // Para mostrar:
          producto: productoTx,
          // Para backend:
          lote_id: loteId ? parseInt(loteId, 10) : null,
          numero_lote: numeroLote || null,
          fecha_caducidad: caducidad || null,
          cantidad_recibida: parseInt(cantidad, 10),
          costo_unitario: costo ? parseFloat(costo) : 0
        };
        detalles.push(item);

        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="text-start">${item.producto}</td>
          <td>${item.numero_lote ?? ('#' + item.lote_id)}</td>
          <td>${item.fecha_caducidad ?? ''}</td>
          <td>${item.cantidad_recibida}</td>
          <td>${item.costo_unitario.toFixed(2)}</td>
          <td><button type="button" class="btn btn-sm btn-outline-danger btnRemove"><i class="bi bi-trash"></i></button></td>
        `;
        row.querySelector(".btnRemove").addEventListener("click", () => {
          row.remove();
          detalles = detalles.filter(d => d !== item);
        });
        tableBody.appendChild(row);

        // limpiar campos de la línea
        loteIdEl.value = "";
        loteTextEl.value = "";
        caducidadEl.value = "";
        cantidadEl.value = "";
        costoEl.value = "";
      });
    }

    // ----- Envío del formulario -----
    const formRecepcion = document.getElementById("form-recepcion");
    if (formRecepcion) {
      const urlCrearRecepcion = "{% url 'recepcion:recepcion_create' %}";

      formRecepcion.addEventListener("submit", function (event) {
        event.preventDefault();

        const formData = {
          numero_envio_bodega: document.getElementById("id_numero_envio_bodega")?.value || "",
          fecha_recepcion: document.getElementById("id_fecha_recepcion")?.value || ""
        };
        const comentario = document.getElementById("comentarioInput")?.value?.trim() || "";

        const payload = { form_data: formData, detalles: detalles, comentario: comentario };

        fetch(urlCrearRecepcion, {
          method: "POST",
          body: JSON.stringify(payload),
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
            "X-Requested-With": "XMLHttpRequest",
          },
        })
        .then(response => {
          if (!response.ok) {
            return response.json().then(errorData => {
              console.error("Error del servidor:", errorData);
              alert("Error: " + (errorData.errors || "Ocurrió un error inesperado."));
              throw new Error("HTTP error: " + response.status);
            });
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            alert("Recepción creada exitosamente.");
            window.location.reload();
          } else {
            console.error("Errores de validación:", data.errors);
            alert("Error de validación: " + JSON.stringify(data.errors));
          }
        })
        .catch(error => {
          console.error("Error en la solicitud:", error);
          alert("Error en la solicitud: " + error.message);
        });
      });
    }
  }

  // Abrir modal y cargar el form por AJAX
  btnCrear.addEventListener("click", function () {
    const url = this.getAttribute("data-url");
    modalContent.innerHTML = '<div class="p-4">Cargando...</div>';
    modalInstance.show();

    fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
      .then(r => r.text())
      .then(html => {
        modalContent.innerHTML = html;
        inicializarFormulario();
      })
      .catch(() => {
        modalContent.innerHTML = '<div class="p-4 text-danger">Error cargando el formulario.</div>';
      });
  });

  // ----------- Auxiliares: búsqueda de productos y lotes -----------
  const modalBuscar     = document.getElementById("modalBuscarProducto");
  const searchInput     = document.getElementById("searchProducto");
  const tbodyResultados = document.getElementById("tablaBuscarProductos");

  const modalLote       = document.getElementById("modalBuscarLote");
  const searchLoteInput = document.getElementById("searchLote");
  const tablaLotes      = document.getElementById("tablaBuscarLotes");

  // Autocomplete de productos
  modalBuscar.addEventListener("shown.bs.modal", () => {
    const productoInput   = document.querySelector("#modalRecepcion #productoInput");
    const productoIdInput = document.querySelector("#modalRecepcion #productoIdInput");
    searchInput.value = "";
    tbodyResultados.innerHTML = "";
    searchInput.focus();

    searchInput.oninput = function () {
      const term = this.value;
      fetch("{% url 'recepcion:search_productos' %}?term=" + encodeURIComponent(term))
        .then(r => r.json())
        .then(data => {
          tbodyResultados.innerHTML = "";
          data.forEach(p => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${p.codigo}</td>
              <td>${p.nombre}</td>
              <td>${p.descripcion ?? ""}</td>
              <td>${p.presentacion ?? ""}</td>
              <td>${p.unidad ?? ""}</td>
              <td>${p.condicion ?? ""}</td>
              <td>${p.receta ? "Sí" : "No"}</td>
              <td>${p.controlado ? "Sí" : "No"}</td>
              <td><button type="button" class="btn btn-sm btn-success">✔</button></td>
            `;
            tr.querySelector("button").addEventListener("click", () => {
              if (productoInput) productoInput.value = `${p.codigo} - ${p.nombre}`;
              if (productoIdInput) productoIdInput.value = p.id;
              bootstrap.Modal.getInstance(modalBuscar).hide();
              bootstrap.Modal.getOrCreateInstance(modalEl).show();
            });
            tbodyResultados.appendChild(tr);
          });
        })
        .catch(() => {
          tbodyResultados.innerHTML = `<tr><td colspan="9" class="text-danger">Error buscando productos.</td></tr>`;
        });
    };
  });

  modalBuscar.addEventListener("hidden.bs.modal", () => {
    tbodyResultados.innerHTML = "";
    searchInput.value = "";
  });

  // Helpers lotes
  function lotesUrl(productoId, term) {
    const base = "{% url 'recepcion:search_lotes' 0 %}".replace("0/", productoId + "/");
    const q = term ? "?term=" + encodeURIComponent(term) : "";
    return base + q;
  }
  function renderLotes(rows) {
    if (!rows || rows.length === 0) {
      tablaLotes.innerHTML = `<tr><td colspan="4" class="text-muted">Sin lotes para este producto.</td></tr>`;
      return;
    }
    tablaLotes.innerHTML = "";
    rows.forEach(l => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${l.numero_lote}</td>
        <td>${l.fecha_caducidad || ""}</td>
        <td>${l.cantidad}</td>
        <td><button type="button" class="btn btn-sm btn-success">✔</button></td>
      `;
      tr.querySelector("button").addEventListener("click", () => {
        document.getElementById("loteInput").value = l.numero_lote;
        document.getElementById("caducidadInput").value = l.fecha_caducidad || "";
        const loteIdHidden = document.getElementById("loteIdInput");
        if (loteIdHidden) loteIdHidden.value = l.id;
        bootstrap.Modal.getInstance(modalLote).hide();
        bootstrap.Modal.getOrCreateInstance(document.getElementById("modalRecepcion")).show();
        document.getElementById("cantidadInput")?.focus();
      });
      tablaLotes.appendChild(tr);
    });
  }
  function loadLotes(term = "") {
    const productoId = document.getElementById("productoIdInput")?.value;
    if (!productoId) {
      tablaLotes.innerHTML = `<tr><td colspan="4" class="text-danger">Primero seleccione un producto.</td></tr>`;
      return;
    }
    tablaLotes.innerHTML = `<tr><td colspan="4" class="text-muted">Cargando...</td></tr>`;
    fetch(lotesUrl(productoId, term))
      .then(r => r.json())
      .then(renderLotes)
      .catch(() => {
        tablaLotes.innerHTML = `<tr><td colspan="4" class="text-danger">Error cargando lotes.</td></tr>`;
      });
  }
  modalLote.addEventListener("shown.bs.modal", () => {
    searchLoteInput.value = "";
    loadLotes("");
    searchLoteInput.oninput = () => loadLotes(searchLoteInput.value);
  });

  // Crear lote rápido
  const modalCrearLote = document.getElementById("modalCrearLote");
  const btnGuardarLote = document.getElementById("btnGuardarLote");
  if (btnGuardarLote) {
    btnGuardarLote.addEventListener("click", () => {
      const productoId = document.getElementById("productoIdInput").value;
      const numero = document.getElementById("numeroLote").value;
      const caducidad = document.getElementById("fechaCaducidad").value;
      const ubicacion = document.getElementById("ubicacionAlmacen").value;
      if (!productoId) { alert("Primero debe seleccionar un producto."); return; }

      fetch("{% url 'recepcion:create_lote' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          producto_id: productoId,
          numero_lote: numero,
          fecha_caducidad: caducidad,
          ubicacion: ubicacion
        })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          bootstrap.Modal.getInstance(modalCrearLote).hide();
          bootstrap.Modal.getOrCreateInstance(modalLote).show();
          loadLotes("");
          // Pre-cargar en el form principal
          document.getElementById("loteInput").value = data.numero_lote;
          document.getElementById("caducidadInput").value = data.fecha_caducidad || "";
          document.getElementById("loteIdInput").value = data.id;
        } else {
          alert(data.error || "Error al crear el lote.");
        }
      });
    });
  }

  // Botones cerrar auxiliares
  document.getElementById("btnCancelarLote")?.addEventListener("click", () => {
    bootstrap.Modal.getInstance(modalCrearLote).hide();
    bootstrap.Modal.getOrCreateInstance(modalLote).show();
  });
  document.getElementById("btnCerrarProducto")?.addEventListener("click", () => {
    bootstrap.Modal.getInstance(modalBuscar)?.hide();
    bootstrap.Modal.getOrCreateInstance(modalEl).show();
  });
  document.getElementById("btnCerrarLote")?.addEventListener("click", () => {
    bootstrap.Modal.getInstance(modalLote).hide();
    bootstrap.Modal.getOrCreateInstance(document.getElementById("modalRecepcion")).show();
  });

  // ---------------- CONSULTAR (selección + modal) ----------------
  const tbody = document.querySelector("#tablaRecepciones tbody");
  const btnConsultar = document.getElementById("btnConsultar");
  let selectedId = null;
  let selectedTr = null;

  // Selección de fila
  tbody.addEventListener("click", (e) => {
    const tr = e.target.closest("tr");
    if (!tr) return;
    if (selectedTr) selectedTr.classList.remove("table-active");
    selectedTr = tr;
    tr.classList.add("table-active");
    selectedId = tr.dataset.id;
    btnConsultar.disabled = !selectedId;
  });

  // Abrir modal de consulta
  btnConsultar.addEventListener("click", () => {
    if (!selectedId) return;

    const urlBase = "{% url 'recepcion:recepcion_detail' 0 %}";
    const url = urlBase.replace("0/", selectedId + "/");

    const modalConsultar = new bootstrap.Modal(document.getElementById("modalConsultar"));
    const container = document.getElementById("modal-consultar-content");
    container.innerHTML = '<div class="p-4">Cargando...</div>';

    fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
      .then(r => r.text())
      .then(html => {
        container.innerHTML = html;
        modalConsultar.show();
      })
      .catch(() => {
        container.innerHTML = '<div class="p-4 text-danger">No se pudo cargar la recepción.</div>';
        modalConsultar.show();
      });
  });
});
</script>
{% endblock %}
