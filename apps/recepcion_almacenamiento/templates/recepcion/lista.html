{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Recepciones ¬∑ SAIF{% endblock %}

{% block content %}
<section class="p-6 md:p-8">
  <div class="saif-card mb-4">
    <div class="saif-card-header">
      <i class="bi bi-box-arrow-in-down"></i>
      <h3>Recepciones de Productos</h3>
    </div>

    <div class="table-wrap">
      <table class="table table-saif align-middle text-center" id="tablaRecepciones">
        <thead>
          <tr>
            <th>ID</th>
            <th>N√∫mero Env√≠o</th>
            <th>Fecha Recepci√≥n</th>
            <th>Usuario</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for r in recepciones %}
          <tr data-id="{{ r.id }}">
            <td>{{ r.id }}</td>
            <td>{{ r.numero_envio_bodega }}</td>
            <td>{{ r.fecha_recepcion|date:"d/m/Y" }}</td>
            <td>{{ r.id_usuario }}</td>
            <td>{{ r.estado_recepcion }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="py-4 text-muted">No hay recepciones registradas.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="px-3 py-3 text-center">
      <button id="btnCrear" class="btn btn-warning me-2" data-bs-toggle="modal"
              data-bs-target="#modalRecepcion" data-url="{% url 'recepcion:crear' %}">
        <i class="bi bi-plus-circle"></i> CREAR
      </button>
      <button id="btnConsultar" class="btn btn-primary me-2" disabled>
        <i class="bi bi-search"></i> CONSULTAR
      </button>
    </div>
  </div>
</section>

<!-- Modal principal -->
<div class="modal fade" id="modalRecepcion" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" id="modal-recepcion-content"></div>
  </div>
</div>

<!-- Incluimos el modal de productos -->
{% include "recepcion/partials/producto_modal.html" %}
<!-- Incluimos el modal de lotes -->
{% include "recepcion/partials/lote_modal.html" %}

{% endblock %} {# <- cierre de block content #}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const modalEl       = document.getElementById("modalRecepcion");
  const modalContent  = document.getElementById("modal-recepcion-content");
  const btnCrear      = document.getElementById("btnCrear");
  const modalInstance = new bootstrap.Modal(modalEl);

  // Cargar el form de creaci√≥n por AJAX
  btnCrear.addEventListener("click", function () {
    const url = btnCrear.getAttribute("data-url");
    modalContent.innerHTML = '<div class="p-4">Cargando...</div>';
    modalInstance.show();

    fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
      .then(r => r.text())
      .then(html => { modalContent.innerHTML = html; })
      .catch(() => {
        modalContent.innerHTML = '<div class="p-4 text-danger">Error cargando el formulario.</div>';
      });
  });

  // Modal de b√∫squeda de productos
  const modalBuscar     = document.getElementById("modalBuscarProducto");
  const searchInput     = document.getElementById("searchProducto");
  const tbodyResultados = document.getElementById("tablaBuscarProductos");

  modalBuscar.addEventListener("shown.bs.modal", () => {
    const productoInput   = document.querySelector("#modalRecepcion #productoInput");
    const productoIdInput = document.querySelector("#modalRecepcion #productoIdInput");

    searchInput.value = "";
    tbodyResultados.innerHTML = "";
    searchInput.focus();

    searchInput.oninput = function() {
      const term = this.value;
      fetch("{% url 'recepcion:search_productos' %}?term=" + encodeURIComponent(term))
        .then(r => r.json())
        .then(data => {
          tbodyResultados.innerHTML = "";
          data.forEach(p => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${p.codigo}</td>
              <td>${p.nombre}</td>
              <td>${p.descripcion ?? ""}</td>
              <td>${p.presentacion ?? ""}</td>
              <td>${p.unidad ?? ""}</td>
              <td>${p.condicion ?? ""}</td>
              <td>${p.receta ? "S√≠" : "No"}</td>
              <td>${p.controlado ? "S√≠" : "No"}</td>
              <td><button type="button" class="btn btn-sm btn-success">‚úî</button></td>
            `;
            tr.querySelector("button").addEventListener("click", () => {
              if (productoInput)   productoInput.value   = `${p.codigo} - ${p.nombre}`;
              if (productoIdInput) productoIdInput.value = p.id;

              const buscarInst = bootstrap.Modal.getInstance(modalBuscar);
              buscarInst.hide();

              const recepInst = bootstrap.Modal.getOrCreateInstance(modalEl);
              recepInst.show();
            });
            tbodyResultados.appendChild(tr);
          });
        })
        .catch(() => {
          tbodyResultados.innerHTML = `<tr><td colspan="9" class="text-danger">Error buscando productos.</td></tr>`;
        });
    };
  });

  modalBuscar.addEventListener("hidden.bs.modal", () => {
    tbodyResultados.innerHTML = "";
    searchInput.value = "";
  });

  
});

// -----------------------------
//  Modal de b√∫squeda de lotes
// -----------------------------
 const modalLote        = document.getElementById("modalBuscarLote");
  const searchLoteInput  = document.getElementById("searchLote");
  const tablaLotes       = document.getElementById("tablaBuscarLotes");
  const loteInput        = document.getElementById("loteInput");
  const caducidadInput   = document.getElementById("caducidadInput");

  // helper: arma la URL /lotes/<producto_id>/search/?term=...
  function lotesUrl(productoId, term) {
    // base con producto_id=0 para usar reverse y luego reemplazar el 0
    const base = "{% url 'recepcion:search_lotes' 0 %}".replace("0/", productoId + "/");
    const q = term ? "?term=" + encodeURIComponent(term) : "?term=";
    return base + q;
  }

  function renderLotes(rows) {
  if (!rows || rows.length === 0) {
    tablaLotes.innerHTML = `<tr><td colspan="4" class="text-muted">Sin lotes para este producto.</td></tr>`;
    return;
  }
  tablaLotes.innerHTML = "";
  rows.forEach(l => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${l.numero_lote}</td>
      <td>${l.fecha_caducidad || ""}</td>
      <td>${l.cantidad}</td>
      <td><button type="button" class="btn btn-sm btn-success">‚úî</button></td>
    `;

    // üîó Acci√≥n al seleccionar el lote
    tr.querySelector("button").addEventListener("click", () => {
      // rellenamos campos del form principal
      document.getElementById("loteInput").value     = l.numero_lote;
      document.getElementById("caducidadInput").value = l.fecha_caducidad || "";
      const loteIdHidden = document.getElementById("loteIdInput");
      if (loteIdHidden) loteIdHidden.value = l.id;

      // cerramos solo el modal de lotes
      bootstrap.Modal.getInstance(modalLote).hide();

      // reabrimos modal de recepci√≥n
      const recepInst = bootstrap.Modal.getOrCreateInstance(
        document.getElementById("modalRecepcion")
      );
      recepInst.show();

      // foco al campo cantidad (flujo natural)
      document.getElementById("cantidadInput")?.focus();
    });

    tablaLotes.appendChild(tr);
  });
}


  function loadLotes(term = "") {
    const productoId = document.getElementById("productoIdInput")?.value;
    if (!productoId) {
      tablaLotes.innerHTML = `<tr><td colspan="4" class="text-danger">Primero seleccione un producto.</td></tr>`;
      return;
    }
    tablaLotes.innerHTML = `<tr><td colspan="4" class="text-muted">Cargando...</td></tr>`;
    fetch(lotesUrl(productoId, term))
      .then(r => r.json())
      .then(renderLotes)
      .catch(() => {
        tablaLotes.innerHTML = `<tr><td colspan="4" class="text-danger">Error cargando lotes.</td></tr>`;
      });
  }

  // Al mostrar el modal ‚Üí carga lotes del producto (sin filtro)
  modalLote.addEventListener("shown.bs.modal", () => {
    searchLoteInput.value = "";
    loadLotes("");               // ‚úÖ carga inicial
    // Buscar mientras escribe
    searchLoteInput.oninput = () => loadLotes(searchLoteInput.value);
  });



// -----------------------------
//  Crear lote manualmente
// -----------------------------
const modalCrearLote  = document.getElementById("modalCrearLote");
const btnGuardarLote  = document.getElementById("btnGuardarLote");

if (btnGuardarLote) {
  btnGuardarLote.addEventListener("click", () => {
    const productoId = document.getElementById("productoIdInput").value;
    const numero     = document.getElementById("numeroLote").value;
    const caducidad  = document.getElementById("fechaCaducidad").value;
    const ubicacion  = document.getElementById("ubicacionAlmacen").value;

    if (!productoId) {
      alert("Primero debe seleccionar un producto.");
      return;
    }

    fetch("{% url 'recepcion:create_lote' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        producto_id: productoId,
        numero_lote: numero,
        fecha_caducidad: caducidad,
        ubicacion: ubicacion
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        // Cerrar SOLO el modal de crear lote
        bootstrap.Modal.getInstance(modalCrearLote).hide();

        // Volver a mostrar modal de b√∫squeda
        const buscarInst = bootstrap.Modal.getOrCreateInstance(modalLote);
        buscarInst.show();

        // recarga y adem√°s selecciona el lote reci√©n creado en el form principal
        loadLotes("");
        loteInput.value = data.numero_lote;
        caducidadInput.value = data.fecha_caducidad || "";

      } else {
        alert(data.error || "Error al crear el lote.");
      }
    });
  });
}

const btnCancelarLote = document.getElementById("btnCancelarLote");

if (btnCancelarLote) {
  btnCancelarLote.addEventListener("click", () => {
    // Cierra SOLO modalCrearLote
    bootstrap.Modal.getInstance(modalCrearLote).hide();

    // Vuelve a mostrar modalBuscarLote
    const buscarInst = bootstrap.Modal.getOrCreateInstance(modalLote);
    buscarInst.show();
  });
}

const btnCerrarProducto = document.getElementById("btnCerrarProducto");

document.addEventListener("DOMContentLoaded", function () {
  const modalBuscar     = document.getElementById("modalBuscarProducto");
  const modalRecepcion  = document.getElementById("modalRecepcion");
  const btnCerrarProducto = document.getElementById("btnCerrarProducto");

  if (btnCerrarProducto) {
    btnCerrarProducto.addEventListener("click", () => {
      // Cierra SOLO el modal de productos
      bootstrap.Modal.getInstance(modalBuscar)?.hide();

      // Reabre el modal de recepci√≥n
      const recepInst = bootstrap.Modal.getOrCreateInstance(modalRecepcion);
      recepInst.show();
    });
  }
});


const btnCerrarLote = document.getElementById("btnCerrarLote");

if (btnCerrarLote) {
  btnCerrarLote.addEventListener("click", () => {
    // Cierra SOLO el modal de lotes
    bootstrap.Modal.getInstance(modalLote).hide();

    // Reabre modal de recepci√≥n
    const recepInst = bootstrap.Modal.getOrCreateInstance(
      document.getElementById("modalRecepcion")
    );
    recepInst.show();
  });
}
  

// -----------------------------
//  A√±adir detalle a la tabla temporal
// -----------------------------
let detalles = [];  // vive mientras est√© abierto el modal

document.addEventListener("click", function (ev) {
  // Soporta clicks sobre el <i> dentro del bot√≥n
  const addBtn = ev.target.closest("#btnAddDetalle");
  if (!addBtn) return;

  // Buscar elementos *ahora* (el form lleg√≥ por AJAX)
  const productoIdEl   = document.getElementById("productoIdInput");
  const productoTextEl = document.getElementById("productoInput");
  const loteIdEl       = document.getElementById("loteIdInput");
  const loteTextEl     = document.getElementById("loteInput");
  const caducidadEl    = document.getElementById("caducidadInput");
  const cantidadEl     = document.getElementById("cantidadInput");
  const costoEl        = document.getElementById("costoInput");
  const tableBody      = document.getElementById("detalleTable");

  if (!tableBody) { console.warn("No se encontr√≥ #detalleTable"); return; }

  const productoId   = productoIdEl?.value.trim();
  const productoText = productoTextEl?.value.trim();
  const loteId       = loteIdEl?.value.trim();
  const loteText     = loteTextEl?.value.trim();
  const caducidad    = caducidadEl?.value || "";
  const cantidad     = cantidadEl?.value;
  const costo        = costoEl?.value;

  if (!productoId || !loteId || !cantidad || !costo) {
    alert("Debe seleccionar producto, lote y llenar cantidad/costo.");
    return;
  }

  const item = {
    producto_id: productoId,
    producto: productoText,
    lote_id: loteId,
    lote: loteText,
    fecha_caducidad: caducidad,
    cantidad: parseInt(cantidad, 10),
    costo: parseFloat(costo),
  };
  detalles.push(item);

  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${item.producto}</td>
    <td>${item.lote}</td>
    <td>${item.fecha_caducidad || ""}</td>
    <td>${item.cantidad}</td>
    <td>${item.costo.toFixed(2)}</td>
    <td><button type="button" class="btn btn-sm btn-danger btnRemove">‚úñ</button></td>
  `;

  row.querySelector(".btnRemove").addEventListener("click", () => {
    row.remove();
    detalles = detalles.filter(d => d !== item);
  });

  tableBody.appendChild(row);

  // Limpia para capturar otro lote del mismo producto (dejamos el producto tal cual)
  loteIdEl.value = "";
  loteTextEl.value = "";
  caducidadEl.value = "";
  cantidadEl.value = "";
  costoEl.value = "";
});


</script>
{% endblock %}
