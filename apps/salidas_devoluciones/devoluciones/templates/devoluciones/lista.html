{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Devoluciones · SAIF{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'lista/lista.css' %}">

<style>
/* ====== Contenedor y tabla: mismo look & feel que Productos/Ventas ====== */
.table-container{ overflow-x:auto; width:100%; scroll-padding-top:90px; }

#tablaDevoluciones{
  table-layout:fixed; width:100%; min-width:1200px;
  border-collapse:separate; border-spacing:0;
  outline:1px solid #e3e6ea; outline-offset:-1px; border-radius:.5rem; margin-bottom:0;
}

#tablaDevoluciones th,#tablaDevoluciones td{
  overflow:hidden; white-space:nowrap; text-overflow:ellipsis; vertical-align:middle;
  padding:.5rem; font-size:.875rem; background-clip:padding-box; border:1px solid #e3e6ea;
}

#tablaDevoluciones tbody tr{ background:#ffffff; }
#tablaDevoluciones tbody tr:hover{ background:#fafafa; }

#tablaDevoluciones thead.sticky-top{ position:sticky; top:0; z-index:10; box-shadow:0 2px 4px rgba(0,0,0,.06); }
#tablaDevoluciones thead.sticky-top tr:first-child th{ position:sticky; top:0; z-index:11; background:#e8f5ec; border-bottom:1px solid #d7dbdf; }
#tablaDevoluciones thead.sticky-top tr.filter-row th{
  position:sticky; top:42px; z-index:10; background:#f4fbf6;
  border-top:1px solid #d9f3e0; border-bottom:1px solid #d7dbdf; box-shadow:0 2px 3px rgba(0,0,0,.04) inset;
  padding:.35rem .5rem; overflow:visible;
}

thead .form-control-sm, thead .form-select-sm{ padding-top:.25rem; padding-bottom:.25rem; height:28px; }
.filter-control{ width:100%; height:32px; padding:.25rem .5rem; border:1px solid #cfe9d7; background:#fff; border-radius:.5rem; transition:border-color .15s, box-shadow .15s; font-size:.85rem; box-sizing:border-box; }
.filter-control::placeholder{ color:#94a3b8; }
.filter-control.text-center{ text-align:center; }
.filter-control:focus{ border-color:#62c07b; outline:0; box-shadow:0 0 0 .15rem rgba(34,197,94,.15); }
select.filter-control{ padding-right:1.75rem; appearance:none; min-width:100px; }
#tablaDevoluciones thead.sticky-top tr.filter-row th .filter-wrap{ display:flex; justify-content:center; }
#tablaDevoluciones thead.sticky-top tr.filter-row th .filter-wrap>select{ width:100%; max-width:100%; }
#tablaDevoluciones thead.sticky-top tr.filter-row th select.form-select.filter-control{ -moz-text-align-last:center !important; text-align-last:center !important; text-align:center !important; }

/* Mínimos por columna */
#tablaDevoluciones thead .filter-row th{ min-width:100px; }
#tablaDevoluciones thead .filter-row th:nth-child(1){ min-width:140px; } /* No. Factura */
#tablaDevoluciones thead .filter-row th:nth-child(2){ min-width:160px; } /* Fecha */
#tablaDevoluciones thead .filter-row th:nth-child(4){ min-width:120px; } /* Estado */

.wp-16{width:16%}.wp-22{width:22%}.wp-34{width:34%}.wp-12{width:12%}
.hidden-by-pagination{ display:none !important; }

#tablaDevoluciones thead tr:first-child th{ border-top:0; }
#tablaDevoluciones tbody tr:last-child td{ border-bottom:0; }
#tablaDevoluciones tr>*:first-child{ border-left:0; }
#tablaDevoluciones tr>*:last-child{  border-right:0; }
#tablaDevoluciones tbody tr.last-visible td{ border-bottom:0 !important; }

/* Selección */
#tablaDevoluciones tr.selected, #tablaDevoluciones tr.table-active { background-color: rgba(25,135,84,.12); }
#tablaDevoluciones tr { cursor: pointer; }
</style>

<style>
.saif-modal--danger{
  border:0;
  border-radius:18px;
  overflow:hidden;
  box-shadow:0 18px 45px rgba(190,18,60,.22);
  font-family:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
}
.saif-modal--danger .modal-header{
  background:linear-gradient(135deg,#dc2626 0%,#b91c1c 55%,#991b1b 100%);
  color:#fff;
  border-bottom:0;
  padding:1rem 1.25rem;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:1rem;
}
.saif-modal--danger .saif-modal-title{
  display:flex;
  align-items:center;
  gap:.75rem;
  font-weight:700;
  letter-spacing:.02em;
}
.saif-modal--danger .saif-modal-icon{
  width:42px;
  height:42px;
  border-radius:12px;
  background:rgba(255,255,255,.2);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:1.25rem;
}
.saif-modal--danger .saif-modal-body{
  background:linear-gradient(180deg,#fff5f5 0%,#fee2e2 100%);
  padding:1.4rem 1.5rem;
}
.saif-modal--danger .saif-confirm-card{
  background:#fff;
  border:1px solid rgba(252,165,165,.6);
  border-radius:1rem;
  box-shadow:0 16px 32px rgba(220,38,38,.18);
  padding:1.15rem 1.25rem;
  color:#7f1d1d;
}
.saif-modal--danger .saif-confirm-text{
  font-size:1rem;
  line-height:1.55;
  margin:0;
}
.saif-alert{
  padding:.85rem 1.1rem;
  border-radius:.85rem;
  font-weight:600;
}
.saif-alert--error{
  background:rgba(254,202,202,.35);
  border:1px solid rgba(239,68,68,.65);
  color:#7f1d1d;
}
.saif-footer{
  background:linear-gradient(145deg,#fef2f2 0%,#fee2e2 100%);
  border-top:0;
  padding:.9rem 1.3rem;
  display:flex;
  justify-content:flex-end;
  gap:.75rem;
}
.saif-btn-light{
  background:#fff;
  border:1px solid rgba(148,163,184,.45);
  color:#334155;
  font-weight:600;
  border-radius:999px;
  padding:.45rem 1.25rem;
}
.saif-btn-light:hover{
  background:#f8fafc;
  border-color:#94a3b8;
  color:#1e293b;
}
.saif-btn-danger{
  background:#dc2626;
  border-color:#dc2626;
  color:#fff;
  font-weight:600;
  border-radius:999px;
  padding:.45rem 1.35rem;
}
.saif-btn-danger:hover{
  background:#b91c1c;
  border-color:#b91c1c;
  color:#fff;
}
</style>

<section class="p-6 md:p-8">
  <div class="saif-card mb-4 shadow-lg rounded-3 overflow-hidden">
    <div class="saif-card-header d-flex align-items-center justify-content-between bg-success text-white px-3 py-2">
      <h3 class="mb-0 fs-6"><i class="bi bi-arrow-counterclockwise me-2"></i> Devoluciones registradas</h3>
      <span class="badge bg-light text-success px-2 py-1 fs-7">SAIF</span>
    </div>

    <div class="table-container">
      <table class="table table-hover align-middle text-center" id="tablaDevoluciones">
        <colgroup>
          <col class="wp-16"><!-- No. Factura -->
          <col class="wp-22"><!-- Fecha -->
          <col class="wp-34"><!-- Usuario -->
          <col class="wp-12"><!-- Estado -->
        </colgroup>
        <thead class="table-success text-dark shadow-sm sticky-top">
          <tr>
            <th>No. Factura</th>
            <th>Fecha</th>
            <th>Usuario</th>
            <th>Estado</th>
          </tr>
          <tr class="filter-row">
            <th><input id="f-ref" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-fecha" class="form-control form-control-sm filter-control text-center" placeholder="dd/mm/aaaa"></th>
            <th><input id="f-usuario" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th>
              <div class="filter-wrap">
                <select id="f-estado" class="form-select form-select-sm filter-control text-center">
                  <option value="">Todos</option>
                  <option value="completado">Completado</option>
                  <option value="cancelado">Cancelado</option>
                </select>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          {% for d in devoluciones %}
          <tr data-ref="{{ d.referencia_transaccion }}" data-estado="{{ d.estado }}">
            <td class="fw-semibold text-truncate">{{ d.referencia_transaccion }}</td>
            <td class="text-truncate">{{ d.fecha|date:"d/m/Y H:i" }}</td>
            <td class="text-truncate">{{ d.usuario }}</td>
            <td class="text-truncate">{{ d.estado }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="py-5 text-muted" data-empty-row>
              <i class="bi bi-inbox fs-3 d-block mb-2"></i>
              Sin devoluciones.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="pagerDevoluciones" class="saif-pager"></div>

    <div class="px-3 py-3 text-center border-top bg-light">
      <button id="btnCrear" class="btn btn-warning rounded-pill px-3 me-2 shadow-sm"
              data-bs-toggle="modal"
              data-bs-target="#modalDevolucion"
              data-url="{% url 'sd:devoluciones:create' %}">
        <i class="bi bi-plus-circle"></i> CREAR
      </button>
      <button id="btnConsultar" class="btn btn-primary rounded-pill px-3 shadow-sm" disabled>
        <i class="bi bi-search"></i> CONSULTAR
      </button>
      <button id="btnCancelar" class="btn btn-outline-danger rounded-pill px-3 ms-2 shadow-sm" disabled>
        <i class="bi bi-x-octagon"></i> CANCELAR
      </button>
    </div>
  </div>
</section>

<!-- Modal principal -->
<div class="modal fade" id="modalDevolucion" tabindex="-1" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" id="modal-devolucion-content"></div>
  </div>
</div>

<!-- Modal: Confirmar cancelación de devolución -->
<div class="modal fade" id="cancelDevModal" tabindex="-1" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content saif-modal saif-modal--danger">
      <div class="modal-header">
        <div class="saif-modal-title">
          <span class="saif-modal-icon"><i class="bi bi-x-octagon"></i></span>
          <span>Cancelar devolución</span>
        </div>
        <span class="saif-badge">SAIF</span>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body saif-modal-body">
        <div id="cancelDevAlert" class="saif-alert saif-alert--error d-none" role="alert"></div>
        <div class="saif-confirm-card">
          <p class="saif-confirm-text">
            ¿Seguro que deseas <strong>cancelar</strong> la devolución
            <span class="text-danger fw-semibold" id="cancelDevRef"></span>?<br>
            Esta acción <u>revertirá</u> el inventario previamente devuelto.
          </p>
        </div>
      </div>
      <div class="modal-footer saif-footer">
        <button type="button" class="btn saif-btn-light" data-bs-dismiss="modal">
          <i class="bi bi-arrow-left"></i> Volver
        </button>
        <button type="button" class="btn saif-btn-danger" id="btnConfirmCancelDev">
          <i class="bi bi-x-octagon"></i> Cancelar devolución
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Reutilizamos modal de productos -->
{% include "recepcion/partials/producto_modal.html" %}
<!-- Solo el modal de lotes de DEVOLUCIONES -->
{% include "devoluciones/partials/lote_modal.html" %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  /* ====== Referencias originales (sin cambiar tu flujo) ====== */
  const table = document.getElementById("tablaDevoluciones");
  const tbody = table.querySelector("tbody");
  const btnConsultar = document.getElementById("btnConsultar");
  const btnCrear = document.getElementById("btnCrear");

  const modalEl = document.getElementById("modalDevolucion");
  const modalContent = document.getElementById("modal-devolucion-content");
  const modalInstance = new bootstrap.Modal(modalEl);

  let selectedRef = null;

  /* ====== Orden: más antigua → más reciente (tu IIFE original) ====== */
  (function ordenarAsc(){
    const filas = Array.from(tbody.querySelectorAll("tr[data-ref]"));
    if (filas.length > 1) filas.reverse().forEach(tr => tbody.appendChild(tr));
  })();

  /* ====== Selección de fila (igual que tenías) ====== */
  table.addEventListener("click", (e) => {
    const tr = e.target.closest("tr[data-ref]");
    if (!tr) return;
    table.querySelectorAll("tr.selected, tr.table-active").forEach(r => r.classList.remove("selected","table-active"));
    tr.classList.add("selected","table-active");
    selectedRef = tr.getAttribute("data-ref");
    btnConsultar.disabled = !selectedRef;
  });

  const btnCancelar = document.getElementById("btnCancelar");

  // Al seleccionar fila, habilita/inhabilita según estado
  table.addEventListener("click", (e) => {
    const tr = e.target.closest("tr[data-ref]");
    if (!tr) return;

    // ... lo que ya tienes ...
    const estadoTxt = (tr.getAttribute("data-estado") || tr.cells[3]?.textContent || "").toLowerCase();
    btnCancelar.disabled = !selectedRef || estadoTxt.includes("cancelado"); // solo si no está cancelada
  });
  // ====== Cancelación con modal (devoluciones) ======
  const cancelDevModalEl = document.getElementById("cancelDevModal");
  const cancelDevModal = new bootstrap.Modal(cancelDevModalEl, { backdrop: 'static', keyboard: false });
  const cancelDevRefEl = document.getElementById("cancelDevRef");
  const cancelDevAlert = document.getElementById("cancelDevAlert");
  const btnConfirmCancelDev = document.getElementById("btnConfirmCancelDev");

  function showCancelDevAlert(msg){
    cancelDevAlert.textContent = Array.isArray(msg) ? msg.join("\n") : String(msg || "Error");
    cancelDevAlert.classList.remove("d-none");
  }
  function hideCancelDevAlert(){
    cancelDevAlert.classList.add("d-none");
    cancelDevAlert.textContent = "";
  }
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return "";
  }

  // Habilitar/inhabilitar CANCELAR según estado de la fila
  table.addEventListener("click", (e) => {
    const tr = e.target.closest("tr[data-ref]");
    if (!tr) return;
    const estadoTxt = (tr.getAttribute("data-estado") || tr.cells[3]?.textContent || "").toLowerCase();
    btnCancelar.disabled = !selectedRef || estadoTxt.includes("cancelado");
  });

  // Abrir modal
  btnCancelar.addEventListener("click", () => {
    if (!selectedRef) return;
    hideCancelDevAlert();
    cancelDevRefEl.textContent = `'${selectedRef}'`;
    btnConfirmCancelDev.disabled = false;
    btnConfirmCancelDev.innerHTML = '<i class="bi bi-x-octagon"></i> Cancelar devolución';
    btnConfirmCancelDev.dataset.ref = selectedRef;
    cancelDevModal.show();
  });

  // Reset al cerrar (X o Volver)
  cancelDevModalEl.addEventListener('hidden.bs.modal', () => {
    hideCancelDevAlert();
    cancelDevRefEl.textContent = '';
    btnConfirmCancelDev.disabled = false;
    btnConfirmCancelDev.removeAttribute('data-ref');
    btnConfirmCancelDev.innerHTML = '<i class="bi bi-x-octagon"></i> Cancelar devolución';
  });

  // Confirmar (POST)
  btnConfirmCancelDev.addEventListener("click", async () => {
    const ref = btnConfirmCancelDev.dataset.ref;
    if (!ref) return;

    hideCancelDevAlert();
    btnConfirmCancelDev.disabled = true;
    btnConfirmCancelDev.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Cancelando...';

    try {
      const resp = await fetch("{% url 'sd:devoluciones:cancel' 'REF' %}".replace("REF", encodeURIComponent(ref)), {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": (document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken'))
        }
      });
      const data = await resp.json().catch(() => ({}));

      if (!resp.ok || !data.success) {
        showCancelDevAlert(data?.errors || "No se pudo cancelar la devolución.");
        btnConfirmCancelDev.disabled = false;
        btnConfirmCancelDev.innerHTML = '<i class="bi bi-x-octagon"></i> Cancelar devolución';
        return;
      }

      cancelDevModal.hide();
      window.location.reload();
    } catch (e) {
      showCancelDevAlert("Error de red al cancelar la devolución.");
      btnConfirmCancelDev.disabled = false;
      btnConfirmCancelDev.innerHTML = '<i class="bi bi-x-octagon"></i> Cancelar devolución';
    }
  });

  /* ====== Abrir modal CREAR (misma ruta y comportamiento) ====== */
  btnCrear.addEventListener("click", function () {
    modalContent.innerHTML = "<div class='p-4'>Cargando...</div>";
    modalInstance.show();
    fetch(this.dataset.url, { headers: {"X-Requested-With":"XMLHttpRequest"} })
      .then(r => r.text())
      .then(html => {
        modalContent.innerHTML = html;
        inicializarFormularioDevolucion();
        cablearBuscadorProductos();
        cablearBuscadorLotes();
      })
      .catch(() => {
        modalContent.innerHTML = "<div class='p-4 text-danger'>Error cargando formulario.</div>";
      });
  });

  /* ====== Abrir modal CONSULTAR (misma ruta) ====== */
  btnConsultar.addEventListener("click", function (){
    if (!selectedRef) return;
    modalContent.innerHTML = "<div class='p-4'>Cargando...</div>";
    modalInstance.show();
    fetch("{% url 'sd:devoluciones:detail' 'REF' %}".replace("REF", encodeURIComponent(selectedRef)))
      .then(r => r.text())
      .then(html => { modalContent.innerHTML = html; })
      .catch(() => { modalContent.innerHTML = "<div class='p-4 text-danger'>Error cargando detalle.</div>"; });
  });

  /* ====== Doble click y Enter para consultar (UX como Productos/Ventas) ====== */
  tbody.addEventListener("dblclick",(ev)=>{
    const row = ev.target.closest("tr[data-ref]");
    if(!row || row.hasAttribute("data-empty-row")) return;
    table.querySelectorAll("tr.selected, tr.table-active").forEach(r => r.classList.remove("selected","table-active"));
    row.classList.add("selected","table-active");
    selectedRef = row.getAttribute("data-ref");
    btnConsultar.disabled = !selectedRef;
    if(selectedRef){
      modalContent.innerHTML = "<div class='p-4'>Cargando...</div>";
      modalInstance.show();
      fetch("{% url 'sd:devoluciones:detail' 'REF' %}".replace("REF", encodeURIComponent(selectedRef)))
        .then(r => r.text()).then(html => { modalContent.innerHTML = html; })
        .catch(()=>{ modalContent.innerHTML = "<div class='p-4 text-danger'>Error cargando detalle.</div>"; });
    }
  });

  document.addEventListener('keydown', (ev)=>{
    if(ev.key==='Enter' && selectedRef){
      ev.preventDefault();
      btnConsultar.click();
    }
  });

  /* ====== Re-mostrar principal al cerrar auxiliares (igual) ====== */
  const mbp = document.getElementById("modalBuscarProducto");
  const mbl = document.getElementById("modalBuscarLote");
  if(mbp){ mbp.addEventListener("hidden.bs.modal", () => { bootstrap.Modal.getOrCreateInstance(modalEl).show(); }); }
  if(mbl){ mbl.addEventListener("hidden.bs.modal", () => { bootstrap.Modal.getOrCreateInstance(modalEl).show(); }); }

  /* ==========================================================
     LÓGICA DEL FORM DE DEVOLUCIÓN (idéntica a tu versión)
     ========================================================== */
  function inicializarFormularioDevolucion(){
    const root = document.getElementById("modalDevolucion");
    const alertBox = root.querySelector("#formAlert");
    const detalles = [];

    const $ = (sel) => root.querySelector(sel);
    const showAlert = (msg)=>{ alertBox.textContent = msg; alertBox.classList.remove("d-none"); };
    const hideAlert = ()=>{ alertBox.textContent=""; alertBox.classList.add("d-none"); };

    window.setProductoSeleccionado = function({ id, texto, codigo, nombre }){
      $("#productoIdInput").value = id || "";
      const soloNombre = nombre || (texto?.split(" - ").slice(1).join(" - ").trim()) || texto || "";
      $("#productoInput").value  = soloNombre;
      $("#codigoInput").value    = codigo || (texto ? String(texto).split(" - ")[0].trim() : "");
      $("#loteIdInput").value = ""; $("#loteInput").value = ""; $("#caducidadInput").value = "";
      bootstrap.Modal.getOrCreateInstance(root).show();
    };

    window.setLoteSeleccionado = function({id, numero_lote, fecha_caducidad}){
      $("#loteIdInput").value = id || "";
      $("#loteInput").value   = numero_lote || "";
      $("#caducidadInput").value = fecha_caducidad || "";
      bootstrap.Modal.getOrCreateInstance(root).show();
      $("#cantidadInput")?.focus();
    };

    $("#btnOpenLoteModal")?.addEventListener("click", (ev) => {
      const ref = $("#facturaInput")?.value?.trim();
      const pid = $("#productoIdInput")?.value;
      if (!ref || !pid){ ev.preventDefault(); ev.stopPropagation(); showAlert("Primero ingrese el No. de factura y seleccione un producto."); }
      else{ hideAlert(); }
    });

    $("#btnAddDetalle")?.addEventListener("click", () => {
      hideAlert();
      const codigo     = ($("#codigoInput")?.value || "").trim();
      const productoTx = ($("#productoInput")?.value || "").trim();
      const productoId = parseInt($("#productoIdInput")?.value || 0, 10);
      const loteId     = parseInt($("#loteIdInput")?.value || 0, 10);
      const loteTx     = ($("#loteInput")?.value || "").trim();
      const qty        = parseInt($("#cantidadInput")?.value || 0, 10);

      if (!productoId){ showAlert("Seleccione un producto."); return; }
      if (!loteId){ showAlert("Seleccione un lote (según la factura)."); return; }
      if (!qty || qty <= 0){ showAlert("Cantidad inválida."); return; }

      const item = { producto_id: productoId, codigo, producto: productoTx, lote_id: loteId, numero_lote: loteTx, cantidad: qty };
      detalles.push(item);

      const tbodyDet = $("#detalleTable");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.codigo}</td>
        <td class="text-start">${item.producto}</td>
        <td>${item.numero_lote}</td>
        <td>${item.cantidad}</td>
        <td><button type="button" class="btn btn-sm btn-outline-danger btn-del"><i class="bi bi-trash"></i></button></td>
      `;
      tr.querySelector(".btn-del").addEventListener("click", () => {
        tr.remove();
        const idx = detalles.indexOf(item);
        if (idx >= 0) detalles.splice(idx, 1);
      });
      tbodyDet.appendChild(tr);

      ["productoInput","productoIdInput","codigoInput","loteInput","loteIdInput","caducidadInput","cantidadInput"]
        .forEach(id => { const el = $("#"+id); if (el) el.value = ""; });
    });

    $("#form-devolucion")?.addEventListener("submit", async (e) => {
      e.preventDefault(); hideAlert();
      const ref   = ($("#facturaInput")?.value || "").trim();
      const fecha = $("#fechaInput")?.value || "";
      const motivo= ($("#motivoInput")?.value || "").trim();

      if (!ref){ showAlert("Ingrese el No. de factura."); return; }
      if (!detalles.length){ showAlert("Agregue al menos un producto a devolver."); return; }

      const payload = {
        form_data: { numero_factura: ref, fecha_devolucion: fecha, motivo: motivo },
        detalles: detalles.map(d => ({ producto_id: d.producto_id, lote_id: d.lote_id, cantidad: d.cantidad }))
      };

      try{
        const resp = await fetch("{% url 'sd:devoluciones:create' %}", {
          method: "POST",
          headers: {
            "Content-Type":"application/json",
            "X-Requested-With":"XMLHttpRequest",
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (!resp.ok || !data.success){ showAlert(data?.errors || "Error al guardar la devolución."); return; }
        window.location.reload();
      }catch(err){
        console.error(err);
        showAlert("Error de red.");
      }
    });
  }

  /* ===============================
     Buscador de PRODUCTOS (reuso)
     =============================== */
  function cablearBuscadorProductos(){
    const modal = document.getElementById("modalBuscarProducto");
    const input = document.getElementById("searchProducto");
    const tbody = document.getElementById("tablaBuscarProductos");
    if (!modal || !input || !tbody) return;

    modal.addEventListener("shown.bs.modal", function onShown(){
      modal.removeEventListener("shown.bs.modal", onShown);
      input.value = "";
      tbody.innerHTML = `<tr><td colspan="9" class="text-muted">Escribe para buscar…</td></tr>`;
      input.focus();

      let t = null;
      input.oninput = function(){
        clearTimeout(t);
        const term = this.value.trim();
        if (!term){
          tbody.innerHTML = `<tr><td colspan="9" class="text-muted">Escribe para buscar…</td></tr>`;
          return;
        }
        t = setTimeout(() => {
          tbody.innerHTML = `<tr><td colspan="9" class="text-muted">Buscando…</td></tr>`;
          fetch("{% url 'recepcion:search_productos' %}?term=" + encodeURIComponent(term))
            .then(r => r.ok ? r.json() : Promise.reject())
            .then(rows => {
              if (!rows?.length){
                tbody.innerHTML = `<tr><td colspan="9" class="text-muted">Sin resultados.</td></tr>`;
                return;
              }
              tbody.innerHTML = "";
              rows.forEach(p => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                  <td>${p.codigo ?? ""}</td>
                  <td>${p.nombre ?? ""}</td>
                  <td>${p.descripcion ?? ""}</td>
                  <td>${p.presentacion ?? ""}</td>
                  <td>${p.unidad ?? ""}</td>
                  <td>${p.condicion ?? ""}</td>
                  <td>${p.receta ? "Sí" : "No"}</td>
                  <td>${p.controlado ? "Sí" : "No"}</td>
                  <td><button type="button" class="btn btn-sm btn-success">✔</button></td>
                `;
                tr.querySelector("button").addEventListener("click", () => {
                  window.setProductoSeleccionado?.({
                    id: p.id,
                    texto: `${p.codigo ?? ""} - ${p.nombre ?? ""}`.trim(),
                    codigo: p.codigo ?? "",
                    nombre: p.nombre ?? ""
                  });
                  bootstrap.Modal.getInstance(modal)?.hide();
                  bootstrap.Modal.getOrCreateInstance(modalEl).show();
                });
                tbody.appendChild(tr);
              });
            })
            .catch(() => {
              tbody.innerHTML = `<tr><td colspan="9" class="text-danger">Error buscando productos.</td></tr>`;
            });
        }, 180);
      };
    }, { once:true });
  }

  /* ==========================
     Buscador de LOTES (igual)
     ========================== */
  function cablearBuscadorLotes(){
    const modalLote  = document.getElementById("modalBuscarLote");
    const tablaLotes = document.getElementById("tablaBuscarLotes");
    const searchLote = document.getElementById("searchLote");
    if (!modalLote || !tablaLotes) return;

    modalLote.addEventListener("shown.bs.modal", function onShown(){
      modalLote.removeEventListener("shown.bs.modal", onShown);
      const ref = document.querySelector("#modalDevolucion #facturaInput")?.value.trim();
      const pid = document.querySelector("#modalDevolucion #productoIdInput")?.value.trim();

      if (!ref || !pid){
        tablaLotes.innerHTML = `<tr><td colspan="4" class="text-danger">Ingrese factura y seleccione producto.</td></tr>`;
        return;
      }

      cargarLotes(ref, pid, "");

      if (searchLote){
        searchLote.value = "";
        searchLote.oninput = () => cargarLotes(ref, pid, searchLote.value);
      }
    }, { once:true });

    function cargarLotes(ref, pid, term){
      tablaLotes.innerHTML = `<tr><td colspan="4" class="text-muted">Cargando…</td></tr>`;
      const url = "{% url 'sd:devoluciones:lotes_por_factura' 'REF' 0 %}"
        .replace("REF", encodeURIComponent(ref))
        .replace("/0/", "/" + encodeURIComponent(pid) + "/");

      fetch(term ? (url + "?term=" + encodeURIComponent(term)) : url)
        .then(r => r.json())
        .then(rows => {
          if (!rows?.length){
            tablaLotes.innerHTML = `<tr><td colspan="4" class="text-muted">Sin lotes para esa factura.</td></tr>`;
            return;
          }
          tablaLotes.innerHTML = "";
          rows.forEach(l => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${l.numero_lote}</td>
              <td>${l.fecha_caducidad || ""}</td>
              <td>${l.vendido}</td>
              <td><button type="button" class="btn btn-sm btn-success">✔</button></td>
            `;
            tr.querySelector("button").addEventListener("click", () => {
              window.setLoteSeleccionado?.({ id:l.id, numero_lote:l.numero_lote, fecha_caducidad:l.fecha_caducidad || "" });
              bootstrap.Modal.getInstance(modalLote)?.hide();
              bootstrap.Modal.getOrCreateInstance(modalEl).show();
              document.querySelector("#modalDevolucion #cantidadInput")?.focus();
            });
            tablaLotes.appendChild(tr);
          });
        })
        .catch(() => {
          tablaLotes.innerHTML = `<tr><td colspan="4" class="text-danger">Error cargando lotes.</td></tr>`;
        });
    }
  }

  /* ====== Utilidades visuales + paginación (idénticas) ====== */
  const pagerEl = document.getElementById("pagerDevoluciones");

  function refreshAutoTitles(){
    table.querySelectorAll("td, th").forEach(el=>{
      if(el.scrollWidth>el.clientWidth){el.setAttribute("title",el.textContent.trim())}
      else{el.removeAttribute("title")}
    });
  }

  function removeEmptyRows(){
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      if(tr.hasAttribute('data-empty-row')) return;
      const tds = Array.from(tr.cells);
      const hasContent = tds.some(td => (td.textContent||'').trim() !== '' || td.querySelector('*'));
      if(!hasContent){ tr.remove(); }
    });
  }

  let currentPage=1; let pageSize=15; const rowHeight=42;

  function recomputarPageSize(){
    const rect=tbody.getBoundingClientRect();
    const margenInf=160;
    const espacio=window.innerHeight-rect.top-margenInf;
    pageSize=Math.max(1,Math.floor(espacio/rowHeight));
  }

  function getDataRows(){
    return Array.from(tbody.querySelectorAll("tr"))
      .filter(tr=>!tr.hasAttribute("data-empty-row") && tr.style.display!=="none");
  }

  function renderPager(totalPages){
    if(totalPages<=1){
      pagerEl.innerHTML="";
      pagerEl.style.display="none";
      return;
    }
    pagerEl.style.display="flex";
    pagerEl.classList.add("justify-content-center","align-items-center","py-3","gap-3");
    pagerEl.innerHTML="";

    const prev=document.createElement("button");
    prev.className="btn btn-success btn-sm rounded-pill shadow-sm px-3";
    prev.innerHTML="<i class='bi bi-chevron-left me-1'></i> Anterior";
    prev.disabled=currentPage===1;
    prev.onclick=()=>{ currentPage--; applyPagination(); };

    const info=document.createElement("span");
    info.className="fw-semibold text-success small";
    info.textContent=`Página ${currentPage} de ${totalPages}`;

    const next=document.createElement("button");
    next.className="btn btn-success btn-sm rounded-pill shadow-sm px-3";
    next.innerHTML="Siguiente <i class='bi bi-chevron-right ms-1'></i>";
    next.disabled=currentPage===totalPages;
    next.onclick=()=>{ currentPage++; applyPagination(); };

    pagerEl.append(prev,info,next);
  }

  function applyPagination(){
    const rows=getDataRows();
    const total=rows.length;
    const totalPages=Math.max(1,Math.ceil(total/pageSize));
    if(currentPage>totalPages) currentPage=totalPages;

    const start=(currentPage-1)*pageSize;
    const end=start+pageSize;

    rows.forEach((tr,idx)=>{
      tr.classList.toggle("hidden-by-pagination", !(idx>=start && idx<end));
    });

    renderPager(totalPages);

    tbody.querySelectorAll('tr').forEach(tr=>tr.classList.remove('last-visible'));
    const visibles = rows.filter(r=>!r.classList.contains('hidden-by-pagination'));
    const last = visibles[visibles.length-1];
    if(last) last.classList.add('last-visible');

    // Si la seleccionada quedó fuera, seleccionamos la primera visible
    if(selectedRef){
      const sel=rows.find(r=>r.getAttribute("data-ref")===selectedRef);
      if(sel && sel.classList.contains("hidden-by-pagination")){
        const firstVisible=rows.find(r=>!r.classList.contains("hidden-by-pagination"));
        if(firstVisible){
          table.querySelectorAll("tr.selected, tr.table-active").forEach(r => r.classList.remove("selected","table-active"));
          firstVisible.classList.add("selected","table-active");
          selectedRef = firstVisible.getAttribute("data-ref");
          btnConsultar.disabled = !selectedRef;
        }
      }
    }

    refreshAutoTitles();
  }

  /* ====== Filtros (adaptados a columnas de Devoluciones) ====== */
  function installFilters(){
    const fRef=document.getElementById("f-ref");
    const fFecha=document.getElementById("f-fecha");
    const fUsuario=document.getElementById("f-usuario");
    const fEstado=document.getElementById("f-estado");
    const inputs=[fRef,fFecha,fUsuario,fEstado].filter(Boolean);

    const norm=(s)=>(s||"").toString().trim().toLowerCase();
    const normEstado=(s)=>norm(s).replace(/[íi]/g,"i");

    function applyFilters(){
      const refVal=norm(fRef?.value);
      const fechaVal=norm(fFecha?.value);
      const usuVal=norm(fUsuario?.value);
      const estVal=normEstado(fEstado?.value);

      const rows=Array.from(tbody.querySelectorAll("tr")).filter(r=>!r.hasAttribute("data-empty-row"));
      rows.forEach(tr=>{
        const tds=tr.querySelectorAll("td");
        const txt=i=>norm(tds[i]?.textContent);
        const estadoAttr = normEstado(tr.getAttribute("data-estado") || txt(3));
        const ok =
          (!refVal   || txt(0).includes(refVal))   &&
          (!fechaVal || txt(1).includes(fechaVal)) &&
          (!usuVal   || txt(2).includes(usuVal))   &&
          (!estVal   || estadoAttr===estVal || estadoAttr.includes(estVal));
        tr.style.display = ok ? "" : "none";
      });
      currentPage=1; applyPagination();
    }

    inputs.forEach(inp=>{
      const ev=(inp.tagName==="SELECT")?"change":"input";
      inp.addEventListener(ev,applyFilters);
    });
  }

  /* ====== Inicialización ====== */
  function boot(){
    removeEmptyRows();
    recomputarPageSize();
    installFilters();
    applyPagination();
    refreshAutoTitles();
    window.addEventListener("resize",()=>{recomputarPageSize();applyPagination();});
  }
  boot();
});
</script>
{% endblock %}
