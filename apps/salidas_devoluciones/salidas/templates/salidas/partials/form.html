{% load static %}
{% load tz %}
{% now "Y-m-d\\TH:i" as current_dt %}

<link rel="stylesheet" href="{% static 'form/form.css' %}">

<style>
:root{
  --saif-h: 42px;
  --saif-radius: 12px;
  --saif-border: #e5e7eb;
  --saif-bg: #ffffff;
  --saif-muted: #6b7280;
}
.saif-modal .modal-body{ overflow-x:hidden; }

/* Contenedores */
.saif-form .section-card{
  background:#f8fafc; border:1px solid var(--saif-border);
  border-radius:var(--saif-radius); padding:14px;
}
.saif-form .section-title{
  font-weight:700; color:#111827; display:flex; align-items:center; gap:.5rem;
}
.saif-form .fieldset-box{
  border:1px solid var(--saif-border); border-radius:var(--saif-radius);
  padding:16px; background:var(--saif-bg);
}

.saif-form .input-group-text,
.saif-form .form-control,
.saif-form .btn{ height:var(--saif-h); }
.saif-form .input-group-text{ min-width:40px; justify-content:center; }
.saif-form .form-label{ margin-bottom:.35rem; }
.saif-form .form-text{ color:var(--saif-muted); margin-top:.35rem; }
.saif-form .input-group > .btn{ border:1px solid var(--saif-border); border-left:0; }

/* Tabla */
.table-bordered{ border:1px solid var(--saif-border)!important; border-radius:10px; overflow:hidden; }
.table-bordered>:not(caption)>*>*{ border-color:var(--saif-border)!important; color:#1f2937; }
.table thead.table-light th{ background:#e9f7ef; color:#0f172a; font-weight:600; }

/* Botón eliminar */
.btn-del{
  border:none; background:#fef2f2; color:#dc2626; border-radius:8px; padding:4px 8px; transition:all .2s ease;
}
.btn-del:hover{ background:#dc2626; color:#fff; }

/* Total */
.saif-total{
  display:flex; align-items:center; justify-content:space-between;
  background:var(--saif-bg); border:1px solid var(--saif-border);
  border-radius:var(--saif-radius); padding:12px 16px; font-weight:700;
}
.saif-total small{ font-weight:500; color:var(--saif-muted); }
#formAlert{ margin-bottom:12px; }

/* Layout */
.detalle-grid{ display:grid; gap:12px; }
.detalle-grid__bottom{
  display:grid; gap:12px; grid-template-columns: 130px 140px; align-items:end;
}
@media (max-width: 991.98px){
  .detalle-grid__bottom{ grid-template-columns: 1fr; }
  #btnAddDetalle{ width:100%; }
}

/* Header modal visual */
.saif-modal .modal-header{ background:#0ea5a0; color:#fff; }
.saif-badge{ background:#e6fffb; color:#0f766e; border-radius:999px; padding:.2rem .5rem; font-weight:700; margin-left:.5rem; }
.saif-modal-title{ display:flex; align-items:center; gap:.5rem; font-weight:800; }
</style>

<div class="saif-modal" id="modalVenta">
  <!-- HEADER -->
  <div class="modal-header">
    <div class="saif-modal-title">
      <span class="saif-modal-icon"><i class="bi bi-receipt-cutoff"></i></span>
      <span>{{ titulo|default:"Registrar Venta" }}</span>
    </div>
    <span class="saif-badge">SAIF</span>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
  </div>

  <!-- FORM -->
  <form id="form-venta" method="post" action="{{ action|default:'' }}" novalidate autocomplete="off">
    {% csrf_token %}
    <div class="modal-body saif-modal-body">
      <div class="container-fluid saif-form">

        <div id="formAlert" class="alert alert-danger d-none" role="alert"></div>

        <!-- ===== Datos generales ===== -->
        <div class="fieldset-box mb-3">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">No. Factura</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-upc-scan"></i></span>
                <input type="text" id="facturaInput" name="numero_factura" class="form-control" placeholder="Ej. F-0001">
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Fecha de Venta</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                <!-- Valor desde servidor para que siempre se vea algo -->
                <input type="datetime-local" id="fechaInput" name="fecha_venta"
                       class="form-control" value="{{ current_dt }}" readonly>
              </div>
              <div class="form-text">Se asigna automáticamente con la fecha y hora actual.</div>
            </div>

            <div class="col-12">
              <label class="form-label">Observaciones <span class="muted-hint">(opcional)</span></label>
              <textarea id="comentarioInput" name="comentario" class="form-control" rows="2" placeholder="Comentario u observación..."></textarea>
            </div>
          </div>
        </div>

        <!-- ===== Detalle de productos ===== -->
        <div class="section-card">
          <div class="section-title mb-2"><i class="bi bi-box"></i> Detalle de Productos</div>

          <div class="detalle-grid">
            <div class="detalle-grid__top">
              <label class="form-label">Producto</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-capsule-pill"></i></span>
                <input type="text" id="productoInput" class="form-control" placeholder="Código o nombre...">
                <input type="hidden" id="productoIdInput">
                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalBuscarProducto" title="Buscar producto">
                  <i class="bi bi-search"></i>
                </button>
              </div>
              <div class="form-text">Selecciona desde el buscador para evitar errores.</div>
            </div>

            <div class="detalle-grid__bottom">
              <div>
                <label class="form-label">Cantidad</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-hash"></i></span>
                  <input type="number" id="cantidadInput" class="form-control" min="1" step="1" value="1" placeholder="0">
                </div>
              </div>

              <div>
                <label class="form-label d-none d-lg-block">&nbsp;</label>
                <button type="button" id="btnAddDetalle" class="btn btn-success w-100">
                  <i class="bi bi-plus-circle"></i> Añadir
                </button>
              </div>
            </div>
          </div>

          <!-- Tabla -->
          <div class="table-responsive mt-3">
            <table class="table table-bordered align-middle text-center">
              <thead class="table-light">
                <tr>
                  <th class="text-start">Producto</th>
                  <th>Cantidad</th>
                  <th><i class="bi bi-trash text-danger"></i></th>
                </tr>
              </thead>
              <tbody id="detalleTable"></tbody>
            </table>
          </div>

          <!-- Total -->
          <div class="saif-total mt-2">
            <small>Total de ítems</small>
            <div id="totalItems">0</div>
          </div>
        </div>

        <input type="hidden" name="detalles_json" id="detallesJson">
      </div>
    </div>

    <!-- FOOTER -->
    <div class="modal-footer">
      <button type="button" class="btn btn-light saif-btn-light" data-bs-dismiss="modal">
        <i class="bi bi-x-lg"></i> Cancelar
      </button>
      <button type="submit" class="btn btn-success">
        <i class="bi bi-check2-circle"></i> Guardar Venta
      </button>
    </div>
  </form>
</div>

<!-- ====================== JS ====================== -->
<script>
(function () {
  // Utilidades
  const $  = (sel, root=document) => root.querySelector(sel);
  const pad = v => String(v).padStart(2,'0');
  const nowLocal = () => {
    const d=new Date();
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  };

  // Inicializador idempotente del modal (soporta contenido inyectado)
  function initVentaModal(modalEl){
    if (!modalEl || modalEl.dataset.initialized === "1") return;
    modalEl.dataset.initialized = "1";

    const alertBox       = $('#formAlert', modalEl);
    const tbody          = $('#detalleTable', modalEl);
    const totalItemsEl   = $('#totalItems', modalEl);
    const hiddenDetalles = $('#detallesJson', modalEl);
    const btnAdd         = $('#btnAddDetalle', modalEl);
    const form           = $('#form-venta', modalEl);

    // Estado
    /** item: { producto_id:number|null, nombre:string, cantidad:number } */
    const detalles = [];

    function showAlert(msg){ if(alertBox){ alertBox.textContent = msg; alertBox.classList.remove('d-none'); } }
    function hideAlert(){ if(alertBox){ alertBox.classList.add('d-none'); alertBox.textContent=''; } }

    // FECHA: fijar al abrir
    const fechaInput = $('#fechaInput', modalEl);
    if (fechaInput) fechaInput.value = nowLocal();

    // API para el buscador de productos
    window.setProductoSeleccionado = function({id, texto}){
      const idInp  = $('#productoIdInput', modalEl);
      const txtInp = $('#productoInput', modalEl);
      if (idInp)  idInp.value  = id ?? '';
      if (txtInp) txtInp.value = texto ?? '';
    };

    // Render y total
    function recomputeTotal(){
      const total = detalles.reduce((acc, it) => acc + (parseInt(it.cantidad,10) || 0), 0);
      if (totalItemsEl) totalItemsEl.textContent = String(total);
    }
    function render(){
      if (!tbody) return;
      tbody.innerHTML = '';
      detalles.forEach((it, idx)=>{
        const tr = document.createElement('tr');
        tr.dataset.idx = String(idx);
        tr.innerHTML = `
          <td class="text-start">${it.nombre}</td>
          <td>${it.cantidad}</td>
          <td><button type="button" class="btn-del" title="Eliminar"><i class="bi bi-trash"></i></button></td>
        `;
        tbody.appendChild(tr);
      });
      recomputeTotal();
    }

    // Añadir (fusiona por ID si hay; si no, por nombre)
    function addDetalle(){
      hideAlert();
      const idRaw   = $('#productoIdInput', modalEl)?.value?.trim() ?? '';
      const nombre  = ($('#productoInput', modalEl)?.value ?? '').trim();
      const cantVal = parseInt($('#cantidadInput', modalEl)?.value ?? '0', 10);

      if (!nombre && !idRaw){ showAlert('Seleccione o escriba un producto.'); return; }
      if (!Number.isFinite(cantVal) || cantVal <= 0){ showAlert('Cantidad inválida.'); return; }

      const producto_id = idRaw ? parseInt(idRaw,10) : null;

      let idx = -1;
      if (producto_id !== null){
        idx = detalles.findIndex(x => x.producto_id === producto_id);
      } else {
        idx = detalles.findIndex(x => x.producto_id === null && x.nombre.toLowerCase() === nombre.toLowerCase());
      }

      if (idx >= 0){
        detalles[idx].cantidad = (parseInt(detalles[idx].cantidad,10)||0) + cantVal;
      } else {
        detalles.push({ producto_id, nombre, cantidad: cantVal });
      }

      // limpiar
      const pInp = $('#productoInput', modalEl), pIdInp = $('#productoIdInput', modalEl), cInp = $('#cantidadInput', modalEl);
      if (pInp) pInp.value = '';
      if (pIdInp) pIdInp.value = '';
      if (cInp) cInp.value = '1';

      render(); // actualiza filas y total
    }

    // Eventos
    btnAdd?.addEventListener('click', addDetalle);
    $('#cantidadInput', modalEl)?.addEventListener('keydown', e => { if (e.key==='Enter'){ e.preventDefault(); addDetalle(); }});
    $('#productoInput', modalEl)?.addEventListener('keydown', e => { if (e.key==='Enter'){ e.preventDefault(); addDetalle(); }});

    tbody?.addEventListener('click', (e)=>{
      const btn = e.target.closest('.btn-del');
      if (!btn) return;
      const tr = btn.closest('tr');
      const idx = parseInt(tr?.dataset.idx ?? '-1', 10);
      if (Number.isInteger(idx) && idx >= 0){
        detalles.splice(idx, 1);
        render();
      }
    });

    form?.addEventListener('submit', (e)=>{
      const factura = ($('#facturaInput', modalEl)?.value ?? '').trim();
      if (!factura){ e.preventDefault(); showAlert('Ingrese el número de factura.'); return; }
      if (!detalles.length){ e.preventDefault(); showAlert('Agregue al menos un producto.'); return; }
      const faltanIds = detalles.some(it => it.producto_id === null || Number.isNaN(it.producto_id));
      if (faltanIds){
        e.preventDefault();
        showAlert('Hay productos sin asociar (ID). Selecciónalos desde el buscador.');
        return;
      }
      if (hiddenDetalles) hiddenDetalles.value = JSON.stringify(detalles);
    });

    render(); // pinta “0” inicial
  }

  // Bootstrap: inicializar al abrir el modal
  document.addEventListener('shown.bs.modal', (ev)=>{
    const modalEl = ev.target.closest('#modalVenta');
    if (modalEl) initVentaModal(modalEl);
  });

  // Si ya está en DOM, intenta inicializar
  const initial = document.getElementById('modalVenta');
  if (initial) initVentaModal(initial);

  // Si usas HTMX y reemplazas el contenido del modal:
  document.addEventListener('htmx:afterSwap', ()=>{
    const modalEl = document.getElementById('modalVenta');
    if (modalEl) initVentaModal(modalEl);
  });
})();
</script>
