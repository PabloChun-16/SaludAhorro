{% load static %}

<link rel="stylesheet" href="{% static 'form/form.css' %}">

<style>
:root{
  --saif-h: 42px;
  --saif-radius: 12px;
  --saif-border: #e5e7eb;
  --saif-bg: #ffffff;
  --saif-muted: #6b7280;
}

.saif-modal .modal-body{ overflow-x:hidden; }

/* Contenedores */
.saif-form .section-card{
  background:#f8fafc; border:1px solid var(--saif-border);
  border-radius:var(--saif-radius); padding:14px;
}
.saif-form .section-title{
  font-weight:700; color:#111827; display:flex; align-items:center; gap:.5rem;
}
.saif-form .fieldset-box{
  border:1px solid var(--saif-border); border-radius:var(--saif-radius);
  padding:16px; background:var(--saif-bg);
}

.saif-form .input-group-text,
.saif-form .form-control,
.saif-form .btn{ height:var(--saif-h); }
.saif-form .input-group-text{ min-width:40px; justify-content:center; }
.saif-form .form-label{ margin-bottom:.35rem; }
.saif-form .form-text{ color:var(--saif-muted); margin-top:.35rem; }
.saif-form .input-group > .btn{ border:1px solid var(--saif-border); border-left:0; }

/* Tabla */
.table-bordered{ border:1px solid var(--saif-border)!important; border-radius:10px; overflow:hidden; }
.table-bordered>:not(caption)>*>*{ border-color:var(--saif-border)!important; color:#1f2937; }
.table thead.table-light th{ background:#eef6f1; color:#0f172a; }

/* Total */
.saif-total{
  display:flex; align-items:center; justify-content:space-between;
  background:var(--saif-bg); border:1px solid var(--saif-border);
  border-radius:var(--saif-radius); padding:12px 16px; font-weight:700;
}
.saif-total small{ font-weight:500; color:var(--saif-muted); }
#formAlert{ margin-bottom:12px; }

/* === NUEVO: Layout “producto arriba / resto abajo” === */
.detalle-grid{
  display:grid; gap:12px;
}
/* .detalle-grid__top removed: empty ruleset */
.detalle-grid__bottom{
  display:grid; gap:12px;
  grid-template-columns: 130px 170px 140px; /* Cantidad | Precio | Añadir */
  align-items:end;
}
@media (max-width: 991.98px){
  .detalle-grid__bottom{ grid-template-columns: 1fr; }
  #btnAddDetalle{ width:100%; }
}
</style>

<div class="saif-modal">
  <!-- HEADER -->
  <div class="modal-header py-3 bg-success text-white">
    <div class="d-flex align-items-center gap-2">
      <img src="{% static 'home/img/logo_empresa.png' %}" alt="Logo" class="rounded-circle bg-white p-1" style="width:34px;height:34px;">
      <h5 class="modal-title mb-0 fw-bold">{{ titulo|default:"Crear Venta" }}</h5>
      <span class="saif-badge ms-2"><i class="bi bi-receipt-cutoff"></i> SAIF</span>
    </div>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
  </div>

  <!-- FORM -->
  <form id="form-venta" method="post" action="{{ action|default:'' }}" novalidate autocomplete="off">
    {% csrf_token %}
    <div class="modal-body">
      <div class="container-fluid saif-form">

        <div id="formAlert" class="alert alert-danger d-none" role="alert"></div>

        <!-- ===== Datos generales ===== -->
        <div class="fieldset-box mb-3">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">No. Factura</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-upc-scan"></i></span>
                <input type="text" id="facturaInput" name="numero_factura" class="form-control" placeholder="Ej. F-0001" value="{{ form.numero_factura.value|default_if_none:'' }}">
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Fecha de Venta</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                <input type="datetime-local" id="fechaInput" name="fecha_venta" class="form-control" value="{{ form.fecha_venta.value|default_if_none:now|date:'Y-m-d\\TH:i' }}">
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">Observaciones <span class="muted-hint">(opcional)</span></label>
              <textarea id="comentarioInput" name="comentario" class="form-control" rows="2" placeholder="Comentario u observación..."></textarea>
            </div>
          </div>
        </div>

        <!-- ===== Detalle de productos (producto arriba, resto abajo) ===== -->
        <div class="section-card">
          <div class="section-title mb-2"><i class="bi bi-box"></i> Detalle de Productos</div>

          <div class="detalle-grid">
            <!-- Fila superior: Producto (100%) -->
            <div class="detalle-grid__top">
              <label class="form-label">Producto</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-capsule-pill"></i></span>
                <input type="text" id="productoInput" class="form-control" placeholder="Código o nombre...">
                <input type="hidden" id="productoIdInput">
                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalBuscarProducto" title="Buscar producto">
                  <i class="bi bi-search"></i>
                </button>
              </div>
              <div class="form-text">Selecciona desde el buscador para evitar errores.</div>
            </div>

            <!-- Fila inferior: Cantidad | Precio | Añadir -->
            <div class="detalle-grid__bottom">
              <div>
                <label class="form-label">Cantidad</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-hash"></i></span>
                  <input type="number" id="cantidadInput" class="form-control" min="1" step="1" value="1" placeholder="0">
                </div>
              </div>

              <div>
                <label class="form-label">Precio Unit.</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                  <input type="number" id="precioInput" class="form-control" min="0" step="0.01" value="0" placeholder="0.00">
                </div>
              </div>

              <div>
                <label class="form-label d-none d-lg-block">&nbsp;</label>
                <button type="button" id="btnAddDetalle" class="btn btn-success w-100">
                  <i class="bi bi-plus-circle"></i> Añadir
                </button>
              </div>
            </div>
          </div>

          <!-- Tabla de detalle -->
          <div class="table-responsive mt-3">
            <table class="table table-bordered align-middle text-center">
              <thead class="table-light">
                <tr>
                  <th class="text-start">Producto</th>
                  <th>Cantidad</th>
                  <th>Precio Unit.</th>
                  <th>Subtotal</th>
                  <th>Acción</th>
                </tr>
              </thead>
              <tbody id="detalleTable"></tbody>
            </table>
          </div>

          <!-- Total -->
          <div class="saif-total mt-2">
            <small>Total de la venta</small>
            <div id="totalVenta">Q 0.00</div>
          </div>
        </div>

        <input type="hidden" name="detalles_json" id="detallesJson">
      </div>
    </div>

    <!-- FOOTER -->
    <div class="modal-footer bg-light">
      <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
        <i class="bi bi-x-lg"></i> Cancelar
      </button>
      <button type="submit" class="btn btn-success">
        <i class="bi bi-check2-circle"></i> Guardar Venta
      </button>
    </div>
  </form>
</div>

<!-- ====================== JS (sin cambios) ====================== -->
<script>
(function () {
  const detalles = [];
  const form = document.getElementById('form-venta');
  const alertBox = document.getElementById('formAlert');
  const hiddenDetalles = document.getElementById('detallesJson');
  const totalVentaEl = document.getElementById('totalVenta');
  const tbody = document.getElementById('detalleTable');
  const $ = (sel) => document.querySelector(sel);

  function showAlert(msg){ alertBox.textContent = msg; alertBox.classList.remove('d-none'); }
  function hideAlert(){ alertBox.classList.add('d-none'); alertBox.textContent=''; }

  const money = new Intl.NumberFormat('es-GT', { style:'currency', currency:'GTQ', minimumFractionDigits:2 });
  const fmtQ = (n) => money.format(Number(n||0));

  window.setProductoSeleccionado = function ({id, texto, precio}) {
    $('#productoIdInput').value = id || '';
    $('#productoInput').value = texto || '';
    if (precio != null && !Number.isNaN(Number(precio))) {
      $('#precioInput').value = Number(precio);
    }
  };

  function recomputeTotal(){
    const items = detalles.filter(Boolean);
    const total = items.reduce((acc, it) => acc + (Number(it.cantidad) * Number(it.precio_unitario)), 0);
    totalVentaEl.textContent = fmtQ(total);
  }

  function buildRow(idx, item){
    const tr = document.createElement('tr');
    tr.dataset.idx = String(idx);
    const subtotal = Number(item.cantidad) * Number(item.precio_unitario);
    tr.innerHTML = `
      <td class="text-start">${item._producto_txt}</td>
      <td>${Number(item.cantidad)}</td>
      <td>${fmtQ(item.precio_unitario)}</td>
      <td>${fmtQ(subtotal)}</td>
      <td>
        <button type="button" class="btn btn-sm btn-outline-danger btn-del" title="Eliminar">
          <i class="bi bi-trash"></i>
        </button>
      </td>`;
    return tr;
  }

  const getCantidad = () => {
    const v = Math.trunc(Number($('#cantidadInput').value));
    return Number.isFinite(v) && v > 0 ? v : 0;
  };
  const getPrecio = () => {
    const v = Number($('#precioInput').value);
    return Number.isFinite(v) && v >= 0 ? Number(v.toFixed(2)) : 0;
  };

  function findExistingIndex(prodId, precio){
    return detalles.findIndex(x => x && x.producto_id===prodId && Number(x.precio_unitario)===Number(precio));
  }

  function addDetalle(){
    hideAlert();
    const productoId = parseInt($('#productoIdInput').value,10);
    const productoTxt = ($('#productoInput').value||'').trim();
    const cantidad = getCantidad();
    const precio = getPrecio();

    if (!productoId){ showAlert('Seleccione un producto.'); $('#productoInput').focus(); return; }
    if (!cantidad){ showAlert('Cantidad inválida.'); $('#cantidadInput').focus(); return; }

    const existingIdx = findExistingIndex(productoId, precio);
    if (existingIdx >= 0){
      detalles[existingIdx].cantidad += cantidad;
      const tr = tbody.querySelector(`tr[data-idx="${existingIdx}"]`);
      if(tr){
        const item = detalles[existingIdx];
        tr.children[1].textContent = item.cantidad;
        const subt = Number(item.cantidad) * Number(item.precio_unitario);
        tr.children[3].textContent = fmtQ(subt);
      }
    } else {
      const item = { producto_id: productoId, cantidad, precio_unitario: precio, _producto_txt: productoTxt };
      const idx = detalles.push(item) - 1;
      tbody.appendChild(buildRow(idx, item));
    }

    $('#productoInput').value = '';
    $('#productoIdInput').value = '';
    $('#cantidadInput').value = '1';
    $('#precioInput').value = '0';
    $('#productoInput').focus();
    recomputeTotal();
  }

  document.getElementById('btnAddDetalle').addEventListener('click', addDetalle);
  $('#cantidadInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addDetalle(); }});
  $('#precioInput').addEventListener('keydown',   (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addDetalle(); }});

  tbody.addEventListener('click', (e) => {
    const del = e.target.closest('.btn-del'); if(!del) return;
    const tr = del.closest('tr'); const idx = parseInt(tr.dataset.idx,10);
    detalles[idx] = null; tr.remove();
    recomputeTotal();
  });

  document.getElementById('form-venta').addEventListener('submit', (e) => {
    const items = detalles.filter(Boolean);
    const factura = ($('#facturaInput').value || '').trim();
    if (!factura){ e.preventDefault(); showAlert('Ingrese el número de factura.'); return false; }
    if (!items.length){ e.preventDefault(); showAlert('Agregue al menos un producto.'); return false; }
    hiddenDetalles.value = JSON.stringify(items);
    hideAlert();
  });

  window.inicializarFormularioVenta = function(){
    try{ document.getElementById('productoInput')?.focus(); }catch(_){ }
  }
})();
</script>
