{% load static %}

<link rel="stylesheet" href="{% static 'consult/consult.css' %}?v=15">

<style>
  .saif-modal .modal-content{ border:0;border-radius:18px;overflow:hidden;box-shadow:0 18px 45px rgba(14,122,58,.25);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  .saif-modal .modal-header{ background:#0f7a3a;color:#fff;border-bottom:0;padding:.9rem 1.1rem; }
  .saif-modal .modal-footer{ border-top:0;background:#fff; }
  .saif-modal .modal-body{ background:#f7fbf9;padding:1rem 1.1rem;max-height:72vh; overflow:auto; }

  /* 👉 Auto-ajuste; nada se corta */
  .stats{
    display:grid; gap:.9rem;
    grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
  }
  .stat{
    display:flex; gap:.75rem; align-items:flex-start;
    background:#fff;border:1px solid #e5e7eb;border-radius:14px;
    padding:.85rem .95rem; box-shadow:0 6px 16px rgba(15,23,42,.06);
    min-width:0; /* permite que el contenido fluya */
  }
  .stat .ico{
    flex:0 0 36px;height:36px;width:36px;border-radius:10px;
    display:flex;align-items:center;justify-content:center;
    background:#ecfdf5;color:#0E7A3A;border:1px solid #a7f3d0;font-size:1.05rem;
  }
  .stat .lbl{
    font-weight:800;color:#0b1220;margin-top:.1rem;
    white-space:normal; /* ✅ permite salto */
  }
  .stat .val{
    color:#111827;margin-top:.1rem;line-height:1.35;
    white-space:normal;      /* ✅ sin cortar */
    overflow:visible;        /* ✅ sin recortar */
    text-overflow:unset;     /* ✅ sin “…” */
    word-break:break-word;   /* rompe en palabra larga si es necesario */
    hyphens:auto;
  }

  .chip-est{
    display:inline-flex;align-items:center;gap:.35rem;
    padding:.24rem .55rem;border-radius:999px;font-weight:700;font-size:.82rem;
    border:1px solid transparent; white-space:normal; /* ✅ chip puede crecer a 2 líneas si hace falta */
  }
  .chip--ok{background:#ecfdf5;color:#065f46;border-color:#a7f3d0;}
  .chip--warn{background:#fff7ed;color:#92400e;border-color:#fed7aa;}
  .chip--bad{background:#fef2f2;color:#991b1b;border-color:#fecaca;}
  .chip--neutral{background:#f3f4f6;color:#374151;border-color:#e5e7eb;}

  .block{ background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 18px rgba(15,23,42,.06); }
  .block-header{ padding:.75rem .95rem;border-bottom:1px solid #eef2f7;font-weight:800;color:#0b1220;display:flex;align-items:center;gap:.5rem; }
  .block-body{ padding:.8rem .9rem; }

  .table thead th{ background:#e8f5ec !important;color:#0b3f2e;border-bottom:1px solid #d7dbdf !important; }
</style>

<div class="saif-modal">
  <div class="modal-header">
    <div class="saif-modal-title">
      <span class="saif-modal-icon"><i class="bi bi-receipt-cutoff"></i></span>
      <span>Detalle de Venta</span>
    </div>
    <span class="saif-badge">SAIF</span>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
  </div>

  <div class="modal-body">
    <div class="stats mb-3">
      <div class="stat">
        <div class="ico"><i class="bi bi-flag"></i></div>
        <div class="min-w-0">
          <div class="lbl">Estado</div>
          <div class="val">
            {% with est=estado|stringformat:"s"|lower %}
              {% if est == "completado" %}
                <span class="chip-est chip--ok"><i class="bi bi-check2-circle"></i> Completado</span>
              {% elif est == "pendiente" %}
                <span class="chip-est chip--warn"><i class="bi bi-hourglass-split"></i> Pendiente</span>
              {% elif est == "anulado" or est == "anulada" %}
                <span class="chip-est chip--bad"><i class="bi bi-x-circle"></i> Anulado</span>
              {% else %}
                <span class="chip-est chip--neutral"><i class="bi bi-question-circle"></i> {{ estado }}</span>
              {% endif %}
            {% endwith %}
          </div>
        </div>
      </div>

      <div class="stat">
        <div class="ico"><i class="bi bi-person-circle"></i></div>
        <div class="min-w-0">
          <div class="lbl">Usuario</div>
          <div class="val">{{ usuario|default:"—" }}</div>
        </div>
      </div>

      <div class="stat">
        <div class="ico"><i class="bi bi-calendar-event"></i></div>
        <div class="min-w-0">
          <div class="lbl">Fecha de Venta</div>
          <div class="val">{% if fecha %}{{ fecha|date:"d/m/Y H:i" }}{% else %}—{% endif %}</div>
        </div>
      </div>

      <div class="stat">
        <div class="ico"><i class="bi bi-upc-scan"></i></div>
        <div class="min-w-0">
          <div class="lbl">No. Factura</div>
          <div class="val">{{ referencia|default:"—" }}</div>
        </div>
      </div>
    </div>

    {% if comentario %}
    <div class="block mb-3">
      <div class="block-header"><i class="bi bi-chat-dots"></i> Comentario</div>
      <div class="block-body">{{ comentario }}</div>
    </div>
    {% endif %}

    <div class="block">
      <div class="block-header"><i class="bi bi-box"></i> Productos Vendidos</div>
      <div class="block-body">
        <div class="table-responsive">
          <table class="table table-bordered align-middle text-center">
            <thead>
              <tr>
                <th>Código</th>
                <th>Producto</th>
                <th>Lote</th>
                <th>Cantidad</th>
              </tr>
            </thead>
            <tbody>
              {% for m in movimientos %}
              <tr>
                <td>{{ m.id_lote.id_producto.codigo_producto }}</td>
                <td class="text-start">{{ m.id_lote.id_producto.nombre }}</td>
                <td>{{ m.id_lote.numero_lote }}</td>
                <td>{{ m.cantidad }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="4" class="text-muted">Sin movimientos</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-footer py-2">
    <a href="{% url 'sd:salidas:venta_export_pdf' referencia %}"

   class="btn btn-success saif-btn-success"
   target="_blank">
  <i class="bi bi-filetype-pdf"></i> Exportar
</a>

    <button type="button" class="btn btn-light saif-btn-light" data-bs-dismiss="modal">
      <i class="bi bi-x-lg"></i> Cerrar
    </button>
  </div>
</div>
