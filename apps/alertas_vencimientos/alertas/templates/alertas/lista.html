{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Alertas de Inventario · SAIF{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'lista/lista.css' %}">

<section class="p-3">
  <div class="saif-card shadow-lg rounded-3 overflow-hidden">
    <!-- HEADER -->
    <div class="saif-card-header d-flex align-items-center justify-content-between bg-success text-white px-3 py-2 flex-wrap gap-2">
      <h3 class="mb-0 fs-6 d-flex align-items-center gap-2">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <span>Alertas de Inventario</span>
      </h3>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <button type="button" id="btnActualizarEstados" class="btn btn-light btn-sm text-success fw-semibold shadow-sm d-flex align-items-center gap-2">
          <span id="spinnerActualizar" class="spinner-border spinner-border-sm text-success d-none" role="status" aria-hidden="true">
            <span class="visually-hidden">Procesando...</span>
          </span>
          <i class="bi bi-arrow-clockwise"></i>
          <span>Actualizar estados de lotes</span>
        </button>
        <span class="badge bg-light text-success px-2 py-1 fs-7">SAIF</span>
      </div>
    </div>

    <!-- BODY -->
    <div class="p-4 bg-light">
      <div id="alertaEstadosLotes" class="alert alert-success d-none small py-2 px-3 mb-3" role="status"></div>
      <div class="row g-4 justify-content-center">
        <!-- STOCK BAJO -->
        <div class="col-md-3 col-sm-6">
          <div class="card alert-card border-success text-center shadow-sm h-100">
            <div class="card-body">
              <div class="icon-wrapper text-success mx-auto mb-2">
                <i class="bi bi-box-seam fs-3"></i>
              </div>
              <h6 class="fw-bold text-success mb-1">Stock Bajo</h6>
              <h3 class="fw-bolder text-dark mb-3">{{ stock_bajo }}</h3>
              <button class="btn btn-outline-success btn-sm rounded-pill px-3"
                      data-modal="#modalStockBajo">
                <i class="bi bi-eye"></i> Ver Detalle
              </button>
            </div>
          </div>
        </div>

        <!-- PRÓXIMOS A VENCER -->
        <div class="col-md-3 col-sm-6">
          <div class="card alert-card border-warning text-center shadow-sm h-100">
            <div class="card-body">
              <div class="icon-wrapper text-warning mx-auto mb-2">
                <i class="bi bi-hourglass-split fs-3"></i>
              </div>
              <h6 class="fw-bold text-warning mb-1">Próximos a Vencer</h6>
              <h3 class="fw-bolder text-dark mb-3">{{ proximos_vencer }}</h3>
              <button class="btn btn-outline-success btn-sm rounded-pill px-3"
                      data-modal="#modalProximosVencer">
                <i class="bi bi-eye"></i> Ver Detalle
              </button>
            </div>
          </div>
        </div>

        <!-- VENCIDOS -->
        <div class="col-md-3 col-sm-6">
          <div class="card alert-card border-secondary text-center shadow-sm h-100">
            <div class="card-body">
              <div class="icon-wrapper text-secondary mx-auto mb-2">
                <i class="bi bi-calendar-x fs-3"></i>
              </div>
              <h6 class="fw-bold text-secondary mb-1">Vencidos</h6>
              <h3 class="fw-bolder text-dark mb-3">{{ vencidos }}</h3>
              <button class="btn btn-outline-success btn-sm rounded-pill px-3"
                      data-modal="#modalVencidos">
                <i class="bi bi-eye"></i> Ver Detalle
              </button>
            </div>
          </div>
        </div>

        <!-- AGOTAMIENTO -->
        <div class="col-md-3 col-sm-6">
          <div class="card alert-card border-info text-center shadow-sm h-100">
            <div class="card-body">
              <div class="icon-wrapper text-info mx-auto mb-2">
                <i class="bi bi-archive fs-3"></i>
              </div>
              <h6 class="fw-bold text-info mb-1">Próximos a Agotarse</h6>
              <h3 class="fw-bolder text-dark mb-3">{{ agotamiento }}</h3>
              <button class="btn btn-outline-success btn-sm rounded-pill px-3"
                      data-modal="#modalAgotamiento">
                <i class="bi bi-eye"></i> Ver Detalle
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Placeholder -->
  <div id="modalContainer"></div>
</section>

<!-- === ESTILO BOOTSTRAP SAIF === -->
<style>
  .alert-card {
    border-radius: 1rem;
    background: #fff;
    transition: all 0.2s ease-in-out;
  }
  .alert-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(25, 135, 84, 0.15);
  }

  .icon-wrapper {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(25, 135, 84, 0.05);
    border: 1px solid rgba(25, 135, 84, 0.15);
  }

  .btn-outline-success {
    border: 1px solid #198754;
    color: #198754;
    transition: all 0.2s ease-in-out;
  }
  .btn-outline-success:hover {
    background-color: #198754;
    color: white;
  }

  h6 { letter-spacing: 0.3px; }
  .saif-hidden-page{ display:none !important; }
</style>
{% endblock %}

{% block extra_js %}
<script>
// ====== Utilidades globales SAIF (solo una vez) ======
window.SAIF = window.SAIF || {};

// Normaliza texto (minúsculas + sin acentos) — compatible con todos los navegadores
SAIF.normalize = function (str) {
  try {
    return (str || "")
      .toString()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toLowerCase()
      .trim();
  } catch (e) {
    return (str || "").toString().toLowerCase().trim();
  }
};

if (!SAIF.getCsrfToken) {
  SAIF.getCsrfToken = function () {
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    if (match) return match[1];
    const input = document.querySelector('input[name=csrfmiddlewaretoken]');
    return input ? input.value : "";
  };
}

if (!SAIF.createPaginator) {
  SAIF.createPaginator = function (tbody, pagerEl, pageSize) {
    if (!tbody) return null;
    const size = Math.max(1, pageSize || 5);
    let currentPage = 1;

    function getActiveRows() {
      return Array.from(tbody.querySelectorAll("tr")).filter(
        (tr) => !tr.classList.contains("d-none")
      );
    }

    function render() {
      const rows = getActiveRows();
      const total = rows.length;
      const totalPages = Math.max(1, Math.ceil(total / size));
      if (currentPage > totalPages) currentPage = totalPages;

      Array.from(tbody.querySelectorAll("tr")).forEach((tr) =>
        tr.classList.remove("saif-hidden-page")
      );

      rows.forEach((tr, index) => {
        const hide = index < (currentPage - 1) * size || index >= currentPage * size;
        tr.classList.toggle("saif-hidden-page", hide);
      });

      if (!pagerEl) return;
      if (total <= size) {
        pagerEl.classList.add("d-none");
        pagerEl.innerHTML = "";
        return;
      }

      pagerEl.classList.remove("d-none");
      pagerEl.classList.add("saif-pager", "d-flex", "justify-content-center", "align-items-center", "gap-2", "py-2");
      pagerEl.innerHTML = "";

      const prev = document.createElement("button");
      prev.type = "button";
      prev.className = "btn btn-success btn-sm rounded-pill shadow-sm px-3";
      prev.innerHTML = "<i class='bi bi-chevron-left me-1'></i> Anterior";
      prev.disabled = currentPage === 1;
      prev.addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage -= 1;
          render();
        }
      });

      const info = document.createElement("span");
      info.className = "fw-semibold text-success small";
      info.textContent = `Pagina ${currentPage} de ${totalPages}`;

      const next = document.createElement("button");
      next.type = "button";
      next.className = "btn btn-success btn-sm rounded-pill shadow-sm px-3";
      next.innerHTML = "Siguiente <i class='bi bi-chevron-right ms-1'></i>";
      next.disabled = currentPage >= totalPages;
      next.addEventListener("click", () => {
        if (currentPage < totalPages) {
          currentPage += 1;
          render();
        }
      });

      pagerEl.append(prev, info, next);
    }

    return {
      refresh: render,
      reset() {
        currentPage = 1;
        render();
      },
    };
  };
}

/* =========================
   Modal: STOCK BAJO
   (Código + Nombre)
========================= */
SAIF.initStockBajo = function (modalEl) {
  if (!modalEl) return;
  const table = modalEl.querySelector("#tablaStockBajo");
  const tbody = table?.querySelector("tbody");
  const totalBadge = modalEl.querySelector("#sbTotalBadge");
  const qCod = modalEl.querySelector("#sb-q-codigo");
  const qNom = modalEl.querySelector("#sb-q-nombre");
  const btnApply = modalEl.querySelector("#sb-btn-apply");
  const btnClear = modalEl.querySelector("#sb-btn-clear");
  if (!tbody || !qCod || !qNom) return;
  const pager = modalEl.querySelector("#sbPager");
  const paginator = SAIF.createPaginator ? SAIF.createPaginator(tbody, pager, 5) : null;

  function apply() {
    const vCod = SAIF.normalize(qCod.value);
    const vNom = SAIF.normalize(qNom.value);
    let count = 0;

    tbody.querySelectorAll("tr").forEach((tr) => {
      const tds = tr.children;
      const cod = SAIF.normalize(tds[0]?.textContent);
      const nom = SAIF.normalize(tds[1]?.textContent);
      const ok = (!vCod || cod.includes(vCod)) && (!vNom || nom.includes(vNom));
      tr.classList.toggle("d-none", !ok);
      if (ok) count++;
    });

    if (totalBadge) totalBadge.textContent = `${count} registro${count === 1 ? "" : "s"}`;
    paginator?.reset();
  }

  function clearAll(e) {
    e?.preventDefault();
    qCod.value = "";
    qNom.value = "";
    apply();
  }

  // Debounce suave al tipear
  let t; const debounced = () => { clearTimeout(t); t = setTimeout(apply, 120); };

  qCod.addEventListener("input", debounced);
  qNom.addEventListener("input", debounced);
  btnApply?.addEventListener("click", (e) => { e.preventDefault(); apply(); });
  btnClear?.addEventListener("click", clearAll);

  // tooltips por overflow
  table.querySelectorAll("td, th").forEach((el) => {
    if (el.scrollWidth > el.clientWidth) el.setAttribute("title", el.textContent.trim());
    else el.removeAttribute("title");
  });

  apply(); // primera pasada
  paginator?.refresh();
};

/* =========================
   Modal: VENCIDOS
   (Producto + Lote)
========================= */
SAIF.initVencidos = function (modalEl) {
  if (!modalEl) return;
  const table = modalEl.querySelector("#tablaVencidos");
  const tbody = table?.querySelector("tbody");
  const totalBadge = modalEl.querySelector("#vvTotalBadge");
  const qProd = modalEl.querySelector("#vv-q-producto");
  const qLote = modalEl.querySelector("#vv-q-lote");
  const btnApply = modalEl.querySelector("#vv-btn-apply");
  const btnClear = modalEl.querySelector("#vv-btn-clear");
  if (!tbody || !qProd || !qLote) return;
  const pager = modalEl.querySelector("#vvPager");
  const paginator = SAIF.createPaginator ? SAIF.createPaginator(tbody, pager, 5) : null;

  function apply() {
    const vProd = SAIF.normalize(qProd.value);
    const vLote = SAIF.normalize(qLote.value);
    let count = 0;

    tbody.querySelectorAll("tr").forEach((tr) => {
      const tds = tr.children;
      const prod = SAIF.normalize(tds[0]?.textContent);
      const lote = SAIF.normalize(tds[1]?.textContent);
      const ok = (!vProd || prod.includes(vProd)) && (!vLote || lote.includes(vLote));
      tr.classList.toggle("d-none", !ok);
      if (ok) count++;
    });

    if (totalBadge) totalBadge.textContent = `${count} registro${count === 1 ? "" : "s"}`;
    paginator?.reset();
  }

  function clearAll(e) {
    e?.preventDefault();
    qProd.value = "";
    qLote.value = "";
    apply();
  }

  let t; const debounced = () => { clearTimeout(t); t = setTimeout(apply, 120); };

  qProd.addEventListener("input", debounced);
  qLote.addEventListener("input", debounced);
  btnApply?.addEventListener("click", (e) => { e.preventDefault(); apply(); });
  btnClear?.addEventListener("click", clearAll);

  // tooltips por overflow
  table.querySelectorAll("td, th").forEach((el) => {
    if (el.scrollWidth > el.clientWidth) el.setAttribute("title", el.textContent.trim());
    else el.removeAttribute("title");
  });

  apply(); // primera pasada
  paginator?.refresh();
};

/* =========================
   Modal: PRÓXIMOS A VENCER
   (Producto + Lote + Días Restantes <=)
========================= */
SAIF.initProximosVencer = function (modalEl) {
  if (!modalEl) return;
  const table = modalEl.querySelector("#tablaProximosVencer");
  const tbody = table?.querySelector("tbody");
  const totalBadge = modalEl.querySelector("#pvTotalBadge");
  const qProd = modalEl.querySelector("#pv-q-producto");
  const qLote = modalEl.querySelector("#pv-q-lote");
  const qDias = modalEl.querySelector("#pv-q-dias");
  const btnApply = modalEl.querySelector("#pv-btn-apply");
  const btnClear = modalEl.querySelector("#pv-btn-clear");
  if (!tbody || !qProd || !qLote) return;
  const pager = modalEl.querySelector("#pvPager");
  const paginator = SAIF.createPaginator ? SAIF.createPaginator(tbody, pager, 5) : null;

  function apply() {
    const vProd = SAIF.normalize(qProd.value);
    const vLote = SAIF.normalize(qLote.value);
    const vDias = (qDias.value || "").trim();
    let count = 0;

    tbody.querySelectorAll("tr").forEach((tr) => {
      const tds = tr.children;
      const prod = SAIF.normalize(tds[0]?.textContent);
      const lote = SAIF.normalize(tds[1]?.textContent);
      const dias = parseInt(tds[4]?.textContent) || 0;

      const ok =
        (!vProd || prod.includes(vProd)) &&
        (!vLote || lote.includes(vLote)) &&
        (!vDias || dias <= parseInt(vDias));

      tr.classList.toggle("d-none", !ok);
      if (ok) count++;
    });

    if (totalBadge) totalBadge.textContent = `${count} registro${count === 1 ? "" : "s"}`;
    paginator?.reset();
  }

  function clearAll(e) {
    e?.preventDefault();
    qProd.value = "";
    qLote.value = "";
    qDias.value = "";
    apply();
  }

  let t; const debounced = () => { clearTimeout(t); t = setTimeout(apply, 120); };

  qProd.addEventListener("input", debounced);
  qLote.addEventListener("input", debounced);
  qDias.addEventListener("input", debounced);
  btnApply?.addEventListener("click", (e) => { e.preventDefault(); apply(); });
  btnClear?.addEventListener("click", clearAll);

  // tooltips por overflow
  table.querySelectorAll("td, th").forEach((el) => {
    if (el.scrollWidth > el.clientWidth) el.setAttribute("title", el.textContent.trim());
    else el.removeAttribute("title");
  });

  apply(); // primera pasada
  paginator?.refresh();
};

/* =========================
   Modal: AGOTAMIENTO
   (Código + Nombre + Margen % <=)
========================= */
SAIF.initAgotamiento = function (modalEl) {
  if (!modalEl) return;
  const table = modalEl.querySelector("#tablaAgotamiento");
  const tbody = table?.querySelector("tbody");
  const totalBadge = modalEl.querySelector("#agTotalBadge");
  const qCod = modalEl.querySelector("#ag-q-codigo");
  const qNom = modalEl.querySelector("#ag-q-nombre");
  const qMargen = modalEl.querySelector("#ag-q-margen");
  const btnApply = modalEl.querySelector("#ag-btn-apply");
  const btnClear = modalEl.querySelector("#ag-btn-clear");
  if (!tbody || !qCod || !qNom) return;
  const pager = modalEl.querySelector("#agPager");
  const paginator = SAIF.createPaginator ? SAIF.createPaginator(tbody, pager, 5) : null;

  function parsePerc(v) {
    if (v == null) return NaN;
    const s = (""+v).replace("%","").trim();
    const n = parseFloat(s);
    return isNaN(n) ? NaN : n;
  }

  function apply() {
    const vCod = SAIF.normalize(qCod.value);
    const vNom = SAIF.normalize(qNom.value);
    const vMargen = parsePerc(qMargen.value);
    let count = 0;

    tbody.querySelectorAll("tr").forEach((tr) => {
      const tds = tr.children;
      const cod = SAIF.normalize(tds[0]?.textContent);
      const nom = SAIF.normalize(tds[1]?.textContent);
      const margenCell = parsePerc(tds[4]?.textContent);
      const ok =
        (!vCod || cod.includes(vCod)) &&
        (!vNom || nom.includes(vNom)) &&
        (isNaN(vMargen) || (!isNaN(margenCell) && margenCell <= vMargen));

      tr.classList.toggle("d-none", !ok);
      if (ok) count++;
    });

    if (totalBadge) totalBadge.textContent = `${count} registro${count === 1 ? "" : "s"}`;
    paginator?.reset();
  }

  function clearAll(e) {
    e?.preventDefault();
    qCod.value = "";
    qNom.value = "";
    qMargen.value = "";
    apply();
  }

  let t; const debounced = () => { clearTimeout(t); t = setTimeout(apply, 120); };

  qCod.addEventListener("input", debounced);
  qNom.addEventListener("input", debounced);
  qMargen.addEventListener("input", debounced);
  btnApply?.addEventListener("click", (e) => { e.preventDefault(); apply(); });
  btnClear?.addEventListener("click", clearAll);

  // tooltips por overflow
  table.querySelectorAll("td, th").forEach((el) => {
    if (el.scrollWidth > el.clientWidth) el.setAttribute("title", el.textContent.trim());
    else el.removeAttribute("title");
  });

  apply(); // primera pasada
  paginator?.refresh();
};

document.addEventListener("DOMContentLoaded", function () {
  const modalConfig = { backdrop: "static", keyboard: false };
  const actualizarUrl = "{% url 'alertas_vencimientos:alertas:actualizar_estados_lotes' %}";
  const btnActualizar = document.getElementById("btnActualizarEstados");
  const spinnerActualizar = document.getElementById("spinnerActualizar");
  const alertaEstados = document.getElementById("alertaEstadosLotes");

  function limpiarAlertaEstados() {
    if (!alertaEstados) return;
    alertaEstados.classList.add("d-none");
    alertaEstados.textContent = "";
    alertaEstados.classList.remove("alert-danger", "alert-success");
    alertaEstados.classList.add("alert-success");
  }

  function mostrarAlertaEstados(tipo, mensaje) {
    if (!alertaEstados) return;
    alertaEstados.textContent = mensaje;
    alertaEstados.classList.remove("d-none", "alert-success", "alert-danger");
    alertaEstados.classList.add(tipo === "error" ? "alert-danger" : "alert-success");
  }

  btnActualizar?.addEventListener("click", () => {
    if (btnActualizar.disabled) return;
    limpiarAlertaEstados();
    btnActualizar.disabled = true;
    btnActualizar.classList.add("disabled", "opacity-75");
    spinnerActualizar?.classList.remove("d-none");

    fetch(actualizarUrl, {
      method: "POST",
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": SAIF.getCsrfToken()
      }
    })
      .then((r) => r.json().then((data) => ({ ok: r.ok, data })))
      .then(({ ok, data }) => {
        if (ok && data?.success) {
          const msg = (data.message || "Actualizacion completada.").toString().trim();
          mostrarAlertaEstados("success", msg);
        } else {
          const msg = (data?.error || "No se pudo actualizar los estados.").toString().trim();
          mostrarAlertaEstados("error", msg);
        }
      })
      .catch(() => {
        mostrarAlertaEstados("error", "Error de red al ejecutar la actualizacion.");
      })
      .finally(() => {
        spinnerActualizar?.classList.add("d-none");
        btnActualizar.disabled = false;
        btnActualizar.classList.remove("disabled", "opacity-75");
      });
  });

  // ====== Config de modales (PADRE) ======
  const modalDefs = [
    {
      selector: '[data-modal="#modalStockBajo"]',
      url: "{% url 'alertas_vencimientos:alertas:alertas_stock_bajo' %}",
      id: "#modalStockBajo",
      init: (el) => SAIF.initStockBajo(el),
    },
    {
      selector: '[data-modal="#modalProximosVencer"]',
      url: "{% url 'alertas_vencimientos:alertas:alertas_proximos_vencer' %}",
      id: "#modalProximosVencer",
      init: (el) => SAIF.initProximosVencer(el),
    },
    {
      selector: '[data-modal="#modalVencidos"]',
      url: "{% url 'alertas_vencimientos:alertas:alertas_vencidos' %}",
      id: "#modalVencidos",
      init: (el) => SAIF.initVencidos(el),
    },
    {
      selector: '[data-modal="#modalAgotamiento"]',
      url: "{% url 'alertas_vencimientos:alertas:alertas_agotamiento' %}",
      id: "#modalAgotamiento",
      init: (el) => SAIF.initAgotamiento(el),
    },
  ];

  const container = document.querySelector("#modalContainer");

  modalDefs.forEach(({ selector, url, id, init }) => {
    // Soporta múltiples botones para el mismo modal
    document.querySelectorAll(selector).forEach((btn) => {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
          .then((r) => r.text())
          .then((html) => {
            container.innerHTML = html;
            const el = container.querySelector(id);

            // Inicializamos los filtros ANTES de abrir el modal
            if (typeof init === "function") init(el);

            new bootstrap.Modal(el, modalConfig).show();
          })
          .catch(() => {
            container.innerHTML =
              '<div class="p-4 text-danger text-center">Error cargando el detalle.</div>';
          });
      });
    });
  });
});
</script>
{% endblock %}













