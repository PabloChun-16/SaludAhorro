{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Gestión de Lotes · SAIF{% endblock %}

{% block content %}
<section class="p-3 p-md-4">
  <div class="saif-card mb-4 shadow-lg rounded-3 overflow-hidden">

    <!-- ENCABEZADO -->
    <div class="saif-card-header d-flex align-items-center justify-content-between bg-success text-white px-3 px-md-4 py-2 py-md-3">
      <h3 class="mb-0 fs-5 fs-md-4">
        <i class="bi bi-boxes me-2"></i> Gestión de Lotes
      </h3>
      <span class="badge bg-light text-success px-2 px-md-3 py-1 py-md-2 fs-6 fs-md-5">SAIF</span>
    </div>

    <!-- TABLA -->
    <div class="table-responsive">
      <table class="table table-hover align-middle text-center" id="tablaLotes">
        <thead class="table-success text-dark">
          <tr>
            <th>Código</th>
            <th>Producto</th>
            <th>N° Lote</th>
            <th>Caducidad</th>
            <th>Disponible</th>
            <th>Ubicación</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for lote in lotes %}
          <tr data-id="{{ lote.id }}">
            <td>{{ lote.id_producto.codigo_producto }}</td>
            <td>{{ lote.id_producto.nombre }}</td>
            <td>{{ lote.numero_lote }}</td>
            <td>{{ lote.fecha_caducidad }}</td>
            <td>{{ lote.cantidad_disponible }}</td>
            <td>{{ lote.ubicacion_almacen }}</td>
            <td>{{ lote.id_estado_lote.nombre_estado }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="py-5 text-muted">
              <i class="bi bi-inbox fs-3 d-block mb-2"></i>
              No hay lotes registrados.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- BOTONES ABAJO -->
    <div class="px-3 py-3 text-center border-top bg-light">
      <button id="btnConsultar" class="btn btn-primary rounded-pill px-4 me-2 shadow-sm" disabled>
        <i class="bi bi-search"></i> Consultar
      </button>
      <button id="btnEditar" class="btn btn-warning rounded-pill px-4 me-2 shadow-sm" disabled>
        <i class="bi bi-pencil"></i> Editar
      </button>
      <button id="btnEliminar" class="btn btn-danger rounded-pill px-4 shadow-sm" disabled>
        <i class="bi bi-trash"></i> Eliminar
      </button>
    </div>
  </div>
</section>

<!-- MODAL GENÉRICO -->
<div class="modal fade" id="modalLotes" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" id="modalLotesContent"></div>
  </div>
</div>

<!-- Modal de confirmación (pequeño) -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white py-2">
        <h6 class="modal-title"><i class="bi bi-trash"></i> Eliminar lote</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        ¿Eliminar el lote <strong id="confirmLoteText"></strong>?
        <div class="small text-muted mt-2">Esta acción no se puede deshacer.</div>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger btn-sm" id="btnConfirmDelete">Eliminar</button>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block extra_js %}
{{ block.super }}

<script>
document.addEventListener("DOMContentLoaded", function () {
  const tabla = document.getElementById("tablaLotes");
  const tbody = tabla.querySelector("tbody");
  const modal = new bootstrap.Modal(document.getElementById("modalLotes"));
  const modalContent = document.getElementById("modalLotesContent");

  // Confirm modal
  const confirmModal = new bootstrap.Modal(document.getElementById("confirmDeleteModal"));
  const confirmText = document.getElementById("confirmLoteText");
  const btnConfirmDelete = document.getElementById("btnConfirmDelete");

  const btnConsultar = document.getElementById("btnConsultar");
  const btnEditar    = document.getElementById("btnEditar");
  const btnEliminar  = document.getElementById("btnEliminar");

  let selectedId   = null;
  let selectedRow  = null;
  let puedeEliminarCache = { allow:false, reason:"" };

  // -------------------------------
  // 🔐 Obtener CSRF Token
  // -------------------------------
  function getCookie(name){
    let cookieValue=null;
    if(document.cookie && document.cookie!==''){
      const cookies=document.cookie.split(';');
      for(let c of cookies){
        c=c.trim();
        if(c.substring(0, name.length+1)===(name+'=')){
          cookieValue=decodeURIComponent(c.substring(name.length+1)); break;
        }
      }
    }
    return cookieValue;
  }

  // -------------------------------
  // 🎛️ Habilitar / deshabilitar botones
  // -------------------------------
  function setButtonsEnabled(enabled){
    btnConsultar.disabled = !enabled;
    btnEditar.disabled    = !enabled;
    btnEliminar.disabled  = !enabled || !puedeEliminarCache.allow;
    btnEliminar.title     = puedeEliminarCache.allow ? "" : (puedeEliminarCache.reason || "Este lote no puede eliminarse.");
  }

  // -------------------------------
  // 🔎 Verificar si se puede eliminar
  // -------------------------------
  async function fetchPuedeEliminar(id){
    const url = "{% url 'inventario:lotes:puede_eliminar' 0 %}".replace("/0/", `/${id}/`);
    const r = await fetch(url, {headers:{'X-Requested-With':'XMLHttpRequest'}});
    puedeEliminarCache = await r.json(); // {allow, reason}
    setButtonsEnabled(true);
  }

  // -------------------------------
  // 🖱️ Seleccionar fila
  // -------------------------------
  tbody.addEventListener("click", async (ev) => {
    const row = ev.target.closest("tr[data-id]");
    if (!row) return;

    tbody.querySelectorAll("tr").forEach(r => r.classList.remove("table-active"));
    row.classList.add("table-active");

    selectedRow = row;
    selectedId  = row.dataset.id;

    btnConsultar.disabled = false;
    btnEditar.disabled    = false;

    await fetchPuedeEliminar(selectedId);
  });

  // -------------------------------
  // 📂 Abrir modal (consultar / editar)
  // -------------------------------
  function abrirModal(url){
    modalContent.innerHTML = '<div class="p-4">Cargando…</div>';
    modal.show();
    fetch(url, { headers:{ "X-Requested-With": "XMLHttpRequest" } })
      .then(r => r.text())
      .then(html => modalContent.innerHTML = html)
      .catch(() => modalContent.innerHTML = '<div class="p-4 text-danger">Error cargando contenido.</div>');
  }

  // -------------------------------
  // 🔍 Consultar
  // -------------------------------
  btnConsultar.addEventListener("click", () => {
    if (selectedId) abrirModal(`{% url 'inventario:lotes:consultar' 0 %}`.replace("/0/", `/${selectedId}/`));
  });

  // -------------------------------
  // ✏️ Editar
  // -------------------------------
  btnEditar.addEventListener("click", () => {
    if (selectedId) abrirModal(`{% url 'inventario:lotes:editar' 0 %}`.replace("/0/", `/${selectedId}/`));
  });

  // -------------------------------
  // 🗑️ Eliminar (con verificación)
  // -------------------------------
  btnEliminar.addEventListener("click", async () => {
    if (!selectedId) return;

    if (!puedeEliminarCache.allow) {
      alert(puedeEliminarCache.reason || "Este lote no puede eliminarse.");
      return;
    }

    const numLote = selectedRow?.children[2]?.textContent?.trim() || "";
    const prod    = selectedRow?.children[1]?.textContent?.trim() || "";
    confirmText.textContent = `${numLote} · ${prod}`;

    btnConfirmDelete.onclick = async () => {
      btnConfirmDelete.disabled = true;

      const again = await fetch("{% url 'inventario:lotes:puede_eliminar' 0 %}".replace("/0/", `/${selectedId}/`));
      const againInfo = await again.json();
      if (!againInfo.allow) {
        btnConfirmDelete.disabled = false;
        confirmModal.hide();
        alert(againInfo.reason || "Este lote ya no puede eliminarse.");
        return;
      }

      const delUrl = "{% url 'inventario:lotes:eliminar' 0 %}".replace("/0/", `/${selectedId}/`);
      const res = await fetch(delUrl, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "X-Requested-With": "XMLHttpRequest"
        }
      });

      confirmModal.hide();
      const data = await res.json();
      btnConfirmDelete.disabled = false;

      if (data.success) {
        window.location.reload();
      } else {
        alert(data.error || "No se pudo eliminar el lote.");
      }
    };

    confirmModal.show();
  });

  // -------------------------------
  // ✅ SUBMIT UNIVERSAL DENTRO DEL MODAL
  // -------------------------------
  modalContent.addEventListener("submit", function (e) {
    const form = e.target.closest("form");
    if (!form) return;
    e.preventDefault();

    fetch(form.action, {
      method: "POST",
      body: new FormData(form),
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": getCookie("csrftoken")
      }
    })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          modal.hide();
          window.location.reload(); // 🔁 vuelve a lista.html
        } else if (data.html) {
          modalContent.innerHTML = data.html; // vuelve a mostrar form con errores
        } else {
          alert("Error al guardar los cambios.");
        }
      })
      .catch(err => {
        console.error(err);
        alert("Error al procesar la solicitud.");
      });
  });

});
</script>


{% endblock %}

