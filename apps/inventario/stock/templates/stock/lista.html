{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Stock de Productos · SAIF{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'lista/lista.css' %}">

<style>
/* ====== Contenedor con scroll ====== */
.table-container{
  overflow-x:auto;
  width:100%;
  max-height:calc(100vh - 250px);
  scroll-padding-top:90px; /* evita que el sticky tape al saltar */
}

/* ====== Tabla ====== */
#tablaStock{
  table-layout:fixed;                    /* consistente con Productos */
  width:100%; min-width:1200px;
  border-collapse:separate;              /* necesario para sticky + bordes finos */
  border-spacing:0;
  outline:1px solid #e3e6ea;             /* contorno sin ocupar espacio (evita "fila fantasma") */
  outline-offset:-1px;
  border-radius:.5rem;
  margin-bottom:0;
}

/* ====== Celdas ====== */
#tablaStock th,
#tablaStock td{
  overflow:hidden;
  white-space:nowrap;
  text-overflow:ellipsis;
  vertical-align:middle;
  padding:.5rem;
  font-size:.875rem;
  background-clip:padding-box;  /* evita solapes con sticky */
  border:1px solid #e3e6ea;     /* líneas internas */
}

/* Mismo color en todas las filas (sin rayado) */
#tablaStock tbody tr{ background:#ffffff; }

/* ====== Encabezado sticky (2 filas) ====== */
#tablaStock thead.sticky-top{
  position:sticky;
  top:0;
  z-index:10;
  box-shadow:0 2px 4px rgba(0,0,0,.06);
}

/* Fila de títulos (1ª fila del thead) */
#tablaStock thead.sticky-top tr:first-child th{
  position:sticky;
  top:0;
  z-index:11;
  background:#e8f5ec;               /* verde muy suave */
  border-bottom:1px solid #d7dbdf;   /* división header/filtros */
}

/* Fila de filtros (2ª fila del thead) */
#tablaStock thead.sticky-top tr.filter-row th{
  position:sticky;
  top:42px;                          /* altura aprox de la fila de títulos */
  z-index:10;
  background:#f4fbf6;
  border-top:1px solid #d9f3e0;
  border-bottom:1px solid #d7dbdf;   /* marca separación con el tbody */
  box-shadow:0 2px 3px rgba(0,0,0,.04) inset;
  padding:.35rem .5rem;
  overflow:visible;                   /* para que no se corte "Todos" */
  min-width:80px;
}

/* Controles compactos del thead */
thead .form-control-sm,
thead .form-select-sm{
  padding-top:.25rem;
  padding-bottom:.25rem;
  height:28px;
}

/* ===== Look unificado de filtros ===== */
.filter-control{
  display:block; width:100%; min-width:0; height:32px;
  padding:.25rem .5rem; box-sizing:border-box;
  border:1px solid #cfe9d7; background:#fff; border-radius:.5rem;
  font-size:.85rem; text-align:center;
  transition:border-color .15s, box-shadow .15s, background-color .15s;
}
.filter-control::placeholder{ color:#94a3b8; } /* slate-400 */
.filter-control:focus{
  border-color:#62c07b; outline:0;
  box-shadow:0 0 0 .15rem rgba(34,197,94,.15);
  background:#fcfffd;
}

/* Selects: centrado visible y flecha consistente */
select.filter-control{
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
  background-repeat:no-repeat; background-position:right .5rem center; background-size:16px 12px;
  padding-right:1.75rem;
  -moz-text-align-last:center !important;
  text-align-last:center !important;
}

/* Fuerza ancho de columnas con select estrecho */
#tablaStock col:nth-child(8){ /* Estado */
  width:120px !important;
}

/* ===== Utilidades de ancho (si prefieres estas, ya tienes col-... abajo) ===== */
.wp-5{width:5%}.wp-6{width:6%}.wp-7{width:7%}.wp-8{width:8%}
.wp-11{width:11%}.wp-12{width:12%}.wp-14{width:14%}.wp-16{width:16%}
.wp-15{width:15%}.wp-22{width:22%}

/* Paginación: ocultar filas fuera de página */
.hidden-by-pagination{ display:none !important; }

/* ===== FIX bordes duplicados vs contorno (evita "celda fantasma") ===== */
#tablaStock thead tr:first-child th{ border-top:0; }
#tablaStock tbody tr:last-child td{ border-bottom:0; }
#tablaStock tr>*:first-child{ border-left:0; }
#tablaStock tr>*:last-child{  border-right:0; }

/* Hover suave */
#tablaStock tbody tr:hover{ background:#fafafa; }

/* ===== Anchos por colgroup (mantengo tus clases existentes) ===== */
.col-codigo{width:90px}.col-nombre{width:140px}.col-descripcion{width:180px}
.col-presentacion{width:120px}.col-disponible{width:100px}.col-lote{width:110px}
.col-caducidad{width:120px}.col-estado{width:120px}.col-compra{width:100px}.col-venta{width:100px}

/* ===== Responsivo ===== */
@media (max-width:1400px){
  #tablaStock th,#tablaStock td{ padding:.4rem; font-size:.8rem; }
  .filter-control{ font-size:.8rem; padding:.2rem .4rem; }
}
@media (max-width:1200px){
  #tablaStock th:nth-child(3), #tablaStock td:nth-child(3){ max-width:150px; } /* Descripción */
}
@media (max-width:992px){
  #tablaStock th:nth-child(2), #tablaStock td:nth-child(2){ max-width:120px; } /* Nombre */
  #tablaStock th:nth-child(3), #tablaStock td:nth-child(3){ max-width:100px; } /* Descripción */
}
@media (max-width:768px){
  .table-container{ font-size:.8rem; }
  #tablaStock th,#tablaStock td{ padding:.3rem; }
}
</style>

<section class="p-3 p-md-4">
  <div class="saif-card mb-4 shadow-lg rounded-3 overflow-hidden">

    <div class="saif-card-header d-flex align-items-center justify-content-between bg-success text-white px-3 px-md-4 py-2 py-md-3">
      <h3 class="mb-0 fs-5 fs-md-4"><i class="bi bi-box-seam me-2"></i> Stock de Productos</h3>
      <span class="badge bg-light text-success px-2 px-md-3 py-1 py-md-2 fs-6 fs-md-5">SAIF</span>
    </div>

    <div class="table-container">
      <!-- OJO: sin table-borderless para que se vean las líneas internas -->
      <table class="table table-hover align-middle text-center" id="tablaStock" role="grid" aria-label="Tabla de stock">
        <colgroup>
          <col class="col-codigo">
          <col class="col-nombre">
          <col class="col-descripcion">
          <col class="col-presentacion">
          <col class="col-disponible">
          <col class="col-lote">
          <col class="col-caducidad">
          <col class="col-estado">
          <col class="col-compra">
          <col class="col-venta">
        </colgroup>

        <thead class="table-success text-dark shadow-sm sticky-top">
          <tr>
            <th scope="col">Código</th>
            <th scope="col">Nombre</th>
            <th scope="col">Descripción</th>
            <th scope="col">Presentación</th>
            <th scope="col">Disponible</th>
            <th scope="col">Lote</th>
            <th scope="col">Caducidad</th>
            <th scope="col">Estado</th>
            <th scope="col">P. Compra</th>
            <th scope="col">P. Venta</th>
          </tr>
          <!-- FILA DE FILTROS (sin 'Disponible' y sin 'Caducidad') -->
          <tr class="filter-row">
            <th><input id="f-codigo" class="form-control form-control-sm filter-control" placeholder="Filtrar"></th>
            <th><input id="f-nombre" class="form-control form-control-sm filter-control" placeholder="Filtrar"></th>
            <th><input id="f-desc"   class="form-control form-control-sm filter-control" placeholder="Filtrar"></th>
            <th><input id="f-pres"   class="form-control form-control-sm filter-control" placeholder="Filtrar"></th>
            <th></th> <!-- Disponible -->
            <th><input id="f-lote"   class="form-control form-control-sm filter-control" placeholder="Filtrar"></th>
            <th></th> <!-- Caducidad -->
            <th>
              <select id="f-estado" class="form-select form-select-sm filter-control">
                <option value="">Todos</option>
                <option value="vigente">Vigente</option>
                <option value="vencido">Vencido</option>
                <option value="otros">Otros</option>
              </select>
            </th>
            <th></th> <!-- P. Compra -->
            <th></th> <!-- P. Venta -->
          </tr>
        </thead>

        <tbody>
          {% for lote in lotes %}
          <tr data-id="{{ lote.id }}" tabindex="0" data-estado="{{ lote.id_estado_lote.nombre_estado }}">
            <td class="text-truncate">{{ lote.id_producto.codigo_producto }}</td>
            <td class="text-truncate text-capitalize">{{ lote.id_producto.nombre }}</td>
            <td class="text-truncate text-muted small">{{ lote.id_producto.descripcion|default:"—" }}</td>
            <td class="text-truncate">{{ lote.id_producto.id_presentacion.nombre_presentacion }}</td>
            <td>{{ lote.cantidad_disponible }}</td>
            <td class="text-truncate">{{ lote.numero_lote }}</td>
            <td>{{ lote.fecha_caducidad }}</td>
            <td>
              <span class="badge {% if lote.id_estado_lote.nombre_estado == 'Vigente' %}bg-success{% elif lote.id_estado_lote.nombre_estado == 'Vencido' %}bg-danger{% else %}bg-secondary{% endif %}">
                {{ lote.id_estado_lote.nombre_estado }}
              </span>
            </td>
            <td>{{ lote.precio_compra }}</td>
            <td>{{ lote.precio_venta }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="10" class="py-5 text-muted" data-empty-row>
              <i class="bi bi-inbox fs-3 d-block mb-2"></i>
              No hay lotes registrados.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="pagerStock" class="saif-pager d-flex justify-content-center align-items-center p-2"></div>

    <div class="px-3 py-3 text-center border-top bg-light">
      <button id="btnConsultar" class="btn btn-primary rounded-pill px-4 me-2 shadow-sm" disabled>
        <i class="bi bi-search"></i> Consultar
      </button>
      <!-- Exportar PDF con filtros -->
      <a href="{% url 'inventario:stock:exportar_pdf' %}" id="btnExportPdf" class="btn btn-success rounded-pill px-4 shadow-sm">
        <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
      </a>
    </div>
  </div>
</section>

<!-- Modal -->
<div class="modal fade" id="modalStock" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" id="modal-stock-content"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const table        = document.getElementById("tablaStock");
  const tbody        = table.querySelector("tbody");
  const pagerEl      = document.getElementById("pagerStock");
  const modalEl      = document.getElementById("modalStock");
  const modalContent = document.getElementById("modal-stock-content");
  const modal        = new bootstrap.Modal(modalEl);

  let selectedId = null;
  const norm = (s)=> (s ?? "").toString().trim().toLowerCase();

  /* Titles auto cuando hay truncado */
  function refreshAutoTitles(){
    table.querySelectorAll("td, th").forEach(el=>{
      if (el.scrollWidth > el.clientWidth) el.setAttribute("title", el.textContent.trim());
      else el.removeAttribute("title");
    });
  }

  /* Modal */
  function abrirModal(url){
    modalContent.innerHTML = '<div class="p-4">Cargando…</div>';
    modal.show();
    fetch(url, { headers:{ "X-Requested-With": "XMLHttpRequest" } })
      .then(r=>r.text())
      .then(html=>{ modalContent.innerHTML = html; })
      .catch(()=>{ modalContent.innerHTML = '<div class="p-4 text-danger">Error cargando el detalle.</div>'; });
  }

  /* Selección de filas */
  function selectRow(row){
    if (!row) return;
    tbody.querySelectorAll("tr").forEach(r=>r.classList.remove("table-active"));
    row.classList.add("table-active");
    selectedId = row.getAttribute("data-id");
    document.getElementById("btnConsultar").disabled = !selectedId;
  }

  tbody.addEventListener("click",(ev)=>{
    const row = ev.target.closest("tr");
    if (!row || row.hasAttribute("data-empty-row")) return;
    selectRow(row);
  });

  tbody.addEventListener("dblclick",(ev)=>{
    const row = ev.target.closest("tr");
    if (!row || row.hasAttribute("data-empty-row")) return;
    selectRow(row);
    if (selectedId) abrirModal(`/inventario/stock/${selectedId}/consultar/`);
  });

  table.addEventListener("keydown",(ev)=>{
    const current = tbody.querySelector("tr.table-active");
    const rows = Array.from(tbody.querySelectorAll("tr"))
      .filter(r=>!r.classList.contains("hidden-by-pagination") && !r.hasAttribute("data-empty-row"));
    if (!rows.length) return;

    const idx = rows.indexOf(current);
    if (ev.key === "ArrowDown"){
      const next = rows[Math.min(rows.length-1, idx+1 >= 0 ? idx+1 : 0)];
      selectRow(next); next.focus({preventScroll:true}); ev.preventDefault();
    }else if (ev.key === "ArrowUp"){
      const prev = rows[Math.max(0, idx-1 >= 0 ? idx-1 : 0)];
      selectRow(prev); prev.focus({preventScroll:true}); ev.preventDefault();
    }else if (ev.key === "Enter" && selectedId){
      abrirModal(`/inventario/stock/${selectedId}/consultar/`); ev.preventDefault();
    }
  });

  document.getElementById("btnConsultar").addEventListener("click", ()=>{
    if (selectedId) abrirModal(`/inventario/stock/${selectedId}/consultar/`);
  });

  /* ===== Preprocesar filas para filtros ===== */
  const COL = { codigo:0, nombre:1, desc:2, pres:3, dispo:4, lote:5, cadu:6, estado:7 };

  function preprocessRows(){
    const rows = Array.from(tbody.querySelectorAll("tr")).filter(r=>!r.hasAttribute("data-empty-row"));
    rows.forEach(tr=>{
      const tds = tr.querySelectorAll("td");
      tr.dataset.codigo = norm(tds[COL.codigo]?.textContent);
      tr.dataset.nombre = norm(tds[COL.nombre]?.textContent);
      tr.dataset.desc   = norm(tds[COL.desc]?.textContent);
      tr.dataset.pres   = norm(tds[COL.pres]?.textContent);
      tr.dataset.lote   = norm(tds[COL.lote]?.textContent);

      const estadoRaw = (tr.getAttribute("data-estado") || tds[COL.estado]?.textContent || "").trim().toLowerCase();
      tr.dataset.estado = (estadoRaw === "vigente" || estadoRaw === "vencido") ? estadoRaw : "otros";
    });
  }

  /* ===== Paginación ===== */
  let currentPage = 1, pageSize = 20;
  const rowHeight = 42;

  function recomputarPageSize(){
    const rect = tbody.getBoundingClientRect();
    const espacio = window.innerHeight - rect.top - 160;
    pageSize = Math.max(1, Math.floor(espacio / rowHeight));
  }
  function getDataRows(){
    return Array.from(tbody.querySelectorAll("tr"))
      .filter(tr=>!tr.hasAttribute("data-empty-row") && tr.style.display !== "none");
  }
  function applyPagination(){
    const rows = getDataRows();
    const totalPages = Math.max(1, Math.ceil(rows.length / pageSize));
    if (currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage - 1) * pageSize;
    const end   = start + pageSize;
    rows.forEach((tr, idx)=> tr.classList.toggle("hidden-by-pagination", !(idx >= start && idx < end)));

    renderPager(totalPages);

    if (selectedId){
      const sel = rows.find(r=>r.getAttribute("data-id") === selectedId);
      if (sel && sel.classList.contains("hidden-by-pagination")){
        const firstVisible = rows.find(r=>!r.classList.contains("hidden-by-pagination"));
        if (firstVisible) selectRow(firstVisible);
      }
    }
    refreshAutoTitles();
  }
  function renderPager(totalPages){
    if (totalPages <= 1){ pagerEl.innerHTML = ""; pagerEl.style.display = "none"; return; }
    pagerEl.style.display = "flex"; pagerEl.innerHTML = "";

    const prev = document.createElement("button");
    prev.className = "btn btn-outline-secondary me-2"; prev.innerHTML = "&laquo; Anterior";
    prev.disabled = currentPage === 1; prev.onclick = ()=>{ currentPage--; applyPagination(); };

    const info = document.createElement("span");
    info.className = "align-self-center mx-3"; info.textContent = `Página ${currentPage} de ${totalPages}`;

    const next = document.createElement("button");
    next.className = "btn btn-outline-secondary ms-2"; next.innerHTML = "Siguiente &raquo;";
    next.disabled = currentPage === totalPages; next.onclick = ()=>{ currentPage++; applyPagination(); };

    pagerEl.append(prev, info, next);
  }

  /* ===== Filtros ===== */
  function installFilters(){
    const fCodigo = document.getElementById("f-codigo");
    const fNombre = document.getElementById("f-nombre");
    const fDesc   = document.getElementById("f-desc");
    const fPres   = document.getElementById("f-pres");
    const fLote   = document.getElementById("f-lote");
    const fEstado = document.getElementById("f-estado");

    const inputs = [fCodigo,fNombre,fDesc,fPres,fLote,fEstado].filter(Boolean);

    function applyFilters(){
      const codeVal = norm(fCodigo.value);
      const nameVal = norm(fNombre.value);
      const descVal = norm(fDesc.value);
      const presVal = norm(fPres.value);
      const loteVal = norm(fLote.value);
      const estVal  = fEstado.value; // "", "vigente", "vencido", "otros"

      const rows = Array.from(tbody.querySelectorAll("tr")).filter(r=>!r.hasAttribute("data-empty-row"));
      rows.forEach(tr=>{
        const ok =
          (!codeVal || tr.dataset.codigo.includes(codeVal)) &&
          (!nameVal || tr.dataset.nombre.includes(nameVal)) &&
          (!descVal || tr.dataset.desc.includes(descVal))   &&
          (!presVal || tr.dataset.pres.includes(presVal))   &&
          (!loteVal || tr.dataset.lote.includes(loteVal))   &&
          (!estVal  || tr.dataset.estado === estVal);

        tr.style.display = ok ? "" : "none";
      });

      currentPage = 1;
      applyPagination();
    }

    function debounce(fn, ms=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    inputs.forEach(inp=>{
      const ev = (inp.tagName === "SELECT") ? "change" : "input";
      const handler = (inp.tagName === "SELECT") ? applyFilters : debounce(applyFilters, 180);
      inp.addEventListener(ev, handler);
    });

    /* Exportar PDF con filtros actuales */
    document.getElementById("btnExportPdf").addEventListener("click", function(e){
      e.preventDefault();
      const base = this.getAttribute("href");
      const params = new URLSearchParams({
        codigo: fCodigo.value || "",
        nombre: fNombre.value || "",
        desc:   fDesc.value   || "",
        pres:   fPres.value   || "",
        lote:   fLote.value   || "",
        estado: fEstado.value || ""
      });
      window.location.href = `${base}?${params.toString()}`;
    });

    applyFilters();
  }

  /* Init */
  recomputarPageSize();
  preprocessRows();
  installFilters();
  applyPagination();
  refreshAutoTitles();
  window.addEventListener("resize", ()=>{ recomputarPageSize(); applyPagination(); });
});
</script>
{% endblock %}
