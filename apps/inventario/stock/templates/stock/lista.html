{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Stock de Productos · SAIF{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'lista/lista.css' %}">

<style>
  /* Contenedor principal con scroll horizontal */
  .table-container {
    overflow-x: auto;
    width: 100%;
  }
  
  /* Tabla con ancho fijo y diseño compacto */
  #tablaStock {
    table-layout: fixed;
    width: 100%;
    min-width: 1200px; /* Ancho mínimo para todas las columnas */
  }
  
  #tablaStock th, #tablaStock td {
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    vertical-align: middle;
    padding: 0.5rem;
    font-size: 0.875rem;
  }
  
  /* Encabezado pegajoso */
  #tablaStock thead.sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
    box-shadow: 0 3px 6px rgba(0,0,0,.05);
  }
  
  /* Ajustes específicos de columnas */
  .col-codigo { width: 90px; }
  .col-nombre { width: 140px; }
  .col-descripcion { width: 180px; }
  .col-presentacion { width: 120px; }
  .col-disponible { width: 80px; }
  .col-lote { width: 110px; }
  .col-caducidad { width: 120px; }
  .col-estado { width: 100px; }
  .col-compra { width: 100px; }
  .col-venta { width: 100px; }
  
  /* Mejora visual para badges */
  .badge {
    font-size: 0.75em;
    padding: 0.4em 0.6em;
  }
  
  .hidden-by-pagination { 
    display: none !important; 
  }
</style>

<section class="p-3 p-md-4">
  <div class="saif-card mb-4 shadow-lg rounded-3 overflow-hidden">

    <!-- Header -->
    <div class="saif-card-header d-flex align-items-center justify-content-between bg-success text-white px-3 px-md-4 py-2 py-md-3">
      <h3 class="mb-0 fs-5 fs-md-4"><i class="bi bi-box-seam me-2"></i> Stock de Productos</h3>
      <span class="badge bg-light text-success px-2 px-md-3 py-1 py-md-2 fs-6 fs-md-5">SAIF</span>
    </div>

    <!-- Contenedor de tabla con scroll -->
    <div class="table-container">
      <table class="table table-hover table-borderless align-middle text-center" id="tablaStock" role="grid" aria-label="Tabla de stock">
        <colgroup>
          <col class="col-codigo">
          <col class="col-nombre">
          <col class="col-descripcion">
          <col class="col-presentacion">
          <col class="col-disponible">
          <col class="col-lote">
          <col class="col-caducidad">
          <col class="col-estado">
          <col class="col-compra">
          <col class="col-venta">
        </colgroup>

        <thead class="table-success text-dark shadow-sm sticky-top">
          <tr>
            <th scope="col">Código</th>
            <th scope="col">Nombre</th>
            <th scope="col">Descripción</th>
            <th scope="col">Presentación</th>
            <th scope="col">Disponible</th>
            <th scope="col">Lote</th>
            <th scope="col">Caducidad</th>
            <th scope="col">Estado</th>
            <th scope="col">P. Compra</th>
            <th scope="col">P. Venta</th>
          </tr>
        </thead>

        <tbody>
          {% for lote in lotes %}
          <tr data-id="{{ lote.id }}" tabindex="0">
            <td class="text-truncate">{{ lote.id_producto.codigo_producto }}</td>
            <td class="text-truncate text-capitalize">{{ lote.id_producto.nombre }}</td>
            <td class="text-truncate text-muted small">{{ lote.id_producto.descripcion|default:"—" }}</td>
            <td class="text-truncate">{{ lote.id_producto.id_presentacion.nombre_presentacion }}</td>
            <td>{{ lote.cantidad_disponible }}</td>
            <td class="text-truncate">{{ lote.numero_lote }}</td>
            <td>{{ lote.fecha_caducidad }}</td>
            <td>
              <span class="badge {% if lote.id_estado_lote.nombre_estado == 'Vigente' %}bg-success{% elif lote.id_estado_lote.nombre_estado == 'Vencido' %}bg-danger{% else %}bg-secondary{% endif %}">
                {{ lote.id_estado_lote.nombre_estado }}
              </span>
            </td>
            <td>{{ lote.precio_compra }}</td>
            <td>{{ lote.precio_venta }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="10" class="py-5 text-muted" data-empty-row>
              <i class="bi bi-inbox fs-3 d-block mb-2"></i>
              No hay lotes registrados.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Paginador -->
    <div id="pagerStock" class="saif-pager"></div>

    <!-- Botones -->
    <div class="px-3 py-3 text-center border-top bg-light">
      <button id="btnConsultar" class="btn btn-primary rounded-pill px-4 me-2 shadow-sm" disabled>
        <i class="bi bi-search"></i> Consultar
      </button>
      <a href="{% url 'inventario:stock:exportar_pdf' %}" class="btn btn-success rounded-pill px-4 shadow-sm">
        <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
      </a>
    </div>
  </div>
</section>

<!-- Modal -->
<div class="modal fade" id="modalStock" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" id="modal-stock-content"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const table         = document.getElementById("tablaStock");
  const tbody         = table.querySelector("tbody");
  const pagerEl       = document.getElementById("pagerStock");
  const modalEl       = document.getElementById("modalStock");
  const modalContent  = document.getElementById("modal-stock-content");
  const modalInstance = new bootstrap.Modal(modalEl);

  let selectedId = null;
  let currentModalUrl = null;

  /* ===== Titles automáticos cuando el texto está truncado ===== */
  function refreshAutoTitles() {
    table.querySelectorAll("td, th").forEach(el => {
      if (el.scrollWidth > el.clientWidth) {
        el.setAttribute("title", el.textContent.trim());
      } else {
        el.removeAttribute("title");
      }
    });
  }

  /* ====== Modal ====== */
  function abrirModal(url) {
    currentModalUrl = url;
    modalContent.innerHTML = '<div class="p-4">Cargando…</div>';
    modalInstance.show();
    fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
      .then(r => r.text())
      .then(html => { modalContent.innerHTML = html; })
      .catch(() => { modalContent.innerHTML = '<div class="p-4 text-danger">Error cargando el detalle.</div>'; });
  }

  /* ====== Selección de fila ====== */
  function selectRow(row) {
    if (!row) return;
    tbody.querySelectorAll("tr").forEach(r => r.classList.remove("table-active"));
    row.classList.add("table-active");
    selectedId = row.getAttribute("data-id");
    document.getElementById("btnConsultar").disabled = !selectedId;
  }

  tbody.addEventListener("click", (ev) => {
    const row = ev.target.closest("tr");
    if (!row || row.hasAttribute("data-empty-row")) return;
    selectRow(row);
  });

  // Doble click = Consultar
  tbody.addEventListener("dblclick", (ev) => {
    const row = ev.target.closest("tr");
    if (!row || row.hasAttribute("data-empty-row")) return;
    selectRow(row);
    if (selectedId) abrirModal(`/inventario/stock/${selectedId}/consultar/`);
  });

  // Teclado para navegar/abrir
  table.addEventListener("keydown", (ev) => {
    const current = tbody.querySelector("tr.table-active");
    const rows = Array.from(tbody.querySelectorAll("tr"))
      .filter(r => !r.classList.contains("hidden-by-pagination") && !r.hasAttribute("data-empty-row"));
    if (!rows.length) return;

    const idx = rows.indexOf(current);
    if (ev.key === "ArrowDown") {
      const next = rows[Math.min(rows.length - 1, idx + 1 >= 0 ? idx + 1 : 0)];
      selectRow(next); next.focus({preventScroll:true});
      ev.preventDefault();
    } else if (ev.key === "ArrowUp") {
      const prev = rows[Math.max(0, idx - 1 >= 0 ? idx - 1 : 0)];
      selectRow(prev); prev.focus({preventScroll:true});
      ev.preventDefault();
    } else if (ev.key === "Enter" && selectedId) {
      abrirModal(`/inventario/stock/${selectedId}/consultar/`);
      ev.preventDefault();
    }
  });

  /* ====== Botones ====== */
  document.getElementById("btnConsultar").addEventListener("click", () => {
    if (selectedId) abrirModal(`/inventario/stock/${selectedId}/consultar/`);
  });

  /* ===== Submit universal dentro del modal ===== */
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  modalContent.addEventListener("submit", function (e) {
    const form = e.target.closest("form");
    if (!form) return;
    e.preventDefault();
    fetch(form.action || window.location.href, {
      method: "POST",
      body: new FormData(form),
      headers: { "X-Requested-With": "XMLHttpRequest", "X-CSRFToken": getCookie("csrftoken") }
    })
    .then(r => r.json())
    .then(data => {
      if (data.ok || data.success) {
        modalInstance.hide();
        window.location.reload();
      } else if (data.html) {
        modalContent.innerHTML = data.html;
      }
    })
    .catch(err => console.error(err));
  });

  /* ===== Paginación dinámica ===== */
  let currentPage = 1;
  let pageSize    = 20;
  const rowHeight = 42;

  function recomputarPageSize() {
    const rect  = tbody.getBoundingClientRect();
    const margenInf = 160;
    const espacio = window.innerHeight - rect.top - margenInf;
    pageSize = Math.max(1, Math.floor(espacio / rowHeight));
  }

  function getDataRows(){
    return Array.from(tbody.querySelectorAll("tr"))
      .filter(tr => !tr.hasAttribute("data-empty-row") && tr.style.display !== "none");
  }

  function applyPagination(){
    const rows       = getDataRows();
    const total      = rows.length;
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    if (currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage - 1) * pageSize;
    const end   = start + pageSize;

    rows.forEach((tr, idx) => {
      tr.classList.toggle("hidden-by-pagination", !(idx >= start && idx < end));
    });

    renderPager(totalPages);

    // mantener selección visible
    if (selectedId) {
      const sel = rows.find(r => r.getAttribute("data-id") === selectedId);
      if (sel && sel.classList.contains("hidden-by-pagination")) {
        const firstVisible = rows.find(r => !r.classList.contains("hidden-by-pagination"));
        if (firstVisible) selectRow(firstVisible);
      }
    }
    refreshAutoTitles();
  }

  function renderPager(totalPages){
    if (totalPages <= 1){
      pagerEl.innerHTML = "";
      pagerEl.style.display = "none";
      return;
    }
    pagerEl.style.display = "flex";
    pagerEl.innerHTML = "";

    const prev = document.createElement("button");
    prev.className = "btn btn-outline-secondary me-2";
    prev.innerHTML = "&laquo; Anterior";
    prev.disabled = currentPage === 1;
    prev.onclick = () => { currentPage--; applyPagination(); };

    const info = document.createElement("span");
    info.className = "align-self-center mx-3";
    info.textContent = `Página ${currentPage} de ${totalPages}`;

    const next = document.createElement("button");
    next.className = "btn btn-outline-secondary ms-2";
    next.innerHTML = "Siguiente &raquo;";
    next.disabled = currentPage === totalPages;
    next.onclick = () => { currentPage++; applyPagination(); };

    pagerEl.append(prev, info, next);
  }

  // Inicializar
  recomputarPageSize();
  applyPagination();
  refreshAutoTitles();

  window.addEventListener("resize", () => {
    recomputarPageSize();
    applyPagination();
  });
});
</script>
{% endblock %}