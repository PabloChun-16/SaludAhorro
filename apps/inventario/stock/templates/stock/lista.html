{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Stock de Productos · SAIF{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'lista/lista.css' %}">

<style>
.table-container{ overflow-x:auto; width:100%; scroll-padding-top:90px; max-width:100%; }

/* ====== Tabla ====== */
#tablaStock{
  table-layout:fixed; width:100%; min-width:1200px;
  border-collapse:separate; border-spacing:0;
  outline:1px solid #e3e6ea; outline-offset:-1px; border-radius:.5rem;
  margin-bottom:0; background:#fff;
}

#tablaStock th, #tablaStock td{
  overflow:hidden; white-space:nowrap; text-overflow:ellipsis; vertical-align:middle;
  padding:.5rem; font-size:.875rem; background-clip:padding-box;
  border:1px solid #e3e6ea;
}
#tablaStock tbody tr{ background:#ffffff; }
#tablaStock tbody tr:hover{ background:#fafafa; }

/* ====== Encabezado sticky ====== */
#tablaStock thead.sticky-top{ position:sticky; top:0; z-index:10; box-shadow:0 2px 4px rgba(0,0,0,.06); }
#tablaStock thead.sticky-top tr:first-child th{
  position:sticky; top:0; z-index:11; background:#e8f5ec;
  border-bottom:1px solid #d7dbdf;
}
#tablaStock thead.sticky-top tr.filter-row th{
  position:sticky; top:42px; z-index:10;
  background:#f4fbf6;
  border-top:1px solid #d9f3e0; border-bottom:1px solid #d7dbdf;
  box-shadow:0 2px 3px rgba(0,0,0,.04) inset;
  padding:.35rem .5rem; overflow:visible; min-width:80px;
}

/* ===== Controles de filtros ===== */
thead .form-control-sm, thead .form-select-sm{ padding-top:.25rem; padding-bottom:.25rem; height:28px; }

.filter-control{
  width:100%; height:32px; padding:.25rem .5rem; box-sizing:border-box;
  border:1px solid #cfe9d7; background:#fff; border-radius:.5rem;
  transition:border-color .15s, box-shadow .15s; font-size:.85rem;
}
.filter-control::placeholder{ color:#94a3b8; }
.filter-control.text-center{ text-align:center; }
.filter-control:focus{ border-color:#62c07b; outline:0; box-shadow:0 0 0 .15rem rgba(34,197,94,.15); }
select.filter-control{ padding-right:1.75rem; appearance:none; min-width:100px; }

#tablaStock thead.sticky-top tr.filter-row th .filter-wrap{ display:flex; justify-content:center; }
#tablaStock thead.sticky-top tr.filter-row th .filter-wrap>select{ width:100%; max-width:100%; }
#tablaStock thead.sticky-top tr.filter-row th select.form-select.filter-control{
  -moz-text-align-last:center !important; text-align-last:center !important; text-align:center !important;
}

/* Fuerza ancho de “Estado” */
#tablaStock col:nth-child(8){ width:120px !important; }

/* Paginación: ocultar filas fuera de página */
.hidden-by-pagination{ display:none !important; }

/* ===== Anchos (%) ===== */
.wp-5{width:5%}.wp-6{width:6%}.wp-7{width:7%}.wp-8{width:8%}
.wp-11{width:11%}.wp-12{width:12%}.wp-14{width:14%}.wp-16{width:16%}
.wp-15{width:15%}.wp-22{width:22%}

/* ===== Colorear columna "Disponible" según estado (verde/rojo) ===== */
tbody tr.estado-disponible td:nth-child(5){
  color:#0f7a3a; font-weight:600;
}
tbody tr.estado-retirado td:nth-child(5){
  color:#b91c1c; font-weight:600;
}

/* Responsive */
@media (max-width:1400px){
  #tablaStock th,#tablaStock td{ padding:.4rem; font-size:.8rem; }
  .filter-control{ font-size:.8rem; padding:.2rem .4rem; }
}
@media (max-width:1200px){
  #tablaStock th:nth-child(3), #tablaStock td:nth-child(3){ max-width:150px; }
}
@media (max-width:992px){
  #tablaStock th:nth-child(2), #tablaStock td:nth-child(2){ max-width:120px; }
  #tablaStock th:nth-child(3), #tablaStock td:nth-child(3){ max-width:100px; }
}
@media (max-width:768px){
  .table-container{ font-size:.8rem; }
  #tablaStock th,#tablaStock td{ padding:.3rem; }
}
</style>
<style>.table-container{ overflow-y:auto; }</style>
<style>
.saif-export-modal{border:0;border-radius:18px;overflow:hidden;box-shadow:0 18px 45px rgba(14,122,58,.25);}
.saif-export-modal .modal-header{background:#0f7a3a;color:#fff;border:0;padding:.85rem 1.1rem;}
.saif-export-modal .modal-footer{border:0;background:#f7fbf9;padding:.75rem 1.1rem;}

.saif-critico-modal{border:0;border-radius:18px;overflow:hidden;box-shadow:0 22px 48px rgba(14,122,58,.28);}
.saif-critico-modal .modal-header{background:#0f7a3a;color:#fff;border:0;padding:.9rem 1.1rem;}
.saif-critico-modal .modal-body{background:#f7fbf9;padding:1.1rem;}
.saif-critico-modal .modal-footer{border:0;background:#f7fbf9;padding:.75rem 1.1rem;}

.critico-layout{display:grid;gap:1rem;grid-template-columns:1fr;}
.critico-table-wrapper{max-height:320px;overflow:auto;border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:.5rem;}
.critico-chart{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:.75rem;box-shadow:0 4px 16px rgba(15,23,42,.06);}

@media(min-width:992px){
  .critico-layout{grid-template-columns:1.2fr .8fr;}
}
</style>

<section class="p-3">
  <div class="saif-card mb-4 shadow-lg rounded-3 overflow-hidden">

    <div class="saif-card-header d-flex align-items-center justify-content-between bg-success text-white px-3 py-2">
      <h3 class="mb-0 fs-6"><i class="bi bi-box-seam me-2"></i> Stock de Productos</h3>
      <span class="badge bg-light text-success px-2 py-1 fs-7">SAIF</span>
    </div>

    <div class="table-container">
      <table class="table table-hover align-middle text-center" id="tablaStock" role="grid" aria-label="Tabla de stock">
        <colgroup>
          <col class="wp-7">
          <col class="wp-15">
          <col class="wp-22">
          <col class="wp-12">
          <col class="wp-12"><!-- Disponible -->
          <col class="wp-8">
          <col class="wp-6">
          <col class="wp-6">
          <col class="wp-6">
          <col class="wp-6">
        </colgroup>

        <thead class="table-success text-dark shadow-sm sticky-top">
          <tr>
            <th scope="col">Código</th>
            <th scope="col">Nombre</th>
            <th scope="col">Descripción</th>
            <th scope="col">Presentación</th>
            <th scope="col">Disponible</th>
            <th scope="col">Lote</th>
            <th scope="col">Caducidad</th>
            <th scope="col">Estado</th>
            <th scope="col">P. Compra</th>
            <th scope="col">P. Venta</th>
          </tr>
          <tr class="filter-row">
            <th><input id="f-codigo" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-nombre" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-desc"   class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-pres"   class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th></th>
            <th><input id="f-lote"   class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th></th>
            <th>
              <div class="filter-wrap">
                <!-- Solo: Todos, Disponible (preseleccionado), Retirado -->
                <select id="f-estado" class="form-select form-select-sm filter-control text-center">
                  <option value="" selected>Todos</option>
                  {% for estado in estados_unicos %}
                    <option value="{{ estado|lower }}">{{ estado }}</option>
                  {% endfor %}
                </select>
              </div>
            </th>
            <th></th>
            <th></th>
          </tr>
        </thead>

        <tbody>
          {% for lote in lotes %}
          <tr
            data-id="{{ lote.id }}"
            tabindex="0"
            data-estado="{{ lote.id_estado_lote.nombre_estado|lower }}"
          >
            <td class="text-truncate">{{ lote.id_producto.codigo_producto }}</td>
            <td class="text-truncate text-capitalize">{{ lote.id_producto.nombre }}</td>
            <td class="text-truncate text-muted small">{{ lote.id_producto.descripcion|default:"—" }}</td>
            <td class="text-truncate">{{ lote.id_producto.id_presentacion.nombre_presentacion }}</td>
            <td>{{ lote.cantidad_disponible }}</td>
            <td class="text-truncate">{{ lote.numero_lote }}</td>
            <td>{{ lote.fecha_caducidad }}</td>
            <td>
              {# Badge verde para Disponible/Vigente; rojo para Retirado/Vencido/Devuelto #}
              {% with est=lote.id_estado_lote.nombre_estado %}
                <span class="badge
                  {% if est == 'Disponible' or est == 'Vigente' %}
                    bg-success
                  {% elif est == 'Retirado' or est == 'Vencido' or est == 'Devuelto' %}
                    bg-danger
                  {% else %}
                    bg-secondary
                  {% endif %}
                ">
                  {{ est }}
                </span>
              {% endwith %}
            </td>
            <td class="text-end">
              {% if lote.precio_compra is not None %}
                Q {{ lote.precio_compra|floatformat:2 }}
              {% else %}
                &mdash;
              {% endif %}
            </td>
            <td class="text-end">
              {% if lote.precio_venta is not None %}
                Q {{ lote.precio_venta|floatformat:2 }}
              {% else %}
                &mdash;
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="10" class="py-5 text-muted" data-empty-row>
              <i class="bi bi-inbox fs-3 d-block mb-2"></i>
              No hay lotes registrados.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="pagerStock" class="saif-pager d-flex justify-content-center align-items-center p-2" role="status" aria-live="polite"></div>

    <div class="px-3 py-3 text-center border-top bg-light">
      <button id="btnConsultar" class="btn btn-primary rounded-pill px-4 me-2 shadow-sm" disabled aria-disabled="true">
        <i class="bi bi-search"></i> Consultar
      </button>
      <button type="button"
              id="btnExportPdf"
              class="btn btn-success rounded-pill px-4 shadow-sm"
              data-export-url="{% url 'inventario:stock:exportar_pdf' %}">
        <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
      </button>
      <button id="btnReporteStockCritico" class="btn btn-warning rounded-pill px-4 shadow-sm">
        <i class="bi bi-bar-chart-line"></i> Reporte Stock Crítico
      </button>
    </div>
  </div>
</section>

<div class="modal fade" id="modalStock" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" id="modal-stock-content"></div>
  </div>
</div>

<!-- Modal Exportar PDF -->
<div class="modal fade" id="modalExportarStock" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content saif-export-modal">
      <div class="modal-header">
        <div class="saif-modal-title">
          <span class="saif-modal-icon"><i class="bi bi-funnel"></i></span>
          <span>Filtrar reporte de stock</span>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="formExportarStock" class="needs-validation" novalidate>
          <p class="small text-muted mb-3">
            Se aplicarán los filtros escritos en la tabla y puedes complementar con estas opciones antes de exportar.
          </p>
          <div class="mb-3">
            <label class="form-label fw-semibold">Estado del lote</label>
            <select class="form-select" name="estado">
              <option value="">Todos</option>
              <option value="vigente">Vigente</option>
              <option value="vencido">Vencido</option>
              <option value="otros">Otros</option>
            </select>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Caducidad desde</label>
              <input type="date" class="form-control" name="cadu_desde">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Caducidad hasta</label>
              <input type="date" class="form-control" name="cadu_hasta">
            </div>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" role="switch" id="soloDisponibles" name="solo_disponibles" value="1">
            <label class="form-check-label" for="soloDisponibles">Solo lotes con stock disponible</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light saif-btn-light" data-bs-dismiss="modal">
          <i class="bi bi-x-lg"></i> Cancelar
        </button>
        <button type="submit" form="formExportarStock" class="btn btn-success">
          <i class="bi bi-file-earmark-arrow-down"></i> Exportar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Reporte Stock Crítico -->
<div class="modal fade" id="modalReporteStockCritico" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content saif-critico-modal">
      <div class="modal-header">
        <div class="saif-modal-title">
          <span class="saif-modal-icon"><i class="bi bi-bar-chart-line"></i></span>
          <span>Productos con Stock Crítico</span>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="critico-layout">
          <div class="critico-chart">
            <canvas id="graficaStockCritico" height="260"></canvas>
          </div>
          <div class="critico-table-wrapper">
            <table class="table table-sm table-striped align-middle text-center mb-0">
              <thead class="table-light">
                <tr>
                  <th class="text-uppercase small">Código</th>
                  <th class="text-uppercase small text-start">Producto</th>
                  <th class="text-uppercase small">Stock Disponible</th>
                </tr>
              </thead>
              <tbody id="tablaStockCritico"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light saif-btn-light" data-bs-dismiss="modal">
          <i class="bi bi-x-lg"></i> Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const table        = document.getElementById("tablaStock");
  const tbody        = table.querySelector("tbody");
  const thead        = table.tHead;
  const pagerEl       = document.getElementById("pagerStock");
  const modalEl       = document.getElementById("modalStock");
  const modalContent  = document.getElementById("modal-stock-content");
  const modal         = new bootstrap.Modal(modalEl, { backdrop: "static", keyboard: false });
  const exportModalEl = document.getElementById("modalExportarStock");
  const exportModal   = exportModalEl ? new bootstrap.Modal(exportModalEl, { backdrop: "static", keyboard: false }) : null;
  const exportForm    = document.getElementById("formExportarStock");
  const exportBtn     = document.getElementById("btnExportPdf");
  const exportUrl     = exportBtn?.dataset.exportUrl || "";

  let selectedId = null;
  const norm = (s)=> (s ?? "").toString().trim().toLowerCase();
  const filterRefs = {};

  function fixStickyOffsets(){
    if(!thead) return;
    const headerRow = thead.rows[0];
    const filterRow = thead.querySelector('.filter-row');
    if(!headerRow || !filterRow) return;
    const h = headerRow.getBoundingClientRect().height;
    Array.from(filterRow.cells).forEach(th => th.style.top = `${h}px`);
  }

  function refreshAutoTitles(){
    const visibles = table.querySelectorAll('thead th, tbody tr:not(.hidden-by-pagination):not([style*="display: none"]) td');
    visibles.forEach(el=>{
      if (el.scrollWidth > el.clientWidth) el.title = el.textContent.trim();
      else el.removeAttribute("title");
    });
  }

  function isEmptyRow(tr){
    if(tr.hasAttribute('data-empty-row')) return false;
    const tds = Array.from(tr.cells);
    if(!tds.length) return true;
    return !tds.some(td => (td.textContent||'').trim() !== '' || td.querySelector('*'));
  }
  function purgeEmptyRows(){
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      if(isEmptyRow(tr)) tr.remove();
    });
  }

  function abrirModal(url){
    modalContent.innerHTML = '<div class="p-4">Cargando…</div>';
    modal.show();
    fetch(url, { headers:{ "X-Requested-With": "XMLHttpRequest" } })
      .then(r=>r.text())
      .then(html=>{ modalContent.innerHTML = html; })
      .catch(()=>{ modalContent.innerHTML = '<div class="p-4 text-danger">Error cargando el detalle.</div>'; });
  }

  function setDisabled(id, v){
    const b = document.getElementById(id);
    if(!b) return;
    b.disabled = v;
    b.setAttribute('aria-disabled', String(v));
  }
  function selectRow(row){
    if (!row) return;
    tbody.querySelectorAll("tr").forEach(r=>r.classList.remove("table-active"));
    row.classList.add("table-active");
    selectedId = row.getAttribute("data-id");
    setDisabled("btnConsultar", !selectedId);
  }

  tbody.addEventListener("click",(ev)=>{
    const row = ev.target.closest("tr");
    if (!row || row.hasAttribute("data-empty-row")) return;
    selectRow(row);
  });
  tbody.addEventListener("dblclick",(ev)=>{
    const row = ev.target.closest("tr");
    if (!row || row.hasAttribute("data-empty-row")) return;
    selectRow(row);
    if (selectedId) abrirModal(`/inventario/stock/${selectedId}/consultar/`);
  });

  function isEditable(el){
    const tag = (el.tagName || '').toLowerCase();
    return el.isContentEditable || tag === 'input' || tag === 'textarea' || tag === 'select';
  }
  table.addEventListener("keydown",(ev)=>{
    if(isEditable(ev.target)) return;
    const current = tbody.querySelector("tr.table-active");
    const rows = Array.from(tbody.querySelectorAll("tr"))
      .filter(r=>!r.classList.contains("hidden-by-pagination") && !r.hasAttribute("data-empty-row") && r.style.display !== "none");
    if (!rows.length) return;

    const idx = rows.indexOf(current);
    if (ev.key === "ArrowDown"){
      const next = rows[Math.min(rows.length-1, idx+1 >= 0 ? idx+1 : 0)];
      selectRow(next); next?.focus?.({preventScroll:true}); ev.preventDefault();
    }else if (ev.key === "ArrowUp"){
      const prev = rows[Math.max(0, idx-1 >= 0 ? idx-1 : 0)];
      selectRow(prev); prev?.focus?.({preventScroll:true}); ev.preventDefault();
    }else if (ev.key === "Enter" && selectedId){
      abrirModal(`/inventario/stock/${selectedId}/consultar/`); ev.preventDefault();
    }
  });

  document.getElementById("btnConsultar")?.addEventListener("click", ()=>{
    if (selectedId) abrirModal(`/inventario/stock/${selectedId}/consultar/`);
  });

  const COL = { codigo:0, nombre:1, desc:2, pres:3, dispo:4, lote:5, cadu:6, estado:7 };

 function preprocessRows(){
  const rows = Array.from(tbody.querySelectorAll("tr")).filter(r=>!r.hasAttribute("data-empty-row"));
  rows.forEach(tr=>{
    const tds = tr.querySelectorAll("td");
    tr.dataset.codigo = norm(tds[COL.codigo]?.textContent);
    tr.dataset.nombre = norm(tds[COL.nombre]?.textContent);
    tr.dataset.desc   = norm(tds[COL.desc]?.textContent);
    tr.dataset.pres   = norm(tds[COL.pres]?.textContent);
    tr.dataset.lote   = norm(tds[COL.lote]?.textContent);

    // ✅ Guardar el estado real (sin reducirlo)
    const estadoRaw = (tr.getAttribute("data-estado") || tds[COL.estado]?.textContent || "").trim().toLowerCase();
    tr.dataset.estado = estadoRaw;

    // 🔹 Colorear la columna "Disponible" según estado principal
    tr.classList.remove("estado-disponible","estado-retirado");
    if (["disponible","vigente"].includes(estadoRaw)) {
      tr.classList.add("estado-disponible");
    } else if (["retirado","vencido","devuelto"].includes(estadoRaw)) {
      tr.classList.add("estado-retirado");
    }
  });
}

/* ====== Paginación ====== */
let currentPage=1; let pageSize=15; const rowHeight=42;

function recomputarPageSize(){
  const rect=tbody.getBoundingClientRect();
  const margenInf=160;
  const espacio=window.innerHeight-rect.top-margenInf;
  pageSize=Math.max(1,Math.floor(espacio/rowHeight));
}

function getDataRows(){
  return Array.from(tbody.querySelectorAll("tr"))
    .filter(tr=>!tr.hasAttribute("data-empty-row") && tr.style.display!=="none");
}

function renderPager(totalPages){
  if(totalPages<=1){
    pagerEl.innerHTML="";
    pagerEl.style.display="none";
    return;
  }

  pagerEl.style.display="flex";
  pagerEl.classList.add("justify-content-center","align-items-center","py-3","gap-3");
  pagerEl.innerHTML="";

  const prev=document.createElement("button");
  prev.className="btn btn-success btn-sm rounded-pill shadow-sm px-3";
  prev.innerHTML="<i class='bi bi-chevron-left me-1'></i> Anterior";
  prev.disabled=currentPage===1;
  prev.onclick=()=>{ currentPage--; applyPagination(); };

  const info=document.createElement("span");
  info.className="fw-semibold text-success small";
  info.textContent=`Página ${currentPage} de ${totalPages}`;

  const next=document.createElement("button");
  next.className="btn btn-success btn-sm rounded-pill shadow-sm px-3";
  next.innerHTML="Siguiente <i class='bi bi-chevron-right ms-1'></i>";
  next.disabled=currentPage===totalPages;
  next.onclick=()=>{ currentPage++; applyPagination(); };

  pagerEl.append(prev,info,next);
}

function applyPagination(){
  const rows=getDataRows();
  const total=rows.length;
  const totalPages=Math.max(1,Math.ceil(total/pageSize));
  if(currentPage>totalPages) currentPage=totalPages;

  const start=(currentPage-1)*pageSize;
  const end=start+pageSize;

  rows.forEach((tr,idx)=>{
    tr.classList.toggle("hidden-by-pagination", !(idx>=start && idx<end));
  });

  renderPager(totalPages);

  tbody.querySelectorAll('tr').forEach(tr=>tr.classList.remove('last-visible'));
  const visibles = rows.filter(r=>!r.classList.contains('hidden-by-pagination'));
  const last = visibles[visibles.length-1];
  if(last) last.classList.add('last-visible');

  if(selectedId){
    const sel=rows.find(r=>r.getAttribute("data-id")===selectedId);
    if(sel && sel.classList.contains("hidden-by-pagination")){
      const firstVisible=rows.find(r=>!r.classList.contains("hidden-by-pagination"));
      if(firstVisible) selectRow(firstVisible);
    }
  }

  refreshAutoTitles();
}

  /* ===== Filtros ===== */
  function installFilters(){
    const fCodigo = filterRefs.codigo = document.getElementById("f-codigo");
    const fNombre = filterRefs.nombre = document.getElementById("f-nombre");
    const fDesc   = filterRefs.desc   = document.getElementById("f-desc");
    const fPres   = filterRefs.pres   = document.getElementById("f-pres");
    const fLote   = filterRefs.lote   = document.getElementById("f-lote");
    const fEstado = filterRefs.estado = document.getElementById("f-estado");

    const inputs = [fCodigo,fNombre,fDesc,fPres,fLote,fEstado].filter(Boolean);

    function applyFilters(){
      const codeVal = norm(fCodigo?.value);
      const nameVal = norm(fNombre?.value);
      const descVal = norm(fDesc?.value);
      const presVal = norm(fPres?.value);
      const loteVal = norm(fLote?.value);
      const estVal  = (fEstado?.value || "").toLowerCase();

      const rows = Array.from(tbody.querySelectorAll("tr")).filter(r=>!r.hasAttribute("data-empty-row"));
      rows.forEach(tr=>{
        const ok =
          (!codeVal || (tr.dataset.codigo||"").includes(codeVal)) &&
          (!nameVal || (tr.dataset.nombre||"").includes(nameVal)) &&
          (!descVal || (tr.dataset.desc||"").includes(descVal))   &&
          (!presVal || (tr.dataset.pres||"").includes(presVal))   &&
          (!loteVal || (tr.dataset.lote||"").includes(loteVal))   &&
          (!estVal  || (tr.dataset.estado||"") === estVal);
        tr.style.display = ok ? "" : "none";
      });

      currentPage = 1;
      recomputarPageSize();
      applyPagination();
    }

    function debounce(fn, ms=180){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    inputs.forEach(inp=>{
      const ev = (inp.tagName === "SELECT") ? "change" : "input";
      const handler = (inp.tagName === "SELECT") ? applyFilters : debounce(applyFilters, 180);
      inp.addEventListener(ev, handler);
    });

    applyFilters();
  }

  /* ===== Init ===== */
  purgeEmptyRows();
  preprocessRows();
  fixStickyOffsets();
  recomputarPageSize();
  installFilters();
  applyPagination();
  refreshAutoTitles();

  window.addEventListener("resize", ()=>{
    fixStickyOffsets();
    recomputarPageSize();
    applyPagination();
  });

  setTimeout(()=>{ fixStickyOffsets(); recomputarPageSize(); applyPagination(); }, 0);

  exportBtn?.addEventListener("click", () => {
    if (!exportModal) return;
    const estadoSelect = exportForm?.querySelector('select[name="estado"]');
    if (estadoSelect && filterRefs.estado) {
      estadoSelect.value = filterRefs.estado.value || "";
    }
    exportModal.show();
  });

  exportForm?.addEventListener("submit", (ev) => {
    ev.preventDefault();
    if (!exportUrl) return;

    const params = new URLSearchParams();
    const setIfValue = (key, el) => {
      const value = (el?.value || "").trim();
      if (value) params.set(key, value);
    };

    setIfValue("codigo", filterRefs.codigo);
    setIfValue("nombre", filterRefs.nombre);
    setIfValue("desc",   filterRefs.desc);
    setIfValue("pres",   filterRefs.pres);
    setIfValue("lote",   filterRefs.lote);

    const estadoSelect = exportForm.querySelector('select[name="estado"]');
    const estadoValue = (estadoSelect?.value || "").trim();
    if (estadoValue) {
      params.set("estado", estadoValue);
    } else if (filterRefs.estado?.value) {
      params.set("estado", filterRefs.estado.value);
    }

    const caduDesde = exportForm.querySelector('input[name="cadu_desde"]')?.value;
    const caduHasta = exportForm.querySelector('input[name="cadu_hasta"]')?.value;
    if (caduDesde) params.set("cadu_desde", caduDesde);
    if (caduHasta) params.set("cadu_hasta", caduHasta);

    const soloDisp = exportForm.querySelector('input[name="solo_disponibles"]')?.checked;
    if (soloDisp) params.set("solo_disponibles", "1");

    const qs = params.toString();
    window.location.href = qs ? `${exportUrl}?${qs}` : exportUrl;
    exportModal?.hide();
  });
});

/* Reporte Stock Crítico */
document.addEventListener("DOMContentLoaded", () => {
  const btnReporte = document.getElementById("btnReporteStockCritico");
  const modalEl    = document.getElementById("modalReporteStockCritico");
  if (!btnReporte || !modalEl) return;

  const modalInst  = new bootstrap.Modal(modalEl, { backdrop: "static", keyboard: false });

  btnReporte.addEventListener("click", () => {
    btnReporte.disabled = true;

    fetch("{% url 'inventario:stock:reporte_stock_critico' %}")
      .then(r => r.json())
      .then(data => {
        const tbody = document.getElementById("tablaStockCritico");
        tbody.innerHTML = "";

        if (Array.isArray(data) && data.length) {
          data.forEach(p => {
            const tr = document.createElement("tr");

            const tdCodigo = document.createElement("td");
            tdCodigo.textContent = p.codigo_producto || "--";

            const tdNombre = document.createElement("td");
            tdNombre.textContent = p.nombre || "Sin nombre";
            tdNombre.classList.add("text-start");

            const tdStock = document.createElement("td");
            tdStock.textContent = (p.stock_total ?? 0);

            tr.append(tdCodigo, tdNombre, tdStock);
            tbody.appendChild(tr);
          });
        } else {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 3;
          td.className = "py-4 text-muted";
          td.textContent = "No hay productos con stock crítico.";
          tr.appendChild(td);
          tbody.appendChild(tr);
        }

        const canvas = document.getElementById("graficaStockCritico");
        if (canvas) {
          const ctx = canvas.getContext("2d");
          if (window.graficaStockCritico instanceof Chart) {
            window.graficaStockCritico.destroy();
          }
          if (Array.isArray(data) && data.length) {
            window.graficaStockCritico = new Chart(ctx, {
              type: "bar",
              data: {
                labels: data.map(p => p.nombre || "Sin nombre"),
                datasets: [{
                  label: "Stock Disponible",
                  data: data.map(p => p.stock_total ?? 0),
                  backgroundColor: "#ffc107",
                  borderRadius: 6,
                }]
              },
              options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
              }
            });
          }
        }

        modalInst.show();
      })
      .catch(() => {
        const tbody = document.getElementById("tablaStockCritico");
        tbody.innerHTML = `<tr><td colspan="3" class="py-4 text-danger">No se pudo cargar el reporte.</td></tr>`;
        if (window.graficaStockCritico instanceof Chart) {
          window.graficaStockCritico.destroy();
        }
        modalInst.show();
      })
      .finally(() => {
        btnReporte.disabled = false;
      });
  });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}
