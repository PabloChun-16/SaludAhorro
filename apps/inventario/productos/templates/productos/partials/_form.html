{% load static %}

<link rel="stylesheet" href="{% static 'form/form.css' %}">

<div class="saif-modal">
  <div class="modal-header">
    <div class="saif-modal-title">
      <span class="saif-modal-icon"><i class="bi bi-box-seam"></i></span>
      <span>{{ titulo|default:"Nuevo Producto" }}</span>
    </div>
    <span class="saif-badge">SAIF</span>
  </div>

  <form method="post" id="form-producto" action="{{ action }}" novalidate autocomplete="off" enctype="multipart/form-data">
    <div class="modal-body saif-modal-body">
      {% csrf_token %}
      <div class="container-fluid">
        <div class="row g-3">

          <!-- Código y Nombre -->
          <div class="col-md-6">
            <label class="form-label">Código</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-upc-scan"></i></span>
              {{ form.codigo_producto }}
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Nombre</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-tag"></i></span>
              {{ form.nombre }}
            </div>
          </div>

          <!-- Descripción -->
          <div class="col-12">
            <label class="form-label">Descripción</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-card-text"></i></span>
              {{ form.descripcion }}
            </div>
          </div>

          <!-- Laboratorio y Presentación -->
          <div class="col-md-6">
            <label class="form-label">Laboratorio</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-buildings"></i></span>
              {{ form.id_laboratorio }}
            </div>
            <div class="mt-2 select-search-helper" data-select="#{{ form.id_laboratorio.id_for_label }}">
              <input type="text"
                     class="form-control form-control-sm select-search-input"
                     placeholder="Buscar laboratorio...">
              <div class="select-search-feedback invalid-feedback mt-1 mb-0 small d-none">
                Sin coincidencias.
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Presentación</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-box"></i></span>
              {{ form.id_presentacion }}
            </div>
            <div class="mt-2 select-search-helper" data-select="#{{ form.id_presentacion.id_for_label }}">
              <input type="text"
                     class="form-control form-control-sm select-search-input"
                     placeholder="Buscar presentación...">
              <div class="select-search-feedback invalid-feedback mt-1 mb-0 small d-none">
                Sin coincidencias.
              </div>
            </div>
          </div>

          <!-- Unidad y Condición -->
          <div class="col-md-6">
            <label class="form-label">Unidad de Medida</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-rulers"></i></span>
              {{ form.id_unidad_medida }}
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Condición de Almacenamiento</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-thermometer-half"></i></span>
              {{ form.id_condicion_almacenamiento }}
            </div>
          </div>

          <!-- Switches Mejorados -->
          <div class="col-md-6">
            <label class="form-label">¿Requiere receta?</label>
            <div class="btn-group w-100" role="group">
              <input type="radio" class="btn-check" name="requiere_receta" id="requiere_no" value="0" {% if not form.instance.requiere_receta %}checked{% endif %}>
              <label class="btn btn-outline-danger" for="requiere_no">No</label>

              <input type="radio" class="btn-check" name="requiere_receta" id="requiere_si" value="1" {% if form.instance.requiere_receta %}checked{% endif %}>
              <label class="btn btn-outline-success" for="requiere_si">Sí</label>
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">¿Es controlado?</label>
            <div class="btn-group w-100" role="group">
              <input type="radio" class="btn-check" name="es_controlado" id="controlado_no" value="0" {% if not form.instance.es_controlado %}checked{% endif %}>
              <label class="btn btn-outline-danger" for="controlado_no">No</label>

              <input type="radio" class="btn-check" name="es_controlado" id="controlado_si" value="1" {% if form.instance.es_controlado %}checked{% endif %}>
              <label class="btn btn-outline-success" for="controlado_si">Sí</label>
            </div>
          </div>

          <!-- Stock mínimo -->
          <div class="col-md-6">
            <label class="form-label">Stock Mínimo</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-boxes"></i></span>
              {{ form.stock_minimo }}
            </div>
          </div>

          <!-- Precios -->
          <div class="col-md-6">
            <label class="form-label">Precio de Compra</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-cash-coin"></i></span>
              {{ form.precio_compra }}
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Precio de Venta</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
              {{ form.precio_venta }}
            </div>
          </div>

         {# ---- Imagen del Producto ---- #}
<div class="col-12">
  <label class="form-label fw-bold">Imagen del Producto</label>

  {% if form.instance.pk %}
    {# ====== ESTÁS EDITANDO: mostrar preview + clear + input ====== #}
    <div class="img-card p-3">
      <div class="d-flex flex-wrap gap-3 align-items-start">



<div style="width:150px; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden;">
  <img id="imgPreview"
       src="{% if form.instance.imagen_url %}{{ form.instance.imagen_url.url }}{% else %}{% static 'home/img/no-image.png' %}{% endif %}"
       alt="Preview"
       style="width:100%; height:auto; display:block; object-fit:cover;">
</div>


        <!-- Controles -->
        <div class="flex-grow-1" style="min-width:280px;">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-image"></i></span>
            <input type="file"
                   name="{{ form.imagen_url.html_name }}"
                   id="id_{{ form.imagen_url.html_name }}"
                   accept="image/*"
                   class="form-control">
          </div>

          {% if form.instance.imagen_url %}
            <div class="mt-2 text-muted small">
              Actual:
              <a href="{{ form.instance.imagen_url.url }}" target="_blank" rel="noopener">
                {{ form.instance.imagen_url.name }}
              </a>
            </div>
          {% endif %}

          {% if form.imagen_url.errors %}
            <div class="invalid-feedback d-block mt-2">
              {{ form.imagen_url.errors|join:", " }}
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    {# JS solo en editar para actualizar el preview #}
    <script>
      (function(){
        const input = document.getElementById("id_{{ form.imagen_url.html_name }}");
        const img   = document.getElementById("imgPreview");
        const clear = document.getElementById("id_{{ form.imagen_url.html_name }}_clear");

        if (input) {
          input.addEventListener("change", function(e){
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            img.src = url;
            if (clear) clear.checked = false;
          });
        }
        if (clear) {
          clear.addEventListener("change", function(){
            if (this.checked) {
              img.dataset.oldsrc = img.src;
              img.src = "{% static 'home/img/no-image.png' %}";
            } else if (img.dataset.oldsrc) {
              img.src = img.dataset.oldsrc;
            }
          });
        }
      })();
    </script>

  {% else %}
    {# ====== NUEVO PRODUCTO: SOLO input limpio, SIN preview ====== #}
    <div class="input-group">
      <span class="input-group-text"><i class="bi bi-image"></i></span>
      <input type="file"
             name="{{ form.imagen_url.html_name }}"
             id="id_{{ form.imagen_url.html_name }}"
             accept="image/*"
             class="form-control">
    </div>
    {% if form.imagen_url.errors %}
      <div class="invalid-feedback d-block mt-2">
        {{ form.imagen_url.errors|join:", " }}
      </div>
    {% endif %}
  {% endif %}
</div>




    <div class="modal-footer">
      <button type="button" class="btn btn-light saif-btn-light" data-bs-dismiss="modal">
        <i class="bi bi-x-lg"></i> Cancelar
      </button>
      <button type="submit" class="btn btn-success">
        <i class="bi bi-check2-circle"></i> Guardar
      </button>
    </div>
  </form>

  <script>
    (function(){
      const normalizeValue = (value) => {
        if (value === null || value === undefined) return "";
        let text = value.toString();
        if (typeof text.normalize === "function") {
          text = text.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }
        return text.toLowerCase();
      };

      const scriptEl = document.currentScript;
      const root = scriptEl ? (scriptEl.closest(".saif-modal") || document) : document;
      root.querySelectorAll(".select-search-helper").forEach((helper) => {
        if (helper.dataset.processed === "1") return;
        helper.dataset.processed = "1";

        const selector = helper.dataset.select;
        if (!selector) return;
        const select = root.querySelector(selector);
        const input = helper.querySelector(".select-search-input");
        const feedback = helper.querySelector(".select-search-feedback");
        if (!select || !input) return;

        const options = Array.from(select.options || []).map((opt) => {
          const label = (opt.textContent || "").trim();
          return {
            el: opt,
            value: opt.value,
            label,
            lower: normalizeValue(label),
          };
        }).filter((opt) => opt.label.length);

        if (!options.length) {
          input.disabled = true;
          return;
        }

        const datalistId = helper.dataset.datalistId || `${select.id || `select_${Math.random().toString(36).slice(2)}`}_list`;
        helper.dataset.datalistId = datalistId;
        let datalist = helper.querySelector(`#${datalistId}`) || helper.querySelector("datalist");
        if (!datalist) {
          datalist = document.createElement("datalist");
          helper.appendChild(datalist);
        }
        datalist.id = datalistId;
        datalist.innerHTML = "";
        options.forEach((opt) => {
          const optionEl = document.createElement("option");
          optionEl.value = opt.label;
          datalist.appendChild(optionEl);
        });
        input.setAttribute("list", datalistId);

        const showFeedback = (hasError) => {
          input.classList.toggle("is-invalid", hasError);
          if (feedback) feedback.classList.toggle("d-none", !hasError);
        };

        const applyMatch = (match, { updateInputValue = false } = {}) => {
          if (!match) return false;
          if (updateInputValue) input.value = match.label;
          if (select.value !== match.value) {
            select.value = match.value;
            select.dispatchEvent(new Event("change", { bubbles: true }));
          }
          showFeedback(false);
          return true;
        };

        const syncFromSelect = () => {
          const current = options.find((opt) => opt.value === select.value);
          input.value = current ? current.label : "";
          showFeedback(false);
        };

        input.addEventListener("input", () => {
          const raw = input.value;
          const norm = normalizeValue(raw);
          if (!norm) {
            select.value = "";
            select.dispatchEvent(new Event("change", { bubbles: true }));
            showFeedback(false);
            return;
          }
          const exact = options.find((opt) => opt.lower === norm);
          const partial = exact || options.find((opt) => opt.lower.includes(norm));
          if (partial) {
            applyMatch(partial, { updateInputValue: false });
          } else {
            showFeedback(true);
          }
        });

        input.addEventListener("change", () => {
          const raw = input.value;
          const norm = normalizeValue(raw);
          if (!norm) {
            select.value = "";
            select.dispatchEvent(new Event("change", { bubbles: true }));
            showFeedback(false);
            return;
          }
          const match = options.find((opt) => opt.lower === norm) || options.find((opt) => opt.lower.includes(norm));
          if (!applyMatch(match, { updateInputValue: true })) {
            showFeedback(true);
          }
        });

        input.addEventListener("blur", () => {
          const raw = input.value.trim();
          if (!raw) {
            select.value = "";
            select.dispatchEvent(new Event("change", { bubbles: true }));
            showFeedback(false);
            input.value = "";
            return;
          }
          const norm = normalizeValue(raw);
          const match = options.find((opt) => opt.lower === norm) || options.find((opt) => opt.lower.includes(norm));
          if (!applyMatch(match, { updateInputValue: true })) {
            input.value = "";
            select.value = "";
            select.dispatchEvent(new Event("change", { bubbles: true }));
            showFeedback(true);
          }
        });

        select.addEventListener("change", syncFromSelect);

        syncFromSelect();
      });
    })();
  </script>
</div>
