{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Usuarios · SAIF{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'lista/lista.css' %}">

<style>
/* ====== Contenedor con scroll ====== */
.table-container{
  overflow-x:auto;
  width:100%;
  scroll-padding-top:90px;
}

/* ====== Tabla ====== */
#tablaUsuarios{
  table-layout:fixed; width:100%; min-width:1000px;
  border-collapse:separate; border-spacing:0;
  outline:1px solid #e3e6ea; outline-offset:-1px;
  border-radius:.5rem; margin-bottom:0;
}
#tablaUsuarios th,#tablaUsuarios td{
  overflow:hidden; white-space:nowrap; text-overflow:ellipsis; vertical-align:middle;
  padding:.5rem; font-size:.875rem; background-clip:padding-box;
  border:1px solid #e3e6ea;
}
#tablaUsuarios tbody tr{ background:#ffffff; }

/* ====== Encabezados pegajosos (doble fila: títulos + filtros) ====== */
#tablaUsuarios thead.sticky-top{ position:sticky; top:0; z-index:10; box-shadow:0 2px 4px rgba(0,0,0,.06); }
#tablaUsuarios thead.sticky-top tr:first-child th{
  position:sticky; top:0; z-index:11;
  background:#e8f5ec; border-bottom:1px solid #d7dbdf;
}
#tablaUsuarios thead.sticky-top tr.filter-row th{
  position:sticky; top:42px; z-index:10; background:#f4fbf6;
  border-top:1px solid #d9f3e0; border-bottom:1px solid #d7dbdf;
  box-shadow:0 2px 3px rgba(0,0,0,.04) inset;
  padding:.35rem .5rem; overflow:visible;
}

/* ====== Controles de filtro ====== */
thead .form-control-sm, thead .form-select-sm{ padding-top:.25rem; padding-bottom:.25rem; height:28px; }
.filter-control{
  width:100%; height:32px; padding:.25rem .5rem;
  border:1px solid #cfe9d7; background:#fff; border-radius:.5rem;
  transition:border-color .15s, box-shadow .15s; font-size:.85rem; box-sizing:border-box;
}
.filter-control::placeholder{ color:#94a3b8; }
.filter-control.text-center{ text-align:center; }
.filter-control:focus{ border-color:#62c07b; outline:0; box-shadow:0 0 0 .15rem rgba(34,197,94,.15); }
#tablaUsuarios thead.sticky-top tr.filter-row th .filter-wrap{ display:flex; justify-content:center; }
#tablaUsuarios thead .filter-row th{ min-width:140px; }
#tablaUsuarios thead .filter-row th:nth-child(3){ min-width:220px; } /* Correo */

/* ====== Colgroup anchos ====== */
.wp-20{width:20%}.wp-20b{width:20%}.wp-30{width:30%}.wp-15{width:15%}.wp-15b{width:15%}

/* ====== Paginación & líneas ====== */
.hidden-by-pagination{ display:none !important; }
#tablaUsuarios thead tr:first-child th{ border-top:0; }
#tablaUsuarios tbody tr:last-child td{ border-bottom:0; }
#tablaUsuarios tr>*:first-child{ border-left:0; }
#tablaUsuarios tr>*:last-child{  border-right:0; }
#tablaUsuarios tbody tr.last-visible td{ border-bottom:0 !important; }

/* ====== Hover ====== */
#tablaUsuarios tbody tr:hover{ background:#fafafa; }
</style>

<section class="p-3">
  <div class="saif-card mb-4 shadow-lg rounded-3 overflow-hidden">
    <div class="saif-card-header d-flex align-items-center justify-content-between bg-success text-white px-3 py-2">
      <h3 class="mb-0 fs-6"><i class="bi bi-people me-2"></i> Gestión de Usuarios</h3>
      <span class="badge bg-light text-success px-2 py-1 fs-7">SAIF</span>
    </div>

    <div class="table-container">
      <table class="table table-hover align-middle text-center" id="tablaUsuarios">
        <colgroup>
          <col class="wp-20"><col class="wp-20b"><col class="wp-30"><col class="wp-15b">
        </colgroup>
        <thead class="table-success text-dark shadow-sm sticky-top">
          <tr>
            <th>Nombre</th>
            <th>Apellido</th>
            <th>Correo</th>
            <th>Rol</th>
          </tr>
          <tr class="filter-row">
            <th><input id="f-nombre"   class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-apellido" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-correo"   class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-rol"      class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
          </tr>
        </thead>

        <tbody>
          {% for u in usuarios %}
          <tr data-id="{{ u.pk }}" data-rol="{{ u.id_rol.nombre_rol|default:'' }}">
            <td class="text-capitalize text-truncate">{{ u.nombre }}</td>
            <td class="text-capitalize text-truncate">{{ u.apellido }}</td>
            <td class="text-nowrap text-truncate">
              <i class="bi bi-envelope text-muted me-1"></i>{{ u.correo_electronico }}
            </td>
            <td class="text-truncate">
              {% if u.id_rol.nombre_rol == "Administrador" %}
                <span class="badge bg-primary"><i class="bi bi-shield-lock me-1"></i>Administrador</span>
              {% elif u.id_rol.nombre_rol == "Empleado" %}
                <span class="badge bg-secondary"><i class="bi bi-person-badge me-1"></i>Empleado</span>
              {% else %}
                <span class="badge bg-info text-dark"><i class="bi bi-people me-1"></i>{{ u.id_rol.nombre_rol }}</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="py-5 text-muted" data-empty-row>
              <i class="bi bi-inbox fs-3 d-block mb-2"></i>
              No hay usuarios registrados.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="pagerUsuarios" class="saif-pager"></div>

    <div class="px-3 py-3 text-center border-top bg-light">
      <button id="btnCrear" class="btn btn-warning rounded-pill px-3 me-2 shadow-sm" data-bs-toggle="modal" data-bs-target="#modalUsuario"><i class="bi bi-plus-circle"></i> Crear</button>
      <button id="btnConsultar" class="btn btn-primary rounded-pill px-3 me-2 shadow-sm" disabled><i class="bi bi-search"></i> Consultar</button>
      <button id="btnEditar" class="btn btn-success rounded-pill px-3 me-2 shadow-sm" disabled><i class="bi bi-pencil"></i> Editar</button>
      <button id="btnEliminar" class="btn btn-danger rounded-pill px-3 shadow-sm" disabled><i class="bi bi-x-circle"></i> Eliminar</button>
    </div>
  </div>
</section>

<!-- Modal -->
<div class="modal fade" id="modalUsuario" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" id="modal-usuario-content"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const table         = document.getElementById("tablaUsuarios");
  const tbody         = table.querySelector("tbody");
  const pagerEl       = document.getElementById("pagerUsuarios");
  const modalEl       = document.getElementById('modalUsuario');
  const modalContent  = document.getElementById('modal-usuario-content');
  const modalInstance = new bootstrap.Modal(modalEl);

  let selectedId = null;

  /* ====== Helpers ====== */
  function refreshAutoTitles(){
    table.querySelectorAll("td, th").forEach(el=>{
      if(el.scrollWidth>el.clientWidth){el.setAttribute("title",el.textContent.trim())}
      else{el.removeAttribute("title")}
    });
  }
  function getCookie(name){
    let cookieValue=null;
    if(document.cookie && document.cookie!==''){
      const cookies=document.cookie.split(';');
      for(let i=0;i<cookies.length;i++){
        const cookie=cookies[i].trim();
        if(cookie.substring(0,name.length+1)===(name+'=')){
          cookieValue=decodeURIComponent(cookie.substring(name.length+1)); break;
        }
      }
    }
    return cookieValue;
  }
  function removeEmptyRows(){
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      if(tr.hasAttribute('data-empty-row')) return;
      const hasContent = Array.from(tr.cells).some(td => (td.textContent||'').trim() !== '' || td.querySelector('*'));
      if(!hasContent){ tr.remove(); }
    });
  }

  /* ====== Modal ====== */
  function abrirModal(url){
    modalContent.innerHTML = '<div class="p-4">Cargando…</div>';
    modalInstance.show();
    fetch(url,{headers:{ "X-Requested-With":"XMLHttpRequest"}})
      .then(r=>r.text()).then(html=>{modalContent.innerHTML=html})
      .catch(()=>{modalContent.innerHTML='<div class="p-4 text-danger">Error cargando el formulario.</div>'});
  }

  modalContent.addEventListener("submit",function(e){
    const form=e.target.closest("form"); if(!form) return; e.preventDefault();
    fetch(form.action||window.location.href,{
      method:"POST",
      body:new FormData(form),
      headers:{ "X-Requested-With":"XMLHttpRequest","X-CSRFToken":getCookie("csrftoken") }
    })
    .then(r=>r.json())
    .then(data=>{
      if(data.ok||data.success){ modalInstance.hide(); window.location.reload(); }
      else if(data.html){ modalContent.innerHTML=data.html; }
    })
    .catch(()=>{ modalContent.innerHTML='<div class="p-4 text-danger">Ocurrió un error. Inténtalo de nuevo.</div>'; });
  });

  /* ====== Selección de fila ====== */
  function selectRow(row){
    if(!row) return;
    tbody.querySelectorAll("tr").forEach(r=>r.classList.remove("table-active"));
    row.classList.add("table-active");
    selectedId = row.getAttribute("data-id");
    document.getElementById("btnConsultar").disabled = false;
    document.getElementById("btnEditar").disabled    = false;
    document.getElementById("btnEliminar").disabled  = false;
  }
  tbody.addEventListener("click",(ev)=>{
    const row = ev.target.closest("tr");
    if(!row || row.hasAttribute("data-empty-row")) return;
    selectRow(row);
  });
  tbody.addEventListener("dblclick",(ev)=>{
    const row = ev.target.closest("tr");
    if(!row || row.hasAttribute("data-empty-row")) return;
    selectRow(row);
    if(selectedId) abrirModal(`/mantenimiento/usuarios/${selectedId}/consultar/`);
  });

  /* ====== Accesos rápidos ====== */
  document.addEventListener('keydown', (ev)=>{
    if(ev.key==='Enter' && selectedId){
      abrirModal(`/mantenimiento/usuarios/${selectedId}/consultar/`); ev.preventDefault();
    }
    if((ev.ctrlKey||ev.metaKey) && ev.key.toLowerCase()==='e' && selectedId){
      abrirModal(`/mantenimiento/usuarios/${selectedId}/editar/`); ev.preventDefault();
    }
    if((ev.ctrlKey||ev.metaKey) && ev.key.toLowerCase()==='d' && selectedId){
      document.getElementById("btnEliminar").click(); ev.preventDefault();
    }
  });

  /* ====== Botones ====== */
  document.getElementById("btnCrear").addEventListener("click",()=>{ abrirModal(`/mantenimiento/usuarios/nuevo/`); });
  document.getElementById("btnConsultar").addEventListener("click",()=>{ if(selectedId) abrirModal(`/mantenimiento/usuarios/${selectedId}/consultar/`) });
  document.getElementById("btnEditar").addEventListener("click",()=>{ if(selectedId) abrirModal(`/mantenimiento/usuarios/${selectedId}/editar/`) });
  document.getElementById("btnEliminar").addEventListener("click",()=>{ if(selectedId) abrirModal(`/mantenimiento/usuarios/${selectedId}/eliminar/`) });

  /* ====== Paginación dinámica (idéntica a Productos) ====== */
  let currentPage=1; let pageSize=15; const rowHeight=42;
  function recomputarPageSize(){
    const rect=tbody.getBoundingClientRect();
    const margenInf=160;
    const espacio=window.innerHeight-rect.top-margenInf;
    pageSize=Math.max(1,Math.floor(espacio/rowHeight));
  }
  function getDataRows(){
    return Array.from(tbody.querySelectorAll("tr"))
      .filter(tr=>!tr.hasAttribute("data-empty-row") && tr.style.display!=="none");
  }
  function renderPager(totalPages){
    if(totalPages<=1){ pagerEl.innerHTML=""; pagerEl.style.display="none"; return; }
    pagerEl.style.display="flex"; pagerEl.innerHTML="";
    const prev=document.createElement("button");
    prev.className="btn btn-outline-secondary me-2";
    prev.innerHTML="&laquo; Anterior";
    prev.disabled=currentPage===1;
    prev.onclick=()=>{currentPage--;applyPagination();};
    const info=document.createElement("span");
    info.className="align-self-center mx-2";
    info.textContent=`Página ${currentPage} de ${totalPages}`;
    const next=document.createElement("button");
    next.className="btn btn-outline-secondary ms-2";
    next.innerHTML="Siguiente &raquo;";
    next.disabled=currentPage===totalPages;
    next.onclick=()=>{currentPage++;applyPagination();};
    pagerEl.append(prev,info,next);
  }
  function applyPagination(){
    const rows=getDataRows();
    const total=rows.length;
    const totalPages=Math.max(1,Math.ceil(total/pageSize));
    if(currentPage>totalPages) currentPage=totalPages;
    const start=(currentPage-1)*pageSize;
    const end=start+pageSize;
    rows.forEach((tr,idx)=>{ tr.classList.toggle("hidden-by-pagination", !(idx>=start && idx<end)); });

    // marcar última visible para cortar la línea inferior
    tbody.querySelectorAll('tr').forEach(tr=>tr.classList.remove('last-visible'));
    const visibles = rows.filter(r=>!r.classList.contains('hidden-by-pagination'));
    const last = visibles[visibles.length-1];
    if(last) last.classList.add('last-visible');

    // si la seleccionada quedó fuera, mover selección
    if(selectedId){
      const sel=rows.find(r=>r.getAttribute("data-id")===selectedId);
      if(sel && sel.classList.contains("hidden-by-pagination")){
        const firstVisible=rows.find(r=>!r.classList.contains("hidden-by-pagination"));
        if(firstVisible) selectRow(firstVisible);
      }
    }
    renderPager(totalPages);
    refreshAutoTitles();
  }

  /* ====== Filtros ====== */
  function installFilters(){
    const fNombre = document.getElementById("f-nombre");
    const fApellido = document.getElementById("f-apellido");
    const fCorreo = document.getElementById("f-correo");
    const fRol = document.getElementById("f-rol");
    const inputs=[fNombre,fApellido,fCorreo,fRol].filter(Boolean);
    const norm=(s)=>(s||"").toString().trim().toLowerCase();

    function applyFilters(){
      const vNom=norm(fNombre?.value), vApe=norm(fApellido?.value),
            vCor=norm(fCorreo?.value), vRol=norm(fRol?.value);
      const rows=Array.from(tbody.querySelectorAll("tr")).filter(r=>!r.hasAttribute("data-empty-row"));
      rows.forEach(tr=>{
        const tds=tr.querySelectorAll("td");
        const txt=i=>norm(tds[i]?.textContent);
        const rolAttr = norm(tr.getAttribute("data-rol"));
        const ok = (!vNom || txt(0).includes(vNom))
                && (!vApe || txt(1).includes(vApe))
                && (!vCor || txt(2).includes(vCor))
                && (!vRol || rolAttr.includes(vRol) || txt(3).includes(vRol));
        tr.style.display = ok ? "" : "none";
      });
      currentPage=1;
      applyPagination();
    }
    inputs.forEach(inp=>{
      const ev="input";
      inp.addEventListener(ev,applyFilters);
    });
  }

  /* ====== Init ====== */
  removeEmptyRows();
  recomputarPageSize();
  installFilters();
  applyPagination();
  refreshAutoTitles();

  window.addEventListener("resize",()=>{recomputarPageSize();applyPagination();});
});
</script>
{% endblock %}
