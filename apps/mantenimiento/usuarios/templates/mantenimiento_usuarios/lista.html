{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Usuarios · SAIF{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'lista/lista.css' %}">

<section class="p-6 md:p-8">

  <div class="saif-card mb-4">
    <div class="saif-card-header">
      <i class="bi bi-people"></i>
      <h3>Gestión de Usuarios</h3>
    </div>

    <!-- SOLO UNA table-wrap -->
    <div class="table-wrap">
      <table class="table table-saif align-middle text-center" id="tablaUsuarios">
        <thead>
          <tr>
            <th style="min-width: 220px;">Nombre</th>
            <th style="min-width: 220px;">Apellido</th>
            <th style="min-width: 260px;">Correo</th>
            <th style="min-width: 180px;">Rol</th>
          </tr>
          <tr class="filter-row">
            <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar Nombre"></th>
            <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar Apellido"></th>
            <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar Correo"></th>
            <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar Rol"></th>
          </tr>
        </thead>

        <tbody>
          {% for u in usuarios %}
          <tr data-id="{{ u.pk }}">
            <td class="text-capitalize">{{ u.nombre }}</td>
            <td class="text-capitalize">{{ u.apellido }}</td>
            <td class="text-nowrap">
              <i class="bi bi-envelope text-muted me-1"></i>{{ u.correo_electronico }}
            </td>
            <td>
              <span class="badge-role">
                {% if u.id_rol.nombre_rol == "Administrador" %}
                  <i class="bi bi-shield-lock me-1"></i>
                {% elif u.id_rol.nombre_rol == "Empleado" %}
                  <i class="bi bi-person-badge me-1"></i>
                {% else %}
                  <i class="bi bi-people me-1"></i>
                {% endif %}
                {{ u.id_rol.nombre_rol }}
              </span>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="py-4 text-muted">No hay usuarios registrados.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Paginador: centrado y con ancho completo -->
    <div id="pagerUsuarios" class="saif-pager"></div>

    <!-- Botones -->
    <div class="px-3 py-3 text-center">
      <button id="btnCrear" class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#modalUsuario">
        <i class="bi bi-plus-circle"></i> CREAR
      </button>
      <button id="btnConsultar" class="btn btn-primary me-2" disabled>
        <i class="bi bi-search"></i> CONSULTAR
      </button>
      <button id="btnEditar" class="btn btn-success me-2" disabled>
        <i class="bi bi-pencil"></i> EDITAR
      </button>
      <button id="btnEliminar" class="btn btn-danger" disabled>
        <i class="bi bi-x-circle"></i> ELIMINAR
      </button>
    </div>
  </div>

</section>

<!-- Modal bootstrap -->
<div class="modal fade" id="modalUsuario" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" id="modal-usuario-content"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}

{{ block.super }}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const table         = document.getElementById("tablaUsuarios");
  const inputs        = table.querySelectorAll("thead input");
  const tbody         = table.querySelector("tbody");
  const pagerEl       = document.getElementById("pagerUsuarios");
  const modalEl       = document.getElementById('modalUsuario');
  const modalContent  = document.getElementById('modal-usuario-content');
  const modalInstance = new bootstrap.Modal(modalEl);

  let selectedUserId = null;
  let currentModalUrl = null;

  /* ---------- Filtros por columna ---------- */
  inputs.forEach((input, i) => {
    input.addEventListener("keyup", function () {
      const filtro = input.value.toLowerCase();
      const filas = tbody.querySelectorAll("tr");
      filas.forEach(fila => {
        if (fila.hasAttribute("data-empty-row")) return;
        const celda = fila.cells[i];
        if (!celda) return;
        const texto = celda.textContent.toLowerCase();
        fila.style.display = texto.includes(filtro) ? "" : "none";
      });
      currentPage = 1;
      recomputarPageSize();
      applyPagination();
    });
  });

  /* ---------- Selección de fila ---------- */
  tbody.addEventListener("click", (ev) => {
    const row = ev.target.closest("tr");
    if (!row || row.hasAttribute("data-empty-row")) return;
    tbody.querySelectorAll("tr").forEach(r => r.classList.remove("table-active"));
    row.classList.add("table-active");
    selectedUserId = row.getAttribute("data-id");
    document.getElementById("btnConsultar").disabled = false;
    document.getElementById("btnEditar").disabled    = false;
    document.getElementById("btnEliminar").disabled  = false;
  });

  /* ---------- Abrir modal y cargar parcial ---------- */
  function abrirModal(url) {
    currentModalUrl = url;
    modalContent.innerHTML = '<div class="p-4">Cargando…</div>';
    modalInstance.show();

    fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
      .then(r => r.text())
      .then(html => { modalContent.innerHTML = html; })
      .catch(() => { modalContent.innerHTML = '<div class="p-4 text-danger">Error cargando el formulario.</div>'; });
  }

  modalEl.addEventListener('hidden.bs.modal', () => {
    currentModalUrl = null;
    modalContent.innerHTML = '';
  });

  /* ---------- Envío del form del modal (delegación) ---------- */
  modalContent.addEventListener('submit', function (e) {
    const form = e.target.closest('form');
    if (!form) return;
    e.preventDefault();

    const formData = new FormData(form);
    const actionUrl = form.getAttribute('action') || currentModalUrl;

    fetch(actionUrl, {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(async (r) => {
      if (r.ok) return r.json();              // { ok: true }
      const data = await r.json().catch(() => ({})); // { ok:false, html:'...' }
      if (data.html) modalContent.innerHTML = data.html;
      throw new Error('validation');
    })
    .then((data) => { if (data.ok) window.location.reload(); })
    .catch((err) => {
      if (err.message !== 'validation') {
        modalContent.innerHTML = '<div class="p-4 text-danger">Ocurrió un error. Inténtalo de nuevo.</div>';
      }
    });
  });

  /* ---------- Botones ---------- */
  document.getElementById("btnCrear").addEventListener("click", () => {
    abrirModal(`/mantenimiento/usuarios/nuevo/`);
  });
  document.getElementById("btnConsultar").addEventListener("click", () => {
    if (selectedUserId) abrirModal(`/mantenimiento/usuarios/${selectedUserId}/consultar/`);
  });
  document.getElementById("btnEditar").addEventListener("click", () => {
    if (selectedUserId) abrirModal(`/mantenimiento/usuarios/${selectedUserId}/editar/`);
  });
  document.getElementById("btnEliminar").addEventListener("click", () => {
    if (selectedUserId) abrirModal(`/mantenimiento/usuarios/${selectedUserId}/eliminar/`);
  });

  /* ---------- Paginación dinámica ---------- */
  let currentPage = 1;
  let pageSize    = 20; // valor inicial; luego se recalcula
  const rowHeight = 45; // igual a --saif-row-h del CSS

  function recomputarPageSize() {
    const rect  = tbody.getBoundingClientRect();
    const margenInf = 160; // espacio para paginador + botones (ajústalo si cambias layout)
    const espacio = window.innerHeight - rect.top - margenInf;
    pageSize = Math.max(1, Math.floor(espacio / rowHeight));
  }

  function getDataRows(){
    return Array.from(tbody.querySelectorAll("tr"))
      .filter(tr => !tr.hasAttribute("data-empty-row") && tr.style.display !== "none");
  }

  function applyPagination(){
    const rows       = getDataRows();
    const total      = rows.length;
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    if (currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage - 1) * pageSize;
    const end   = start + pageSize;

    rows.forEach((tr, idx) => {
      tr.classList.toggle("hidden-by-pagination", !(idx >= start && idx < end));
    });

    renderPager(totalPages, total);
  }

  function renderPager(totalPages, total){
    if (totalPages <= 1){
      pagerEl.innerHTML = "";
      pagerEl.style.display = "none";
      return;
    }
    pagerEl.style.display = "flex";
    pagerEl.innerHTML = "";

    const prev = document.createElement("button");
    prev.className = "page-btn";
    prev.textContent = "←";
    prev.disabled = currentPage === 1;
    prev.onclick = () => { currentPage--; applyPagination(); };

    const info = document.createElement("span");
    info.className = "info";
    info.textContent = `Página ${currentPage} de ${totalPages}`;

    const next = document.createElement("button");
    next.className = "page-btn";
    next.textContent = "→";
    next.disabled = currentPage === totalPages;
    next.onclick = () => { currentPage++; applyPagination(); };

    pagerEl.append(prev, info, next);
  }

  function rellenarHastaAbajo(){
    // elimina relleno anterior
    tbody.querySelectorAll("tr[data-empty-row]").forEach(tr => tr.remove());

    const rect  = tbody.getBoundingClientRect();
    const margenInf = 160;
    const espacio = window.innerHeight - rect.top - margenInf;

    const visibles = Array.from(tbody.querySelectorAll("tr"))
      .filter(tr => tr.style.display !== "none" && !tr.classList.contains("hidden-by-pagination"));

    const usados = visibles.length * rowHeight;
    const faltan = Math.max(0, Math.ceil((espacio - usados) / rowHeight));
    for (let i = 0; i < faltan; i++){
      const tr = document.createElement("tr");
      tr.setAttribute("data-empty-row", "true");
      tr.innerHTML = `<td colspan="4">&nbsp;</td>`;
      tbody.appendChild(tr);
    }
  }


  // Inicial: limpia posibles rellenos antiguos, calcula y pagina
tbody.querySelectorAll("tr[data-empty-row]").forEach(tr => tr.remove());
recomputarPageSize();
applyPagination();

// Recalcular en resize
window.addEventListener("resize", () => {
  recomputarPageSize();
  applyPagination();
});

// Inicial: limpia posibles rellenos antiguos, calcula y pagina
tbody.querySelectorAll("tr[data-empty-row]").forEach(tr => tr.remove());
recomputarPageSize();
applyPagination();

// Recalcular en resize
window.addEventListener("resize", () => {
  recomputarPageSize();
  applyPagination();
});

});


</script>
{% endblock %}
