<div class="saif-modal saif-modal--states">
  <style>
    /* ====== Cambiar estado (scoped al modal) ====== */
    .saif-modal--states .modal-header{
      background: linear-gradient(135deg,#0f7a3a, #0b5f2c);
      color:#fff;border-bottom:0;padding:.9rem 1rem;
    }
    .saif-modal--states .saif-badge{
      background:#e8fff1;color:#0f7a3a;font-weight:800;border-radius:999px;padding:.2rem .5rem;font-size:.72rem;
    }
    .saif-callout{
      border:1px solid #fde68a;background:linear-gradient(180deg,#fff8e1,#fff4cc);
      color:#7a5c00;border-radius:12px;padding:.8rem .9rem;box-shadow:inset 0 0 0 2px rgba(250,204,21,.08);
    }
    .state-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.9rem;margin-top:.75rem;
    }
    .state-card{
      position:relative; display:flex; gap:.65rem; align-items:center; cursor:pointer;
      border:1px solid #d7ebe0; border-radius:14px; padding:.65rem .75rem; background:#fff;
      box-shadow:0 10px 24px rgba(15,122,58,.06); transition: transform .12s ease, box-shadow .12s ease, border-color .12s;
      user-select:none;
    }
    .state-card:hover{ transform: translateY(-1px); box-shadow:0 14px 28px rgba(15,122,58,.12); }
    .state-card.is-selected{ border-color:#86efac; box-shadow:0 18px 36px rgba(15,122,58,.20); }
    .state-card.is-current::after{
      content:"Actual"; position:absolute; top:.55rem; right:.6rem; font-size:.72rem;
      background:#edf2f7; color:#475569; border-radius:999px; padding:.1rem .45rem; font-weight:700;
    }
    .state-card input[type="radio"]{ position:absolute; inset:0; opacity:0; }
    .sc-icon{
      width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;
      box-shadow:inset 0 0 0 2px rgba(15,122,58,.07); flex:0 0 40px; font-size:1rem;
    }
    .sc-icon--enviada{ background:linear-gradient(135deg,#e6f0ff,#d7e7ff); color:#2563eb; }
    .sc-icon--completada{ background:linear-gradient(135deg,#dcfce7,#c8f4d6); color:#15803d; }
    .sc-icon--cancelada{ background:linear-gradient(135deg,#ffe4e6,#ffd5d8); color:#b91c1c; }
    .sc-title{ font-weight:800; color:#0b3f2e; line-height:1; }
    .sc-desc{ font-size:.85rem; color:#334155; margin-top:.15rem; }
    .saif-modal--states .modal-footer{ background:linear-gradient(145deg,#f6fdf8 0%,#eef8f1 100%); border-top:0; }
    .saif-btn-light{ background:#f8fff9; border:1px solid #cfe9d7; color:#166534; font-weight:700; }
    .saif-btn-light:hover{ background:#ecfdf5; border-color:#a7f3d0; color:#0f7a3a; }
  </style>

  <div class="modal-header">
    <div class="saif-modal-title d-flex align-items-center gap-2">
      <span class="saif-modal-icon"><i class="bi bi-arrow-repeat"></i></span>
      <span>Cambiar estado</span>
    </div>
    <span class="saif-badge">SAIF</span>
  </div>

  <form method="post" id="formCambiarEstadoSolicitud"
        action="{% url 'solicitudes_bodega_central:solicitud_cambiar_estado' solicitud.id %}">
    {% csrf_token %}
    <div class="modal-body">
      <div class="saif-callout small">
        <strong>Notas</strong><br>
        – Puedes pasar la solicitud entre <em>Enviada</em>, <em>Completada</em> y <em>Cancelada</em> libremente.<br>
        – El estado no afecta inventario.
      </div>

      <div class="state-grid">
        {% for e in estados %}
          {% with e.nombre_estado as n %}
          <label class="state-card {% if n == actual %}is-current is-selected{% endif %}">
            <input class="form-check-input" type="radio" name="estado_id" id="e{{e.id}}" value="{{e.id}}"
                   {% if n == actual %}checked{% endif %}>
            <div class="sc-icon
                {% if n == 'Enviada' %}sc-icon--enviada
                {% elif n == 'Completada' %}sc-icon--completada
                {% else %}sc-icon--cancelada{% endif %}">
              {% if n == 'Enviada' %}
                <i class="bi bi-send-check"></i>
              {% elif n == 'Completada' %}
                <i class="bi bi-check2-circle"></i>
              {% else %}
                <i class="bi bi-x-octagon"></i>
              {% endif %}
            </div>
            <div>
              <div class="sc-title">{{ n }}</div>
              <div class="sc-desc">
                {% if n == 'Enviada' %}
                  La solicitud fue enviada y espera ser procesada por bodega.
                {% elif n == 'Completada' %}
                  El pedido de la solicitud fue enviado a la sucursal.
                {% else %}
                  La solicitud fue cancelada por la sucursal o la bodega.
                {% endif %}
              </div>
            </div>
          </label>
          {% endwith %}
        {% endfor %}
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-light saif-btn-light" data-bs-dismiss="modal">
        <i class="bi bi-x-lg"></i> Cancelar
      </button>
      <button type="submit" class="btn btn-success">
        <i class="bi bi-check2-circle"></i> Confirmar
      </button>
    </div>
  </form>

  <script>
    // Marca visualmente la tarjeta seleccionada
    (function(){
      const container = document.currentScript.closest('.saif-modal--states');
      container.querySelectorAll('.state-card input[type="radio"]').forEach(r => {
        r.addEventListener('change', () => {
          container.querySelectorAll('.state-card').forEach(c => c.classList.remove('is-selected'));
          r.closest('.state-card').classList.add('is-selected');
        });
      });
    })();
  </script>
</div>
