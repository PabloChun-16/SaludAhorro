{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Lista de Solicitudes · SAIF{% endblock %}

{% block content %}
<section class="p-3">
  <!-- ================== CARD ================== -->
  <div class="saif-card mb-4 shadow-lg rounded-3 overflow-hidden">
    <div class="saif-card-header d-flex align-items-center justify-content-between bg-success text-white px-3 py-2">
      <h3 class="mb-0 fs-6"><i class="bi bi-list-ul me-2"></i> Lista de Solicitudes</h3>
      <span class="badge bg-light text-success px-2 py-1 fs-7">SAIF</span>
    </div>

    <!-- ================== TABLA ================== -->
    <div class="table-container">
      <table class="table table-hover align-middle text-center" id="tablaSolicitudes">
        <colgroup>
          <col style="width:18%"><col style="width:22%"><col style="width:10%"><col style="width:8%">
          <col style="width:22%"><col style="width:10%"><col style="width:10%">
        </colgroup>

        <thead class="table-success text-dark shadow-sm sticky-top">
          <tr>
            <th scope="col">Documento</th>
            <th scope="col">Producto</th>
            <th scope="col">Cantidad</th>
            <th scope="col">Urgente</th>
            <th scope="col">Observaciones</th>
            <th scope="col">Estado</th>
            <th scope="col">Fecha</th>
          </tr>
          <tr class="filter-row">
            <th><input id="f-doc"  class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-prod" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-cant" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th>
              <div class="filter-wrap">
                <select id="f-urg" class="form-select form-select-sm filter-control text-center">
                  <option value="">Todos</option><option value="si">Sí</option><option value="no">No</option>
                </select>
              </div>
            </th>
            <th><input id="f-obs" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th>
              <div class="filter-wrap">
                <select id="f-estado" class="form-select form-select-sm filter-control text-center">
                  <option value="">Todos</option>
                  <option value="enviada">Enviada</option>
                  <option value="completada">Completada</option>
                  <option value="cancelada">Cancelada</option>
                </select>
              </div>
            </th>
            <th><input id="f-fecha" class="form-control form-control-sm filter-control text-center" placeholder="YYYY-MM-DD"></th>
          </tr>
        </thead>

        <tbody>
          {% for solicitud in solicitudes %}
          <tr class="fila-solicitud"
              data-id="{{ solicitud.id }}">
            <td class="text-truncate">{{ solicitud.nombre_documento }}</td>
            <td class="text-truncate">
              {% with d=solicitud.detalles.first %}
                {% if d and d.id_producto %}{{ d.id_producto.nombre }}{% else %}—{% endif %}
              {% endwith %}
            </td>
            <td class="text-truncate">
              {% with d=solicitud.detalles.first %}{{ d.cantidad_solicitada|default:"—" }}{% endwith %}
            </td>
            <td>
              {% with d=solicitud.detalles.first %}
                {% if d and d.es_urgente %}<span class="badge bg-primary">Sí</span>{% else %}<span class="badge bg-secondary">No</span>{% endif %}
              {% endwith %}
            </td>
            <td class="text-truncate">
              {% with d=solicitud.detalles.first %}{{ d.observaciones|default:"—" }}{% endwith %}
            </td>
            <td class="text-truncate">{{ solicitud.id_estado_solicitud.nombre_estado }}</td>
            <td class="text-truncate">{{ solicitud.fecha_solicitud|date:"Y-m-d H:i" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="7" class="py-5 text-muted" data-empty-row>
            <i class="bi bi-inbox fs-3 d-block mb-2"></i> No hay solicitudes registradas
          </td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="pagerSolicitudes" class="saif-pager"></div>

    <!-- ================== BOTONES (dentro del card) ================== -->
    <div class="px-3 py-3 text-center border-top bg-light">
      <button id="btnConsultar"
              class="btn btn-primary rounded-pill px-3 me-2 shadow-sm"
              disabled>
        <i class="bi bi-file-earmark-text"></i> Consultar
      </button>

      <a href="{% url 'solicitudes_bodega_central:exportar_solicitudes_pdf' %}"
         class="btn btn-success rounded-pill px-3 me-2 shadow-sm">
        <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
      </a>

      <button class="btn btn-info rounded-pill px-3 text-white shadow-sm"
              data-bs-toggle="modal" data-bs-target="#dashboardModal"
              style="background-color:#8b5cf6; border:none;">
        <i class="bi bi-bar-chart"></i> Dashboard
      </button>
      <span id="urlPatterns"
            data-obtener="{% url 'solicitudes_bodega_central:obtener_solicitud' 0 %}"
            hidden></span>
    </div>
  </div>
</section>

<!-- ====== MODAL: CONSULTAR ====== -->
<div class="modal fade saif-modal" id="consultarSolicitudModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div class="saif-modal-title">
          <span class="saif-modal-icon"><i class="bi bi-inboxes"></i></span>
          <span>Detalle de Solicitud</span>
        </div>
        <span class="saif-badge">SAIF</span>
      </div>

      <div class="modal-body p-3 p-md-4 saif-modal-body">
        <!-- Resumen compacto -->
        <div class="saif-summary row g-3 mb-4">
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="saif-info-card">
              <div class="saif-info-card__icon"><i class="bi bi-file-earmark-text"></i></div>
              <div class="w-100">
                <span class="saif-info-card__label">Documento</span>
                <span class="saif-info-card__value" id="detalleDocumento">-</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Productos de la solicitud -->
        <div class="saif-block saif-block--compact">
          <div class="saif-block__header">
            <i class="bi bi-box-seam me-2"></i> Productos de la solicitud
          </div>
          <div class="saif-block__body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle m-0 saif-table--compact">
                <thead>
                  <tr>
                    <th class="text-start">Producto</th>
                    <th class="text-center">Cantidad</th>
                    <th class="text-center">Urgente</th>
                    <th class="text-start">Observaciones</th>
                  </tr>
                </thead>
                <tbody id="detalleProductosModal"></tbody>
              </table>
            </div>
          </div>
        </div>


        <!-- Seguimiento (grid ordenado) -->
        <div class="saif-block saif-block--compact">
          <div class="saif-block__header">
            <i class="bi bi-info-circle me-2"></i> Seguimiento
          </div>
          <div class="saif-block__body">
            <div class="dv-grid --compact">
              <div class="dv --compact">
                <span class="dv__label">Estado</span>
                <div class="dv__field">
                  <span class="dv__icon"><i class="bi bi-flag"></i></span>
                  <span class="dv__value" id="detalleEstado">-</span>
                </div>
              </div>
              <div class="dv --compact">
                <span class="dv__label">Fecha</span>
                <div class="dv__field">
                  <span class="dv__icon"><i class="bi bi-calendar-event"></i></span>
                  <span class="dv__value" id="detalleFecha">-</span>
                </div>
              </div>
              <div class="dv --compact">
                <span class="dv__label">Usuario</span>
                <div class="dv__field">
                  <span class="dv__icon"><i class="bi bi-person"></i></span>
                  <span class="dv__value" id="detalleUsuario">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- /modal-body -->

      <div class="modal-footer justify-content-between saif-footer">
        <span class="text-success small fw-semibold"><i class="bi bi-shield-check me-1"></i> SAIF</span>
        <button class="btn btn-light saif-btn-light" data-bs-dismiss="modal"><i class="bi bi-x-lg"></i> Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- ================== MODAL DASHBOARD ================== -->
<div class="modal fade" id="dashboardModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div class="saif-modal-title">
          <span class="saif-modal-icon"><i class="bi bi-bar-chart"></i></span>
          <span>Dashboard de Solicitudes</span>
        </div>
      </div>

      <div class="modal-body bg-slate-50">
        <!-- Filtros -->
        <div class="grid md:grid-cols-4 gap-4 mb-4 dash-filters">  
          <div>
            <label for="filtroProducto" class="form-label fw-bold">Producto</label>
            <select id="filtroProducto" class="form-select">
              <option value="">Todos</option>
              {% for producto in productos %}
              <option value="{{ producto.nombre }}">{{ producto.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="filtroUsuario" class="form-label fw-bold">Usuario</label>
            <select id="filtroUsuario" class="form-select">
              <option value="">Todos</option>
              {% for usuario in usuarios %}
              <option value="{{ usuario.username }}">{{ usuario.username }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="filtroFechaInicio" class="form-label fw-bold">Fecha Inicio</label>
            <input type="date" id="filtroFechaInicio" class="form-control">
          </div>
          <div>
            <label for="filtroFechaFin" class="form-label fw-bold">Fecha Fin</label>
            <input type="date" id="filtroFechaFin" class="form-control">
          </div>
        </div>  

        <!-- Gráficas -->
        <div class="grid md:grid-cols-2 gap-4">
          <div class="bg-white p-3 rounded shadow">
            <h6 class="fw-bold mb-2">Solicitudes por Producto</h6>
            <canvas id="chartProductos"></canvas>
          </div>
          <div class="bg-white p-3 rounded shadow">
            <h6 class="fw-bold mb-2">Solicitudes por Usuario</h6>
            <canvas id="chartUsuarios"></canvas>
          </div>
        </div>

        <div class="bg-white p-3 rounded shadow mt-4">
          <h6 class="fw-bold mb-2">Solicitudes por Fecha</h6>
          <canvas id="chartFechas"></canvas>
        </div>
      </div>
      <div class="modal-footer justify-content-end">
        <button type="button" class="btn btn-light saif-btn-light" data-bs-dismiss="modal">
          <i class="bi bi-x-lg"></i> Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ================== ESTILOS (clon de Productos) ================== -->
<style>
.table-container{ overflow-x:auto; width:100%; scroll-padding-top:90px; }

#tablaSolicitudes{
  table-layout:fixed; width:100%; min-width:1200px;
  border-collapse:separate; border-spacing:0;
  outline:1px solid #e3e6ea; outline-offset:-1px; border-radius:.5rem; margin-bottom:0;
}
#tablaSolicitudes th,#tablaSolicitudes td{
  overflow:hidden; white-space:nowrap; text-overflow:ellipsis; vertical-align:middle;
  padding:.5rem; font-size:.875rem; background-clip:padding-box; border:1px solid #e3e6ea;
}
#tablaSolicitudes tbody tr{ background:#ffffff; }
#tablaSolicitudes tbody tr:hover{ background:#fafafa; }

#tablaSolicitudes thead.sticky-top{ position:sticky; top:0; z-index:10; box-shadow:0 2px 4px rgba(0,0,0,.06); }
#tablaSolicitudes thead.sticky-top tr:first-child th{ position:sticky; top:0; z-index:11; background:#e8f5ec; border-bottom:1px solid #d7dbdf; }
#tablaSolicitudes thead.sticky-top tr.filter-row th{
  position:sticky; top:42px; z-index:10; background:#f4fbf6;
  border-top:1px solid #d9f3e0; border-bottom:1px solid #d7dbdf; box-shadow:0 2px 3px rgba(0,0,0,.04) inset;
  padding:.35rem .5rem; overflow:visible;
}

thead .form-control-sm, thead .form-select-sm{ padding-top:.25rem; padding-bottom:.25rem; height:28px; }
.filter-control{ width:100%; height:32px; padding:.25rem .5rem; border:1px solid #cfe9d7; background:#fff; border-radius:.5rem; transition:border-color .15s, box-shadow .15s; font-size:.85rem; box-sizing:border-box; }
.filter-control::placeholder{ color:#94a3b8; }
.filter-control.text-center{ text-align:center; }
.filter-control:focus{ border-color:#62c07b; outline:0; box-shadow:0 0 0 .15rem rgba(34,197,94,.15); }
#tablaSolicitudes thead.sticky-top tr.filter-row th .filter-wrap{ display:flex; justify-content:center; }
#tablaSolicitudes thead.sticky-top tr.filter-row th .filter-wrap>select{ width:100%; max-width:100%; }
#tablaSolicitudes thead.sticky-top tr.filter-row th select.form-select.filter-control{ -moz-text-align-last:center !important; text-align-last:center !important; text-align:center !important; }

#tablaSolicitudes thead tr:first-child th{ border-top:0; }
#tablaSolicitudes tbody tr:last-child td{ border-bottom:0; }
#tablaSolicitudes tr>*:first-child{ border-left:0; }
#tablaSolicitudes tr>*:last-child{  border-right:0; }
#tablaSolicitudes tbody tr.last-visible td{ border-bottom:0 !important; }

.hidden-by-pagination{ display:none !important; }

/* Modal + tarjetas de detalle */
.saif-modal .modal-content { border:0; border-radius:18px; overflow:hidden; box-shadow:0 18px 45px rgba(14,122,58,.25); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif }
.saif-modal .modal-header { background:#0f7a3a; color:#fff; border-bottom:0; padding:.9rem 1.1rem }
#consultarSolicitudModal .saif-modal-body{background:#f6fdf8}
#consultarSolicitudModal .saif-summary .saif-info-card{display:flex;gap:.75rem;align-items:center;background:linear-gradient(145deg,#f5fbf7 0%,#e8f5ed 100%);border:1px solid rgba(207,233,215,.9);border-radius:1.05rem;padding:1rem 1.15rem;box-shadow:0 14px 26px rgba(16,122,58,.12);height:100%}
#consultarSolicitudModal .saif-info-card__icon{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#e1f8eb 0%,#c8efd8 100%);color:#0f7a3a;display:flex;align-items:center;justify-content:center;font-size:1.15rem;box-shadow:inset 0 0 0 2px rgba(15,122,58,.08)}
#consultarSolicitudModal .saif-info-card__icon--state{background:linear-gradient(135deg,#e8edff 0%,#d6dcff 100%);color:#2563eb}
#consultarSolicitudModal .saif-info-card__icon--alert{background:linear-gradient(135deg,#fff4e6 0%,#ffe1b2 100%);color:#b45309}
#consultarSolicitudModal .saif-info-card__label{display:block;font-size:.74rem;text-transform:uppercase;letter-spacing:.045em;color:#166534}
#consultarSolicitudModal .saif-info-card__value{font-size:1.05rem;font-weight:700;color:#0b3f2e}
#consultarSolicitudModal .saif-info-card__value.--empty{color:#64748b;font-style:italic}
#consultarSolicitudModal .saif-pill{display:inline-flex;align-items:center;gap:.3rem;padding:.28rem .65rem;border-radius:999px;font-weight:600;font-size:.78rem}
#consultarSolicitudModal .saif-pill--neutral{background:#eef2f7;color:#334155}
#consultarSolicitudModal .saif-pill--success{background:#dcfce7;color:#166534}
#consultarSolicitudModal .saif-pill--alert{background:#fef3c7;color:#b45309}
#consultarSolicitudModal .saif-block{background:#fff;border:1px solid #d7ebe0;border-radius:1rem;box-shadow:0 16px 32px rgba(15,122,58,.1);overflow:hidden}
#consultarSolicitudModal .saif-block--highlight{background:linear-gradient(145deg,#f4fbf6 0%,#eef7f1 100%);border-color:#cfe9d7}
#consultarSolicitudModal .saif-block__header{padding:.9rem 1.2rem;font-weight:700;color:#14532d;background:linear-gradient(145deg,#e8f5ec 0%,#dff0e4 100%);display:flex;align-items:center;gap:.6rem}
#consultarSolicitudModal .saif-block__body{padding:1rem 1.25rem;color:#0f172a;white-space:pre-wrap;font-size:.95rem}
#consultarSolicitudModal .saif-block__body.--empty{color:#64748b;font-style:italic}
#consultarSolicitudModal .saif-footer{background:linear-gradient(145deg,#f6fdf8 0%,#eef8f1 100%);border-top:0;padding:.9rem 1.3rem}
#consultarSolicitudModal .saif-btn-light{background:#f8fff9;border:1px solid #cfe9d7;color:#166534;font-weight:600}
#consultarSolicitudModal .saif-btn-light:hover{background:#ecfdf5;border-color:#a7f3d0;color:#0f7a3a}
#consultarSolicitudModal .modal-header{background:linear-gradient(135deg,#0f7a3a 0%,#0c6430 60%,#074d24 100%);}
#consultarSolicitudModal .saif-modal-title span:last-child{font-weight:700;letter-spacing:.02em;}
#consultarSolicitudModal .saif-info-card__value .saif-pill{display:inline-flex;}
/* ===== Dashboard SAIF look & feel ===== */
#dashboardModal .modal-content{
  border:0; border-radius:18px; overflow:hidden;
  box-shadow:0 22px 55px rgba(14,122,58,.25);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}
#dashboardModal .modal-header{
  background:linear-gradient(135deg,#0f7a3a 0%,#0c6430 60%,#074d24 100%);
  color:#fff; border-bottom:0; padding:.9rem 1.1rem;
}
#dashboardModal .saif-modal-title span:last-child{
  font-weight:700; letter-spacing:.02em;
}

/* Área del body */
#dashboardModal .modal-body{
  background:linear-gradient(180deg,#f6fdf8 0%,#effaf3 100%);
}

/* Filtros como “chips/cards” */
#dashboardModal .dash-filters > div{
  background:#fff; border:1px solid #d7ebe0; border-radius:.9rem;
  padding:.75rem .9rem; box-shadow:0 12px 24px rgba(15,122,58,.08);
}
#dashboardModal .dash-filters .form-label{
  font-size:.78rem; text-transform:uppercase; letter-spacing:.045em;
  color:#166534; margin-bottom:.35rem;
}
#dashboardModal .dash-filters .form-select,
#dashboardModal .dash-filters .form-control{
  border:1px solid #cfe9d7; border-radius:.6rem;
  box-shadow:none; height:38px; padding:.35rem .6rem;
}
#dashboardModal .dash-filters .form-select:focus,
#dashboardModal .dash-filters .form-control:focus{
  border-color:#62c07b; box-shadow:0 0 0 .15rem rgba(34,197,94,.15);
}

/* Tarjetas de gráficos */
#dashboardModal .bg-white.p-3.rounded.shadow{
  border-radius:1rem !important;
  border:1px solid #d7ebe0;
  box-shadow:0 16px 32px rgba(15,122,58,.1) !important;
  background:linear-gradient(145deg,#f5fbf7 0%,#e8f5ed 100%) !important;
}
#dashboardModal h6{
  font-weight:800; color:#14532d;
  margin-bottom:.75rem !important;
}

/* Altura de los charts para evitar “saltos” */
#dashboardModal canvas{ max-height: 300px; }
@media (min-width: 1200px){ #dashboardModal canvas{ max-height: 320px; } }

/* Footer del modal */
#dashboardModal .modal-footer{
  background:linear-gradient(145deg,#f6fdf8 0%,#eef8f1 100%);
  border-top:0; padding:.9rem 1.3rem;
}
</style>

<!-- ================== LIBRERÍAS ================== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ================== DATOS DESDE DJANGO ================== -->
<script>
  let solicitudesData = [];
  try { solicitudesData = JSON.parse('{{ solicitudes_json|escapejs }}'); }
  catch (e) { console.error("Error al parsear solicitudes_json:", e); }
</script>

<!-- ================== LÓGICA TABLA (clon Productos) ================== -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const modalConfig = { backdrop: "static", keyboard: false };
  const table = document.getElementById("tablaSolicitudes");
  const tbody = table.querySelector("tbody");
  const pagerEl = document.getElementById("pagerSolicitudes");
  const btnConsultar = document.getElementById("btnConsultar");
  const modalEl = document.getElementById("consultarSolicitudModal");
  const modalConsultar = modalEl ? new bootstrap.Modal(modalEl, modalConfig) : null;
  const dashboardModalEl = document.getElementById("dashboardModal");
  if (dashboardModalEl) {
    new bootstrap.Modal(dashboardModalEl, modalConfig);
  }

  let selectedId = null;
  const cleanValue = (value) => {
    const val = (value || "").toString().trim();
    const lower = val.toLowerCase();
    if (!val || val === "-" || val === "\u2014" || lower === "n/a" || lower === "none") return "";
    return val;
  };
  const normalizeText = (text = "") => {
    if (typeof text.normalize === "function") {
      return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }
    return text;
  };
  const setValue = (id, value, fallback = "-") => {
    const el = document.getElementById(id);
    if (!el) return;
    const val = cleanValue(value);
    if (val) {
      el.textContent = val;
      el.classList.remove("--empty");
    } else {
      el.textContent = fallback;
      el.classList.add("--empty");
    }
  };
  const formatDateTime = (value = "") => {
    const trimmed = value.trim();
    if (!trimmed) return "";
    const parts = trimmed.split(" ");
    const dateBits = (parts[0] || "").split("-");
    if (dateBits.length !== 3) return trimmed;
    const [year, month, day] = dateBits;
    if (!year || !month || !day) return trimmed;
    let timeLabel = "";
    if (parts[1]) {
      const bits = parts[1].split(":");
      const hh = bits[0] ? bits[0].padStart(2, "0") : "";
      const mm = bits[1] ? bits[1].padStart(2, "0") : "";
      timeLabel = hh && mm ? ` ${hh}:${mm}` : "";
    }
    return `${day}/${month}/${year}${timeLabel}`;
  };
  function selectRow(row){
    if(!row) return;
    tbody.querySelectorAll("tr").forEach(r=>r.classList.remove("table-active","table-success","bg-emerald-100"));
    row.classList.add("table-active","table-success");
    selectedId = row.getAttribute("data-id") || null;
    if(btnConsultar){
      btnConsultar.disabled = !selectedId;
      if(selectedId) btnConsultar.dataset.id = selectedId;
      else delete btnConsultar.dataset.id;
    }
  }

  tbody.addEventListener("click", (ev)=>{
    const row = ev.target.closest("tr");
    if(!row || row.hasAttribute("data-empty-row")) return;
    selectRow(row);
  });

  tbody.addEventListener("dblclick",(ev)=>{
    const row = ev.target.closest("tr");
    if(!row || row.hasAttribute("data-empty-row")) return;
    selectRow(row);
    if(btnConsultar) btnConsultar.click();
  });

  document.addEventListener("keydown",(ev)=>{
    const activeTag = (document.activeElement && document.activeElement.tagName) || "";
    if(["INPUT","SELECT","TEXTAREA"].includes(activeTag)) return;

    const rows = getDataRows().filter(r=>!r.classList.contains("hidden-by-pagination"));
    if(!rows.length) return;

    if(ev.key==="ArrowUp" || ev.key==="ArrowDown"){
      let idx = rows.findIndex(r=>r.classList.contains("table-active"));
      if(idx===-1) idx = 0;
      else idx += (ev.key==="ArrowDown" ? 1 : -1);
      idx = Math.max(0, Math.min(rows.length-1, idx));
      selectRow(rows[idx]);
      rows[idx].scrollIntoView({ block:'nearest' });
      ev.preventDefault();
      return;
    }

    if(ev.key==='Enter' && btnConsultar && !btnConsultar.disabled){
      btnConsultar.click();
      ev.preventDefault();
    }
  });

  if (btnConsultar && modalConsultar) {
    btnConsultar.addEventListener("click", async () => {
      const row = tbody.querySelector("tr.table-active");
      if (!row) { alert("Selecciona una solicitud primero."); return; }

      const id = row.getAttribute("data-id");
      try {
        const base = document.getElementById("urlPatterns")?.dataset?.obtener || "";
        // Reemplaza el 0 final (con o sin /) por el id seleccionado, sin suponer el patrón exacto
        const url  = base.replace(/\/0\/?$/, `/${id}/`);

        const r = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();

        // Cabecera
        setValue("detalleDocumento", data.documento || "-", "-");

        // Seguimiento
        (function(){
          const k = (data.estado || "").toLowerCase();
          const estadoEl = document.getElementById("detalleEstado");
          if (estadoEl) {
            let cls = "saif-pill saif-pill--neutral";
            if (["enviada","completada"].includes(k)) cls = "saif-pill saif-pill--success";
            if (["cancelada"].includes(k))           cls = "saif-pill saif-pill--alert";
            estadoEl.textContent = data.estado || "Sin estado";
            estadoEl.className   = cls;
          }
          setValue("detalleFecha", data.fecha || "-", "-");
          setValue("detalleUsuario", data.usuario || "-", "-");
        })();

        // Tabla de productos
        (function(){
          const tbodyDet = document.getElementById("detalleProductosModal");
          if (!tbodyDet) return;
          tbodyDet.innerHTML = "";
          (data.detalles || []).forEach(d=>{
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td class="text-start">${(d.producto||"")}</td>
              <td class="text-center">${d.cantidad||0}</td>
              <td class="text-center">${d.urgente ? "Sí" : "No"}</td>
              <td class="text-start">${(d.observaciones||"—")}</td>`;
            tbodyDet.appendChild(tr);
          });
          if (!tbodyDet.children.length) {
            tbodyDet.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Sin productos</td></tr>`;
          }
        })();

        modalConsultar.show();
      } catch (e) {
        console.error(e);
        alert("No se pudo consultar la solicitud.");
      }
    });
  }


  function refreshAutoTitles(){
    table.querySelectorAll("td, th").forEach(el=>{
      if(el.scrollWidth>el.clientWidth){ el.setAttribute("title", el.textContent.trim()); }
      else{ el.removeAttribute("title"); }
    });
  }

  function removeEmptyRows(){
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      if(tr.hasAttribute('data-empty-row')) return;
      const tds = Array.from(tr.cells);
      const hasContent = tds.some(td => (td.textContent||'').trim() !== '' || td.querySelector('*'));
      if(!hasContent){ tr.remove(); }
    });
  }

  /* ===== Paginación ===== */
  let currentPage=1; let pageSize=15; const rowHeight=42;

  function recomputarPageSize(){
    const rect=tbody.getBoundingClientRect();
    const margenInf=160;
    const espacio=window.innerHeight-rect.top-margenInf;
    pageSize=Math.max(1,Math.floor(espacio/rowHeight));
  }

  function getDataRows(){
    return Array.from(tbody.querySelectorAll("tr"))
      .filter(tr=>!tr.hasAttribute("data-empty-row") && tr.style.display!=="none");
  }

  function renderPager(totalPages){
    if(totalPages<=1){
      pagerEl.innerHTML=""; pagerEl.style.display="none"; return;
    }
    pagerEl.style.display="flex";
    pagerEl.classList.add("justify-content-center","align-items-center","py-3","gap-3");
    pagerEl.innerHTML="";

    const prev=document.createElement("button");
    prev.className="btn btn-success btn-sm rounded-pill shadow-sm px-3";
    prev.innerHTML="<i class='bi bi-chevron-left me-1'></i> Anterior";
    prev.disabled=currentPage===1;
    prev.onclick=()=>{ currentPage--; applyPagination(); };

    const info=document.createElement("span");
    info.className="fw-semibold text-success small";
    info.textContent=`Página ${currentPage} de ${totalPages}`;

    const next=document.createElement("button");
    next.className="btn btn-success btn-sm rounded-pill shadow-sm px-3";
    next.innerHTML="Siguiente <i class='bi bi-chevron-right ms-1'></i>";
    next.disabled=currentPage===totalPages;
    next.onclick=()=>{ currentPage++; applyPagination(); };

    pagerEl.append(prev,info,next);
  }

  function applyPagination(){
    const rows=getDataRows();
    const total=rows.length;
    const totalPages=Math.max(1,Math.ceil(total/pageSize));
    if(currentPage>totalPages) currentPage=totalPages;

    const start=(currentPage-1)*pageSize;
    const end=start+pageSize;

    rows.forEach((tr,idx)=>{
      tr.classList.toggle("hidden-by-pagination", !(idx>=start && idx<end));
    });

    renderPager(totalPages);

    tbody.querySelectorAll('tr').forEach(tr=>tr.classList.remove('last-visible'));
    const visibles = rows.filter(r=>!r.classList.contains('hidden-by-pagination'));
    const last = visibles[visibles.length-1];
    if(last) last.classList.add('last-visible');

    if(!visibles.length){
      selectedId = null;
      if(btnConsultar){
        btnConsultar.disabled = true;
        delete btnConsultar.dataset.id;
      }
    }

    if(selectedId){
      const sel=rows.find(r=>r.getAttribute("data-id")===selectedId);
      if(sel && sel.classList.contains("hidden-by-pagination")){
        const firstVisible=rows.find(r=>!r.classList.contains("hidden-by-pagination"));
        if(firstVisible) selectRow(firstVisible);
      }
    }
    refreshAutoTitles();
  }

  /* ===== Filtros ===== */
  function installFilters(){
    const fDoc=document.getElementById("f-doc");
    const fProd=document.getElementById("f-prod");
    const fCant=document.getElementById("f-cant");
    const fUrg=document.getElementById("f-urg");
    const fObs=document.getElementById("f-obs");
    const fEst=document.getElementById("f-estado");
    const fFecha=document.getElementById("f-fecha");

    const inputs=[fDoc,fProd,fCant,fUrg,fObs,fEst,fFecha].filter(Boolean);
    const norm=(s)=>(s||"").toString().trim().toLowerCase();
    const yesNo=(s)=>{ const t=norm(s).replace(/[íi]/g,"i"); if(t==="si") return "si"; if(t==="no") return "no"; return t; };

    function applyFilters(){
      const vDoc=norm(fDoc?.value), vProd=norm(fProd?.value), vCant=norm(fCant?.value),
            vUrg=yesNo(fUrg?.value), vObs=norm(fObs?.value), vEst=norm(fEst?.value),
            vFecha=norm(fFecha?.value);

      const rows=Array.from(tbody.querySelectorAll("tr")).filter(r=>!r.hasAttribute("data-empty-row"));
      rows.forEach(tr=>{
        const tds=tr.querySelectorAll("td");
        const txt=i=>norm(tds[i]?.textContent);
        const ok =
          (!vDoc   || txt(0).includes(vDoc)) &&
          (!vProd  || txt(1).includes(vProd)) &&
          (!vCant  || txt(2).includes(vCant)) &&
          (!vUrg   || yesNo(txt(3))===vUrg) &&
          (!vObs   || txt(4).includes(vObs)) &&
          (!vEst   || norm(tr.getAttribute("data-estado")||txt(5))===vEst) &&
          (!vFecha || (tr.getAttribute("data-fecha")||"").includes(vFecha));
        tr.style.display = ok ? "" : "none";
      });
      currentPage=1;
      applyPagination();
    }

    inputs.forEach(inp=>{
      const ev=(inp.tagName==="SELECT")?"change":"input";
      inp.addEventListener(ev,applyFilters);
    });
  }

  removeEmptyRows();
  recomputarPageSize();
  installFilters();
  applyPagination();
  refreshAutoTitles();

  window.addEventListener("resize",()=>{recomputarPageSize();applyPagination();});
});
</script>

<!-- ================== DASHBOARD (JSON o tabla como fallback) ================== -->
<script>
(function(){
  function parseISO(d){ return (d||"").slice(0,10); }
  function getDataFromJSON(){
    if(!Array.isArray(solicitudesData) || !solicitudesData.length) return [];
    return solicitudesData.map(x=>{
      const producto = x.producto || x.id_producto || x.id_producto__nombre || x.nombre_producto || "—";
      const usuario  = x.usuario  || x.user || x.created_by || x.creado_por || "—";
      const fechaRaw = x.fecha    || x.fecha_solicitud || x.created_at || x.creado_el || "";
      return { producto: String(producto), usuario: String(usuario), fecha: parseISO(String(fechaRaw)) };
    }).filter(d=>d.producto!=="—" || d.usuario!=="—" || d.fecha);
  }
  function getDataFromTable(){
    const rows = Array.from(document.querySelectorAll("#tablaSolicitudes tbody tr"))
      .filter(tr=>!tr.hasAttribute("data-empty-row"));
    return rows.map(tr=>{
      const producto = tr.dataset.producto || tr.cells[1]?.textContent.trim() || "—";
      const usuario  = "—"; // si no lo traes en tabla
      const fecha    = tr.dataset.fecha ? String(tr.dataset.fecha).slice(0,10) : "";
      return { producto, usuario, fecha };
    });
  }

  let baseData = getDataFromJSON();
  if(!baseData.length) baseData = getDataFromTable();

  // Autorrellenar selects si vienen vacíos
  function fillSelectOptions(select, values){
    if(!select) return;
    const current = new Set(Array.from(select.options).map(o=>o.value));
    values.forEach(v=>{
      if(v && !current.has(v)){
        const opt=document.createElement("option");
        opt.value=v; opt.textContent=v;
        select.appendChild(opt);
      }
    });
  }
  const fProd = document.getElementById("filtroProducto");
  const fUser = document.getElementById("filtroUsuario");
  fillSelectOptions(fProd, Array.from(new Set(baseData.map(d=>d.producto).filter(Boolean))));
  fillSelectOptions(fUser, Array.from(new Set(baseData.map(d=>d.usuario).filter(Boolean))));

  const modal = document.getElementById("dashboardModal");
  const fIni  = document.getElementById("filtroFechaInicio");
  const fFin  = document.getElementById("filtroFechaFin");

  let chartProductos, chartUsuarios, chartFechas;

  function filtrar(){
    let data = baseData.slice();
    if(fProd && fProd.value) data = data.filter(d=>d.producto===fProd.value);
    if(fUser && fUser.value) data = data.filter(d=>d.usuario===fUser.value);
    if(fIni  && fIni.value)  data = data.filter(d=>!d.fecha || d.fecha >= fIni.value);
    if(fFin  && fFin.value)  data = data.filter(d=>!d.fecha || d.fecha <= fFin.value);
    return data;
  }

  function destroyAll(){
    if(chartProductos){ chartProductos.destroy(); chartProductos = null; }
    if(chartUsuarios){ chartUsuarios.destroy(); chartUsuarios = null; }
    if(chartFechas){   chartFechas.destroy();   chartFechas   = null; }
  }

  function contBy(arr, key){
    const map=new Map();
    arr.forEach(o=>{
      const k=(o[key]||"—")+"";
      map.set(k,(map.get(k)||0)+1);
    });
    const labels=[...map.keys()];
    const counts=labels.map(l=>map.get(l));
    return {labels,counts};
  }

  function renderCharts(){
    const data = filtrar();
    const byProd = contBy(data,"producto");
    const byUser = contBy(data,"usuario");
    const onlyDates = data.filter(d=>d.fecha);
    const labelsDates = [...new Set(onlyDates.map(d=>d.fecha))].sort();
    const countsDates = labelsDates.map(f=> onlyDates.filter(d=>d.fecha===f).length);

    destroyAll();

    chartProductos = new Chart(document.getElementById("chartProductos"), {
      type:"bar",
      data:{ labels:byProd.labels, datasets:[{ label:"Solicitudes por Producto", data:byProd.counts, backgroundColor:"#10b981" }] },
      options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
    });

    chartUsuarios = new Chart(document.getElementById("chartUsuarios"), {
      type:"pie",
      data:{ labels:byUser.labels, datasets:[{ data:byUser.counts, backgroundColor:["#0E7A3A","#f59e0b","#ef4444","#6366f1","#14b8a6","#6b7280"] }] },
      options:{ plugins:{legend:{position:"bottom"}} }
    });

    chartFechas = new Chart(document.getElementById("chartFechas"), {
      type:"line",
      data:{ labels:labelsDates, datasets:[{ label:"Solicitudes por Fecha", data:countsDates, borderColor:"#8b5cf6", backgroundColor:"rgba(139,92,246,.2)", tension:.3, fill:true }] },
      options:{ plugins:{legend:{position:"top"}}, scales:{y:{beginAtZero:true}} }
    });
  }

  if(modal) modal.addEventListener("shown.bs.modal", renderCharts);
  [fProd,fUser,fIni,fFin].forEach(el=>{ if(el) el.addEventListener("change", renderCharts); });
})();
</script>
{% endblock %}
