{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Solicitudes · SAIF{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'lista/lista.css' %}">
<link rel="stylesheet" href="{% static 'consult/consult.css' %}">

<style>
/* =================== LISTA =================== */
.table-container{ overflow-x:auto; width:100%; scroll-padding-top:90px; }

#tablaSolicitudes{
  table-layout:fixed; width:100%; min-width:1200px;
  border-collapse:separate; border-spacing:0;
  outline:1px solid #e3e6ea; outline-offset:-1px; border-radius:.5rem; margin-bottom:0;
}
#tablaSolicitudes th,#tablaSolicitudes td{
  overflow:hidden; white-space:nowrap; text-overflow:ellipsis; vertical-align:middle;
  padding:.5rem; font-size:.875rem; background-clip:padding-box; border:1px solid #e3e6ea; color:#0f172a;
}
#tablaSolicitudes tbody tr{ background:#ffffff; }
#tablaSolicitudes tbody tr:hover{ background:#fafafa; }

#tablaSolicitudes thead.sticky-top{ position:sticky; top:0; z-index:10; box-shadow:0 2px 4px rgba(0,0,0,.06); }
#tablaSolicitudes thead.sticky-top tr:first-child th{ position:sticky; top:0; z-index:11; background:#e8f5ec; border-bottom:1px solid #d7dbdf; }
#tablaSolicitudes thead.sticky-top tr.filter-row th{
  position:sticky; top:42px; z-index:10; background:#f4fbf6;
  border-top:1px solid #d9f3e0; border-bottom:1px solid #d7dbdf; box-shadow:0 2px 3px rgba(0,0,0,.04) inset;
  padding:.35rem .5rem; overflow:visible;
}
thead .form-control-sm, thead .form-select-sm{ padding-top:.25rem; padding-bottom:.25rem; height:28px; }
.filter-control{ width:100%; height:32px; padding:.25rem .5rem; border:1px solid #cfe9d7; background:#fff; border-radius:.5rem; transition:border-color .15s, box-shadow .15s; font-size:.85rem; box-sizing:border-box; }
.filter-control::placeholder{ color:#94a3b8; }
.filter-control.text-center{ text-align:center; }
.filter-control:focus{ border-color:#62c07b; outline:0; box-shadow:0 0 0 .15rem rgba(34,197,94,.15); }
#tablaSolicitudes thead.sticky-top tr.filter-row th .filter-wrap{ display:flex; justify-content:center; }
#tablaSolicitudes thead.sticky-top tr.filter-row th .filter-wrap>select{ width:100%; max-width:100%; }
#tablaSolicitudes thead.sticky-top tr.filter-row th select.form-select.filter-control{ -moz-text-align-last:center !important; text-align-last:center !important; text-align:center !important; }

.wp-18{width:18%}.wp-26{width:26%}.wp-12{width:12%}.wp-10{width:10%}.wp-24{width:24%}.wp-10b{width:10%}
.hidden-by-pagination{ display:none !important; }

#tablaSolicitudes thead tr:first-child th{ border-top:0; }
#tablaSolicitudes tbody tr:last-child td{ border-bottom:0; }
#tablaSolicitudes tr>*:first-child{ border-left:0; }
#tablaSolicitudes tr>*:last-child{  border-right:0; }
#tablaSolicitudes tbody tr.last-visible td{ border-bottom:0 !important; }

#tablaSolicitudes tr.selected, #tablaSolicitudes tr.table-active { background-color: rgba(25,135,84,.12); }
#tablaSolicitudes tr { cursor: pointer; }

/* =============== CONSULTAR: Tarjetas y bloques =============== */
.saif-modal .modal-content{ border:0;border-radius:18px;overflow:hidden;box-shadow:0 18px 45px rgba(14,122,58,.25);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
.saif-modal .modal-header{ background:#0f7a3a;color:#fff;border-bottom:0;padding:.85rem 1rem; }
.saif-modal .btn-close.btn-close-white{ filter: invert(1); opacity:.9; }

.saif-modal-body{ background:linear-gradient(180deg,#f6fdf8 0%,#effaf3 100%); }

/* Tarjetas resumen */
.saif-summary > [class*="col"]{
  display:flex; flex-direction:column;
}
.saif-summary .saif-info-card{
  display:flex; gap:.75rem; align-items:center;
  background:linear-gradient(145deg,#f5fbf7 0%,#e8f5ed 100%);
  border:1px solid rgba(207,233,215,.9);
  border-radius:1rem; padding:.85rem 1rem;
  box-shadow:0 10px 22px rgba(16,122,58,.10);
  min-height:72px;
  width:100%;
  height:100%;
}
.saif-info-card__icon{
  width:42px; height:42px; border-radius:50%;
  background:linear-gradient(135deg,#e1f8eb 0%,#c8efd8 100%);
  color:#0f7a3a; display:flex; align-items:center; justify-content:center; font-size:1rem;
  box-shadow:inset 0 0 0 2px rgba(15,122,58,.08);
  flex: 0 0 42px;
}
.saif-info-card__icon--state{
  background:linear-gradient(135deg,#e8edff 0%,#d6dcff 100%); color:#2563eb;
}
.saif-info-card__label{
  display:block; font-size:.74rem; text-transform:uppercase; letter-spacing:.045em; color:#166534; margin-bottom:.15rem;
}
.saif-info-card__value{
  display:block; font-size:1.05rem; font-weight:700; color:#0b3f2e; max-width:100%;
  word-break:break-word; white-space:normal; line-height:1.4;
}
.saif-info-card .text-truncate{ max-width:100%; white-space:normal; word-break:break-word; }
.saif-info-card > :not(.saif-info-card__icon){ min-width:0; }

/* Modal buscar producto */
.saif-modal--search .saif-search-group{
  display:flex; align-items:center;
  border:1px solid #cfe9d7;
  border-radius:.95rem;
  background:#ffffff;
  box-shadow:0 10px 24px rgba(15,122,58,.14);
}
.saif-modal--search .saif-search-group .saif-ig{
  border:0;
  background:linear-gradient(145deg,#f4fbf6 0%,#e5f3eb 100%);
  color:#0f7a3a;
  font-weight:700;
  padding:.65rem .9rem;
}
.saif-modal--search .saif-search-group .saif-input{
  border:0;
  background:transparent;
  padding:.7rem .9rem;
  box-shadow:none;
}
.saif-modal--search .saif-search-group .saif-input:focus{
  box-shadow:none;
}
.saif-modal--search .saif-table-wrapper{
  border:1px solid #d7ebe0;
  border-radius:1rem;
  background:#ffffff;
  box-shadow:0 14px 30px rgba(15,122,58,.12);
  overflow:hidden;
}
.saif-modal--search .saif-table-scroll{ max-height:50vh; overflow:auto; }
.saif-modal--search table{ margin:0; font-size:.88rem; color:#0f172a; }
.saif-modal--search thead th{
  background:linear-gradient(145deg,#e1f5ea 0%,#d4ecdd 100%);
  color:#14532d;
  font-weight:800;
  border-bottom:1px solid #cfe9d7;
  padding:.65rem .75rem;
}
.saif-modal--search tbody td{
  padding:.6rem .75rem;
  border-color:#e5f2ea;
  vertical-align:middle;
}
.saif-modal--search tbody tr:nth-child(even){ background:#f8fffb; }
.saif-modal--search tbody tr:hover{ background:#effcf4; }

/* Chips */
.saif-pill{ display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .6rem; border-radius:999px; font-weight:700; font-size:.8rem; }
.saif-pill--success{ background:#dcfce7; color:#166534; }
.saif-pill--neutral{ background:#edf2f7; color:#334155; }
.saif-pill--warning{ background:#fef3c7; color:#92400e; }
.saif-pill--danger{ background:#fee2e2; color:#991b1b; }

/* Bloques */
.saif-block{
  background:#ffffff; border:1px solid #d7ebe0; border-radius:1rem; box-shadow:0 12px 28px rgba(15,122,58,.09); overflow:hidden;
}
.saif-block--highlight{ background:linear-gradient(145deg,#f4fbf6 0%,#eef7f1 100%); border-color:#cfe9d7; }
.saif-block__header{
  padding:.8rem 1rem; font-weight:800; color:#14532d;
  background:linear-gradient(145deg,#e8f5ec 0%,#dff0e4 100%); display:flex; align-items:center; gap:.5rem;
}
.saif-block__body{
  padding:1rem 1rem; color:#0f172a; white-space:pre-wrap; font-size:.95rem; line-height:1.35;
  word-break:break-word;
}
.saif-block__body.--empty{ color:#64748b; font-style:italic; }

/* Footer modal */
.saif-footer{ background:linear-gradient(145deg,#f6fdf8 0%,#eef8f1 100%); border-top:0; padding:.8rem 1rem; }
.saif-btn-light{ background:#f8fff9; border:1px solid #cfe9d7; color:#166534; font-weight:700; }
.saif-btn-light:hover{ background:#ecfdf5; border-color:#a7f3d0; color:#0f7a3a; }

/* =============== NUEVO: Grid limpio para “Seguimiento” =============== */
.dv-grid{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
  gap: .9rem;
  align-items:start;
}
.dv{ display:flex; flex-direction:column; gap:.35rem; }
.dv__label{ font-size:.78rem; color:#166534; font-weight:700; }
.dv__field{
  display:flex; align-items:center; gap:.6rem;
  background:#f8fafc; border:1px solid #e5e7eb; border-radius:.75rem;
  padding:.6rem .75rem;
}
.dv__icon{
  width:28px; height:28px; border-radius:999px; display:flex; align-items:center; justify-content:center;
  background:#e8f5ec; color:#0f7a3a; font-size:.9rem; flex:0 0 28px;
}
.dv__value{ font-weight:800; color:#0b3f2e; word-break:break-word; white-space:normal; line-height:1.35; }
.dv__value.--empty{ color:#64748b; font-style:italic; }

/* Aux */
.text-truncate{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

/* ======= COMPACT ======= */
.saif-block--compact .saif-block__header{ padding:.55rem .8rem; }
.saif-block--compact .saif-block__body{ padding:.55rem .8rem; }

.saif-table--compact thead th,
.saif-table--compact tbody td{ padding:.45rem .6rem !important; }

.dv-grid.--compact{ gap:.5rem; }
.dv.--compact .dv__field{ padding:.45rem .6rem; }
</style>

<section class="p-6 md:p-8">
  <div class="saif-card mb-4 shadow-lg rounded-3 overflow-hidden">
    <div class="saif-card-header d-flex align-items-center justify-content-between bg-success text-white px-3 py-2">
      <h3 class="mb-0 fs-6"><i class="bi bi-inboxes me-2"></i> Registro de Solicitudes</h3>
      <span class="badge bg-light text-success px-2 py-1 fs-7">SAIF</span>
    </div>

    <!-- ===== TABLA ===== -->
    <div class="table-container">
      <table class="table table-hover align-middle text-center" id="tablaSolicitudes">
        <colgroup>
          <col class="wp-18"><col class="wp-26"><col class="wp-12"><col class="wp-10"><col class="wp-24"><col class="wp-10b">
        </colgroup>
        <thead class="table-success text-dark shadow-sm sticky-top">
          <tr>
            <th scope="col">Documento</th>
            <th scope="col">Producto</th>
            <th scope="col">Cantidad</th>
            <th scope="col">Urgente</th>
            <th scope="col">Observaciones</th>
            <th scope="col">Estado</th>
          </tr>
          <tr class="filter-row">
            <th><input id="f-doc" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-prod" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-cant" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th>
              <div class="filter-wrap">
                <select id="f-urg" class="form-select form-select-sm filter-control text-center">
                  <option value="">Todos</option><option value="si">Sí</option><option value="no">No</option>
                </select>
              </div>
            </th>
            <th><input id="f-obs" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th>
              <div class="filter-wrap">
                <select id="f-estado" class="form-select form-select-sm filter-control text-center">
                  <option value="">Todos</option>
                  <option value="enviada">Enviada</option>
                  <option value="completada">Completada</option>
                  <option value="cancelada">Cancelada</option>
                </select>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          {% for solicitud in solicitudes %}
          {% with d=solicitud.detalles.first %}
          <tr
            data-id="{{ solicitud.id }}"
            data-documento="{{ solicitud.nombre_documento }}"
            data-producto="{% if d %}{{ d.id_producto.nombre }}{% endif %}"
            data-producto-id="{% if d %}{{ d.id_producto.id }}{% endif %}"
            data-cantidad="{% if d %}{{ d.cantidad_solicitada }}{% endif %}"
            data-urgente="{% if d and d.es_urgente %}True{% else %}False{% endif %}"
            data-observaciones="{% if d %}{{ d.observaciones|default:'—' }}{% endif %}"
            data-estado="{{ solicitud.id_estado_solicitud.nombre_estado }}"
            data-fecha="{{ solicitud.fecha_solicitud|date:'Y-m-d H:i' }}"
          >
            <td class="text-truncate fw-semibold">{{ solicitud.nombre_documento }}</td>
            <td class="text-truncate">{% if d %}{{ d.id_producto.nombre }}{% else %}—{% endif %}</td>
            <td class="text-truncate">{% if d %}{{ d.cantidad_solicitada }}{% else %}—{% endif %}</td>
            <td>
              {% if d and d.es_urgente %}
                <span class="badge bg-primary">Sí</span>
              {% else %}
                <span class="badge bg-secondary">No</span>
              {% endif %}
            </td>
            <td class="text-truncate">{% if d %}{{ d.observaciones|default:"—" }}{% else %}—{% endif %}</td>
            <td>
              {% if solicitud.id_estado_solicitud.nombre_estado == "Activo" %}
                <span class="badge bg-success">Activo</span>
              {% elif solicitud.id_estado_solicitud.nombre_estado == "Inactivo" %}
                <span class="badge bg-danger">Inactivo</span>
              {% else %}
                <span class="badge bg-secondary">{{ solicitud.id_estado_solicitud.nombre_estado }}</span>
              {% endif %}
            </td>
          </tr>
          {% endwith %}
          {% empty %}
          <tr>
            <td colspan="6" class="py-5 text-muted" data-empty-row>
              <i class="bi bi-inbox fs-3 d-block mb-2"></i>
              No hay solicitudes registradas
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="pagerSolicitudes" class="saif-pager"></div>

    <div class="px-3 py-3 text-center border-top bg-light">
      <button id="btnCrear" class="btn btn-warning rounded-pill px-3 me-2 shadow-sm">
        <i class="bi bi-plus-circle"></i> CREAR
      </button>
      <button id="btnConsultar" class="btn btn-primary rounded-pill px-3 shadow-sm" disabled>
        <i class="bi bi-search"></i> CONSULTAR
      </button>
      <button id="btnCambiarEstado"
        class="btn btn-outline-success rounded-pill px-3 shadow-sm"
        disabled>
        <i class="bi bi-arrow-repeat"></i> Cambiar estado
      </button>

      <!-- patrones de URL para JS -->
      <span id="urlPatterns"
            data-cambiar-modal="{% url 'solicitudes_bodega_central:solicitud_cambiar_estado_modal' 0 %}"
            data-obtener="{% url 'solicitudes_bodega_central:obtener_solicitud' 0 %}"
            hidden></span>
    </div>
  </div>
</section>

<!-- ====== CSRF a mano para fetch ====== -->
<form style="display:none">{% csrf_token %}</form>

<!-- ====== MODAL: CREAR ====== -->
<div class="modal fade" id="modalSolicitud" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content saif-modal">
      <div class="modal-header">
        <div class="saif-modal-title">
          <span class="saif-modal-icon"><i class="bi bi-inboxes"></i></span>
          <span>Crear Solicitud</span>
        </div>
        <span class="saif-badge">SAIF</span>
      </div>

      <div class="modal-body saif-modal-body">
        <div id="formAlertSolicitud" class="alert alert-danger d-none"></div>

        <form id="form-solicitud">
          <div class="saif-section mb-4">
            <div class="saif-section__title">
              <i class="bi bi-clipboard2-check"></i> Datos de la solicitud
            </div>
            <div class="row g-3 mt-1">
              <div class="col-md-8">
                <label class="form-label">Documento</label>
                <div class="input-group">
                  <span class="input-group-text saif-ig"><i class="bi bi-file-earmark-text"></i></span>
                  <input id="documentoInput" type="text" class="form-control saif-input" placeholder="Ej. RQ-0001" required>
                </div>
              </div>
            </div>
          </div>

          <div class="saif-section mb-3">
            <div class="saif-section__title">
              <i class="bi bi-box-seam"></i> Detalle de productos
            </div>
            <div class="mb-2 mt-2">
              <label class="form-label">Producto</label>
              <div class="input-group">
                <span class="input-group-text saif-ig"><i class="bi bi-capsule-pill"></i></span>
                <input id="productoInput" type="text" class="form-control saif-input" placeholder="Codigo o nombre..." readonly>
                <input id="productoIdInput" type="hidden">
                <button class="btn btn-outline-success saif-btn-outline" type="button" data-bs-toggle="modal" data-bs-target="#modalBuscarProducto">
                  <i class="bi bi-search"></i>
                </button>
              </div>
              <div class="form-text">Selecciona desde el buscador para evitar errores.</div>
            </div>
            <div class="row g-2 align-items-end">
              <div class="col-sm-4 col-lg-3">
                <label class="form-label">Cantidad</label>
                <div class="input-group">
                  <span class="input-group-text saif-ig"><i class="bi bi-hash"></i></span>
                  <input id="cantidadInput" type="number" class="form-control saif-input" min="1" value="1">
                </div>
              </div>
              <div class="col-sm-4 col-lg-3">
                <label class="form-label d-block">Urgente</label>
                <div class="form-check form-switch ps-0">
                  <input id="urgenteInput" class="form-check-input ms-2" type="checkbox">
                  <label class="form-check-label ms-2">Si</label>
                </div>
              </div>
              <div class="col-sm-4 col-lg-6">
                <label class="form-label">Observaciones</label>
                <input id="obsInput" type="text" class="form-control saif-input" placeholder="Opcional">
              </div>
              <div class="col-12 mt-3">
                <button type="button" class="btn btn-success w-100" id="btnAddDetalle">
                  <i class="bi bi-plus-circle"></i> Anadir
                </button>
              </div>
            </div>
            <div class="table-responsive mt-3">
              <table class="table table-hover align-middle saif-table">
                <thead>
                  <tr>
                    <th class="text-start">Producto</th>
                    <th>Cantidad</th>
                    <th>Urgente</th>
                    <th class="text-start">Observaciones</th>
                    <th>Accion</th>
                  </tr>
                </thead>
                <tbody id="detalleTable"></tbody>
              </table>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-light saif-btn-light" data-bs-dismiss="modal">
              <i class="bi bi-x-lg"></i> Cancelar
            </button>
            <button type="submit" class="btn btn-success">
              <i class="bi bi-check-circle"></i> Guardar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ====== MODAL: CONSULTAR ====== -->
<div class="modal fade saif-modal" id="consultarSolicitudModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div class="saif-modal-title">
          <span class="saif-modal-icon"><i class="bi bi-inboxes"></i></span>
          <span>Detalle de Solicitud</span>
        </div>
        <span class="saif-badge">SAIF</span>
      </div>

      <div class="modal-body p-3 p-md-4 saif-modal-body">
        <!-- Resumen compacto -->
        <div class="saif-summary row g-3 mb-4">
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="saif-info-card">
              <div class="saif-info-card__icon"><i class="bi bi-file-earmark-text"></i></div>
              <div class="w-100">
                <span class="saif-info-card__label">Documento</span>
                <span class="saif-info-card__value" id="detalleDocumento">-</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Productos de la solicitud -->
        <div class="saif-block saif-block--compact">
          <div class="saif-block__header">
            <i class="bi bi-box-seam me-2"></i> Productos de la solicitud
          </div>
          <div class="saif-block__body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle m-0 saif-table--compact">
                <thead>
                  <tr>
                    <th class="text-start">Producto</th>
                    <th class="text-center">Cantidad</th>
                    <th class="text-center">Urgente</th>
                    <th class="text-start">Observaciones</th>
                  </tr>
                </thead>
                <tbody id="detalleProductosModal"></tbody>
              </table>
            </div>
          </div>
        </div>


        <!-- Seguimiento (grid ordenado) -->
        <div class="saif-block saif-block--compact">
          <div class="saif-block__header">
            <i class="bi bi-info-circle me-2"></i> Seguimiento
          </div>
          <div class="saif-block__body">
            <div class="dv-grid --compact">
              <div class="dv --compact">
                <span class="dv__label">Estado</span>
                <div class="dv__field">
                  <span class="dv__icon"><i class="bi bi-flag"></i></span>
                  <span class="dv__value" id="detalleEstado">-</span>
                </div>
              </div>
              <div class="dv --compact">
                <span class="dv__label">Fecha</span>
                <div class="dv__field">
                  <span class="dv__icon"><i class="bi bi-calendar-event"></i></span>
                  <span class="dv__value" id="detalleFecha">-</span>
                </div>
              </div>
              <div class="dv --compact">
                <span class="dv__label">Usuario</span>
                <div class="dv__field">
                  <span class="dv__icon"><i class="bi bi-person"></i></span>
                  <span class="dv__value" id="detalleUsuario">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- /modal-body -->

      <div class="modal-footer justify-content-between saif-footer">
        <span class="text-success small fw-semibold"><i class="bi bi-shield-check me-1"></i> SAIF</span>
        <button class="btn btn-light saif-btn-light" data-bs-dismiss="modal"><i class="bi bi-x-lg"></i> Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL CAMBIAR ESTADO -->
<div class="modal fade" id="modalCambiarEstado" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content" id="modal-cambiar-estado-content"></div>
  </div>
</div>

{% include "recepcion/partials/producto_modal.html" %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const modalConfig = { backdrop: "static", keyboard: false };
  const table = document.getElementById("tablaSolicitudes");
  const tbody = table.querySelector("tbody");
  const pagerEl = document.getElementById("pagerSolicitudes");

  const btnCrear = document.getElementById("btnCrear");
  const btnConsultar = document.getElementById("btnConsultar");

  const modalEl = document.getElementById("modalSolicitud");
  const modalCrear = new bootstrap.Modal(modalEl, modalConfig);
  const modalBuscar = document.getElementById("modalBuscarProducto");

  function attachChildModal(childEl) {
    if (!childEl || childEl.dataset.parentSync === "1") return;
    childEl.addEventListener("show.bs.modal", () => {
      if (modalEl.classList.contains("show")) {
        modalCrear.hide();
        childEl.dataset.parentHidden = "1";
      } else {
        childEl.dataset.parentHidden = "0";
      }
    });
    childEl.addEventListener("hidden.bs.modal", () => {
      if (childEl.dataset.parentHidden === "1" && !modalEl.classList.contains("show")) {
        modalCrear.show();
      }
      childEl.dataset.parentHidden = "0";
    });
    childEl.dataset.parentSync = "1";
  }
  attachChildModal(modalBuscar); // <= asegúrate de llamar esto



  const modalConsultar = new bootstrap.Modal(document.getElementById("consultarSolicitudModal"), modalConfig);
  const modalCambiar = new bootstrap.Modal(document.getElementById("modalCambiarEstado"), modalConfig);
  const modalCambiarContent = document.getElementById("modal-cambiar-estado-content");

  const btnCambiarEstado = document.getElementById("btnCambiarEstado");


  let selectedId = null;
  let selectedRow = null;

  const ESC_MAP = { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" };
  const escapeHtml = (str = "") => str.replace(/[&<>"']/g, ch => ESC_MAP[ch] || ch);
  const cleanValue = (value) => {
    const val = (value || "").toString().trim();
    const lower = val.toLowerCase();
    if (!val || val === "-" || lower === "n/a" || lower === "none" || val === "\u2014") return "";
    return val;
  };
  const setValue = (id, value, fallback = "-") => {
    const el = document.getElementById(id);
    if (!el) return;
    const val = cleanValue(value);
    if (val) {
      el.textContent = val;
      el.classList.remove("--empty");
    } else {
      el.textContent = fallback;
      el.classList.add("--empty");
    }
  };
  const formatDateTime = (value = "") => {
    const trimmed = value.trim();
    if (!trimmed) return "";
    const parts = trimmed.split(" ");
    const dateBits = (parts[0] || "").split("-");
    if (dateBits.length !== 3) return trimmed;
    const [year, month, day] = dateBits;
    let timeLabel = "";
    if (parts[1]) {
      const bits = parts[1].split(":");
      const hh = bits[0] ? bits[0].padStart(2, "0") : "";
      const mm = bits[1] ? bits[1].padStart(2, "0") : "";
      timeLabel = hh && mm ? ` ${hh}:${mm}` : "";
    }
    if (!year || !month || !day) return trimmed;
    return `${day}/${month}/${year}${timeLabel}`;
  };
  const buildPill = (label, tone) => `<span class="saif-pill ${tone}">${escapeHtml(label)}</span>`;

  // ========== Selección de fila y consultar ==========
  table.addEventListener("click", (e) => {
    const tr = e.target.closest("tr[data-id]");
    if (!tr) return;

    table.querySelectorAll("tr.selected, tr.table-active")
        .forEach(r => r.classList.remove("selected","table-active"));

    tr.classList.add("selected","table-active");

    selectedRow = tr;
    selectedId  = tr.dataset.id || null;

    // habilita/propaga id a los botones
    btnConsultar.disabled = !selectedId;

    if (btnCambiarEstado) {
      btnCambiarEstado.disabled = !selectedId;
      if (selectedId) btnCambiarEstado.dataset.id = selectedId;
      else delete btnCambiarEstado.dataset.id;
    }
  });


  tbody.addEventListener("dblclick",(ev)=>{
    const tr = ev.target.closest("tr[data-id]");
    if(!tr || tr.hasAttribute("data-empty-row")) return;

    table.querySelectorAll("tr.selected, tr.table-active")
        .forEach(r => r.classList.remove("selected","table-active"));

    tr.classList.add("selected","table-active");

    selectedRow = tr;
    selectedId  = tr.dataset.id || null;             // <--- NUEVO
    btnConsultar.disabled = !selectedId;

    if (btnCambiarEstado) {                           // <--- NUEVO
      btnCambiarEstado.disabled = !selectedId;
      if (selectedId) btnCambiarEstado.dataset.id = selectedId;
      else delete btnCambiarEstado.dataset.id;
    }

    btnConsultar.click();
  });


  btnConsultar.addEventListener("click", async function () {
    const row = selectedRow;
    if (!row) return;

    // 1) Llamar al backend para traer todos los detalles
    const base = document.getElementById("urlPatterns").dataset.obtener; // /.../0/obtener/
    const url  = base.replace("/0/", `/${selectedId}/`);
    let data;
    try {
      const r = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" }});
      data = await r.json();
    } catch {
      return;
    }

    // 2) Documento / Estado / Fecha
    const doc = cleanValue(data.documento);
    setValue("detalleDocumento", doc, "-");
    const estadoEl = document.getElementById("detalleEstado");
    if (estadoEl) {
      const estado = cleanValue(data.estado);
      const estadoLower = (estado || "").toLowerCase();
      let tone = "saif-pill--neutral";
      if (["enviada","completada"].includes(estadoLower)) tone = "saif-pill--success";
      if (["cancelada"].includes(estadoLower)) tone = "saif-pill--danger";
      estadoEl.innerHTML = buildPill(estado || "Sin estado", tone);
      estadoEl.classList.remove("--empty");
    }
    const fechaEl = document.getElementById("detalleFecha");
    if (fechaEl) {
      const f = formatDateTime(data.fecha || "");
      if (f) { fechaEl.textContent = f; fechaEl.classList.remove("--empty"); }
      else { fechaEl.textContent = "-"; fechaEl.classList.add("--empty"); }
    }

    // 3) Resumen (toma el primer detalle solo para las “tarjetas” superiores)
    const first = (data.detalles && data.detalles.length) ? data.detalles[0] : null;
    if (first) {
      const productoEl = document.getElementById("detalleProducto");
      if (productoEl) {
        const p = cleanValue(first.producto);
        if (p) { productoEl.textContent = p; productoEl.classList.remove("--empty"); productoEl.setAttribute("title", p); }
        else   { productoEl.textContent = "Sin producto"; productoEl.classList.add("--empty"); productoEl.removeAttribute("title"); }
      }
      setValue("detalleCantidad", String(first.cantidad || ""), "-");

      const urgenteEl = document.getElementById("detalleUrgente");
      if (urgenteEl) {
        urgenteEl.innerHTML = buildPill(first.urgente ? "Urgente" : "No urgente",
                                        first.urgente ? "saif-pill--warning" : "saif-pill--neutral");
        urgenteEl.classList.remove("--empty");
      }
    } else {
      setValue("detalleProducto", "", "Sin producto");
      setValue("detalleCantidad", "", "-");
      const urgenteEl = document.getElementById("detalleUrgente");
      if (urgenteEl) { urgenteEl.textContent = "-"; urgenteEl.classList.add("--empty"); }
    }

    // 4) Observaciones (si hay varias, junta; si no hay ninguna, “Sin observaciones”)
    const obsTodas = (data.detalles || [])
      .map(d => (d.observaciones || "").trim())
      .filter(Boolean);
    setValue("detalleObservaciones", obsTodas.length ? obsTodas.join(" · ") : "", "Sin observaciones");

    // 5) Tabla de productos
    const tbodyDet = document.getElementById("detalleProductosModal");
    if (tbodyDet) {
      tbodyDet.innerHTML = "";
      (data.detalles || []).forEach(d => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="text-start">${escapeHtml(d.producto || "")}</td>
          <td class="text-center">${d.cantidad || 0}</td>
          <td class="text-center">${d.urgente ? "Sí" : "No"}</td>
          <td class="text-start">${escapeHtml((d.observaciones || "—") || "—")}</td>`;
        tbodyDet.appendChild(tr);
      });
      if (!tbodyDet.children.length) {
        tbodyDet.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Sin productos</td></tr>`;
      }
    }

    // Usuario
    setValue("detalleUsuario", data.usuario || "", "-");
    modalConsultar.show();
  });


  // ========== Crear ==========
  const alertBox = document.getElementById("formAlertSolicitud");
  const showAlert = (msg)=>{ alertBox.textContent = msg; alertBox.classList.remove("d-none"); };
  const hideAlert = ()=>{ alertBox.textContent=""; alertBox.classList.add("d-none"); };

  btnCrear.addEventListener("click", function () {
    document.getElementById("form-solicitud").reset?.();
    document.getElementById("detalleTable").innerHTML = "";
    hideAlert();
    modalCrear.show();
  });

  // API global para setear producto desde el buscador
  window.setProductoSeleccionado = function({id, texto}) {
    const idEl  = document.querySelector("#productoIdInput");
    const txtEl = document.querySelector("#productoInput");
    if (idEl)  idEl.value  = id || "";
    if (txtEl) txtEl.value = texto || "";
  };

  // Añadir detalle a la tabla
  document.getElementById("btnAddDetalle").addEventListener("click", () => {
    hideAlert();
    const pid = document.getElementById("productoIdInput").value || "";
    const ptx = (document.getElementById("productoInput").value || "").trim();
    const qty = parseInt(document.getElementById("cantidadInput").value || 0, 10);
    const urg = !!document.getElementById("urgenteInput").checked;
    const obs = (document.getElementById("obsInput").value || "").trim();

    if (!pid){ showAlert("Seleccione un producto."); return; }
    if (!qty || qty <= 0){ showAlert("Cantidad inválida."); return; }

    const tbodyDet = document.getElementById("detalleTable");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="text-start" data-id="${pid}" data-nombre="${ptx}">${ptx}</td>
      <td>${qty}</td>
      <td>${urg ? "Sí" : "No"}</td>
      <td class="text-start">${obs || "—"}</td>
      <td><button type="button" class="btn btn-sm btn-outline-danger btn-del"><i class="bi bi-trash"></i></button></td>`;
    tr.querySelector(".btn-del").addEventListener("click", () => tr.remove());
    tbodyDet.appendChild(tr);

    document.getElementById("productoIdInput").value = "";
    document.getElementById("productoInput").value  = "";
    document.getElementById("cantidadInput").value  = "1";
    document.getElementById("urgenteInput").checked = false;
    document.getElementById("obsInput").value = "";
  });

  // Enviar (POST JSON)
  document.getElementById("form-solicitud").addEventListener("submit", async (e)=>{
    e.preventDefault(); hideAlert();

    const doc = (document.getElementById("documentoInput").value || "").trim();
    if (!doc){ showAlert("Ingrese nombre del documento."); return; }

    const detalles = [];
    document.querySelectorAll("#detalleTable tr").forEach(tr=>{
      const tds = tr.children;
      const nombre = tds[0].dataset.nombre || tds[0].textContent.trim();
      const pid    = parseInt(tds[0].dataset.id || "0", 10);
      const qty    = parseInt((tds[1].textContent||"0").trim(), 10);
      const urg    = (tds[2].textContent||"").trim().toLowerCase().startsWith('s');
      const obs    = (tds[3].textContent||"").trim();
      if(pid && qty>0){
        detalles.push({producto_id: pid, cantidad: qty, urgente: urg, observaciones: (obs==="—"? "" : obs), producto:nombre});
      }
    });

    if (!detalles.length){ showAlert("Agregue al menos un producto."); return; }

    const payload = { form_data: { nombre_documento: doc }, detalles };

    try{
      const resp = await fetch("{% url 'solicitudes_bodega_central:crear_solicitud' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With":"XMLHttpRequest",
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if (!resp.ok || !data.success){
        const msg = (data && (data.errors || data.message)) ? (data.errors || data.message) : "Error al guardar.";
        showAlert(msg);
        return;
      }
      window.location.reload();
    }catch(err){
      console.error(err);
      showAlert("Error de red.");
    }
  });


  if(modalBuscar){
    modalBuscar.addEventListener("shown.bs.modal", () => {
      searchInput.value = ""; tbodyResultados.innerHTML = ""; searchInput.focus();
    });
  }

  // ====== Buscador de productos (reuso) (TAL CUAL SALIDAS) ======
  const searchInput   = document.getElementById("searchProducto");
  const tbodyResultados = document.getElementById("tablaBuscarProductos");

  function cablearBuscadorProductos(){
    if(!modalBuscar) return;
    modalBuscar.addEventListener("shown.bs.modal", onShownBuscador, { once:true });
  }

  function onShownBuscador(){
    if (searchInput) searchInput.value = "";
    if (tbodyResultados) tbodyResultados.innerHTML = "";
    searchInput?.focus();

    if(!searchInput || !tbodyResultados) return;

    searchInput.oninput = function () {
      const term = this.value;
      fetch("{% url 'recepcion:search_productos' %}?term=" + encodeURIComponent(term))
        .then(r => r.json())
        .then(data => {
          tbodyResultados.innerHTML = "";
          data.forEach(p => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${p.codigo}</td>
              <td>${p.nombre}</td>
              <td>${p.descripcion ?? ""}</td>
              <td>${p.presentacion ?? ""}</td>
              <td>${p.unidad ?? ""}</td>
              <td>${p.condicion ?? ""}</td>
              <td>${p.receta ? "Sí" : "No"}</td>
              <td>${p.controlado ? "Sí" : "No"}</td>
              <td><button type="button" class="btn btn-sm btn-success">✔</button></td>
            `;
            tr.querySelector("button").addEventListener("click", () => {
              if (window.setProductoSeleccionado) {
                window.setProductoSeleccionado({
                  id: p.id,
                  texto: `${p.codigo} - ${p.nombre}`
                });
              }
              bootstrap.Modal.getInstance(modalBuscar).hide();
              // si estabas creando, reabre el modal padre (por si se cerró)
              const parent = document.getElementById("modalSolicitud");
              if (parent) bootstrap.Modal.getOrCreateInstance(parent).show();
            });
            tbodyResultados.appendChild(tr);
          });
        })
        .catch(() => {
          tbodyResultados.innerHTML = `<tr><td colspan="9" class="text-danger">Error buscando productos.</td></tr>`;
        });
    };
  }

  // Llamar una vez cuando cargue el CREAR
  cablearBuscadorProductos();

  // Si quieres reabrir el modal padre siempre que cierres el buscador (defensivo)
  if(modalBuscar){
    modalBuscar.addEventListener("hidden.bs.modal", () => {
      const parent = document.getElementById("modalSolicitud");
      if (parent && !parent.classList.contains("show")) {
        bootstrap.Modal.getOrCreateInstance(parent).show();
      }
    });
  }


  // ========== Paginación y filtros ==========
  function refreshAutoTitles(){
    table.querySelectorAll("td, th").forEach(el=>{
      if(el.scrollWidth>el.clientWidth){el.setAttribute("title",el.textContent.trim())}
      else{el.removeAttribute("title")}
    });
  }
  function removeEmptyRows(){
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      if(tr.hasAttribute('data-empty-row')) return;
      const hasContent = Array.from(tr.cells).some(td => (td.textContent||'').trim() !== '' || td.querySelector('*'));
      if(!hasContent){ tr.remove(); }
    });
  }
  let currentPage=1; let pageSize=15; const rowHeight=42;
  function recomputarPageSize(){
    const rect=tbody.getBoundingClientRect();
    const margenInf=160;
    const espacio=window.innerHeight-rect.top-margenInf;
    pageSize=Math.max(1,Math.floor(espacio/rowHeight));
  }
  function getDataRows(){
    return Array.from(tbody.querySelectorAll("tr")).filter(tr=>!tr.hasAttribute("data-empty-row") && tr.style.display!=="none");
  }
  function renderPager(totalPages){
    if(totalPages<=1){ pagerEl.innerHTML=""; pagerEl.style.display="none"; return; }
    pagerEl.style.display="flex";
    pagerEl.classList.add("justify-content-center","align-items-center","py-3","gap-3");
    pagerEl.innerHTML="";
    const prev=document.createElement("button");
    prev.className="btn btn-success btn-sm rounded-pill shadow-sm px-3";
    prev.innerHTML="<i class='bi bi-chevron-left me-1'></i> Anterior";
    prev.disabled=currentPage===1;
    prev.onclick=()=>{ currentPage--; applyPagination(); };
    const info=document.createElement("span");
    info.className="fw-semibold text-success small";
    info.textContent=`Página ${currentPage} de ${totalPages}`;
    const next=document.createElement("button");
    next.className="btn btn-success btn-sm rounded-pill shadow-sm px-3";
    next.innerHTML="Siguiente <i class='bi bi-chevron-right ms-1'></i>";
    next.disabled=currentPage===totalPages;
    next.onclick=()=>{ currentPage++; applyPagination(); };
    pagerEl.append(prev,info,next);
  }
  function applyPagination(){
    const rows=getDataRows();
    const total=rows.length;
    const totalPages=Math.max(1,Math.ceil(total/pageSize));
    if(currentPage>totalPages) currentPage=totalPages;
    const start=(currentPage-1)*pageSize;
    const end=start+pageSize;
    rows.forEach((tr,idx)=>{ tr.classList.toggle("hidden-by-pagination", !(idx>=start && idx<end)); });
    renderPager(totalPages);
    tbody.querySelectorAll('tr').forEach(tr=>tr.classList.remove('last-visible'));
    const visibles = rows.filter(r=>!r.classList.contains('hidden-by-pagination'));
    const last = visibles[visibles.length-1]; if(last) last.classList.add('last-visible');
    refreshAutoTitles();
  }
  function installFilters(){
    const fDoc=document.getElementById("f-doc");
    const fProd=document.getElementById("f-prod");
    const fCant=document.getElementById("f-cant");
    const fUrg=document.getElementById("f-urg");
    const fObs=document.getElementById("f-obs");
    const fEst=document.getElementById("f-estado");
    const inputs=[fDoc,fProd,fCant,fUrg,fObs,fEst].filter(Boolean);
    const norm=(s)=>(s||"").toString().trim().toLowerCase();
    const yesNo=(s)=>{ const t=norm(s).replace(/[íi]/g,"i"); if(t==="si") return "si"; if(t==="no") return "no"; return t; };
    function applyFilters(){
      const vDoc=norm(fDoc?.value), vProd=norm(fProd?.value), vCant=norm(fCant?.value),
            vUrg=yesNo(fUrg?.value), vObs=norm(fObs?.value), vEst=norm(fEst?.value);
      const rows=Array.from(tbody.querySelectorAll("tr")).filter(r=>!r.hasAttribute("data-empty-row"));
      rows.forEach(tr=>{
        const tds=tr.querySelectorAll("td");
        const txt=i=>norm(tds[i]?.textContent);
        const ok =
          (!vDoc  || txt(0).includes(vDoc)) &&
          (!vProd || txt(1).includes(vProd)) &&
          (!vCant || txt(2).includes(vCant)) &&
          (!vUrg  || (txt(3).includes("sí") || txt(3).includes("si")) === (vUrg==="si")) &&
          (!vObs  || txt(4).includes(vObs)) &&
          (!vEst  || norm(tds[5]?.innerText)===vEst);
        tr.style.display = ok ? "" : "none";
      });
      currentPage=1; applyPagination();
    }
    inputs.forEach(inp=>{ const ev=(inp.tagName==="SELECT")?"change":"input"; inp.addEventListener(ev,applyFilters); });
  }

  /* ======== Cambiar estado + Editar (AJAX) ======== */
const urlPatterns = document.getElementById("urlPatterns");


// Engancha el submit del form de CAMBIAR ESTADO cada vez que cargue el modal
function hookFormCambiarEstado() {
  const form = document.getElementById("formCambiarEstadoSolicitud");
  if (!form) return;
  form.addEventListener("submit", function (ev) {
    ev.preventDefault();
    const fd = new FormData(form);
    fetch(form.action, {
      method: "POST",
      body: fd,
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        modalCambiar.hide();
        window.location.reload(); // refresca la tabla y queda en el sistema
      } else {
        alert(d.error || "No se pudo cambiar el estado.");
      }
    })
    .catch(() => alert("Error al procesar el cambio de estado."));
  }, { once: true });
}


// Abrir modal Cambiar estado
btnCambiarEstado?.addEventListener("click", () => {
  const id = btnCambiarEstado.dataset.id;
  if (!id) return;
  const url = urlPatterns.dataset.cambiarModal.replace("/0/", `/${id}/`);
  modalCambiarContent.innerHTML = '<div class="p-4 text-center text-muted">Cargando...</div>';
  modalCambiar.show();

  fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" }})
    .then(r => r.json())
    .then(d => {
      modalCambiarContent.innerHTML = d.html;
      hookFormCambiarEstado();
    })
    .catch(() => modalCambiarContent.innerHTML = '<div class="p-4 text-danger">Error cargando modal.</div>');
});


  removeEmptyRows();
  recomputarPageSize();
  installFilters();
  applyPagination();
  refreshAutoTitles();
  window.addEventListener("resize",()=>{recomputarPageSize();applyPagination();});
});
</script>
{% endblock %}
