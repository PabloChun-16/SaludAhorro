{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Solicitudes · SAIF{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'lista/lista.css' %}">

<style>
.table-container{ overflow-x:auto; width:100%; scroll-padding-top:90px; }

#tablaSolicitudes{
  table-layout:fixed; width:100%; min-width:1200px;
  border-collapse:separate; border-spacing:0;
  outline:1px solid #e3e6ea; outline-offset:-1px; border-radius:.5rem; margin-bottom:0;
}
#tablaSolicitudes th,#tablaSolicitudes td{
  overflow:hidden; white-space:nowrap; text-overflow:ellipsis; vertical-align:middle;
  padding:.5rem; font-size:.875rem; background-clip:padding-box; border:1px solid #e3e6ea; color:#0f172a;
}
#tablaSolicitudes tbody tr{ background:#ffffff; }
#tablaSolicitudes tbody tr:hover{ background:#fafafa; }

#tablaSolicitudes thead.sticky-top{ position:sticky; top:0; z-index:10; box-shadow:0 2px 4px rgba(0,0,0,.06); }
#tablaSolicitudes thead.sticky-top tr:first-child th{ position:sticky; top:0; z-index:11; background:#e8f5ec; border-bottom:1px solid #d7dbdf; }
#tablaSolicitudes thead.sticky-top tr.filter-row th{
  position:sticky; top:42px; z-index:10; background:#f4fbf6;
  border-top:1px solid #d9f3e0; border-bottom:1px solid #d7dbdf; box-shadow:0 2px 3px rgba(0,0,0,.04) inset;
  padding:.35rem .5rem; overflow:visible;
}
thead .form-control-sm, thead .form-select-sm{ padding-top:.25rem; padding-bottom:.25rem; height:28px; }
.filter-control{ width:100%; height:32px; padding:.25rem .5rem; border:1px solid #cfe9d7; background:#fff; border-radius:.5rem; transition:border-color .15s, box-shadow .15s; font-size:.85rem; box-sizing:border-box; }
.filter-control::placeholder{ color:#94a3b8; }
.filter-control.text-center{ text-align:center; }
.filter-control:focus{ border-color:#62c07b; outline:0; box-shadow:0 0 0 .15rem rgba(34,197,94,.15); }
#tablaSolicitudes thead.sticky-top tr.filter-row th .filter-wrap{ display:flex; justify-content:center; }
#tablaSolicitudes thead.sticky-top tr.filter-row th .filter-wrap>select{ width:100%; max-width:100%; }
#tablaSolicitudes thead.sticky-top tr.filter-row th select.form-select.filter-control{ -moz-text-align-last:center !important; text-align-last:center !important; text-align:center !important; }

.wp-18{width:18%}.wp-26{width:26%}.wp-12{width:12%}.wp-10{width:10%}.wp-24{width:24%}.wp-10b{width:10%}
.hidden-by-pagination{ display:none !important; }

#tablaSolicitudes thead tr:first-child th{ border-top:0; }
#tablaSolicitudes tbody tr:last-child td{ border-bottom:0; }
#tablaSolicitudes tr>*:first-child{ border-left:0; }
#tablaSolicitudes tr>*:last-child{  border-right:0; }
#tablaSolicitudes tbody tr.last-visible td{ border-bottom:0 !important; }

#tablaSolicitudes tr.selected, #tablaSolicitudes tr.table-active { background-color: rgba(25,135,84,.12); }
#tablaSolicitudes tr { cursor: pointer; }
</style>

<section class="p-6 md:p-8">
  <div class="saif-card mb-4 shadow-lg rounded-3 overflow-hidden">
    <div class="saif-card-header d-flex align-items-center justify-content-between bg-success text-white px-3 py-2">
      <h3 class="mb-0 fs-6"><i class="bi bi-inboxes me-2"></i> Registro de Solicitudes</h3>
      <span class="badge bg-light text-success px-2 py-1 fs-7">SAIF</span>
    </div>

    <!-- ===== TABLA ===== -->
    <div class="table-container">
      <table class="table table-hover align-middle text-center" id="tablaSolicitudes">
        <colgroup>
          <col class="wp-18"><col class="wp-26"><col class="wp-12"><col class="wp-10"><col class="wp-24"><col class="wp-10b">
        </colgroup>
        <thead class="table-success text-dark shadow-sm sticky-top">
          <tr>
            <th scope="col">Documento</th>
            <th scope="col">Producto</th>
            <th scope="col">Cantidad</th>
            <th scope="col">Urgente</th>
            <th scope="col">Observaciones</th>
            <th scope="col">Estado</th>
          </tr>
          <tr class="filter-row">
            <th><input id="f-doc" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-prod" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-cant" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th>
              <div class="filter-wrap">
                <select id="f-urg" class="form-select form-select-sm filter-control text-center">
                  <option value="">Todos</option><option value="si">Sí</option><option value="no">No</option>
                </select>
              </div>
            </th>
            <th><input id="f-obs" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th>
              <div class="filter-wrap">
                <select id="f-estado" class="form-select form-select-sm filter-control text-center">
                  <option value="">Todos</option>
                  <option value="activo">Activo</option>
                  <option value="inactivo">Inactivo</option>
                  <option value="enviada">Enviada</option>
                  <option value="pendiente">Pendiente</option>
                </select>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          {% for solicitud in solicitudes %}
          {% with d=solicitud.detalles.first %}
          <tr
            data-id="{{ solicitud.id }}"
            data-documento="{{ solicitud.nombre_documento }}"
            data-producto="{% if d %}{{ d.id_producto.nombre }}{% endif %}"
            data-producto-id="{% if d %}{{ d.id_producto.id }}{% endif %}"
            data-cantidad="{% if d %}{{ d.cantidad_solicitada }}{% endif %}"
            data-urgente="{% if d and d.es_urgente %}True{% else %}False{% endif %}"
            data-observaciones="{% if d %}{{ d.observaciones|default:'—' }}{% endif %}"
            data-estado="{{ solicitud.id_estado_solicitud.nombre_estado }}"
            data-fecha="{{ solicitud.fecha_solicitud|date:'Y-m-d H:i' }}"
          >
            <td class="text-truncate fw-semibold">{{ solicitud.nombre_documento }}</td>
            <td class="text-truncate">{% if d %}{{ d.id_producto.nombre }}{% else %}—{% endif %}</td>
            <td class="text-truncate">{% if d %}{{ d.cantidad_solicitada }}{% else %}—{% endif %}</td>
            <td>
              {% if d and d.es_urgente %}
                <span class="badge bg-primary">Sí</span>
              {% else %}
                <span class="badge bg-secondary">No</span>
              {% endif %}
            </td>
            <td class="text-truncate">{% if d %}{{ d.observaciones|default:"—" }}{% else %}—{% endif %}</td>
            <td>
              {% if solicitud.id_estado_solicitud.nombre_estado == "Activo" %}
                <span class="badge bg-success">Activo</span>
              {% elif solicitud.id_estado_solicitud.nombre_estado == "Inactivo" %}
                <span class="badge bg-danger">Inactivo</span>
              {% else %}
                <span class="badge bg-secondary">{{ solicitud.id_estado_solicitud.nombre_estado }}</span>
              {% endif %}
            </td>
          </tr>
          {% endwith %}
          {% empty %}
          <tr>
            <td colspan="6" class="py-5 text-muted" data-empty-row>
              <i class="bi bi-inbox fs-3 d-block mb-2"></i>
              No hay solicitudes registradas
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="pagerSolicitudes" class="saif-pager"></div>

    <div class="px-3 py-3 text-center border-top bg-light">
      <button id="btnCrear" class="btn btn-warning rounded-pill px-3 me-2 shadow-sm">
        <i class="bi bi-plus-circle"></i> CREAR
      </button>
      <button id="btnConsultar" class="btn btn-primary rounded-pill px-3 shadow-sm" disabled>
        <i class="bi bi-search"></i> CONSULTAR
      </button>
    </div>
  </div>
</section>

<!-- ====== CSRF a mano para fetch ====== -->
<form style="display:none">{% csrf_token %}</form>

<!-- ====== MODAL: CREAR (todo aquí) ====== -->
<div class="modal fade" id="modalSolicitud" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content saif-modal">
        <div class="modal-header">
          <div class="saif-modal-title">
            <span class="saif-modal-icon"><i class="bi bi-inboxes"></i></span>
            <span>Crear Solicitud</span>
          </div>
          <span class="saif-badge">SAIF</span>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body saif-modal-body">
          <div id="formAlertSolicitud" class="alert alert-danger d-none"></div>

        <form id="form-solicitud">
          <div class="saif-section mb-4">
            <div class="saif-section__title">
              <i class="bi bi-clipboard2-check"></i> Datos de la solicitud
            </div>
            <div class="row g-3 mt-1">
              <div class="col-md-8">
                <label class="form-label">Documento</label>
                <div class="input-group">
                  <span class="input-group-text saif-ig"><i class="bi bi-file-earmark-text"></i></span>
                  <input id="documentoInput" type="text" class="form-control saif-input" placeholder="Ej. RQ-0001" required>
                </div>
              </div>
            </div>
          </div>

          <div class="saif-section mb-3">
            <div class="saif-section__title">
              <i class="bi bi-box-seam"></i> Detalle de productos
            </div>
            <div class="mb-2 mt-2">
              <label class="form-label">Producto</label>
              <div class="input-group">
                <span class="input-group-text saif-ig"><i class="bi bi-capsule-pill"></i></span>
                <input id="productoInput" type="text" class="form-control saif-input" placeholder="Codigo o nombre..." readonly>
                <input id="productoIdInput" type="hidden">
                <button class="btn btn-outline-success saif-btn-outline" type="button" data-bs-toggle="modal" data-bs-target="#modalBuscarProducto">
                  <i class="bi bi-search"></i>
                </button>
              </div>
              <div class="form-text">Selecciona desde el buscador para evitar errores.</div>
            </div>
            <div class="row g-2 align-items-end">
              <div class="col-sm-4 col-lg-3">
                <label class="form-label">Cantidad</label>
                <div class="input-group">
                  <span class="input-group-text saif-ig"><i class="bi bi-hash"></i></span>
                  <input id="cantidadInput" type="number" class="form-control saif-input" min="1" value="1">
                </div>
              </div>
              <div class="col-sm-4 col-lg-3">
                <label class="form-label d-block">Urgente</label>
                <div class="form-check form-switch ps-0">
                  <input id="urgenteInput" class="form-check-input ms-2" type="checkbox">
                  <label class="form-check-label ms-2">Si</label>
                </div>
              </div>
              <div class="col-sm-4 col-lg-6">
                <label class="form-label">Observaciones</label>
                <input id="obsInput" type="text" class="form-control saif-input" placeholder="Opcional">
              </div>
              <div class="col-12 mt-3">
                <button type="button" class="btn btn-success w-100" id="btnAddDetalle">
                  <i class="bi bi-plus-circle"></i> Anadir
                </button>
              </div>
            </div>
            <div class="table-responsive mt-3">
              <table class="table table-hover align-middle saif-table">
                <thead>
                  <tr>
                    <th class="text-start">Producto</th>
                    <th>Cantidad</th>
                    <th>Urgente</th>
                    <th class="text-start">Observaciones</th>
                    <th>Accion</th>
                  </tr>
                </thead>
                <tbody id="detalleTable"></tbody>
              </table>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-light saif-btn-light" data-bs-dismiss="modal">
              <i class="bi bi-x-lg"></i> Cancelar
            </button>
            <button type="submit" class="btn btn-success">
              <i class="bi bi-check-circle"></i> Guardar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ====== MODAL: CONSULTAR (rellenado desde la fila seleccionada) ====== -->
<div class="modal fade saif-modal" id="consultarSolicitudModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div class="saif-modal-title">
          <span class="saif-modal-icon"><i class="bi bi-inboxes"></i></span>
          <span>Detalle de Solicitud</span>
        </div>
        <span class="saif-badge">SAIF</span>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body py-3 bg-slate-50">
        <div class="kv-grid">
          <div class="kv"><div class="kv__key fw-bold">Documento</div><div class="kv__val" id="detalleDocumento"></div></div>
          <div class="kv"><div class="kv__key fw-bold">Producto</div><div class="kv__val" id="detalleProducto"></div></div>
          <div class="kv"><div class="kv__key fw-bold">Cantidad</div><div class="kv__val" id="detalleCantidad"></div></div>
          <div class="kv"><div class="kv__key fw-bold">Urgente</div><div class="kv__val" id="detalleUrgente"></div></div>
          <div class="kv kv--block"><div class="kv__key fw-bold">Observaciones</div><div class="kv__val" id="detalleObservaciones"></div></div>
          <div class="kv"><div class="kv__key fw-bold">Estado</div><div class="kv__val" id="detalleEstado"></div></div>
        </div>
      </div>
      <div class="modal-footer bg-white">
        <button class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal"><i class="bi bi-x-lg"></i> Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- ====== MODAL: BUSCAR PRODUCTO (clonado del de recepción) ====== -->
<div class="modal fade" id="modalBuscarProducto" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div class="saif-modal-title">
          <span class="saif-modal-icon"><i class="bi bi-search"></i></span>
          <span>Buscar producto</span>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <input id="searchProducto" type="text" class="form-control" placeholder="Escribe código o nombre...">
        </div>
        <div class="table-responsive" style="max-height:50vh;overflow:auto">
          <table class="table table-hover table-sm">
            <thead class="table-success">
              <tr>
                <th>Código</th><th>Nombre</th><th>Descripción</th><th>Presentación</th>
                <th>Unidad</th><th>Condición</th><th>Receta</th><th>Ctrl.</th><th>Elegir</th>
              </tr>
            </thead>
            <tbody id="tablaBuscarProductos"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const table = document.getElementById("tablaSolicitudes");
  const tbody = table.querySelector("tbody");
  const pagerEl = document.getElementById("pagerSolicitudes");

  const btnCrear = document.getElementById("btnCrear");
  const btnConsultar = document.getElementById("btnConsultar");

  const modalEl = document.getElementById("modalSolicitud");
  const modalCrear = new bootstrap.Modal(modalEl);
  const modalBuscar = document.getElementById("modalBuscarProducto");
  const modalConsultar = new bootstrap.Modal(document.getElementById("consultarSolicitudModal"));

  let selectedRow = null;

  // ========== Selección de fila y consultar ==========
  table.addEventListener("click", (e) => {
    const tr = e.target.closest("tr[data-id]");
    if (!tr) return;
    table.querySelectorAll("tr.selected, tr.table-active").forEach(r => r.classList.remove("selected","table-active"));
    tr.classList.add("selected","table-active");
    selectedRow = tr;
    btnConsultar.disabled = false;
  });

  tbody.addEventListener("dblclick",(ev)=>{
    const tr = ev.target.closest("tr[data-id]");
    if(!tr || tr.hasAttribute("data-empty-row")) return;
    table.querySelectorAll("tr.selected, tr.table-active").forEach(r => r.classList.remove("selected","table-active"));
    tr.classList.add("selected","table-active");
    selectedRow = tr;
    btnConsultar.disabled = false;
    btnConsultar.click();
  });

  btnConsultar.addEventListener("click", function () {
    const row = selectedRow;
    if (!row) return;
    document.getElementById("detalleDocumento").textContent = row.dataset.documento || "";
    document.getElementById("detalleProducto").textContent = row.dataset.producto || "";
    document.getElementById("detalleCantidad").textContent = row.dataset.cantidad || "";
    document.getElementById("detalleUrgente").textContent = (row.dataset.urgente === "True") ? "Sí" : "No";
    document.getElementById("detalleObservaciones").textContent = row.dataset.observaciones || "—";
    document.getElementById("detalleEstado").textContent = row.dataset.estado || "";
    modalConsultar.show();
  });

  // ========== Crear ==========
  btnCrear.addEventListener("click", function () {
    // Limpia el formulario cada vez
    document.getElementById("formAlertSolicitud").classList.add("d-none");
    document.getElementById("formAlertSolicitud").textContent = "";
    document.getElementById("form-solicitud").reset?.();
    document.getElementById("detalleTable").innerHTML = "";
    modalCrear.show();
  });

  const alertBox = document.getElementById("formAlertSolicitud");
  const showAlert = (msg)=>{ alertBox.textContent = msg; alertBox.classList.remove("d-none"); };
  const hideAlert = ()=>{ alertBox.textContent=""; alertBox.classList.add("d-none"); };

  // API global para setear producto desde el buscador
  window.setProductoSeleccionado = function({id, texto}) {
    const idEl  = document.querySelector("#productoIdInput");
    const txtEl = document.querySelector("#productoInput");
    if (idEl)  idEl.value  = id || "";
    if (txtEl) txtEl.value = texto || "";
  };

  // Añadir detalle a la tabla
  document.getElementById("btnAddDetalle").addEventListener("click", () => {
    hideAlert();
    const pid = document.getElementById("productoIdInput").value || "";
    const ptx = (document.getElementById("productoInput").value || "").trim();
    const qty = parseInt(document.getElementById("cantidadInput").value || 0, 10);
    const urg = !!document.getElementById("urgenteInput").checked;
    const obs = (document.getElementById("obsInput").value || "").trim();

    if (!pid){ showAlert("Seleccione un producto."); return; }
    if (!qty || qty <= 0){ showAlert("Cantidad inválida."); return; }

    const tbodyDet = document.getElementById("detalleTable");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="text-start" data-id="${pid}" data-nombre="${ptx}">${ptx}</td>
      <td>${qty}</td>
      <td>${urg ? "Sí" : "No"}</td>
      <td class="text-start">${obs || "—"}</td>
      <td><button type="button" class="btn btn-sm btn-outline-danger btn-del"><i class="bi bi-trash"></i></button></td>`;
    tr.querySelector(".btn-del").addEventListener("click", () => tr.remove());
    tbodyDet.appendChild(tr);

    // limpiar captura
    document.getElementById("productoIdInput").value = "";
    document.getElementById("productoInput").value  = "";
    document.getElementById("cantidadInput").value  = "1";
    document.getElementById("urgenteInput").checked = false;
    document.getElementById("obsInput").value = "";
  });

  // Enviar (POST JSON)
  document.getElementById("form-solicitud").addEventListener("submit", async (e)=>{
    e.preventDefault(); hideAlert();

    const doc = (document.getElementById("documentoInput").value || "").trim();
    if (!doc){ showAlert("Ingrese nombre del documento."); return; }

    // Construye detalles desde la tabla
    const detalles = [];
    document.querySelectorAll("#detalleTable tr").forEach(tr=>{
      const tds = tr.children;
      const nombre = tds[0].dataset.nombre || tds[0].textContent.trim();
      const pid    = parseInt(tds[0].dataset.id || "0", 10);
      const qty    = parseInt((tds[1].textContent||"0").trim(), 10);
      const urg    = (tds[2].textContent||"").trim().toLowerCase().startsWith('s'); // Sí
      const obs    = (tds[3].textContent||"").trim();
      if(pid && qty>0){
        detalles.push({producto_id: pid, cantidad: qty, urgente: urg, observaciones: (obs==="—"? "" : obs), producto:nombre});
      }
    });

    if (!detalles.length){ showAlert("Agregue al menos un producto."); return; }

    const payload = {
      form_data: { nombre_documento: doc },
      detalles: detalles
    };

    try{
      const resp = await fetch("{% url 'solicitudes_bodega_central:crear_solicitud' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With":"XMLHttpRequest",
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if (!resp.ok || !data.success){
        const msg = (data && (data.errors || data.message)) ? (data.errors || data.message) : "Error al guardar.";
        showAlert(msg);
        return;
      }
      window.location.reload();
    }catch(err){
      console.error(err);
      showAlert("Error de red.");
    }
  });

  // ========== Buscador de productos ==========
  const searchInput = document.getElementById("searchProducto");
  const tbodyResultados = document.getElementById("tablaBuscarProductos");

  if(modalBuscar){
    modalBuscar.addEventListener("shown.bs.modal", () => {
      searchInput.value = ""; tbodyResultados.innerHTML = ""; searchInput.focus();
    });
    modalBuscar.addEventListener("hidden.bs.modal", () => {
      // Regresa al modal de crear
      bootstrap.Modal.getOrCreateInstance(modalEl).show();
    });
  }

  if(searchInput){
    searchInput.oninput = function () {
      const term = this.value;
      fetch("{% url 'recepcion:search_productos' %}?term=" + encodeURIComponent(term))
        .then(r => r.json())
        .then(data => {
          tbodyResultados.innerHTML = "";
          data.forEach(p => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${p.codigo}</td>
              <td>${p.nombre}</td>
              <td>${p.descripcion ?? ""}</td>
              <td>${p.presentacion ?? ""}</td>
              <td>${p.unidad ?? ""}</td>
              <td>${p.condicion ?? ""}</td>
              <td>${p.receta ? "Sí" : "No"}</td>
              <td>${p.controlado ? "Sí" : "No"}</td>
              <td><button type="button" class="btn btn-sm btn-success">✔</button></td>
            `;
            tr.querySelector("button").addEventListener("click", () => {
              if (window.setProductoSeleccionado) {
                window.setProductoSeleccionado({
                  id: p.id,
                  texto: `${p.codigo} - ${p.nombre}`
                });
              }
              bootstrap.Modal.getInstance(modalBuscar).hide();
            });
            tbodyResultados.appendChild(tr);
          });
        })
        .catch(() => {
          tbodyResultados.innerHTML = `<tr><td colspan="9" class="text-danger">Error buscando productos.</td></tr>`;
        });
    };
  }

  // ========== Utilidades: paginación y filtros ==========
  function refreshAutoTitles(){
    table.querySelectorAll("td, th").forEach(el=>{
      if(el.scrollWidth>el.clientWidth){el.setAttribute("title",el.textContent.trim())}
      else{el.removeAttribute("title")}
    });
  }
  function removeEmptyRows(){
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      if(tr.hasAttribute('data-empty-row')) return;
      const hasContent = Array.from(tr.cells).some(td => (td.textContent||'').trim() !== '' || td.querySelector('*'));
      if(!hasContent){ tr.remove(); }
    });
  }
  let currentPage=1; let pageSize=15; const rowHeight=42;
  function recomputarPageSize(){
    const rect=tbody.getBoundingClientRect();
    const margenInf=160;
    const espacio=window.innerHeight-rect.top-margenInf;
    pageSize=Math.max(1,Math.floor(espacio/rowHeight));
  }
  function getDataRows(){
    return Array.from(tbody.querySelectorAll("tr")).filter(tr=>!tr.hasAttribute("data-empty-row") && tr.style.display!=="none");
  }
  function renderPager(totalPages){
    if(totalPages<=1){ pagerEl.innerHTML=""; pagerEl.style.display="none"; return; }
    pagerEl.style.display="flex";
    pagerEl.classList.add("justify-content-center","align-items-center","py-3","gap-3");
    pagerEl.innerHTML="";
    const prev=document.createElement("button");
    prev.className="btn btn-success btn-sm rounded-pill shadow-sm px-3";
    prev.innerHTML="<i class='bi bi-chevron-left me-1'></i> Anterior";
    prev.disabled=currentPage===1;
    prev.onclick=()=>{ currentPage--; applyPagination(); };
    const info=document.createElement("span");
    info.className="fw-semibold text-success small";
    info.textContent=`Página ${currentPage} de ${totalPages}`;
    const next=document.createElement("button");
    next.className="btn btn-success btn-sm rounded-pill shadow-sm px-3";
    next.innerHTML="Siguiente <i class='bi bi-chevron-right ms-1'></i>";
    next.disabled=currentPage===totalPages;
    next.onclick=()=>{ currentPage++; applyPagination(); };
    pagerEl.append(prev,info,next);
  }
  function applyPagination(){
    const rows=getDataRows();
    const total=rows.length;
    const totalPages=Math.max(1,Math.ceil(total/pageSize));
    if(currentPage>totalPages) currentPage=totalPages;
    const start=(currentPage-1)*pageSize;
    const end=start+pageSize;
    rows.forEach((tr,idx)=>{ tr.classList.toggle("hidden-by-pagination", !(idx>=start && idx<end)); });
    renderPager(totalPages);
    tbody.querySelectorAll('tr').forEach(tr=>tr.classList.remove('last-visible'));
    const visibles = rows.filter(r=>!r.classList.contains('hidden-by-pagination'));
    const last = visibles[visibles.length-1]; if(last) last.classList.add('last-visible');
    refreshAutoTitles();
  }
  function installFilters(){
    const fDoc=document.getElementById("f-doc");
    const fProd=document.getElementById("f-prod");
    const fCant=document.getElementById("f-cant");
    const fUrg=document.getElementById("f-urg");
    const fObs=document.getElementById("f-obs");
    const fEst=document.getElementById("f-estado");
    const inputs=[fDoc,fProd,fCant,fUrg,fObs,fEst].filter(Boolean);
    const norm=(s)=>(s||"").toString().trim().toLowerCase();
    const yesNo=(s)=>{ const t=norm(s).replace(/[íi]/g,"i"); if(t==="si") return "si"; if(t==="no") return "no"; return t; };
    function applyFilters(){
      const vDoc=norm(fDoc?.value), vProd=norm(fProd?.value), vCant=norm(fCant?.value),
            vUrg=yesNo(fUrg?.value), vObs=norm(fObs?.value), vEst=norm(fEst?.value);
      const rows=Array.from(tbody.querySelectorAll("tr")).filter(r=>!r.hasAttribute("data-empty-row"));
      rows.forEach(tr=>{
        const tds=tr.querySelectorAll("td");
        const txt=i=>norm(tds[i]?.textContent);
        const ok =
          (!vDoc  || txt(0).includes(vDoc)) &&
          (!vProd || txt(1).includes(vProd)) &&
          (!vCant || txt(2).includes(vCant)) &&
          (!vUrg  || (txt(3).includes("sí") || txt(3).includes("si")) === (vUrg==="si")) &&
          (!vObs  || txt(4).includes(vObs)) &&
          (!vEst  || norm(tds[5]?.innerText)===vEst);
        tr.style.display = ok ? "" : "none";
      });
      currentPage=1; applyPagination();
    }
    inputs.forEach(inp=>{ const ev=(inp.tagName==="SELECT")?"change":"input"; inp.addEventListener(ev,applyFilters); });
  }

  removeEmptyRows();
  recomputarPageSize();
  installFilters();
  applyPagination();
  refreshAutoTitles();
  window.addEventListener("resize",()=>{recomputarPageSize();applyPagination();});
});
</script>
{% endblock %}

