{% extends "dashboard/base.html" %}
{% load static %}
{% load tz %}

{% block title %}Registrar de Envíos · SAIF{% endblock %}

{% block content %}
<section class="p-3">
  <div class="saif-card mb-4 shadow-lg rounded-3 overflow-hidden">
    <!-- ============ HEADER ============ -->
    <div class="saif-card-header d-flex align-items-center justify-content-between bg-success text-white px-3 py-2">
      <h3 class="mb-0 fs-6"><i class="bi bi-truck me-2"></i> Registro de Envíos</h3>
      <span class="badge bg-light text-success px-2 py-1 fs-7">SAIF</span>
    </div>

    <!-- ============ TABLA ============ -->
    <div class="table-container">
      <table class="table table-hover align-middle text-center" id="tablaEnvios">
        <colgroup>
          <col style="width:30%"><col style="width:25%"><col style="width:20%"><col style="width:25%">
        </colgroup>
        <thead class="table-success text-dark shadow-sm sticky-top">
          <tr>
            <th scope="col">Reporte</th>
            <th scope="col">Usuario</th>
            <th scope="col">Estado</th>
            <th scope="col">Fecha</th>
          </tr>
          <!-- Fila de filtros -->
          <tr class="filter-row">
            <th><input id="f-reporte" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-usuario" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-estado"  class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-fecha"   class="form-control form-control-sm filter-control text-center" placeholder="YYYY-MM-DD"></th>
          </tr>
        </thead>
        <tbody>
          {% for envio in envios %}
     <tr class="fila-envio"
    data-id="{{ envio.id }}"
    data-reporte="{{ envio.nombre_reporte }}"
    {% if envio.id_usuario %}
      data-usuario="{{ envio.id_usuario.nombre }}"
      data-usuario-id="{{ envio.id_usuario.id }}"
    {% else %}
      data-usuario=""
      data-usuario-id=""
    {% endif %}
    {% if envio.id_estado_envio %}
      data-estado="{{ envio.id_estado_envio.nombre_estado }}"
      data-estado-id="{{ envio.id_estado_envio.id }}"
    {% else %}
      data-estado=""
      data-estado-id=""
    {% endif %}
    data-fecha="{{ envio.fecha_envio|date:'Y-m-d' }}"
    data-fecha-iso="{{ envio.fecha_envio|date:'Y-m-d\\TH:i' }}">
  <td class="text-truncate">{{ envio.nombre_reporte }}</td>
  <td class="text-truncate">
    {% if envio.id_usuario %}
      {{ envio.id_usuario.nombre }}
    {% else %}
      —
    {% endif %}
  </td>
  <td class="text-truncate">
    {% if envio.id_estado_envio %}
      {{ envio.id_estado_envio.nombre_estado }}
    {% else %}
      —
    {% endif %}
  </td>
  <td class="text-truncate">{{ envio.fecha_envio|date:"d/m/Y H:i" }}</td>
</tr>



          {% empty %}
          <tr>
            <td colspan="4" class="py-5 text-muted" data-empty-row>
              <i class="bi bi-inbox fs-3 d-block mb-2"></i>
              No hay envíos registrados
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ============ PAGER ============ -->
    <div id="pagerEnvios" class="saif-pager"></div>

    <!-- ============ BOTONES (footer) ============ -->
    <div class="px-3 py-3 text-center border-top bg-light">
      <button class="btn btn-warning rounded-pill px-3 me-2 shadow-sm"
              data-bs-toggle="modal" data-bs-target="#crearEnvioModal">
        <i class="bi bi-plus-circle"></i> Crear
      </button>
      <button id="btnConsultar" class="btn btn-primary rounded-pill px-3 me-2 shadow-sm" disabled>
        <i class="bi bi-eye"></i> Consultar
      </button>
      <button id="btnEditar" class="btn btn-success rounded-pill px-3 me-2 shadow-sm" disabled>
        <i class="bi bi-pencil"></i> Editar
      </button>
      <button id="btnEliminar" class="btn btn-danger rounded-pill px-3 shadow-sm" disabled>
        <i class="bi bi-trash"></i> Eliminar
      </button>

      <button id="btnCambiarEstado" class="btn btn-outline-success rounded-pill px-3 me-2 shadow-sm" disabled>
        <i class="bi bi-arrow-repeat"></i> Cambiar estado
      </button>

      <!-- patrón de URL para JS -->
      <span id="urlPatterns"
            data-cambiar-modal="{% url 'recetas:envio_cambiar_estado' 0 %}"
            hidden></span>
    </div>
  </div>
</section>

<!-- ================= CSRF oculto ================= -->
<form style="display:none">{% csrf_token %}</form>


<!-- MODAL CAMBIAR ESTADO -->
<div class="modal fade" id="modalCambiarEstado" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content saif-modal saif-modal--envio" id="modal-cambiar-estado-content"></div>
  </div>
</div>

<!-- ============================= MODAL CREAR ENVÍO ============================= -->
<div class="modal fade saif-modal" id="crearEnvioModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{% url 'recetas:crear_envio' %}">
        {% csrf_token %}
        <div class="modal-header">
          <div class="saif-modal-title">
            <span class="saif-modal-icon"><i class="bi bi-send-check"></i></span>
            <span>Nuevo Envío</span>
          </div>
          <span class="saif-badge">SAIF</span>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body saif-modal-body">
          <div id="crearEnvioAlert" class="alert alert-danger d-none"></div>

          <div class="saif-section mb-4">
            <div class="saif-section__title">
              <i class="bi bi-truck"></i> Datos del envio
            </div>
            <div class="row g-3 mt-1">
              <div class="col-md-6">
                <label class="form-label">Nombre del reporte</label>
                <div class="input-group">
                  <span class="input-group-text saif-ig"><i class="bi bi-file-earmark-text"></i></span>
                  <input type="text" name="nombre_reporte" class="form-control saif-input" placeholder="Nombre del reporte" required>
                </div>
              </div>
              <div class="col-12">
                <div class="d-flex flex-wrap gap-2">
                  <span class="badge bg-success-subtle text-success-emphasis border border-success-subtle">Estado: Enviado (automatico)</span>
                  <span class="badge bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle">Usuario: se toma del usuario de la primera receta seleccionada</span>
                </div>
              </div>
            </div>
          </div>

          <div class="saif-section">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="saif-section__title w-100 me-3">
                <i class="bi bi-journal-medical"></i> Recetas seleccionadas
              </div>
              <button type="button" class="btn btn-outline-success saif-btn-outline ms-auto" data-bs-toggle="modal" data-bs-target="#modalBuscarReceta" data-parent="crear">
                <i class="bi bi-search"></i> Buscar recetas
              </button>
            </div>

            <div class="table-responsive">
              <table class="table table-hover align-middle saif-table">
                <thead>
                  <tr>
                    <th class="text-start">Factura</th>
                    <th class="text-start">Referente</th>
                    <th class="text-start">Producto</th>
                    <th class="text-start">Usuario</th>
                    <th class="text-center">Fecha</th>
                    <th class="text-center">Quitar</th>
                  </tr>
                </thead>
                <tbody id="recetasSeleccionadasBody"></tbody>
              </table>
            </div>
            <div class="form-text mt-2">Agrega una o varias recetas desde el buscador. No se permiten duplicados.</div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-light saif-btn-light" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Cancelar
          </button>
          <button type="submit" class="btn btn-success" id="crearEnvioSubmit">
            <i class="bi bi-check2-circle"></i> Guardar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ============================= MODAL CONSULTAR ============================= -->
<div class="modal fade saif-modal" id="consultarEnvioModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div class="saif-modal-title">
          <span class="saif-modal-icon"><i class="bi bi-send-check"></i></span>
          <span>Detalle de Envío</span>
        </div>
        <span class="saif-badge">SAIF</span>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body py-3 bg-slate-50">
        <div class="kv-grid mb-3">
          <div class="kv"><div class="kv__key">Reporte</div><div class="kv__val" id="detalleReporte">—</div></div>
          <div class="kv"><div class="kv__key">Usuario</div><div class="kv__val" id="detalleUsuario">—</div></div>
          <div class="kv"><div class="kv__key">Estado</div><div class="kv__val" id="detalleEstado">—</div></div>
          <div class="kv"><div class="kv__key">Fecha</div><div class="kv__val" id="detalleFecha">—</div></div>
        </div>

        <!-- Lista de recetas del envío (opcional: si luego agregas endpoint JSON, aquí puedes llenarlo por fetch) -->
        <div class="border rounded-3 p-3 bg-white">
          <h6 class="fw-bold text-emerald-700 mb-2">
            <i class="bi bi-journal-text me-2"></i>Recetas asociadas
          </h6>
          <div class="table-responsive">
            <table class="table table-sm" id="tablaRecetasDelEnvio">
              <thead class="table-light">
                <tr>
                  <th>Factura</th>
                  <th>Referente</th>
                  <th>Producto</th>
                  <th>Usuario Venta</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody>
                <!-- (Opcional) puedes poblar por fetch si expones un endpoint JSON -->
              </tbody>
            </table>
          </div>
          <small class="text-muted">Si creaste el envío aquí, verás todas las recetas que seleccionaste.</small>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-light saif-btn-light" data-bs-dismiss="modal">
          <i class="bi bi-x-lg"></i> Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ============================= MODAL EDITAR ============================= -->
<div class="modal fade saif-modal" id="editarEnvioModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="post" id="editarEnvioForm">
        {% csrf_token %}
        <div class="modal-header">
          <div class="saif-modal-title">
            <span class="saif-modal-icon"><i class="bi bi-pencil-square"></i></span>
            <span>Editar Envío</span>
          </div>
          <span class="saif-badge">SAIF</span>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body bg-slate-50 py-4 grid md:grid-cols-2 gap-4">
          <input type="text" name="nombre_reporte" id="editReporte" class="form-control rounded-lg" placeholder="Nombre del reporte">
          <input type="datetime-local" name="fecha_envio" id="editFecha" class="form-control rounded-lg">

          <!-- Info de que estado/usuario no se editan aquí -->
          <div class="md:col-span-2 d-flex flex-wrap gap-2">
            <span class="badge bg-success-subtle text-success-emphasis border border-success-subtle">
              Estado: Enviado (no editable)
            </span>
            <span class="badge bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle">
              Usuario: asignado automáticamente (no editable)
            </span>
          </div>
        </div>

        <div class="modal-footer bg-white">
          <button type="button" class="btn btn-light saif-btn-light" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Cancelar
          </button>
          <button type="submit" class="btn btn-success">
            <i class="bi bi-check2-circle"></i> Guardar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ============================= MODAL ELIMINAR ============================= -->
<div class="modal fade saif-modal" id="eliminarEnvioModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" id="eliminarEnvioForm">
        {% csrf_token %}
        <div class="modal-header">
          <div class="saif-modal-title">
            <span class="saif-modal-icon"><i class="bi bi-trash"></i></span>
            <span>Eliminar Envío</span>
          </div>
          <span class="saif-badge">SAIF</span>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body text-center py-4 bg-slate-50">
          <p class="fw-semibold text-slate-700">
            ¿Seguro que deseas eliminar el envío <strong id="eliminarReporte" class="text-red-600"></strong>?
          </p>
        </div>

        <div class="modal-footer justify-center bg-white">
          <button class="btn btn-light saif-btn-light" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Cancelar
          </button>
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash-fill"></i> Eliminar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ============================= MODAL BUSCAR RECETA ============================= -->
<div class="modal fade saif-modal" id="modalBuscarReceta" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div class="saif-modal-title">
          <span class="saif-modal-icon"><i class="bi bi-search"></i></span>
          <span>Buscar receta</span>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <input id="searchReceta" type="text" class="form-control" placeholder="Factura, referente, producto, usuario o fecha...">
        </div>
        <div class="table-responsive" style="max-height:50vh;overflow:auto">
          <table class="table table-hover table-sm">
            <thead class="table-success">
              <tr>
                <th>Factura</th>
                <th>Referente</th>
                <th>Producto</th>
                <th>Usuario</th>
                <th>Fecha</th>
                <th>Elegir</th>
              </tr>
            </thead>
            <tbody id="tablaBuscarRecetas">
              {% for r in recetas %}
              <tr data-id="{{ r.id }}"
                  data-factura="{{ r.referencia_factura }}"
                  data-referente="{{ r.referente_receta }}"
                  data-producto="{{ r.id_producto.nombre }}"
                  data-usuario="{{ r.id_usuario_venta.nombre }}"
                  data-fecha="{{ r.fecha_venta|date:'Y-m-d' }}"
                  data-fecha-show="{{ r.fecha_venta|date:'d/m/Y H:i' }}">
                <td>{{ r.referencia_factura }}</td>
                <td>{{ r.referente_receta }}</td>
                <td>{{ r.id_producto.nombre }}</td>
                <td>{{ r.id_usuario_venta.nombre }}</td>
                <td>{{ r.fecha_venta|date:"d/m/Y H:i" }}</td>
                <td><button type="button" class="btn btn-sm btn-success btn-elegir-receta">✔</button></td>
              </tr>
              {% empty %}
              <tr><td colspan="6" class="text-muted">No hay recetas disponibles para seleccionar.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-light saif-btn-light" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- ============================= ESTILOS ============================= -->
<style>
.table-container{overflow-x:auto;width:100%;scroll-padding-top:90px}
#tablaEnvios{table-layout:fixed;width:100%;min-width:900px;border-collapse:separate;border-spacing:0;outline:1px solid #e3e6ea;outline-offset:-1px;border-radius:.5rem;margin-bottom:0}
#tablaEnvios th,#tablaEnvios td{overflow:hidden;white-space:nowrap;text-overflow:ellipsis;vertical-align:middle;padding:.5rem;font-size:.875rem;background-clip:padding-box;border:1px solid #e3e6ea}
#tablaEnvios tbody tr{background:#ffffff}
thead.sticky-top{position:sticky;top:0;z-index:10;box-shadow:0 2px 4px rgba(0,0,0,.06)}
thead.sticky-top tr:first-child th{position:sticky;top:0;z-index:11;background:#e8f5ec;border-bottom:1px solid #d7dbdf}
thead.sticky-top tr.filter-row th{position:sticky;top:42px;z-index:10;background:#f4fbf6;border-top:1px solid #d9f3e0;border-bottom:1px solid #d7dbdf;box-shadow:0 2px 3px rgba(0,0,0,.04) inset;padding:.35rem .5rem;overflow:visible}
.filter-control{width:100%;height:32px;padding:.25rem .5rem;border:1px solid #cfe9d7;background:#fff;border-radius:.5rem;transition:border-color .15s,box-shadow .15s;font-size:.85rem;box-sizing:border-box}
.filter-control::placeholder{color:#94a3b8}
.filter-control.text-center{text-align:center}
.filter-control:focus{border-color:#62c07b;outline:0;box-shadow:0 0 0 .15rem rgba(34,197,94,.15)}
.hidden-by-pagination{display:none!important}
#tablaEnvios thead tr:first-child th{border-top:0}
#tablaEnvios tbody tr:last-child td{border-bottom:0}
#tablaEnvios tr>*:first-child{border-left:0}
#tablaEnvios tr>*:last-child{border-right:0}
#tablaEnvios tbody tr.last-visible td{border-bottom:0!important}
#tablaEnvios tbody tr:hover{background:#fafafa}
.saif-modal .modal-content,.saif-modal.saif-modal--envio{border:0;border-radius:18px;overflow:hidden;box-shadow:0 18px 45px rgba(14,122,58,.25)}
.kv-grid{display:grid;grid-template-columns:1fr 1fr;gap:.85rem 1rem}
.kv{display:grid;grid-template-columns:160px 1fr;align-items:start;gap:.35rem .5rem;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:.65rem .75rem;box-shadow:0 4px 12px rgba(15,23,42,.04)}
.kv__key{font-weight:700;color:#0b1220}
.kv__val{color:#0f172a}
.saif-modal--envio .modal-header{background:linear-gradient(135deg,#0f7a3a 0%,#0c6430 55%,#074d24 100%);color:#fff;border-bottom:0;padding:1rem 1.2rem;display:flex;align-items:center;justify-content:space-between;gap:1rem}
.saif-modal--envio .saif-modal-title{display:flex;align-items:center;gap:.75rem;font-weight:700;letter-spacing:.02em}
.saif-modal--envio .saif-modal-icon{width:42px;height:42px;border-radius:12px;background:rgba(255,255,255,.2);display:inline-flex;align-items:center;justify-content:center;font-size:1.25rem}
.saif-modal--envio .saif-modal-body{background:linear-gradient(180deg,#f6fdf8 0%,#effaf3 100%);padding:1.4rem 1.5rem;display:flex;flex-direction:column;gap:1.2rem}
.saif-field{display:flex;flex-direction:column;gap:.45rem}
.saif-label{font-weight:600;color:#14532d;font-size:.95rem}
.saif-input-readonly{display:flex;align-items:center;gap:.55rem;background:#fff;border:1px solid #cfe9d7;border-radius:.85rem;padding:.65rem .85rem;min-height:48px;box-shadow:0 6px 16px rgba(15,122,58,.12);color:#0f172a;font-weight:600}
.saif-input-readonly i{color:#0f7a3a}
.saif-select-wrap{position:relative;display:flex;align-items:center}
.saif-select-icon{position:absolute;left:1rem;color:#0f7a3a;font-size:1rem;pointer-events:none}
.saif-select{border-radius:.85rem;border:1px solid #cfe9d7;padding:.65rem .9rem .65rem 2.6rem;font-weight:600;color:#0f172a;box-shadow:0 6px 16px rgba(15,122,58,.12)}
.saif-select:focus{border-color:#22c55e;box-shadow:0 0 0 .15rem rgba(34,197,94,.18);outline:0}
.saif-hint{display:flex;align-items:center;gap:.55rem;background:rgba(15,122,58,.08);border:1px solid rgba(34,197,94,.2);border-radius:.9rem;padding:.65rem .85rem;color:#0f5132;font-size:.9rem}
.saif-footer{background:linear-gradient(145deg,#f6fdf8 0%,#eef8f1 100%);border-top:0;padding:.9rem 1.3rem;display:flex;justify-content:flex-end;gap:.75rem}
.saif-btn-light{background:#f8fff9;border:1px solid #cfe9d7;color:#166534;font-weight:600;border-radius:999px;padding:.45rem 1.25rem}
.saif-btn-light:hover{background:#ecfdf5;border-color:#a7f3d0;color:#0f7a3a}
.saif-btn-success{background:#0f7a3a;border-color:#0f7a3a;color:#fff;font-weight:600;border-radius:999px;padding:.45rem 1.4rem}
.saif-btn-success:hover{background:#0c5d2c;border-color:#0c5d2c;color:#fff}
</style>

<!-- ============================= SCRIPT ============================= -->
<script>
document.addEventListener("DOMContentLoaded",function(){
  const table=document.getElementById("tablaEnvios");
  const tbody=table.querySelector("tbody");
  const pagerEl=document.getElementById("pagerEnvios");
  const btnCambiar = document.getElementById("btnCambiarEstado");

  let selectedRow=null, selectedId=null;

  function toggleButtons(enabled){
    ["btnConsultar","btnEditar","btnEliminar","btnCambiarEstado"].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.disabled = !enabled;
    });
  }
  toggleButtons(false);

  function selectRow(row){
    if(!row) return;
    tbody.querySelectorAll("tr").forEach(r=>r.classList.remove("table-active"));
    row.classList.add("table-active");

    selectedRow = row;
    selectedId  = row.getAttribute("data-id");

    // habilita todos los botones (incluido Cambiar estado)
    toggleButtons(true);

    // y guarda el id en el botón de Cambiar estado para que el click sepa a quién abrir
    const btnCambiar = document.getElementById("btnCambiarEstado");
    if (btnCambiar) {
      btnCambiar.dataset.id = selectedId || "";
    }
  }

  tbody.addEventListener("click", ev=>{
    const row = ev.target.closest("tr");
    if(!row || row.hasAttribute("data-empty-row")) return;
    selectRow(row);
  });


  tbody.addEventListener("dblclick",ev=>{
    const row=ev.target.closest("tr");
    if(!row || row.hasAttribute("data-empty-row")) return;
    selectRow(row);
    document.getElementById("btnConsultar").click();
  });

  document.addEventListener("keydown",ev=>{
    if(ev.key==='Enter' && selectedId){
      document.getElementById("btnConsultar").click();
      ev.preventDefault();
    }
  });

// ====== Consultar ======
document.getElementById("btnConsultar").addEventListener("click", async function() {
  if (!selectedRow) {
    alert("Selecciona un envío primero.");
    return;
  }

  const idEnvio = selectedRow.dataset.id;
  document.getElementById("detalleReporte").textContent = selectedRow.dataset.reporte || "—";
  document.getElementById("detalleUsuario").textContent = selectedRow.dataset.usuario || "—";
  document.getElementById("detalleEstado").textContent  = selectedRow.dataset.estado  || "—";
  document.getElementById("detalleFecha").textContent   = selectedRow.dataset.fecha   || "—";

  // ===== Llenar recetas asociadas por fetch =====
  const recetasBody = document.querySelector("#tablaRecetasDelEnvio tbody");
  if (recetasBody) recetasBody.innerHTML = "<tr><td colspan='5' class='text-center text-muted'>Cargando...</td></tr>";

  try {
    const res = await fetch(`/recetas/envios/${idEnvio}/recetas/`);
    const data = await res.json();

    if (!data.length) {
      recetasBody.innerHTML = "<tr><td colspan='5' class='text-center text-muted'>No hay recetas asociadas.</td></tr>";
    } else {
      recetasBody.innerHTML = data.map(r => `
        <tr>
          <td>${r.factura}</td>
          <td>${r.referente}</td>
          <td>${r.producto}</td>
          <td>${r.usuario}</td>
          <td>${r.fecha}</td>
        </tr>
      `).join("");
    }
  } catch (error) {
    recetasBody.innerHTML = "<tr><td colspan='5' class='text-danger text-center'>Error al cargar recetas.</td></tr>";
    console.error("Error al obtener recetas:", error);
  }

  new bootstrap.Modal(document.getElementById("consultarEnvioModal")).show();
});

  // ====== Editar (solo nombre + fecha) ======
  document.getElementById("btnEditar").addEventListener("click",function(){
    if(!selectedRow){ alert("Selecciona un envío primero."); return; }
    const id=selectedRow.dataset.id;
    document.getElementById("editReporte").value = selectedRow.dataset.reporte || "";

    const iso = selectedRow.dataset.fechaIso || "";
    document.getElementById("editFecha").value = iso;

    document.getElementById("editarEnvioForm").action = `/recetas/envio/${id}/editar/`;
    new bootstrap.Modal(document.getElementById("editarEnvioModal")).show();
  });

  // ====== Eliminar ======
  document.getElementById("btnEliminar").addEventListener("click",function(){
    if(!selectedRow){ alert("Selecciona un envío primero."); return; }
    const id=selectedRow.dataset.id;
    document.getElementById("eliminarReporte").textContent = selectedRow.dataset.reporte || "";
    document.getElementById("eliminarEnvioForm").action = `/recetas/envio/${id}/eliminar/`;
    new bootstrap.Modal(document.getElementById("eliminarEnvioModal")).show();
  });

  // ====== Utilidades ======
  function refreshAutoTitles(){
    table.querySelectorAll("td, th").forEach(el=>{
      if(el.scrollWidth>el.clientWidth){ el.setAttribute("title", el.textContent.trim()); }
      else{ el.removeAttribute("title"); }
    });
  }

  function removeEmptyRows(){
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      if(tr.hasAttribute('data-empty-row')) return;
      const tds = Array.from(tr.cells);
      const hasContent = tds.some(td => (td.textContent||'').trim() !== '' || td.querySelector('*'));
      if(!hasContent){ tr.remove(); }
    });
  }

  // ====== Paginación dinámica ======
  let currentPage=1; let pageSize=15; const rowHeight=42;

  function recomputarPageSize(){
    const rect=tbody.getBoundingClientRect();
    const margenInf=160;
    const espacio=window.innerHeight-rect.top-margenInf;
    pageSize=Math.max(1,Math.floor(espacio/rowHeight));
  }

  function getDataRows(){
    return Array.from(tbody.querySelectorAll("tr"))
      .filter(tr=>!tr.hasAttribute("data-empty-row") && tr.style.display!=="none");
  }

  function renderPager(totalPages){
    if(totalPages<=1){
      pagerEl.innerHTML=""; pagerEl.style.display="none"; return;
    }
    pagerEl.style.display="flex";
    pagerEl.classList.add("justify-content-center","align-items-center","py-3","gap-3");
    pagerEl.innerHTML="";

    const prev=document.createElement("button");
    prev.className="btn btn-success btn-sm rounded-pill shadow-sm px-3";
    prev.innerHTML="<i class='bi bi-chevron-left me-1'></i> Anterior";
    prev.disabled=currentPage===1;
    prev.onclick=()=>{ currentPage--; applyPagination(); };

    const info=document.createElement("span");
    info.className="fw-semibold text-success small";
    info.textContent=`Página ${currentPage} de ${totalPages}`;

    const next=document.createElement("button");
    next.className="btn btn-success btn-sm rounded-pill shadow-sm px-3";
    next.innerHTML="Siguiente <i class='bi bi-chevron-right ms-1'></i>";
    next.disabled=currentPage===totalPages;
    next.onclick=()=>{ currentPage++; applyPagination(); };

    pagerEl.append(prev,info,next);
  }

  function applyPagination(){
    const rows=getDataRows();
    const total=rows.length;
    const totalPages=Math.max(1,Math.ceil(total/pageSize));
    if(currentPage>totalPages) currentPage=totalPages;

    const start=(currentPage-1)*pageSize;
    const end=start+pageSize;

    rows.forEach((tr,idx)=>{
      tr.classList.toggle("hidden-by-pagination", !(idx>=start && idx<end));
    });

    renderPager(totalPages);

    tbody.querySelectorAll('tr').forEach(tr=>tr.classList.remove('last-visible'));
    const visibles = rows.filter(r=>!r.classList.contains('hidden-by-pagination'));
    const last = visibles[visibles.length-1];
    if(last) last.classList.add('last-visible');

    if(selectedId){
      const sel=rows.find(r=>r.getAttribute("data-id")===selectedId);
      if(sel && sel.classList.contains("hidden-by-pagination")){
        const firstVisible=rows.find(r=>!r.classList.contains("hidden-by-pagination"));
        if(firstVisible) selectRow(firstVisible);
      }
    }
    refreshAutoTitles();
  }

  // ====== Filtros ======
  function installFilters(){
    const fRep=document.getElementById("f-reporte");
    const fUsr=document.getElementById("f-usuario");
    const fEst=document.getElementById("f-estado");
    const fFec=document.getElementById("f-fecha");
    const inputs=[fRep,fUsr,fEst,fFec].filter(Boolean);
    const norm=(s)=>(s||"").toString().trim().toLowerCase();

    function applyFilters(){
      const vRep=norm(fRep?.value), vUsr=norm(fUsr?.value),
            vEst=norm(fEst?.value), vFec=norm(fFec?.value);

      const rows=Array.from(tbody.querySelectorAll("tr")).filter(r=>!r.hasAttribute("data-empty-row"));
      rows.forEach(tr=>{
        const tds=tr.querySelectorAll("td");
        const ok =
          (!vRep || (tds[0]?.textContent||"").toLowerCase().includes(vRep)) &&
          (!vUsr || (tds[1]?.textContent||"").toLowerCase().includes(vUsr)) &&
          (!vEst || (tds[2]?.textContent||"").toLowerCase().includes(vEst)) &&
          (!vFec || (tr.getAttribute("data-fecha")||"").includes(vFec));
        tr.style.display = ok ? "" : "none";
      });
      currentPage=1;
      applyPagination();
    }

    inputs.forEach(inp=>inp.addEventListener("input",applyFilters));
  }

  // ====== Buscar Recetas (modal secundario) ======
  const modalBuscarEl = document.getElementById("modalBuscarReceta");
  const modalCrearEl  = document.getElementById("crearEnvioModal");
  let parentContext = null; // desde dónde abrí el buscador

  document.querySelectorAll('[data-bs-target="#modalBuscarReceta"]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      parentContext = btn.getAttribute('data-parent') || null;
    });
  });

  if(modalBuscarEl){
    modalBuscarEl.addEventListener("hidden.bs.modal", ()=>{
      if(parentContext === 'crear' && modalCrearEl){
        bootstrap.Modal.getOrCreateInstance(modalCrearEl).show();
      }
    });
    modalBuscarEl.addEventListener("shown.bs.modal", ()=>{
      const input = document.getElementById("searchReceta");
      if(input){ input.value=""; input.focus(); }
    });
  }

  // Filtrado local en el buscador
  const searchReceta = document.getElementById("searchReceta");
  const tbodyBuscar  = document.getElementById("tablaBuscarRecetas");

  function normaliza(s){ return (s||"").toString().toLowerCase().trim(); }

  if(searchReceta && tbodyBuscar){
    searchReceta.addEventListener("input", ()=>{
      const term = normaliza(searchReceta.value);
      Array.from(tbodyBuscar.querySelectorAll("tr")).forEach(tr=>{
        const fac = normaliza(tr.dataset.factura);
        const ref = normaliza(tr.dataset.referente);
        const pro = normaliza(tr.dataset.producto);
        const usu = normaliza(tr.dataset.usuario);
        const fec = normaliza(tr.dataset.fecha);
        const ok = !term || fac.includes(term) || ref.includes(term) || pro.includes(term) || usu.includes(term) || fec.includes(term);
        tr.style.display = ok ? "" : "none";
      });
    });

    // Elegir receta -> agregar a seleccionadas y cerrar buscador
    tbodyBuscar.addEventListener("click", (e)=>{
      const btn = e.target.closest(".btn-elegir-receta");
      if(!btn) return;
      const tr = btn.closest("tr");
      if(!tr) return;

      const data = {
        id: tr.dataset.id,
        factura: tr.dataset.factura,
        referente: tr.dataset.referente,
        producto: tr.dataset.producto,
        usuario: tr.dataset.usuario,
        fecha: tr.dataset.fechaShow || tr.querySelector("td:nth-child(5)")?.textContent || ""
      };
      addRecetaSeleccionada(data);
      bootstrap.Modal.getInstance(modalBuscarEl)?.hide();
    });
  }

  // Tabla de seleccionadas (Crear Envío)
  const selBody = document.getElementById("recetasSeleccionadasBody");
  const crearEnvioAlert = document.getElementById("crearEnvioAlert");

  function showCrearAlert(msg){
    if(!crearEnvioAlert) return;
    crearEnvioAlert.textContent = msg || "Error";
    crearEnvioAlert.classList.remove("d-none");
  }
  function hideCrearAlert(){
    if(!crearEnvioAlert) return;
    crearEnvioAlert.textContent = "";
    crearEnvioAlert.classList.add("d-none");
    }

  function yaExiste(id){
    return !!selBody.querySelector(`tr[data-id="${id}"]`);
  }

  function addRecetaSeleccionada({id, factura, referente, producto, usuario, fecha}){
    hideCrearAlert();
    if(!id){ showCrearAlert("Receta inválida."); return; }
    if(yaExiste(id)){ showCrearAlert("La receta ya fue agregada."); return; }

    const tr = document.createElement("tr");
    tr.setAttribute("data-id", id);
    tr.innerHTML = `
      <td class="text-start">${factura||""}</td>
      <td class="text-start">${referente||""}</td>
      <td class="text-start">${producto||""}</td>
      <td class="text-start">${usuario||""}</td>
      <td class="text-center">${fecha||""}</td>
      <td class="text-center">
        <button type="button" class="btn btn-sm btn-outline-danger btn-quitar-receta"><i class="bi bi-x-lg"></i></button>
      </td>
      <input type="hidden" name="recetas[]" value="${id}">
    `;
    tr.querySelector(".btn-quitar-receta").addEventListener("click", ()=> tr.remove());
    selBody.appendChild(tr);
  }

  // Validar antes de enviar (al menos 1 receta)
  const crearSubmit = document.getElementById("crearEnvioSubmit");
  if(crearSubmit){
    crearSubmit.closest("form")?.addEventListener("submit", (e)=>{
      hideCrearAlert();
      if(!selBody.querySelector("tr[data-id]")){
        e.preventDefault();
        showCrearAlert("Agrega al menos una receta al envío.");
      }
    });
  }

  // ===== Cambiar estado (abrir modal por AJAX y enganchar submit) =====
  const urlPatterns = document.getElementById("urlPatterns");
  const modalCambiar = new bootstrap.Modal(document.getElementById("modalCambiarEstado"));
  const modalCambiarContent = document.getElementById("modal-cambiar-estado-content");

  function hookCambiarEstadoForm(){
    const form = document.getElementById("formCambiarEstadoEnvio");
    if(!form) return;
    form.addEventListener("submit", function(ev){
      ev.preventDefault();
      const fd = new FormData(form);
      fetch(form.action, {
        method: "POST",
        body: fd,
        headers: { "X-Requested-With": "XMLHttpRequest" }
      })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          modalCambiar.hide();
          // refrescamos para ver el nuevo estado en la tabla
          window.location.reload();
        } else {
          alert(d.error || "No se pudo cambiar el estado.");
        }
      })
      .catch(() => alert("Error al procesar el cambio de estado."));
    }, { once: true }); // evita múltiples bindings
  }

  document.getElementById("btnCambiarEstado")?.addEventListener("click", () => {
    const id = document.getElementById("btnCambiarEstado").dataset.id;
    if(!id) return;

    const url = urlPatterns.dataset.cambiarModal.replace("/0/", `/${id}/`);
    modalCambiarContent.innerHTML = '<div class="p-4 text-center text-muted">Cargando...</div>';
    modalCambiar.show();

    fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
      .then(r => r.json())
      .then(d => {
        modalCambiarContent.innerHTML = d.html;
        hookCambiarEstadoForm();
      })
      .catch(() => {
        modalCambiarContent.innerHTML = '<div class="p-4 text-danger">Error cargando modal.</div>';
      });
  });


  // ====== Init ======
  removeEmptyRows();
  recomputarPageSize();
  installFilters();
  applyPagination();
  refreshAutoTitles();
  window.addEventListener("resize",()=>{recomputarPageSize();applyPagination();});
});
</script>
{% endblock %}
