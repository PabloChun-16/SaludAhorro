{% extends "dashboard/base.html" %}
{% load static %}
{% load tz %}

{% block title %}Registro de Recetas · SAIF{% endblock %}

{% block content %}
<section class="p-3">
  <!-- ================== CARD ================== -->
  <div class="saif-card mb-4 shadow-lg rounded-3 overflow-hidden">
    <div class="saif-card-header d-flex align-items-center justify-content-between bg-success text-white px-3 py-2">
      <h3 class="mb-0 fs-6"><i class="bi bi-journal-medical me-2"></i> Registro de Recetas</h3>
      <span class="badge bg-light text-success px-2 py-1 fs-7">SAIF</span>
    </div>

    <!-- ================== TABLA ================== -->
    <div class="table-container">
      <table class="table table-hover align-middle text-center" id="tablaRecetas">
        <colgroup>
          <col style="width:18%"><col style="width:20%"><col style="width:22%"><col style="width:20%"><col style="width:20%">
        </colgroup>
        <thead class="table-success text-dark shadow-sm sticky-top">
          <tr>
            <th scope="col">Factura</th>
            <th scope="col">Referente</th>
            <th scope="col">Producto</th>
            <th scope="col">Usuario Venta</th>
            <th scope="col">Fecha</th>
          </tr>
          <tr class="filter-row">
            <th><input id="f-factura"   class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-referente" class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-producto"  class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-usuario"   class="form-control form-control-sm filter-control text-center" placeholder="Filtrar"></th>
            <th><input id="f-fecha"     class="form-control form-control-sm filter-control text-center" placeholder="YYYY-MM-DD"></th>
          </tr>
        </thead>
        <tbody>
          {% for receta in recetas %}
          <tr class="fila-receta"
              data-id="{{ receta.id }}"
              data-factura="{{ receta.referencia_factura }}"
              data-referente="{{ receta.referente_receta }}"
              data-producto-id="{{ receta.id_producto.id }}"
              data-producto-nombre="{{ receta.id_producto.nombre }}"
              data-usuario-id="{{ receta.id_usuario_venta.id }}"
              data-usuario-nombre="{{ receta.id_usuario_venta.nombre }}"
              data-fecha="{{ receta.fecha_venta|date:'Y-m-d' }}">
            <td class="text-truncate">{{ receta.referencia_factura }}</td>
            <td class="text-truncate">{{ receta.referente_receta }}</td>
            <td class="text-truncate">{{ receta.id_producto.nombre }}</td>
            <td class="text-truncate">{{ receta.id_usuario_venta.nombre }}</td>
            <td class="text-truncate">{{ receta.fecha_venta|localtime|date:"d/m/Y H:i" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="py-5 text-muted" data-empty-row>
            <i class="bi bi-inbox fs-3 d-block mb-2"></i> No hay recetas registradas
          </td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="pagerRecetas" class="saif-pager"></div>

    <!-- ================== BOTONES ================== -->
    <div class="px-3 py-3 text-center border-top bg-light">
      <button class="btn btn-warning rounded-pill px-3 me-2 shadow-sm"
              data-bs-toggle="modal" data-bs-target="#crearRecetaModal">
        <i class="bi bi-plus-circle"></i> Crear
      </button>
      <button id="btnConsultar" class="btn btn-primary rounded-pill px-3 me-2 shadow-sm" disabled>
        <i class="bi bi-eye"></i> Consultar
      </button>
      <button id="btnEditar" class="btn btn-success rounded-pill px-3 me-2 shadow-sm" disabled>
        <i class="bi bi-pencil"></i> Editar
      </button>
      <button id="btnEliminar" class="btn btn-danger rounded-pill px-3 shadow-sm" disabled>
        <i class="bi bi-trash"></i> Eliminar
      </button>
    </div>
  </div>
</section>

<!-- ====== CSRF para fetch ====== -->
<form style="display:none">{% csrf_token %}</form>

<!-- ================== MODAL CREAR ================== -->
<div class="modal fade saif-modal" id="crearRecetaModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{% url 'recetas:crear_receta' %}">
        {% csrf_token %}
        <div class="modal-header bg-emerald-700 text-white">
          <div class="d-flex align-items-center gap-3">
            <img src="{% static 'home/img/logo_empresa.png' %}" alt="Logo"
                 class="rounded-circle bg-white p-2 shadow-sm" style="width:38px;height:38px;">
            <h5 class="modal-title fw-bold mb-0">Nueva Receta</h5>
            <span class="saif-badge ms-2"><i class="bi bi-shield-check"></i> SAIF</span>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body bg-slate-50 py-4">
          <div class="grid md:grid-cols-2 gap-4">
            <!-- Factura: readonly + hidden + buscador -->
            <div class="md:col-span-2">
              <label class="form-label fw-semibold mb-1">Referencia factura</label>
              <div class="input-group">
                <input id="crearFacturaTxt" type="text" class="form-control rounded-start" placeholder="Seleccione la factura desde el buscador" readonly>
                <input id="crearFacturaVal" type="hidden" name="referencia_factura">
                <button class="btn btn-outline-secondary"
                        type="button"
                        data-bs-toggle="modal"
                        data-bs-target="#modalBuscarFactura"
                        data-parent="crear">
                  <i class="bi bi-search"></i>
                </button>
              </div>
              <small class="text-muted">La selección de factura asigna automáticamente el usuario de venta (y puede sugerir el producto).</small>
            </div>

            <input type="text" name="referente_receta" class="form-control rounded-lg" placeholder="Referente Receta" required>

            <!-- Producto: readonly + hidden + botón buscar (puedes permitir cambiarlo manualmente) -->
            <div class="md:col-span-2">
              <label class="form-label fw-semibold mb-1">Producto</label>
              <div class="input-group">
                <input id="crearProductoTxt" type="text" class="form-control rounded-start" placeholder="Seleccione desde el buscador" readonly>
                <input id="crearProductoId" type="hidden" name="id_producto">
                <button class="btn btn-outline-secondary"
                        type="button"
                        data-bs-toggle="modal"
                        data-bs-target="#modalBuscarProducto"
                        data-parent="crear">
                  <i class="bi bi-search"></i>
                </button>
              </div>
            </div>

            <!-- Usuario de la venta: hidden + display readonly (se llena al elegir factura) -->
            <div class="md:col-span-2">
              <label class="form-label fw-semibold mb-1">Usuario de la venta</label>
              <input id="crearUsuarioVentaTxt" type="text" class="form-control" placeholder="Se autocompleta al elegir la factura" readonly>
              <input id="crearUsuarioVentaId" type="hidden" name="id_usuario_venta">
            </div>
          </div>
        </div>

        <div class="modal-footer bg-white">
          <button class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Cancelar
          </button>
          <button class="btn btn-success rounded-pill px-4">
            <i class="bi bi-check2-circle"></i> Guardar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ================== MODAL CONSULTAR ================== -->
<div class="modal fade saif-modal" id="consultarRecetaModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-emerald-700 text-white">
        <div class="d-flex align-items-center gap-3">
          <img src="{% static 'home/img/logo_empresa.png' %}" alt="Logo"
               class="rounded-circle bg-white p-2 shadow-sm" style="width:38px;height:38px;">
          <h5 class="modal-title fw-bold mb-0">Detalle de Receta</h5>
          <span class="saif-badge ms-2"><i class="bi bi-shield-check"></i> SAIF</span>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body py-3 bg-slate-50">
        <div class="kv-grid">
          <div class="kv"><div class="kv__key">Factura</div><div class="kv__val" id="detalleFactura">—</div></div>
          <div class="kv"><div class="kv__key">Referente</div><div class="kv__val" id="detalleReferente">—</div></div>
          <div class="kv"><div class="kv__key">Producto</div><div class="kv__val" id="detalleProducto">—</div></div>
          <div class="kv"><div class="kv__key">Usuario Venta</div><div class="kv__val" id="detalleUsuario">—</div></div>
          <div class="kv"><div class="kv__key">Fecha</div><div class="kv__val" id="detalleFecha">—</div></div>
        </div>
      </div>

      <div class="modal-footer bg-white">
        <button class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
          <i class="bi bi-x-lg"></i> Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ================== MODAL EDITAR ================== -->
<div class="modal fade saif-modal" id="editarRecetaModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="post" id="editarRecetaForm">
        {% csrf_token %}
        <div class="modal-header bg-green-600 text-white">
          <h5 class="modal-title fw-bold mb-0">Editar Receta</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body bg-slate-50 py-4 grid md:grid-cols-2 gap-4">
          <!-- Factura: readonly + buscador -->
          <div class="md:col-span-2">
            <label class="form-label fw-semibold mb-1">Referencia factura</label>
            <div class="input-group">
              <input id="editFacturaTxt" type="text" class="form-control rounded-start" placeholder="Seleccione la factura desde el buscador" readonly>
              <input id="editFacturaVal" type="hidden" name="referencia_factura">
              <button class="btn btn-outline-secondary"
                      type="button"
                      data-bs-toggle="modal"
                      data-bs-target="#modalBuscarFactura"
                      data-parent="editar">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </div>

          <input type="text" name="referente_receta" id="editReferente" class="form-control rounded-lg" placeholder="Referente Receta">

          <!-- Producto -->
          <div class="md:col-span-2">
            <label class="form-label fw-semibold mb-1">Producto</label>
            <div class="input-group">
              <input id="editProductoTxt" type="text" class="form-control rounded-start" placeholder="Seleccione desde el buscador" readonly>
              <input id="editProductoId" type="hidden" name="id_producto">
              <button class="btn btn-outline-secondary"
                      type="button"
                      data-bs-toggle="modal"
                      data-bs-target="#modalBuscarProducto"
                      data-parent="editar">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </div>

          <!-- Usuario venta (hidden + display) -->
          <div class="md:col-span-2">
            <label class="form-label fw-semibold mb-1">Usuario de la venta</label>
            <input id="editUsuarioTxt" type="text" class="form-control" readonly>
            <input id="editUsuarioId" type="hidden" name="id_usuario_venta">
          </div>
        </div>

        <div class="modal-footer bg-white">
          <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success rounded-pill px-4">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ================== MODAL ELIMINAR ================== -->
<div class="modal fade saif-modal" id="eliminarRecetaModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" id="eliminarRecetaForm">
        {% csrf_token %}
        <div class="modal-header bg-red-700 text-white">
          <div class="d-flex align-items-center gap-3">
            <img src="{% static 'home/img/logo_empresa.png' %}" alt="Logo"
                 class="rounded-circle bg-white p-2 shadow-sm" style="width:38px;height:38px;">
            <h5 class="modal-title fw-bold mb-0">Eliminar Receta</h5>
            <span class="saif-badge ms-2"><i class="bi bi-shield-check"></i> SAIF</span>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body text-center py-4 bg-slate-50">
          <p class="fw-semibold text-slate-700">
            ¿Seguro que deseas eliminar la receta
            <strong id="eliminarFactura" class="text-red-600"></strong>?
          </p>
        </div>

        <div class="modal-footer justify-center bg-white">
          <button class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Cancelar
          </button>
          <button class="btn btn-danger rounded-pill px-4">
            <i class="bi bi-trash-fill"></i> Eliminar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ================== MODAL: BUSCAR PRODUCTO ================== -->
<div class="modal fade" id="modalBuscarProducto" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title"><i class="bi bi-search me-2"></i>Buscar producto</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <input id="searchProducto" type="text" class="form-control" placeholder="Escribe código o nombre...">
        </div>
        <div class="table-responsive" style="max-height:50vh;overflow:auto">
          <table class="table table-hover table-sm">
            <thead class="table-success">
              <tr>
                <th>Código</th>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Presentación</th>
                <th>Unidad</th>
                <th>Condición</th>
                <th>Receta</th>
                <th>Ctrl.</th>
                <th>Elegir</th>
              </tr>
            </thead>
            <tbody id="tablaBuscarProductos"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- ================== MODAL: BUSCAR FACTURA ================== -->
<div class="modal fade" id="modalBuscarFactura" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title"><i class="bi bi-search me-2"></i>Buscar factura</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <input id="searchFactura" type="text" class="form-control" placeholder="Número de factura, producto, usuario...">
        </div>
        <div class="table-responsive" style="max-height:50vh;overflow:auto">
          <table class="table table-hover table-sm">
            <thead class="table-success">
              <tr>
                <th>Factura</th>
                <th>Usuario venta</th>
                <th>Producto</th>
                <th>Fecha</th>
                <th>Elegir</th>
              </tr>
            </thead>
            <tbody id="tablaBuscarFacturas"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- ================== ESTILOS (tabla + modal) ================== -->
<style>
.table-container{ overflow-x:auto; width:100%; scroll-padding-top:90px; }
#tablaRecetas{
  table-layout:fixed; width:100%; min-width:1100px;
  border-collapse:separate; border-spacing:0;
  outline:1px solid #e3e6ea; outline-offset:-1px; border-radius:.5rem; margin-bottom:0;
}
#tablaRecetas th,#tablaRecetas td{
  overflow:hidden; white-space:nowrap; text-overflow:ellipsis; vertical-align:middle;
  padding:.5rem; font-size:.875rem; background-clip:padding-box; border:1px solid #e3e6ea;
}
#tablaRecetas tbody tr{ background:#ffffff; }
#tablaRecetas tbody tr:hover{ background:#fafafa; }
#tablaRecetas thead.sticky-top{ position:sticky; top:0; z-index:10; box-shadow:0 2px 4px rgba(0,0,0,.06); }
#tablaRecetas thead.sticky-top tr:first-child th{ position:sticky; top:0; z-index:11; background:#e8f5ec; border-bottom:1px solid #d7dbdf; }
#tablaRecetas thead.sticky-top tr.filter-row th{
  position:sticky; top:42px; z-index:10; background:#f4fbf6;
  border-top:1px solid #d9f3e0; border-bottom:1px solid #d7dbdf; box-shadow:0 2px 3px rgba(0,0,0,.04) inset;
  padding:.35rem .5rem; overflow:visible;
}
thead .form-control-sm{ padding-top:.25rem; padding-bottom:.25rem; height:28px; }
.filter-control{ width:100%; height:32px; padding:.25rem .5rem; border:1px solid #cfe9d7; background:#fff; border-radius:.5rem; transition:border-color .15s, box-shadow .15s; font-size:.85rem; box-sizing:border-box; }
.filter-control::placeholder{ color:#94a3b8; }
.filter-control.text-center{ text-align:center; }
.filter-control:focus{ border-color:#62c07b; outline:0; box-shadow:0 0 0 .15rem rgba(34,197,94,.15); }
#tablaRecetas thead tr:first-child th{ border-top:0; }
#tablaRecetas tbody tr:last-child td{ border-bottom:0; }
#tablaRecetas tr>*:first-child{ border-left:0; }
#tablaRecetas tr>*:last-child{  border-right:0; }
#tablaRecetas tbody tr.last-visible td{ border-bottom:0 !important; }
.hidden-by-pagination{ display:none !important; }
.saif-modal .modal-content { border:0; border-radius:18px; overflow:hidden; box-shadow:0 18px 45px rgba(14,122,58,.25); }
.saif-modal .modal-header { background:#0E7A3A; color:#fff; border-bottom:0; padding:.6rem .9rem }
.saif-modal .saif-badge { background:rgba(255,255,255,.15); border-radius:999px; padding:.12rem .5rem; font-weight:600; font-size:.8rem }
.kv-grid { display:grid; grid-template-columns:1fr 1fr; gap:.85rem 1rem }
.kv { display:grid; grid-template-columns:160px 1fr; align-items:start; gap:.35rem .5rem; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:.65rem .75rem; box-shadow:0 4px 12px rgba(15,23,42,.04) }
.kv__key { font-weight:700; color:#0b1220 }
.kv__val { color:#0f172a }
@media (max-width:768px){ .kv-grid{grid-template-columns:1fr} .kv{grid-template-columns:140px 1fr} }
</style>

<!-- ================== LÓGICA ================== -->
<script>
document.addEventListener("DOMContentLoaded", function(){
  const table   = document.getElementById("tablaRecetas");
  const tbody   = table.querySelector("tbody");
  const pagerEl = document.getElementById("pagerRecetas");

  let selectedRow = null, selectedId = null;

  function setButtonsState(enabled){
    document.getElementById("btnConsultar").disabled = !enabled;
    document.getElementById("btnEditar").disabled    = !enabled;
    document.getElementById("btnEliminar").disabled  = !enabled;
  }
  setButtonsState(false);

  function selectRow(row){
    if(!row) return;
    tbody.querySelectorAll("tr").forEach(r=>r.classList.remove("table-active"));
    row.classList.add("table-active");
    selectedRow = row;
    selectedId  = row.getAttribute("data-id");
    setButtonsState(true);
  }

  tbody.addEventListener("click",(ev)=>{
    const row = ev.target.closest("tr");
    if(!row || row.hasAttribute("data-empty-row")) return;
    selectRow(row);
  });

  tbody.addEventListener("dblclick",(ev)=>{
    const row = ev.target.closest("tr");
    if(!row || row.hasAttribute("data-empty-row")) return;
    selectRow(row);
    document.getElementById("btnConsultar").click();
  });

  document.addEventListener("keydown",(ev)=>{
    if(ev.key==='Enter' && selectedId){
      document.getElementById("btnConsultar").click();
      ev.preventDefault();
    }
  });

  /* ====== Consultar ====== */
  document.getElementById("btnConsultar").addEventListener("click",()=>{
    if(!selectedRow){ alert("Selecciona una receta primero."); return; }
    document.getElementById("detalleFactura").textContent   = selectedRow.dataset.factura || "—";
    document.getElementById("detalleReferente").textContent = selectedRow.dataset.referente || "—";
    document.getElementById("detalleProducto").textContent  = selectedRow.dataset.productoNombre || "—";
    document.getElementById("detalleUsuario").textContent   = selectedRow.dataset.usuarioNombre || "—";
    document.getElementById("detalleFecha").textContent     = selectedRow.dataset.fecha || "—";
    new bootstrap.Modal(document.getElementById("consultarRecetaModal")).show();
  });

  /* ====== Editar (carga datos + action) ====== */
  document.getElementById("btnEditar").addEventListener("click",()=>{
    if(!selectedRow){ alert("Selecciona una receta primero."); return; }
    const id = selectedRow.dataset.id;

    // Factura y usuario venta (display + hidden)
    document.getElementById("editFacturaTxt").value  = selectedRow.dataset.factura || "";
    document.getElementById("editFacturaVal").value  = selectedRow.dataset.factura || "";
    document.getElementById("editUsuarioTxt").value  = selectedRow.dataset.usuarioNombre || "";
    document.getElementById("editUsuarioId").value   = selectedRow.dataset.usuarioId || "";

    // Referente y producto
    document.getElementById("editReferente").value   = selectedRow.dataset.referente || "";
    document.getElementById("editProductoId").value  = selectedRow.dataset.productoId || "";
    document.getElementById("editProductoTxt").value = selectedRow.dataset.productoNombre || "";

    document.getElementById("editarRecetaForm").action = `/recetas/${id}/editar/`;
    new bootstrap.Modal(document.getElementById("editarRecetaModal")).show();
  });

  /* ====== Eliminar ====== */
  document.getElementById("btnEliminar").addEventListener("click",()=>{
    if(!selectedRow){ alert("Selecciona una receta primero."); return; }
    const id = selectedRow.dataset.id;
    document.getElementById("eliminarFactura").textContent = selectedRow.dataset.factura || "";
    document.getElementById("eliminarRecetaForm").action  = `/recetas/${id}/eliminar/`;
    new bootstrap.Modal(document.getElementById("eliminarRecetaModal")).show();
  });

  /* ====== Utilidades ====== */
  function refreshAutoTitles(){
    table.querySelectorAll("td, th").forEach(el=>{
      if(el.scrollWidth>el.clientWidth){ el.setAttribute("title", el.textContent.trim()); }
      else{ el.removeAttribute("title"); }
    });
  }

  function removeEmptyRows(){
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      if(tr.hasAttribute('data-empty-row')) return;
      const tds = Array.from(tr.cells);
      const hasContent = tds.some(td => (td.textContent||'').trim() !== '' || td.querySelector('*'));
      if(!hasContent){ tr.remove(); }
    });
  }

  /* ====== Paginación ====== */
  let currentPage=1; let pageSize=15; const rowHeight=42;

  function recomputarPageSize(){
    const rect=tbody.getBoundingClientRect();
    const margenInf=160;
    const espacio=window.innerHeight-rect.top-margenInf;
    pageSize=Math.max(1,Math.floor(espacio/rowHeight));
  }

  function getDataRows(){
    return Array.from(tbody.querySelectorAll("tr"))
      .filter(tr=>!tr.hasAttribute("data-empty-row") && tr.style.display!=="none");
  }

  function renderPager(totalPages){
    if(totalPages<=1){ pagerEl.innerHTML=""; pagerEl.style.display="none"; return; }
    pagerEl.style.display="flex";
    pagerEl.classList.add("justify-content-center","align-items-center","py-3","gap-3");
    pagerEl.innerHTML="";

    const prev=document.createElement("button");
    prev.className="btn btn-success btn-sm rounded-pill shadow-sm px-3";
    prev.innerHTML="<i class='bi bi-chevron-left me-1'></i> Anterior";
    prev.disabled=currentPage===1;
    prev.onclick=()=>{ currentPage--; applyPagination(); };

    const info=document.createElement("span");
    info.className="fw-semibold text-success small";
    info.textContent=`Página ${currentPage} de ${totalPages}`;

    const next=document.createElement("button");
    next.className="btn btn-success btn-sm rounded-pill shadow-sm px-3";
    next.innerHTML="Siguiente <i class='bi bi-chevron-right ms-1'></i>";
    next.disabled=currentPage===totalPages;
    next.onclick=()=>{ currentPage++; applyPagination(); };

    pagerEl.append(prev,info,next);
  }

  function applyPagination(){
    const rows=getDataRows();
    const total=rows.length;
    const totalPages=Math.max(1,Math.ceil(total/pageSize));
    if(currentPage>totalPages) currentPage=totalPages;

    const start=(currentPage-1)*pageSize;
    const end=start+pageSize;

    rows.forEach((tr,idx)=>{
      tr.classList.toggle("hidden-by-pagination", !(idx>=start && idx<end));
    });

    renderPager(totalPages);

    tbody.querySelectorAll('tr').forEach(tr=>tr.classList.remove('last-visible'));
    const visibles = rows.filter(r=>!r.classList.contains('hidden-by-pagination'));
    const last = visibles[visibles.length-1];
    if(last) last.classList.add('last-visible');

    if(selectedId){
      const sel=rows.find(r=>r.getAttribute("data-id")===selectedId);
      if(sel && sel.classList.contains("hidden-by-pagination")){
        const firstVisible=rows.find(r=>!r.classList.contains("hidden-by-pagination"));
        if(firstVisible) selectRow(firstVisible);
      }
    }
    refreshAutoTitles();
  }

  /* ====== Filtros ====== */
  function installFilters(){
    const fFactura  = document.getElementById("f-factura");
    const fReferente= document.getElementById("f-referente");
    const fProducto = document.getElementById("f-producto");
    const fUsuario  = document.getElementById("f-usuario");
    const fFecha    = document.getElementById("f-fecha");

    const inputs=[fFactura,fReferente,fProducto,fUsuario,fFecha].filter(Boolean);
    const norm=(s)=>(s||"").toString().trim().toLowerCase();

    function applyFilters(){
      const vFac=norm(fFactura?.value), vRef=norm(fReferente?.value),
            vProd=norm(fProducto?.value), vUser=norm(fUsuario?.value),
            vFecha=norm(fFecha?.value);

      const rows=Array.from(tbody.querySelectorAll("tr")).filter(r=>!r.hasAttribute("data-empty-row"));
      rows.forEach(tr=>{
        const tds=tr.querySelectorAll("td");
        const txt=i=>norm(tds[i]?.textContent);
        const ok =
          (!vFac   || txt(0).includes(vFac)) &&
          (!vRef   || txt(1).includes(vRef)) &&
          (!vProd  || txt(2).includes(vProd)) &&
          (!vUser  || txt(3).includes(vUser)) &&
          (!vFecha || (tr.getAttribute("data-fecha")||"").includes(vFecha));
        tr.style.display = ok ? "" : "none";
      });
      currentPage=1;
      applyPagination();
    }

    inputs.forEach(inp=>{
      const ev=(inp.tagName==="SELECT")?"change":"input";
      inp.addEventListener(ev,applyFilters);
    });
  }

  /* ====== Buscador de productos (modal) ====== */
  const modalBuscarProd = document.getElementById("modalBuscarProducto");
  const modalCrear      = document.getElementById("crearRecetaModal");
  const modalEditar     = document.getElementById("editarRecetaModal");

  // Contexto de origen para reabrir el modal principal
  let parentContext = null;
  document.querySelectorAll('[data-bs-target="#modalBuscarProducto"],[data-bs-target="#modalBuscarFactura"]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      parentContext = btn.getAttribute('data-parent') || null;
    });
  });

  const searchProducto     = document.getElementById("searchProducto");
  const tbodyBuscarProd    = document.getElementById("tablaBuscarProductos");

  if(modalBuscarProd){
    modalBuscarProd.addEventListener("shown.bs.modal", () => {
      if (searchProducto){ searchProducto.value = ""; searchProducto.focus(); }
      if (tbodyBuscarProd){ tbodyBuscarProd.innerHTML = ""; }
    });
    modalBuscarProd.addEventListener("hidden.bs.modal", () => {
      if (parentContext === 'crear' && modalCrear){
        bootstrap.Modal.getOrCreateInstance(modalCrear).show();
      } else if (parentContext === 'editar' && modalEditar){
        bootstrap.Modal.getOrCreateInstance(modalEditar).show();
      }
    });
  }

  function setProductoSeleccionado({id, texto}){
    if (parentContext === 'editar'){
      document.getElementById("editProductoId").value  = id || "";
      document.getElementById("editProductoTxt").value = texto || "";
    } else {
      document.getElementById("crearProductoId").value  = id || "";
      document.getElementById("crearProductoTxt").value = texto || "";
    }
  }

  if (searchProducto){
    searchProducto.oninput = function(){
      const term = this.value || "";
      fetch("{% url 'recepcion:search_productos' %}?term=" + encodeURIComponent(term))
        .then(r => r.json())
        .then(data => {
          tbodyBuscarProd.innerHTML = "";
          if (!Array.isArray(data) || data.length===0){
            tbodyBuscarProd.innerHTML = `<tr><td colspan="9" class="text-muted">Sin resultados.</td></tr>`;
            return;
          }
          data.forEach(p => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${p.codigo ?? ""}</td>
              <td>${p.nombre ?? ""}</td>
              <td>${p.descripcion ?? ""}</td>
              <td>${p.presentacion ?? ""}</td>
              <td>${p.unidad ?? ""}</td>
              <td>${p.condicion ?? ""}</td>
              <td>${p.receta ? "Sí" : "No"}</td>
              <td>${p.controlado ? "Sí" : "No"}</td>
              <td><button type="button" class="btn btn-sm btn-success">✔</button></td>
            `;
            tr.querySelector("button").addEventListener("click", () => {
              setProductoSeleccionado({
                id: p.id,
                texto: `${p.codigo ?? ""} - ${p.nombre ?? ""}`.trim()
              });
              bootstrap.Modal.getInstance(modalBuscarProd).hide();
            });
            tbodyBuscarProd.appendChild(tr);
          });
        })
        .catch(() => {
          tbodyBuscarProd.innerHTML = `<tr><td colspan="9" class="text-danger">Error buscando productos.</td></tr>`;
        });
    };
  }

  /* ====== Buscador de facturas (modal) ====== */
  const modalBuscarFac  = document.getElementById("modalBuscarFactura");
  const searchFactura   = document.getElementById("searchFactura");
  const tbodyBuscarFac  = document.getElementById("tablaBuscarFacturas");

  if(modalBuscarFac){
    modalBuscarFac.addEventListener("shown.bs.modal", () => {
      if (searchFactura){ searchFactura.value = ""; searchFactura.focus(); }
      if (tbodyBuscarFac){ tbodyBuscarFac.innerHTML = ""; }
    });
    modalBuscarFac.addEventListener("hidden.bs.modal", () => {
      if (parentContext === 'crear' && modalCrear){
        bootstrap.Modal.getOrCreateInstance(modalCrear).show();
      } else if (parentContext === 'editar' && modalEditar){
        bootstrap.Modal.getOrCreateInstance(modalEditar).show();
      }
    });
  }

  function setFacturaSeleccionada({factura, usuarioId, usuarioNombre, productoId, productoNombre}){
    if (parentContext === 'editar'){
      document.getElementById("editFacturaTxt").value  = factura || "";
      document.getElementById("editFacturaVal").value  = factura || "";
      document.getElementById("editUsuarioTxt").value  = usuarioNombre || "";
      document.getElementById("editUsuarioId").value   = usuarioId || "";
      // opcional: sugerir producto
      if(productoId){
        document.getElementById("editProductoId").value  = productoId;
        document.getElementById("editProductoTxt").value = productoNombre || "";
      }
    } else {
      document.getElementById("crearFacturaTxt").value  = factura || "";
      document.getElementById("crearFacturaVal").value  = factura || "";
      document.getElementById("crearUsuarioVentaTxt").value = usuarioNombre || "";
      document.getElementById("crearUsuarioVentaId").value  = usuarioId || "";
      if(productoId){
        document.getElementById("crearProductoId").value  = productoId;
        document.getElementById("crearProductoTxt").value = productoNombre || "";
      }
    }
  }

  if (searchFactura){
    searchFactura.oninput = function(){
      const term = this.value || "";
      // Endpoint equivalente al buscador de productos
      fetch("{% url 'recetas:search_facturas' %}?term=" + encodeURIComponent(term))
        .then(r => r.json())
        .then(data => {
          tbodyBuscarFac.innerHTML = "";
          if (!Array.isArray(data) || data.length===0){
            tbodyBuscarFac.innerHTML = `<tr><td colspan="5" class="text-muted">Sin resultados.</td></tr>`;
            return;
          }
          data.forEach(f => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${f.factura ?? ""}</td>
              <td>${f.usuario_nombre ?? ""}</td>
              <td>${f.producto_nombre ?? ""}</td>
              <td>${f.fecha ?? ""}</td>
              <td><button type="button" class="btn btn-sm btn-success">✔</button></td>
            `;
            tr.querySelector("button").addEventListener("click", () => {
              setFacturaSeleccionada({
                factura: f.factura,
                usuarioId: f.usuario_id,
                usuarioNombre: f.usuario_nombre,
                productoId: f.producto_id,
                productoNombre: f.producto_nombre
              });
              bootstrap.Modal.getInstance(modalBuscarFac).hide();
            });
            tbodyBuscarFac.appendChild(tr);
          });
        })
        .catch(() => {
          tbodyBuscarFac.innerHTML = `<tr><td colspan="5" class="text-danger">Error buscando facturas.</td></tr>`;
        });
    };
  }

  /* ====== Init ====== */
  removeEmptyRows();
  recomputarPageSize();
  installFilters();
  applyPagination();
  refreshAutoTitles();
  window.addEventListener("resize",()=>{recomputarPageSize();applyPagination();});
});
</script>
{% endblock %}
